"use strict";var Fe=Object.create;var B=Object.defineProperty;var Qe=Object.getOwnPropertyDescriptor;var Xe=Object.getOwnPropertyNames;var ze=Object.getPrototypeOf,Ye=Object.prototype.hasOwnProperty;var Ke=(r,e)=>{for(var t in e)B(r,t,{get:e[t],enumerable:!0})},le=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Xe(e))!Ye.call(r,o)&&o!==t&&B(r,o,{get:()=>e[o],enumerable:!(n=Qe(e,o))||n.enumerable});return r};var je=(r,e,t)=>(t=r!=null?Fe(ze(r)):{},le(e||!r||!r.__esModule?B(t,"default",{value:r,enumerable:!0}):t,r)),We=r=>le(B({},"__esModule",{value:!0}),r);var mt={};Ke(mt,{behaviorPlugin:()=>De,behaviors:()=>b,browserPlugin:()=>Te,browserUtils:()=>A,clearID:()=>xe,clearTimers:()=>we,errorPlugin:()=>Ne,flush:()=>ve,generateStableDeviceIdAsync:()=>Ie,getBrowserData:()=>D,getDeviceId:()=>_,getID:()=>V,init:()=>_e,networkPlugin:()=>Ue,pageviewPlugin:()=>Me,performancePlugin:()=>Ae,plugins:()=>T,sessionPlugin:()=>Re,sessions:()=>v,setID:()=>Pe,storageUtils:()=>g,track:()=>f,use:()=>ye,userPlugin:()=>Ce});module.exports=We(mt);var d={DEFAULT_MAX_QUEUE_SIZE:1e3,DEFAULT_BATCH_SIZE:20,DEFAULT_BATCH_INTERVAL:1e3,MAX_BATCH_SIZE:50,MIN_BATCH_SIZE:5,MAX_BATCH_INTERVAL:3e3,MIN_BATCH_INTERVAL:200,QUEUE_PRESSURE_HIGH:.7,QUEUE_PRESSURE_VERY_HIGH:.9,QUEUE_PRESSURE_LOW:.2,QUEUE_PRESSURE_MEDIUM:.6,NETWORK_CHECK_INTERVAL:5e3,BEACON_SIZE_LIMIT:65536,SMALL_DATA_THRESHOLD:1024,MAX_RETRY_COUNT:5,DEFAULT_TIMEOUT:3e4,QUEUE_CLEANUP_RATIO:.1,MAX_CLEANUP_COUNT:10,OFFLINE_CHECK_INTERVAL:3e4,DEDUPE_CACHE_MAX_SIZE:1e4};var X=class{constructor(e=1e4){this.cache=new Map,this.maxSize=e}has(e){return this.cache.has(e)}set(e,t){if(this.cache.size>=this.maxSize){let n=this.cache.keys().next().value;n!==void 0&&this.cache.delete(n)}this.cache.set(e,t)}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}size(){return this.cache.size}get(e){let t=this.cache.get(e);return t!==void 0&&(this.cache.delete(e),this.cache.set(e,t)),t}};function Q(r){return`${r.id}_${r.event}_${r.timestamp}`}var H=class{constructor(e=1e4){this.cache=new X(e)}exists(e){let t=Q(e);return this.cache.has(t)}add(e){let t=Q(e);this.cache.set(t,!0)}remove(e){let t=Q(e);this.cache.delete(t)}removeBatch(e){e.forEach(t=>this.remove(t))}clear(){this.cache.clear()}size(){return this.cache.size()}};var Ge={RANDOM_STRING_DEFAULT_LENGTH:8,NUMBER_FORMAT_DEFAULT_DECIMALS:2},z={random:(r=Ge.RANDOM_STRING_DEFAULT_LENGTH)=>{let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let n=0;n<r;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},uuid:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){let e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),generateEventId:()=>{let r=I(),e=new Date(r),t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),i=String(e.getSeconds()).padStart(2,"0"),u=String(e.getMilliseconds()).padStart(3,"0"),l=`${t}${n}${o}${s}${a}${i}${u}`,h=z.random(8);return`${l}${h}`},truncate:(r,e,t="...")=>r.length<=e?r:r.substring(0,e-t.length)+t};var c=()=>typeof window!="undefined",I=()=>Date.now();var Y=class{constructor(){this.state={type:"unknown",lastCheckTime:0,effectiveType:"4g",rtt:0,downlink:0},this.checkInterval=d.NETWORK_CHECK_INTERVAL}shouldUpdate(){return I()-this.state.lastCheckTime>=this.checkInterval}update(){if(!(!c()||typeof navigator=="undefined")&&this.shouldUpdate()&&(this.state.lastCheckTime=I(),this.state.type=navigator.onLine?"online":"offline","connection"in navigator)){let e=navigator.connection;this.state.effectiveType=e.effectiveType||"unknown",this.state.rtt=e.rtt||0,this.state.downlink=e.downlink||0,(this.state.effectiveType==="2g"||this.state.rtt>1e3||this.state.downlink<1)&&(this.state.type="slow")}}getState(){return this.update(),{...this.state}}getType(){return this.update(),this.state.type}isOnline(){return this.update(),this.state.type==="online"}isOffline(){return this.update(),this.state.type==="offline"}isSlow(){return this.update(),this.state.type==="slow"}},de=new Y;var K=class{select(e,t){let n=de.getType();return n==="offline"?"beacon":n==="slow"||t>d.BEACON_SIZE_LIMIT?"fetch":t<d.SMALL_DATA_THRESHOLD?"beacon":"fetch"}};async function Ze(r,e,t){if(!c()||typeof navigator.sendBeacon=="undefined")return!1;try{let n=navigator.sendBeacon(r,e);return t&&console.log("[Node-Trace] Sent with beacon:",n),n}catch(n){return t&&console.log("[Node-Trace] Beacon failed:",n),!1}}async function he(r,e,t,n,o){if(!c()||typeof fetch=="undefined")return!1;try{let s=await fetch(r,{method:"POST",body:e,headers:{"Content-Type":"application/json",...t},keepalive:!0,signal:n?AbortSignal.timeout(n):void 0});return o&&console.log("[Node-Trace] Sent with fetch:",s.ok),s.ok}catch(s){return o&&console.log("[Node-Trace] Fetch failed:",s),!1}}async function Je(r,e,t,n){return!c()||typeof XMLHttpRequest=="undefined"?!1:new Promise(o=>{let s=new XMLHttpRequest,a=JSON.stringify(e);s.open("POST",r,!0),s.setRequestHeader("Content-Type","application/json"),t>0&&(s.timeout=t),s.onload=function(){let i=s.status>=200&&s.status<300;n&&console.log("[Node-Trace] Sent with XHR:",i),o(i)},s.onerror=function(){n&&console.log("[Node-Trace] XHR failed"),o(!1)},s.ontimeout=function(){n&&console.log("[Node-Trace] XHR timeout"),o(!1)},s.send(a)})}var j=class{constructor(){this.strategySelector=new K}async send(e){if(!c())return{success:!1,strategy:"fetch",time:0};let t=Date.now(),{endpoint:n,data:o,timeout:s=d.DEFAULT_TIMEOUT,headers:a={},debug:i}=e,u=JSON.stringify(o),l=u.length,h=this.strategySelector.select(u,l),p=!1;h==="beacon"&&(p=await Ze(n,u,i),p||(p=await he(n,u,a,s,i))),(h==="fetch"||!p)&&(p=await he(n,u,a,s,i),p||(p=await Je(n,o,s,i)));let w=Date.now()-t;return{success:p,strategy:h,time:w}}},ge=new j;var W=class{constructor(e){this.errors=[];this.stats={total:0,byType:{},byLevel:{},byCode:{},lastError:0,rate:{lastMinute:0,lastHour:0},consecutiveErrors:0,maxConsecutiveErrors:0};this.errorTimestamps=[];this.config={capture:!0,logLevel:"warn",maxErrors:100,...e},this.initStats()}initStats(){["network","network:timeout","network:offline","network:server","network:client","storage","storage:quota","storage:access","browser","plugin","plugin:init","plugin:execute","queue","queue:full","queue:overflow","device","session","session:timeout","behavior","data","data:validation","data:serialization","config","init","runtime","unknown"].forEach(n=>{this.stats.byType[n]=0}),["debug","info","warn","error","fatal"].forEach(n=>{this.stats.byLevel[n]=0})}generateErrorId(){return"error_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}parseStack(e){let t=e.split(`
`);for(let n of t){let o=n.match(/at \s*(?:\w+\s+)?\(?([^:]+):(\d+):(\d+)\)?/);if(o)return{file:o[1],line:parseInt(o[2])}}return{}}updateStats(e){this.stats.total++,this.stats.byType[e.type]=(this.stats.byType[e.type]||0)+1,this.stats.byLevel[e.level]=(this.stats.byLevel[e.level]||0)+1,e.code&&(this.stats.byCode[e.code]=(this.stats.byCode[e.code]||0)+1),this.stats.lastError=e.timestamp,this.errorTimestamps.push(e.timestamp);let t=Date.now()-3600*1e3;this.errorTimestamps=this.errorTimestamps.filter(s=>s>t);let n=Date.now()-60*1e3;this.stats.rate.lastMinute=this.errorTimestamps.filter(s=>s>n).length,this.stats.rate.lastHour=this.errorTimestamps.length,e.timestamp-this.stats.lastError<5e3?(this.stats.consecutiveErrors++,this.stats.consecutiveErrors>this.stats.maxConsecutiveErrors&&(this.stats.maxConsecutiveErrors=this.stats.consecutiveErrors)):this.stats.consecutiveErrors=1}captureError(e,t,n,o,s="error",a,i){let u=n,l=n;if(!this.config.capture)return{type:e,level:s,message:t,code:a,stack:u==null?void 0:u.stack,context:o,timestamp:Date.now(),id:this.generateErrorId()};let h,p;if(u!=null&&u.stack){let E=this.parseStack(u.stack);h=E.file,p=E.line}let w={type:e,level:s,message:t,code:a,stack:u==null?void 0:u.stack,context:o,details:l==null?void 0:l.details,source:i||"unknown",file:h,line:p,timestamp:Date.now(),id:this.generateErrorId(),event:o==null?void 0:o.event,userId:o==null?void 0:o.userId,deviceId:o==null?void 0:o.deviceId};return this.errors.push(w),this.errors.length>this.config.maxErrors&&this.errors.shift(),this.updateStats(w),this.logError(w),this.checkErrorRate(w),w}checkErrorRate(e){this.stats.rate.lastMinute>10&&typeof console!="undefined"&&console.warn("[Node-Trace] High error rate detected:",{errorsPerMinute:this.stats.rate.lastMinute,consecutiveErrors:this.stats.consecutiveErrors,maxConsecutiveErrors:this.stats.maxConsecutiveErrors}),this.stats.consecutiveErrors>5&&typeof console!="undefined"&&console.error("[Node-Trace] Critical error sequence detected:",{consecutiveErrors:this.stats.consecutiveErrors,lastError:e,recentErrors:this.errors.slice(-3)})}logError(e){var o;let t=((o=m.options)==null?void 0:o.debug)||!1,n=this.shouldLog(e.level);if(t&&n){let s=`[Node-Trace] [${e.type.toUpperCase()}]${e.code?` [${e.code}]`:""}`,a=e.context?` Context: ${JSON.stringify(e.context)}`:"",i=e.details?` Details: ${JSON.stringify(e.details)}`:"",u=e.stack?`
Stack: ${e.stack}`:"",l=` ErrorID: ${e.id}`;switch(e.level){case"debug":console.debug(`${s} ${e.message}${l}${a}${i}${u}`);break;case"info":console.info(`${s} ${e.message}${l}${a}${i}${u}`);break;case"warn":console.warn(`${s} ${e.message}${l}${a}${i}${u}`);break;case"error":console.error(`${s} ${e.message}${l}${a}${i}${u}`);break;case"fatal":console.error(`${s} [FATAL] ${e.message}${l}${a}${i}${u}`);break}}}getStats(){return{...this.stats}}getRecentErrors(e=10){return this.errors.slice(-e)}hasErrors(){return this.errors.length>0}getErrorSummary(){if(this.errors.length===0)return{total:0,lastError:null,mostFrequentType:null,mostFrequentLevel:null,rate:{lastMinute:0,lastHour:0}};let e=null,t=0;Object.entries(this.stats.byType).forEach(([s,a])=>{a>t&&(t=a,e=s)});let n=null,o=0;return Object.entries(this.stats.byLevel).forEach(([s,a])=>{a>o&&(o=a,n=s)}),{total:this.stats.total,lastError:this.errors[this.errors.length-1],mostFrequentType:e,mostFrequentLevel:n,rate:{lastMinute:this.stats.rate.lastMinute,lastHour:this.stats.rate.lastHour}}}shouldLog(e){let t=["debug","info","warn","error","fatal"],n=t.indexOf(this.config.logLevel);return t.indexOf(e)>=n}getErrors(){return[...this.errors]}clearErrors(){this.errors=[]}handleNetworkError(e,t){this.captureError("network","Network error occurred",e,t)}handleStorageError(e,t){this.captureError("storage","Storage error occurred",e,t,"warn")}handleBrowserError(e,t){this.captureError("browser","Browser API error occurred",e,t,"warn")}handlePluginError(e,t){this.captureError("plugin","Plugin error occurred",e,t)}handleQueueError(e,t){this.captureError("queue","Queue error occurred",e,t)}handleDeviceError(e,t){this.captureError("device","Device ID error occurred",e,t,"warn")}handleSessionError(e,t){this.captureError("session","Session error occurred",e,t,"warn")}handleBehaviorError(e,t){this.captureError("behavior","Behavior error occurred",e,t,"warn")}handleDataError(e,t){this.captureError("data","Data processing error occurred",e,t)}handleUnknownError(e,t){this.captureError("unknown","Unknown error occurred",e,t)}},P=new W;function G(r,e){P.handleNetworkError(r,e)}function O(r,e){P.handleStorageError(r,e)}function pe(r,e){P.handleBrowserError(r,e)}function y(r,e){P.handlePluginError(r,e)}function q(r,e){P.handleSessionError(r,e)}function x(r,e){P.handleBehaviorError(r,e)}var fe=je(require("dexie")),Z=class extends fe.default{constructor(){super("nodeTraceDb"),this.version(1).stores({offlineEvents:"id, event, timestamp"})}},$=new Z,J=class{async all(){try{return await $.offlineEvents.toArray()}catch(e){return[]}}async add(e){try{await $.offlineEvents.bulkAdd(e)}catch(t){}}async clear(){try{await $.offlineEvents.clear()}catch(e){}}async delete(e){try{e.length>0&&await $.offlineEvents.bulkDelete(e)}catch(t){}}},C=new J;var ee=class{constructor(){this.queue=[],this.dedupe=new H(d.DEDUPE_CACHE_MAX_SIZE),this.stats={totalEvents:0,sendSuccessCount:0,sendFailCount:0,averageSendTime:0,lastSendTime:0},this.config=null,this.timer=null,this.retryTimers=[],this.offlineCheckTimer=null}init(e){this.config=e,this.startOfflineCheck()}calculatePressure(){return this.config?this.queue.length/this.config.maxQueueSize:0}getDynamicBatchSize(){if(!this.config)return d.DEFAULT_BATCH_SIZE;let e=this.calculatePressure(),t=this.config.batchSize;return e>d.QUEUE_PRESSURE_MEDIUM?t=Math.max(Math.floor(t*.8),d.MIN_BATCH_SIZE):e<d.QUEUE_PRESSURE_LOW&&(t=Math.min(Math.ceil(t*1.2),d.MAX_BATCH_SIZE)),Math.min(t,this.queue.length)}getDynamicInterval(){if(!this.config)return d.DEFAULT_BATCH_INTERVAL;let e=this.calculatePressure(),t=this.config.batchInterval;return e>d.QUEUE_PRESSURE_MEDIUM?t=Math.max(t*.5,d.MIN_BATCH_INTERVAL):e<d.QUEUE_PRESSURE_LOW&&(t=Math.min(t*1.5,d.MAX_BATCH_INTERVAL)),t}handleQueueFull(){if(!this.config)return;let e=this.calculatePressure(),t=1;e>d.QUEUE_PRESSURE_VERY_HIGH?t=Math.min(Math.ceil(this.queue.length*d.QUEUE_CLEANUP_RATIO),d.MAX_CLEANUP_COUNT):e>d.QUEUE_PRESSURE_HIGH&&(t=Math.min(Math.ceil(this.queue.length*.05),5));let n=this.queue.splice(0,t);this.dedupe.removeBatch(n),this.config.debug&&console.log("[Node-Trace] Queue full, removed events:",t)}push(e){var n;if(this.dedupe.exists(e)){(n=this.config)!=null&&n.debug&&console.log("[Node-Trace] Event already exists, skipping:",e.event);return}if(!this.config){this.queue.push(e),this.dedupe.add(e);return}this.queue.length>=this.config.maxQueueSize&&this.handleQueueFull(),this.queue.push(e),this.dedupe.add(e),this.stats.totalEvents++,this.config.debug&&(console.log("[Node-Trace] Event pushed:",e.event),console.log("[Node-Trace] Queue length:",this.queue.length)),this.calculatePressure()>d.QUEUE_PRESSURE_HIGH?this.flush():this.schedule()}schedule(){if(this.timer)return;let e=this.getDynamicInterval();this.timer=setTimeout(()=>{this.flush()},e)}updateStats(e,t){this.stats.lastSendTime=Date.now(),t?this.stats.sendSuccessCount++:this.stats.sendFailCount++;let n=this.stats.sendSuccessCount+this.stats.sendFailCount;n>0&&(this.stats.averageSendTime=(this.stats.averageSendTime*(n-1)+e)/n)}async handleSendFailure(e){if(this.config){if(this.config.debug&&console.log("[Node-Trace] Send failed, batch size:",e.length),this.config.offlineEnabled&&c())try{await C.add(e),this.config.debug&&console.log("[Node-Trace] Events cached offline:",e.length)}catch(t){G(t,{eventCount:e.length})}else if(this.config.retryCount>0){let n=this.config.retryInterval*Math.pow(2,this.stats.sendFailCount%d.MAX_RETRY_COUNT),o=setTimeout(()=>{var s;this.queue.unshift(...e),e.forEach(a=>this.dedupe.add(a)),(s=this.config)!=null&&s.debug&&console.log("[Node-Trace] Retrying events:",e.length),this.schedule()},n);this.retryTimers.push(o)}}}async handleSendSuccess(e){var t;(t=this.config)!=null&&t.debug&&console.log("[Node-Trace] Events sent successfully:",e.length),c()&&await C.clear()}applyBeforeSendHooks(e){let t=T.sort(),n=e;for(let o of t)if(o.beforeSend)try{n=o.beforeSend(n)}catch(s){y(s,{plugin:o.name,context:"beforeSend"})}return n}applyAfterSendHooks(e,t){let n=T.getAll();for(let o of n)if(o.afterSend)try{o.afterSend(e,t)}catch(s){y(s,{plugin:o.name,context:"afterSend"})}}async flush(){if(!this.config||this.queue.length===0)return;let e=this.getDynamicBatchSize(),t=this.queue.splice(0,e);this.dedupe.removeBatch(t);let n=this.applyBeforeSendHooks(t),o=await ge.send({endpoint:this.config.endpoint,data:{appId:this.config.appId,appKey:this.config.appKey,events:n},timeout:this.config.timeout,headers:this.config.headers,debug:this.config.debug});this.updateStats(o.time,o.success),this.applyAfterSendHooks(n,o.success),o.success?await this.handleSendSuccess(n):await this.handleSendFailure(n),this.timer=null}startOfflineCheck(){var e;!c()||this.offlineCheckTimer||(e=this.config)!=null&&e.offlineEnabled&&(this.offlineCheckTimer=setInterval(async()=>{await this.restoreOfflineEvents()},d.OFFLINE_CHECK_INTERVAL))}async restoreOfflineEvents(){var e,t;if(c())try{let n=await C.all();if(n.length===0)return;let o=new Set;this.queue.forEach(a=>{let i=`${a.id}_${a.event}_${a.timestamp}`;o.add(i)});let s=n.filter(a=>{let i=`${a.id}_${a.event}_${a.timestamp}`;return!o.has(i)});if(s.length>0){let a=s.map(i=>i.id);a.length>0&&await C.delete(a),this.queue.unshift(...s),s.forEach(i=>this.dedupe.add(i)),(e=this.config)!=null&&e.debug&&console.log("[Node-Trace] Restored offline events:",s.length),this.schedule()}else await C.clear(),(t=this.config)!=null&&t.debug&&console.log("[Node-Trace] All offline events are duplicates, cleared")}catch(n){G(n,{eventCount:0})}}clearTimers(){this.timer&&(clearTimeout(this.timer),this.timer=null),this.retryTimers.forEach(e=>clearTimeout(e)),this.retryTimers=[],this.offlineCheckTimer&&(clearInterval(this.offlineCheckTimer),this.offlineCheckTimer=null)}getStats(){return{...this.stats}}length(){return this.queue.length}clear(){this.queue=[],this.dedupe.clear()}},R=new ee;function me(r){R.push(r)}async function ve(){await R.flush()}function we(){R.clearTimers()}var et={appKey:"",debug:!1,sampleRate:1,blacklist:[],whitelist:void 0,batchSize:20,batchInterval:1e3,offlineEnabled:!1,maxQueueSize:1e3,retryCount:3,retryInterval:1e3,headers:{},timeout:3e4,beforeSend:void 0},m={options:null,queue:[],plugins:[],sortedPluginsCache:null},te=class{constructor(){this.plugins=new Map}createPluginContext(){return{getPlugins:()=>Object.fromEntries(this.plugins),getPlugin:e=>this.plugins.get(e)||null,getAllPlugins:()=>this.getAll(),callPluginMethod:(e,t,...n)=>{let o=this.plugins.get(e);if(o&&typeof o[t]=="function"){let s=o[t];return s(...n)}return null}}}register(e){try{if(this.plugins.has(e.name))return console.warn(`[Node-Trace] Plugin ${e.name} already registered`),!1;if(e.dependencies&&e.dependencies.length>0){for(let t of e.dependencies)if(!this.plugins.has(t))return console.warn(`[Node-Trace] Plugin ${e.name} depends on ${t}, which is not registered`),!1}if(e.conflicts&&e.conflicts.length>0){for(let t of e.conflicts)if(this.plugins.has(t))return console.warn(`[Node-Trace] Plugin ${e.name} conflicts with ${t}`),!1}return e.lifecycle="idle",e.enabled=!0,e.priority=e.priority||0,this.plugins.set(e.name,e),m.sortedPluginsCache=null,!0}catch(t){return y(t,{plugin:e.name}),!1}}init(e){try{e.lifecycle="loading";let t=this.createPluginContext();return e.beforeInit&&e.beforeInit(t),e.setup&&e.setup(t),e.init&&e.init(t),e.activate&&e.activate(t),e.afterInit&&e.afterInit(t),e.lifecycle="active",!0}catch(t){return y(t,{plugin:e.name}),e.lifecycle="error",!1}}destroy(e){try{let t=this.createPluginContext();return e.beforeDestroy&&e.beforeDestroy(t),e.deactivate&&e.deactivate(t),e.destroy&&e.destroy(t),e.afterDestroy&&e.afterDestroy(t),e.lifecycle="destroyed",!0}catch(t){return y(t,{plugin:e.name}),!1}}get(e){return this.plugins.get(e)}getAll(){return Array.from(this.plugins.values())}getEnabled(){return Array.from(this.plugins.values()).filter(e=>e.enabled)}enable(e){let t=this.plugins.get(e);return t?(t.enabled=!0,m.sortedPluginsCache=null,!0):!1}disable(e){let t=this.plugins.get(e);return t?(t.enabled=!1,m.sortedPluginsCache=null,!0):!1}remove(e){let t=this.plugins.get(e);if(!t)return!1;this.destroy(t);let n=this.plugins.delete(e);return m.sortedPluginsCache=null,n}clear(){for(let e of this.plugins.values())this.destroy(e);this.plugins.clear(),m.sortedPluginsCache=null}sort(){return Array.from(this.plugins.values()).filter(e=>e.enabled).sort((e,t)=>(e.priority||0)-(t.priority||0))}},T=new te;function _e(r){m.options={...et,...r},R.init({maxQueueSize:r.maxQueueSize||1e3,batchSize:r.batchSize||20,batchInterval:r.batchInterval||1e3,retryCount:r.retryCount||3,retryInterval:r.retryInterval||1e3,offlineEnabled:r.offlineEnabled||!1,debug:r.debug||!1,endpoint:r.endpoint,appId:r.appId,appKey:r.appKey,headers:r.headers,timeout:r.timeout})}function ye(r){if(!T.register(r)){console.warn(`[Node-Trace] Failed to register plugin ${r.name}`);return}T.init(r),m.plugins.push(r)}function tt(r){var t;let e=m.options;return e?!(e.sampleRate&&Math.random()>e.sampleRate||(t=e.blacklist)!=null&&t.includes(r)||e.whitelist&&!e.whitelist.includes(r)):!0}function f(r,e){var i,u;if(!tt(r))return;let n={id:z.generateEventId(),event:r,properties:e,timestamp:I()},o=m.sortedPluginsCache;o||(o=T.sort(),m.sortedPluginsCache=o);for(let l of o)if(l.onTrack)try{let h=l.onTrack(n);if(h===null)return;n=h}catch(h){y(h,{plugin:l.name,event:r})}let s=(u=(i=m.options)==null?void 0:i.beforeSend)==null?void 0:u.call(i,n);if(s===null)return;let a=s||n;me(a);for(let l of o)if(l.onTracked)try{l.onTracked(a)}catch(h){y(h,{plugin:l.name,event:r})}}function be(r){var a,i,u,l,h,p,w;let e="unknown",t="0",n="0",o="Unknown",s="0";return/Chrome/.test(r)?(e="Chrome",t=((a=r.match(/Chrome\/(\d+)/))==null?void 0:a[1])||"0",n=t,o="Blink"):/Firefox/.test(r)?(e="Firefox",t=((i=r.match(/Firefox\/(\d+)/))==null?void 0:i[1])||"0",n=t,o="Gecko"):/Safari/.test(r)&&!/Chrome/.test(r)?(e="Safari",t=((u=r.match(/Version\/(\d+)/))==null?void 0:u[1])||"0",n=t,o="WebKit"):/Edge/.test(r)?(e="Edge",t=((l=r.match(/Edge\/(\d+)/))==null?void 0:l[1])||"0",n=t,o="Blink"):/MSIE|Trident/.test(r)&&(e="Internet Explorer",t=((h=r.match(/MSIE\s(\d+)|rv:(\d+)/))==null?void 0:h[1])||"0",n=t,o="Trident"),o==="WebKit"?s=((p=r.match(/WebKit\/(\d+)/))==null?void 0:p[1])||"0":o==="Gecko"&&(s=((w=r.match(/Gecko\/(\d+)/))==null?void 0:w[1])||"0"),{name:e,version:t,major:n,engine:o,engineVersion:s}}function Ee(r){let e=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/.test(r)&&!/iPad/.test(r),t=/iPad/.test(r)||/Android/.test(r)&&!/Mobile/.test(r),n=!e&&!t,o="unknown";return e?o="mobile":t?o="tablet":n&&(o="desktop"),{isMobile:e,isTablet:t,isDesktop:n,type:o}}function rt(r){let e=be(r);return{name:e.name,major:e.major,engine:e.engine,engineVersion:e.engineVersion}}function nt(r){let e=Ee(r);return{isMobile:e.isMobile,isTablet:e.isTablet,isDesktop:e.isDesktop}}function ot(){return!c()||typeof navigator=="undefined"?{app_code_name:"",app_name:"",language:"",platform:"",browser_version:"",user_agent:"non-browser"}:{app_code_name:navigator.appCodeName,app_name:navigator.appName,language:navigator.language,platform:navigator.platform,browser_version:navigator.appVersion,user_agent:navigator.userAgent}}function st(r){let e=rt(r);return{browser_name:e.name,browser_major_version:e.major,engine_name:e.engine,engine_version:e.engineVersion}}function it(r){if(!c()||typeof window=="undefined")return{is_mobile:!1,is_tablet:!1,is_desktop:!0,device_width:0,device_height:0,device_pixel_ratio:1};let e=nt(r);return{is_mobile:e.isMobile,is_tablet:e.isTablet,is_desktop:e.isDesktop,device_width:window.innerWidth,device_height:window.innerHeight,device_pixel_ratio:window.devicePixelRatio}}function at(){var r,e,t,n;return!c()||typeof navigator=="undefined"?{is_online:!0,connection_type:"unknown",downlink:void 0,effective_type:void 0,rtt:void 0}:{is_online:navigator.onLine,connection_type:((r=navigator.connection)==null?void 0:r.type)||"unknown",downlink:(e=navigator.connection)==null?void 0:e.downlink,effective_type:(t=navigator.connection)==null?void 0:t.effectiveType,rtt:(n=navigator.connection)==null?void 0:n.rtt}}function ct(){return!c()||typeof screen=="undefined"?{screen_width:0,screen_height:0,screen_available_width:0,screen_available_height:0,screen_color_depth:0}:{screen_width:screen.width,screen_height:screen.height,screen_available_width:screen.availWidth,screen_available_height:screen.availHeight,screen_color_depth:screen.colorDepth}}function ut(){return!c()||typeof window=="undefined"||typeof document=="undefined"?{current_url:"",pathname:"",hostname:"",protocol:"",port:"",search:"",hash:"",document_url:"",referrer_url:"",content_type:"",document_title:"",document_charset:"",document_ready_state:"loading"}:{current_url:window.location.href,pathname:window.location.pathname,hostname:window.location.hostname,protocol:window.location.protocol,port:window.location.port,search:window.location.search,hash:window.location.hash,document_url:document.URL,referrer_url:document.referrer,content_type:document.contentType||"",document_title:document.title,document_charset:document.characterSet||document.charset||"",document_ready_state:document.readyState}}function lt(){return!c()||typeof window=="undefined"||typeof document=="undefined"?{scroll_x:0,scroll_y:0}:{scroll_x:window.pageXOffset||document.documentElement.scrollLeft||0,scroll_y:window.pageYOffset||document.documentElement.scrollTop||0}}var A={getBrowser:()=>{if(!c()||typeof navigator=="undefined")return{name:"unknown",version:"0",platform:"unknown"};let r=be(navigator.userAgent);return{name:r.name,version:r.version,platform:navigator.platform}},getDeviceType:()=>!c()||typeof navigator=="undefined"?"unknown":Ee(navigator.userAgent).type,getNetworkState:()=>{if(!c()||typeof navigator=="undefined")return{type:"offline",effectiveType:"unknown",rtt:0,downlink:0};let r=navigator.onLine?"online":"offline",e="unknown",t=0,n=0;if("connection"in navigator){let o=navigator.connection;e=(o==null?void 0:o.effectiveType)||"unknown",t=(o==null?void 0:o.rtt)||0,n=(o==null?void 0:o.downlink)||0}return{type:r,effectiveType:e,rtt:t,downlink:n}}},g={get:(r,e)=>{if(!c()||typeof localStorage=="undefined")return null;try{let t=localStorage.getItem(r);return t===null?null:e?e(t):t}catch(t){return null}},set:(r,e)=>{if(!c()||typeof localStorage=="undefined")return!1;try{let t=typeof e=="string"?e:JSON.stringify(e);return localStorage.setItem(r,t),!0}catch(t){return!1}},remove:r=>{if(!c()||typeof localStorage=="undefined")return!1;try{return localStorage.removeItem(r),!0}catch(e){return!1}},clear:()=>{if(!c()||typeof localStorage=="undefined")return!1;try{return localStorage.clear(),!0}catch(r){return!1}}};function D(){var r,e,t,n,o,s,a,i,u,l,h,p,w;if(!c())return{device_id:_(),event:"pageview",user_agent:"non-browser",device_width:0,device_height:0,is_online:!0,connection_type:"unknown",app_code_name:"",app_name:"",language:"",platform:"",time_zone:Intl.DateTimeFormat().resolvedOptions().timeZone,browser_version:"",browser_name:"non-browser",browser_major_version:"0",engine_name:"unknown",engine_version:"0",device_pixel_ratio:1,is_mobile:!1,is_tablet:!1,is_desktop:!0,current_url:"",pathname:"",hostname:"",protocol:"",port:"",search:"",hash:"",document_url:"",referrer_url:"",content_type:"",document_title:"",document_charset:"",document_ready_state:"loading",screen_width:0,screen_height:0,screen_available_width:0,screen_available_height:0,screen_color_depth:0,scroll_x:0,scroll_y:0,begin_time:Date.now()};try{let E=ot(),Be=st(E.user_agent),He=it(E.user_agent),Oe=at(),qe=ct(),$e=ut(),Ve=lt();return{device_id:_(),event:"pageview",...E,...He,...Oe,...Be,...qe,...$e,...Ve,time_zone:Intl.DateTimeFormat().resolvedOptions().timeZone,begin_time:Date.now()}}catch(E){return{device_id:_(),event:"pageview",user_agent:(navigator==null?void 0:navigator.userAgent)||"unknown",device_width:(window==null?void 0:window.innerWidth)||0,device_height:(window==null?void 0:window.innerHeight)||0,is_online:(navigator==null?void 0:navigator.onLine)||!1,connection_type:((r=navigator==null?void 0:navigator.connection)==null?void 0:r.type)||"unknown",downlink:(e=navigator==null?void 0:navigator.connection)==null?void 0:e.downlink,effective_type:(t=navigator==null?void 0:navigator.connection)==null?void 0:t.effectiveType,rtt:(n=navigator==null?void 0:navigator.connection)==null?void 0:n.rtt,app_code_name:(navigator==null?void 0:navigator.appCodeName)||"",app_name:(navigator==null?void 0:navigator.appName)||"",language:(navigator==null?void 0:navigator.language)||"",platform:(navigator==null?void 0:navigator.platform)||"",time_zone:Intl.DateTimeFormat().resolvedOptions().timeZone,browser_version:navigator==null?void 0:navigator.appVersion,device_pixel_ratio:(window==null?void 0:window.devicePixelRatio)||1,is_mobile:!1,is_tablet:!1,is_desktop:!0,current_url:((o=window==null?void 0:window.location)==null?void 0:o.href)||"",pathname:((s=window==null?void 0:window.location)==null?void 0:s.pathname)||"",hostname:((a=window==null?void 0:window.location)==null?void 0:a.hostname)||"",protocol:((i=window==null?void 0:window.location)==null?void 0:i.protocol)||"",port:((u=window==null?void 0:window.location)==null?void 0:u.port)||"",search:((l=window==null?void 0:window.location)==null?void 0:l.search)||"",hash:((h=window==null?void 0:window.location)==null?void 0:h.hash)||"",document_url:(document==null?void 0:document.URL)||"",referrer_url:(document==null?void 0:document.referrer)||"",content_type:(document==null?void 0:document.contentType)||"",document_title:(document==null?void 0:document.title)||"",document_charset:(document==null?void 0:document.characterSet)||(document==null?void 0:document.charset)||"",document_ready_state:(document==null?void 0:document.readyState)||"loading",screen_width:(screen==null?void 0:screen.width)||0,screen_height:(screen==null?void 0:screen.height)||0,screen_available_width:(screen==null?void 0:screen.availWidth)||0,screen_available_height:(screen==null?void 0:screen.availHeight)||0,screen_color_depth:(screen==null?void 0:screen.colorDepth)||0,scroll_x:(window==null?void 0:window.pageXOffset)||((p=document==null?void 0:document.documentElement)==null?void 0:p.scrollLeft)||0,scroll_y:(window==null?void 0:window.pageYOffset)||((w=document==null?void 0:document.documentElement)==null?void 0:w.scrollTop)||0,begin_time:Date.now()}}}var Te={name:"browser",version:"1.0.0",description:"Browser information plugin for collecting browser data and device information",priority:30,onTrack(r){try{let e=D(),t={browser_name:e.browser_name,browser_version:e.browser_version,device_type:e.is_mobile?"mobile":e.is_tablet?"tablet":"desktop",platform:e.platform,user_agent:e.user_agent,screen_width:e.screen_width,screen_height:e.screen_height,is_online:e.is_online,connection_type:e.connection_type,current_url:e.current_url,referrer_url:e.referrer_url};return{...r,properties:{...r.properties,...t}}}catch(e){return r}},getInfo(){return{name:this.name,version:this.version,description:this.description,browserData:D(),browserUtils:A.getBrowser(),deviceType:A.getDeviceType(),networkState:A.getNetworkState()}}};var re="__analytics_device_id__",M="__analytics_user_id__",ne=null,Se=32;async function dt(r){if(c()&&typeof crypto!="undefined"&&crypto.subtle){let t=new TextEncoder().encode(r),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(s=>s.toString(16).padStart(2,"0")).join("")}else if(!c()&&typeof require!="undefined")try{return require("crypto").createHash("sha256").update(r).digest("hex")}catch(e){return oe(r)}else return oe(r)}function oe(r){let e=0;for(let n=0;n<r.length;n++){let o=r.charCodeAt(n);e=(e<<5)-e+o,e=e&e}let t=Math.abs(e).toString(36);if(t.length<Se){let n=Math.random().toString(36).slice(2,10);return`${t}_${n}`}return t.substring(0,Se)}function se(){if(!c()){if(!ne){let r=Date.now().toString(36),e=Math.random().toString(36).slice(2,10);ne=`${r}_${e}`}return ne}try{let r={userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,hardwareConcurrency:navigator.hardwareConcurrency,deviceMemory:navigator.deviceMemory,screen:{width:screen.width,height:screen.height,colorDepth:screen.colorDepth},vendor:navigator.vendor,appVersion:navigator.appVersion,product:navigator.product,productSub:navigator.productSub,timestampHash:Math.floor(Date.now()/864e5).toString()},e=JSON.stringify(r);return oe(e)}catch(r){pe(r,{context:"device_id_generation"});let e=Date.now().toString(36),t=Math.random().toString(36).slice(2,10);return`${e}_${t}`}}async function ht(){if(!c())return se();try{let r={userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,hardwareConcurrency:navigator.hardwareConcurrency,deviceMemory:navigator.deviceMemory,screen:{width:screen.width,height:screen.height,colorDepth:screen.colorDepth},vendor:navigator.vendor,appVersion:navigator.appVersion,product:navigator.product,productSub:navigator.productSub},e=JSON.stringify(r);return(await dt(e)).substring(0,32)}catch(r){return se()}}function ke(){return se()}async function Ie(){return ht()}function _(){if(!c())return ke();let r=g.get(re);if(r)return r;let e=ke();return g.set(re,e)||O(new Error("Failed to set device ID in localStorage"),{key:re,operation:"set"}),e}function Pe(r){if(!c())return;g.set(M,r)||O(new Error("Failed to set user ID in localStorage"),{key:M,operation:"set"})}function V(){if(!c())return _();let r=g.get(M);return r||_()}function xe(){if(!c())return;g.remove(M)||O(new Error("Failed to remove user ID from localStorage"),{key:M,operation:"remove"})}var Ce={name:"user",version:"1.0.0",description:"User management plugin for device ID and user ID generation and management",priority:10,onTrack(r){return{...r,device_id:_(),user_id:V()}},getInfo(){return{name:this.name,version:this.version,description:this.description,deviceId:_(),userId:V(),isBrowser:c()}}};var N="__analytics_session_id__",L="__analytics_session_start__",k="__analytics_session_last_active__",ie={TIMEOUT:1800*1e3,SYNC_INTERVAL:5e3},ae=class{constructor(){this.session=null;this.timeoutId=null;this.storageCache={};this.lastStorageSync=0;this.syncInterval=ie.SYNC_INTERVAL}start(){if(c())try{this.session=this.getOrCreateSession(),this.startSessionTimeout(),this.updateLastActive()}catch(e){q(e,{context:"start"})}}updateLastActive(){if(!(!c()||!this.session))try{let e=Date.now();this.session.lastActive=e,this.storageCache[k]=e.toString(),this.syncStorage(),this.resetSessionTimeout()}catch(e){q(e,{context:"updateLastActive"})}}getID(){var e;return this.session||this.start(),((e=this.session)==null?void 0:e.id)||null}getStartTime(){var e;return this.session||this.start(),((e=this.session)==null?void 0:e.startTime)||null}getDuration(){return this.session||this.start(),this.session?Date.now()-this.session.startTime:0}isNew(){var e;return this.session||this.start(),((e=this.session)==null?void 0:e.isNew)||!1}clearTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}incrementPageViews(){this.session&&this.session.pageViews++}incrementEvents(){this.session&&this.session.events++}getStats(){var e,t;return this.session||this.start(),{pageViews:((e=this.session)==null?void 0:e.pageViews)||0,events:((t=this.session)==null?void 0:t.events)||0,duration:this.session?Date.now()-this.session.startTime:0}}getContext(){var e,t,n,o,s;return this.session||this.start(),{session_id:((e=this.session)==null?void 0:e.id)||"",session_start:((t=this.session)==null?void 0:t.startTime)||0,session_duration:this.session?Date.now()-this.session.startTime:0,session_page_views:((n=this.session)==null?void 0:n.pageViews)||0,session_events:((o=this.session)==null?void 0:o.events)||0,session_is_new:((s=this.session)==null?void 0:s.isNew)||!1}}stop(){if(c())try{g.remove(N),g.remove(L),g.remove(k),delete this.storageCache[N],delete this.storageCache[L],delete this.storageCache[k],this.session=null,this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}catch(e){q(e,{context:"stop"})}}startSessionTimeout(){this.resetSessionTimeout()}resetSessionTimeout(){this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.stop()},ie.TIMEOUT)}syncStorage(){let e=Date.now();e-this.lastStorageSync<this.syncInterval||(Object.entries(this.storageCache).forEach(([t,n])=>{g.set(t,n)}),this.lastStorageSync=e)}getOrCreateSession(){let e=this.storageCache[N],t=this.storageCache[L],n=this.storageCache[k];(!e||!t||!n)&&(e=g.get(N),t=g.get(L),n=g.get(k),e&&(this.storageCache[N]=e),t&&(this.storageCache[L]=t),n&&(this.storageCache[k]=n));let o=t?Number(t):null,s=n?Number(n):null;if(e&&o&&s&&Date.now()-s<ie.TIMEOUT)return{id:e,startTime:o,lastActive:s,pageViews:0,events:0,isNew:!1};let a=this.generateSessionId(),i=Date.now();return this.storageCache[N]=a,this.storageCache[L]=i.toString(),this.storageCache[k]=i.toString(),this.syncStorage(),{id:a,startTime:i,lastActive:i,pageViews:0,events:0,isNew:!0}}generateSessionId(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}},v=new ae,Re={name:"session",version:"1.0.0",description:"Session management plugin for tracking user sessions",priority:10,init(r){v.start()},onTrack(r){v.updateLastActive(),v.incrementEvents(),r.event==="page_view"&&v.incrementPageViews();let e=v.getContext();return{...r,properties:{...r.properties,...e}}},state:{sessions:v},getInfo(){return{name:this.name,version:this.version,description:this.description,sessionId:v.getID(),sessionStartTime:v.getStartTime(),sessionDuration:v.getDuration(),sessionIsNew:v.isNew(),sessionPageViews:v.getStats().pageViews,sessionEvents:v.getStats().events}}};var ce="__analytics_behavior_path__",S={MAX_STEPS:50,SAVE_INTERVAL:2e3,DEFAULT_RECENT_BEHAVIORS_LIMIT:10,CONTEXT_RECENT_BEHAVIORS_LIMIT:5,ANALYSIS_RESULT_LIMIT:5,SESSION_TIMEOUT:1800*1e3},ue=class{constructor(){this.behaviorPath=[];this.saveTimeoutId=null;this.lastSaveTime=0;this.saveInterval=S.SAVE_INTERVAL}init(){if(c())try{this.behaviorPath=this.loadBehaviorPath()}catch(e){x(e,{context:"init"}),this.behaviorPath=[]}}loadBehaviorPath(){let e=g.get(ce);if(!e)return[];try{let t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(t){return[]}}saveBehaviorPath(){if(!c())return;if(this.saveTimeoutId&&(clearTimeout(this.saveTimeoutId),this.saveTimeoutId=null),Date.now()-this.lastSaveTime<this.saveInterval){this.saveTimeoutId=setTimeout(()=>{this.saveBehaviorPathToStorage()},this.saveInterval);return}this.saveBehaviorPathToStorage()}saveBehaviorPathToStorage(){try{this.behaviorPath.length>S.MAX_STEPS&&(this.behaviorPath=this.behaviorPath.slice(-S.MAX_STEPS)),g.set(ce,JSON.stringify(this.behaviorPath)),this.lastSaveTime=Date.now()}catch(e){x(e,{context:"saveBehaviorPathToStorage"})}}track(e,t={}){if(c())try{let n={event:e,timestamp:Date.now(),properties:t,path:window.location.pathname,referrer:document.referrer};this.behaviorPath.push(n),this.saveBehaviorPath()}catch(n){x(n,{context:"track",event:e})}}trackView(e={}){if(c())try{let t={event:"pageview",timestamp:Date.now(),properties:e,path:window.location.pathname,referrer:document.referrer};this.behaviorPath.push(t),this.saveBehaviorPath()}catch(t){x(t,{context:"trackView"})}}getPath(){return[...this.behaviorPath]}getRecent(e=S.DEFAULT_RECENT_BEHAVIORS_LIMIT){return this.behaviorPath.slice(-e)}getStats(){let e=this.behaviorPath.length,t=new Set(this.behaviorPath.map(o=>o.event)).size,n=0;if(e>1){let o=0;for(let s=1;s<e;s++)o+=this.behaviorPath[s].timestamp-this.behaviorPath[s-1].timestamp;n=o/(e-1)}return{totalSteps:e,uniqueEvents:t,averageTimeBetweenSteps:n}}getContext(){var n,o;let e=this.getRecent(S.CONTEXT_RECENT_BEHAVIORS_LIMIT),t=this.getStats();return{behavior_steps:e.length,behavior_unique_events:t.uniqueEvents,behavior_avg_time_between_steps:Math.round(t.averageTimeBetweenSteps),last_event:((n=e[e.length-1])==null?void 0:n.event)||"",last_event_time:((o=e[e.length-1])==null?void 0:o.timestamp)||0}}clear(){if(c())try{this.clearTimeouts(),this.behaviorPath=[],g.remove(ce),this.lastSaveTime=0}catch(e){x(e,{context:"clear"})}}clearTimeouts(){this.saveTimeoutId&&(clearTimeout(this.saveTimeoutId),this.saveTimeoutId=null)}analyze(){let e={};for(let i of this.behaviorPath)e[i.event]=(e[i.event]||0)+1;let t=Object.entries(e).map(([i,u])=>({event:i,count:u})).sort((i,u)=>u.count-i.count).slice(0,S.ANALYSIS_RESULT_LIMIT),n={};for(let i of this.behaviorPath)n[i.path]=(n[i.path]||0)+1;let o=Object.entries(n).map(([i,u])=>({path:i,count:u})).sort((i,u)=>u.count-i.count).slice(0,S.ANALYSIS_RESULT_LIMIT),s=this.extractSessions(),a=s.length>0?s.reduce((i,u)=>i+u.duration,0)/s.length:0;return{mostFrequentEvents:t,commonPaths:o,averageSessionDuration:a}}extractSessions(){let e=[];if(this.behaviorPath.length===0)return e;let t=[this.behaviorPath[0]],n=this.behaviorPath[0].timestamp;for(let o=1;o<this.behaviorPath.length;o++){let s=this.behaviorPath[o];if(s.timestamp-t[t.length-1].timestamp>S.SESSION_TIMEOUT){let i=t[t.length-1].timestamp;e.push({startTime:n,endTime:i,duration:i-n,steps:[...t]}),t=[s],n=s.timestamp}else t.push(s)}if(t.length>0){let o=t[t.length-1].timestamp;e.push({startTime:n,endTime:o,duration:o-n,steps:[...t]})}return e}},b=new ue,De={name:"behavior",version:"1.0.0",description:"Behavior tracking plugin for tracking user behavior and page views",priority:20,dependencies:["session"],setup(r){if(!r.getPlugin("session")){console.warn("[Node-Trace] behavior plugin requires session plugin to be registered");return}},init(r){b.init()},onTrack(r){b.track(r.event,r.properties||{}),r.event==="page_view"&&b.trackView(r.properties||{});let e=b.getContext();return{...r,properties:{...r.properties,...e}}},state:{behaviors:b},getInfo(){return{name:this.name,version:this.version,description:this.description,behaviorStats:b.getStats(),recentBehaviors:b.getRecent(5)}}};var Ne={name:"error",setup(r){c()&&(window.addEventListener("error",e=>{try{f("js_error",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})}catch(t){}}),window.addEventListener("unhandledrejection",e=>{var t;try{f("promise_error",{reason:String(e.reason),message:((t=e.reason)==null?void 0:t.message)||String(e.reason)})}catch(n){}}))}};function Le(){var r,e;if(c())try{let t=window.performance;if(!t||!t.getEntriesByType)return;let n=t.getEntriesByType("navigation");if(n.length>0){let s=n[0];f("page_performance",{loadTime:s.loadEventEnd-s.fetchStart,ttfb:s.responseStart-s.fetchStart,domContentLoaded:s.domContentLoadedEventEnd-s.fetchStart,redirectTime:s.redirectEnd-s.redirectStart,dnsTime:s.domainLookupEnd-s.domainLookupStart,tcpTime:s.connectEnd-s.connectStart,sslTime:s.secureConnectionStart?s.connectEnd-s.secureConnectionStart:0,firstPaint:((r=t.getEntriesByType("paint").find(a=>a.name==="first-paint"))==null?void 0:r.startTime)||0,firstContentfulPaint:((e=t.getEntriesByType("paint").find(a=>a.name==="first-contentful-paint"))==null?void 0:e.startTime)||0})}let o=t.getEntriesByType("resource");if(o.length>0){let s={total:o.length,scripts:0,stylesheets:0,images:0,fonts:0,other:0,totalLoadTime:0};o.forEach(a=>{let i=a;s.totalLoadTime+=i.duration,i.name.includes(".js")?s.scripts++:i.name.includes(".css")?s.stylesheets++:/(jpg|jpeg|png|gif|webp|svg)$/i.test(i.name)?s.images++:/(woff|woff2|ttf|otf)$/i.test(i.name)?s.fonts++:s.other++}),f("resource_performance",s)}}catch(t){}}var Ae={name:"performance",setup(r){c()&&(document.readyState==="complete"?Le():window.addEventListener("load",Le))}};function U(){if(c())try{let r=D();f("page_view",{...r,url:window.location.href,pathname:window.location.pathname,referrer:document.referrer,title:document.title})}catch(r){}}function gt(){if(!c())return;window.addEventListener("hashchange",U);let r=history.pushState,e=history.replaceState;history.pushState=function(...t){r.apply(this,t),U()},history.replaceState=function(...t){e.apply(this,t),U()},window.addEventListener("popstate",U)}var Me={name:"pageview",dependencies:["session","behavior"],setup(r){if(!c())return;let e=r.getPlugin("session"),t=r.getPlugin("behavior");if(!e){console.warn("[Node-Trace] pageview plugin requires session plugin to be registered");return}if(!t){console.warn("[Node-Trace] pageview plugin requires behavior plugin to be registered");return}U(),gt()}};function F(r){try{let e=m.options;if(!(e!=null&&e.endpoint))return!1;let t=new URL(e.endpoint),n=new URL(r,window.location.origin);return t.protocol===n.protocol&&t.host===n.host&&t.pathname===n.pathname}catch(e){return!1}}function pt(){if(!c()||!window.XMLHttpRequest)return;let r=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,n,o,s,a){let i=this;return i._requestStartTime=Date.now(),i._requestMethod=t,i._requestUrl=n,r.call(this,t,n,o!==!1,s,a)},XMLHttpRequest.prototype.send=function(t){let n=this;return this.addEventListener("load",function(){var o;try{let s=((o=n._requestUrl)==null?void 0:o.toString())||"";if(F(s))return;let a=Date.now()-(n._requestStartTime||Date.now());f("network_request",{method:n._requestMethod||"GET",url:s,status:n.status,statusText:n.statusText,duration:a,type:"xhr",success:n.status>=200&&n.status<300})}catch(s){}}),this.addEventListener("error",function(){var o;try{let s=((o=n._requestUrl)==null?void 0:o.toString())||"";if(F(s))return;let a=Date.now()-(n._requestStartTime||Date.now());f("network_request",{method:n._requestMethod||"GET",url:s,status:0,statusText:"Error",duration:a,type:"xhr",success:!1})}catch(s){}}),this.addEventListener("abort",function(){var o;try{let s=((o=n._requestUrl)==null?void 0:o.toString())||"";if(F(s))return;let a=Date.now()-(n._requestStartTime||Date.now());f("network_request",{method:n._requestMethod||"GET",url:s,status:0,statusText:"Aborted",duration:a,type:"xhr",success:!1})}catch(s){}}),e.call(this,t)}}function ft(){if(!c()||!window.fetch)return;let r=window.fetch;window.fetch=async function(...e){let t=Date.now(),n=e[0],s=(e[1]||{}).method||"GET";if(F(n))return r.apply(this,e);try{let a=await r.apply(this,e),i=Date.now()-t;return f("network_request",{method:s,url:n,status:a.status,statusText:a.statusText,duration:i,type:"fetch",success:a.ok}),a}catch(a){let i=Date.now()-t;throw f("network_request",{method:s,url:n,status:0,statusText:a instanceof Error?a.message:"Error",duration:i,type:"fetch",success:!1}),a}}}var Ue={name:"network",setup(r){c()&&(pt(),ft())}};0&&(module.exports={behaviorPlugin,behaviors,browserPlugin,browserUtils,clearID,clearTimers,errorPlugin,flush,generateStableDeviceIdAsync,getBrowserData,getDeviceId,getID,init,networkPlugin,pageviewPlugin,performancePlugin,plugins,sessionPlugin,sessions,setID,storageUtils,track,use,userPlugin});
//# sourceMappingURL=index.js.map