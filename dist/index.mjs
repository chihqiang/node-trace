var z=(r=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(r,{get:(e,t)=>(typeof require!="undefined"?require:e)[t]}):r)(function(r){if(typeof require!="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});var h={DEFAULT_MAX_QUEUE_SIZE:1e3,DEFAULT_BATCH_SIZE:20,DEFAULT_BATCH_INTERVAL:1e3,MAX_BATCH_SIZE:50,MIN_BATCH_SIZE:5,MAX_BATCH_INTERVAL:3e3,MIN_BATCH_INTERVAL:200,QUEUE_PRESSURE_HIGH:.7,QUEUE_PRESSURE_VERY_HIGH:.9,QUEUE_PRESSURE_LOW:.2,QUEUE_PRESSURE_MEDIUM:.6,NETWORK_CHECK_INTERVAL:5e3,BEACON_SIZE_LIMIT:65536,SMALL_DATA_THRESHOLD:1024,MAX_RETRY_COUNT:5,DEFAULT_TIMEOUT:3e4,QUEUE_CLEANUP_RATIO:.1,MAX_CLEANUP_COUNT:10,OFFLINE_CHECK_INTERVAL:3e4,DEDUPE_CACHE_MAX_SIZE:1e4};var K=class{constructor(e=1e4){this.cache=new Map,this.maxSize=e}has(e){return this.cache.has(e)}set(e,t){if(this.cache.size>=this.maxSize){let n=this.cache.keys().next().value;n!==void 0&&this.cache.delete(n)}this.cache.set(e,t)}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}size(){return this.cache.size}get(e){let t=this.cache.get(e);return t!==void 0&&(this.cache.delete(e),this.cache.set(e,t)),t}};function Y(r){return`${r.id}_${r.event}_${r.timestamp}`}var U=class{constructor(e=1e4){this.cache=new K(e)}exists(e){let t=Y(e);return this.cache.has(t)}add(e){let t=Y(e);this.cache.set(t,!0)}remove(e){let t=Y(e);this.cache.delete(t)}removeBatch(e){e.forEach(t=>this.remove(t))}clear(){this.cache.clear()}size(){return this.cache.size()}};var Ue={RANDOM_STRING_DEFAULT_LENGTH:8,NUMBER_FORMAT_DEFAULT_DECIMALS:2},W={random:(r=Ue.RANDOM_STRING_DEFAULT_LENGTH)=>{let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let n=0;n<r;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},uuid:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){let e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}),generateEventId:()=>{let r=R(),e=new Date(r),t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),s=String(e.getSeconds()).padStart(2,"0"),u=String(e.getMilliseconds()).padStart(3,"0"),p=`${t}${n}${o}${i}${a}${s}${u}`,g=W.random(8);return`${p}${g}`},truncate:(r,e,t="...")=>r.length<=e?r:r.substring(0,e-t.length)+t};var c=()=>typeof window!="undefined",R=()=>Date.now();var j=class{constructor(){this.state={type:"unknown",lastCheckTime:0,effectiveType:"4g",rtt:0,downlink:0},this.checkInterval=h.NETWORK_CHECK_INTERVAL}shouldUpdate(){return R()-this.state.lastCheckTime>=this.checkInterval}update(){if(!(!c()||typeof navigator=="undefined")&&this.shouldUpdate()&&(this.state.lastCheckTime=R(),this.state.type=navigator.onLine?"online":"offline","connection"in navigator)){let e=navigator.connection;this.state.effectiveType=e.effectiveType||"unknown",this.state.rtt=e.rtt||0,this.state.downlink=e.downlink||0,(this.state.effectiveType==="2g"||this.state.rtt>1e3||this.state.downlink<1)&&(this.state.type="slow")}}getState(){return this.update(),{...this.state}}getType(){return this.update(),this.state.type}isOnline(){return this.update(),this.state.type==="online"}isOffline(){return this.update(),this.state.type==="offline"}isSlow(){return this.update(),this.state.type==="slow"}},ge=new j;var Z=class{constructor(){this.strategyHistory=new Map;this.HISTORY_SIZE=10}select(e,t){let n=ge.getType();return n==="offline"?"beacon":n==="slow"?this.selectBasedOnHistory(t,["fetch","beacon"]):t>h.BEACON_SIZE_LIMIT?this.selectBasedOnHistory(t,["fetch","xhr"]):t<h.SMALL_DATA_THRESHOLD?this.selectBasedOnHistory(t,["beacon","fetch"]):this.selectBasedOnHistory(t,["fetch","beacon","xhr"])}selectBasedOnHistory(e,t){let n=t[0],o=0;for(let i of t){let a=this.strategyHistory.get(i);if(a&&a.total>0){let s=a.success/a.total;s>o&&(o=s,n=i)}}return n}recordResult(e,t){let n=this.strategyHistory.get(e)||{success:0,total:0};n.total++,t&&n.success++,this.strategyHistory.set(e,n),n.total>this.HISTORY_SIZE&&(n.success=Math.floor(n.success*.8),n.total=Math.floor(n.total*.8))}getSuccessRate(e){let t=this.strategyHistory.get(e);return!t||t.total===0?1:t.success/t.total}resetHistory(){this.strategyHistory.clear()}};async function He(r,e,t){if(!c()||typeof navigator.sendBeacon=="undefined")return!1;try{let n=navigator.sendBeacon(r,e);return t&&console.log("[Node-Trace] Sent with beacon:",n),n}catch(n){return t&&console.log("[Node-Trace] Beacon failed:",n),!1}}async function me(r,e,t,n,o){if(!c()||typeof fetch=="undefined")return!1;try{let i=await fetch(r,{method:"POST",body:e,headers:{"Content-Type":"application/json",...t},keepalive:!0,signal:n?AbortSignal.timeout(n):void 0});return o&&console.log("[Node-Trace] Sent with fetch:",i.ok),i.ok}catch(i){return o&&console.log("[Node-Trace] Fetch failed:",i),!1}}async function Oe(r,e,t,n){return!c()||typeof XMLHttpRequest=="undefined"?!1:new Promise(o=>{let i=new XMLHttpRequest,a=JSON.stringify(e);i.open("POST",r,!0),i.setRequestHeader("Content-Type","application/json"),t>0&&(i.timeout=t),i.onload=function(){let s=i.status>=200&&i.status<300;n&&console.log("[Node-Trace] Sent with XHR:",s),o(s)},i.onerror=function(){n&&console.log("[Node-Trace] XHR failed"),o(!1)},i.ontimeout=function(){n&&console.log("[Node-Trace] XHR timeout"),o(!1)},i.send(a)})}var G=class{constructor(){this.strategySelector=new Z}async send(e){if(!c())return{success:!1,strategy:"fetch",time:0};let t=Date.now(),{endpoint:n,data:o,timeout:i=h.DEFAULT_TIMEOUT,headers:a={},debug:s}=e,u=JSON.stringify(o),p=u.length,g=this.strategySelector.select(u,p),l=!1,d=g;g==="beacon"&&(l=await He(n,u,s),l||(l=await me(n,u,a,i,s),d="fetch")),(g==="fetch"||!l)&&(l=await me(n,u,a,i,s),d="fetch",l||(l=await Oe(n,o,i,s),d="xhr"));let E=Date.now()-t;return this.strategySelector.recordResult(d,l),{success:l,strategy:d,time:E}}},ve=new G;var M=class{constructor(e){this.errors=[];this.stats={total:0,byType:{},byLevel:{},byCode:{},lastError:0,rate:{lastMinute:0,lastHour:0},consecutiveErrors:0,maxConsecutiveErrors:0};this.errorTimestamps=[];this.config={capture:!0,logLevel:"warn",maxErrors:100,...e},this.initStats()}initStats(){["network","network:timeout","network:offline","network:server","network:client","storage","storage:quota","storage:access","browser","plugin","plugin:init","plugin:execute","queue","queue:full","queue:overflow","device","session","session:timeout","behavior","data","data:validation","data:serialization","config","init","runtime","unknown"].forEach(n=>{this.stats.byType[n]=0}),["debug","info","warn","error","fatal"].forEach(n=>{this.stats.byLevel[n]=0})}generateErrorId(){return"error_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}parseStack(e){let t=e.split(`
`);for(let n of t){let o=n.match(/at \s*(?:\w+\s+)?\(?([^:]+):(\d+):(\d+)\)?/);if(o)return{file:o[1],line:parseInt(o[2])}}return{}}updateStats(e){this.stats.total++,this.stats.byType[e.type]=(this.stats.byType[e.type]||0)+1,this.stats.byLevel[e.level]=(this.stats.byLevel[e.level]||0)+1,e.code&&(this.stats.byCode[e.code]=(this.stats.byCode[e.code]||0)+1),this.stats.lastError=e.timestamp,this.errorTimestamps.push(e.timestamp);let t=Date.now()-3600*1e3;this.errorTimestamps=this.errorTimestamps.filter(i=>i>t);let n=Date.now()-60*1e3;this.stats.rate.lastMinute=this.errorTimestamps.filter(i=>i>n).length,this.stats.rate.lastHour=this.errorTimestamps.length,e.timestamp-this.stats.lastError<5e3?(this.stats.consecutiveErrors++,this.stats.consecutiveErrors>this.stats.maxConsecutiveErrors&&(this.stats.maxConsecutiveErrors=this.stats.consecutiveErrors)):this.stats.consecutiveErrors=1}captureError(e,t,n,o,i="error",a,s){let u=n,p=n;if(!this.config.capture)return{type:e,level:i,message:t,code:a,stack:u==null?void 0:u.stack,context:o,timestamp:Date.now(),id:this.generateErrorId()};let g,l;if(u!=null&&u.stack){let E=this.parseStack(u.stack);g=E.file,l=E.line}let d={type:e,level:i,message:t,code:a,stack:u==null?void 0:u.stack,context:o,details:p==null?void 0:p.details,source:s||"unknown",file:g,line:l,timestamp:Date.now(),id:this.generateErrorId(),event:o==null?void 0:o.event,userId:o==null?void 0:o.userId,deviceId:o==null?void 0:o.deviceId};return this.errors.push(d),this.errors.length>this.config.maxErrors&&this.errors.shift(),this.updateStats(d),this.logError(d),this.checkErrorRate(d),d}checkErrorRate(e){this.stats.rate.lastMinute>10&&typeof console!="undefined"&&console.warn("[Node-Trace] High error rate detected:",{errorsPerMinute:this.stats.rate.lastMinute,consecutiveErrors:this.stats.consecutiveErrors,maxConsecutiveErrors:this.stats.maxConsecutiveErrors}),this.stats.consecutiveErrors>5&&typeof console!="undefined"&&console.error("[Node-Trace] Critical error sequence detected:",{consecutiveErrors:this.stats.consecutiveErrors,lastError:e,recentErrors:this.errors.slice(-3)})}logError(e){var o;let t=((o=m.options)==null?void 0:o.debug)||!1,n=this.shouldLog(e.level);if(t&&n){let i=`[Node-Trace] [${e.type.toUpperCase()}]${e.code?` [${e.code}]`:""}`,a=e.context?` Context: ${JSON.stringify(e.context)}`:"",s=e.details?` Details: ${JSON.stringify(e.details)}`:"",u=e.stack?`
Stack: ${e.stack}`:"",p=` ErrorID: ${e.id}`;switch(e.level){case"debug":console.debug(`${i} ${e.message}${p}${a}${s}${u}`);break;case"info":console.info(`${i} ${e.message}${p}${a}${s}${u}`);break;case"warn":console.warn(`${i} ${e.message}${p}${a}${s}${u}`);break;case"error":console.error(`${i} ${e.message}${p}${a}${s}${u}`);break;case"fatal":console.error(`${i} [FATAL] ${e.message}${p}${a}${s}${u}`);break}}}getStats(){return{...this.stats}}getRecentErrors(e=10){return this.errors.slice(-e)}hasErrors(){return this.errors.length>0}getErrorSummary(){if(this.errors.length===0)return{total:0,lastError:null,mostFrequentType:null,mostFrequentLevel:null,rate:{lastMinute:0,lastHour:0}};let e=null,t=0;Object.entries(this.stats.byType).forEach(([i,a])=>{a>t&&(t=a,e=i)});let n=null,o=0;return Object.entries(this.stats.byLevel).forEach(([i,a])=>{a>o&&(o=a,n=i)}),{total:this.stats.total,lastError:this.errors[this.errors.length-1],mostFrequentType:e,mostFrequentLevel:n,rate:{lastMinute:this.stats.rate.lastMinute,lastHour:this.stats.rate.lastHour}}}shouldLog(e){let t=["debug","info","warn","error","fatal"],n=t.indexOf(this.config.logLevel);return t.indexOf(e)>=n}getErrors(){return[...this.errors]}clearErrors(){this.errors=[]}handleNetworkError(e,t){this.captureError("network","Network error occurred",e,t)}handleStorageError(e,t){this.captureError("storage","Storage error occurred",e,t,"warn")}handleBrowserError(e,t){this.captureError("browser","Browser API error occurred",e,t,"warn")}handlePluginError(e,t){this.captureError("plugin","Plugin error occurred",e,t)}handleQueueError(e,t){this.captureError("queue","Queue error occurred",e,t)}handleDeviceError(e,t){this.captureError("device","Device ID error occurred",e,t,"warn")}handleSessionError(e,t){this.captureError("session","Session error occurred",e,t,"warn")}handleBehaviorError(e,t){this.captureError("behavior","Behavior error occurred",e,t,"warn")}handleDataError(e,t){this.captureError("data","Data processing error occurred",e,t)}handleUnknownError(e,t){this.captureError("unknown","Unknown error occurred",e,t)}};function Pt(){let r=["network","network:timeout","network:offline","network:server","network:client","storage","storage:quota","storage:access","browser","plugin","plugin:init","plugin:execute","queue","queue:full","queue:overflow","device","session","session:timeout","behavior","data","data:validation","data:serialization","config","init","runtime","unknown"],e=["debug","info","warn","error","fatal"],t={};r.forEach(o=>{t[o]=0});let n={};return e.forEach(o=>{n[o]=0}),{total:0,byType:t,byLevel:n,byCode:{},lastError:0,rate:{lastMinute:0,lastHour:0},consecutiveErrors:0,maxConsecutiveErrors:0}}function It(r){let e=Date.now(),t=e-60*1e3,n=e-3600*1e3;return{lastMinute:r.filter(o=>o>t).length,lastHour:r.filter(o=>o>n).length}}function kt(r,e){if(r.length===0)return{total:0,lastError:null,mostFrequentType:null,mostFrequentLevel:null,rate:{lastMinute:0,lastHour:0}};let t=null,n=0;Object.entries(e.byType).forEach(([a,s])=>{s>n&&(n=s,t=a)});let o=null,i=0;return Object.entries(e.byLevel).forEach(([a,s])=>{s>i&&(i=s,o=a)}),{total:e.total,lastError:r[r.length-1],mostFrequentType:t,mostFrequentLevel:o,rate:e.rate}}function xt(r,e){return r.filter(t=>t>e)}var y=new M;function Dt(r,e,t,n,o="error"){y.captureError(r,e,t,n,o)}function J(r,e){y.handleNetworkError(r,e)}function H(r,e){y.handleStorageError(r,e)}function O(r,e){y.handleBrowserError(r,e)}function _(r,e){y.handlePluginError(r,e)}function Nt(r,e){y.handleQueueError(r,e)}function Lt(r,e){y.handleDeviceError(r,e)}function q(r,e){y.handleSessionError(r,e)}function C(r,e){y.handleBehaviorError(r,e)}function Mt(r,e){y.handleDataError(r,e)}function At(r,e){y.handleUnknownError(r,e)}import qe from"dexie";var ee=class extends qe{constructor(){super("nodeTraceDb"),this.version(1).stores({offlineEvents:"id, event, timestamp"})}},F=new ee,te=class{constructor(){this.writeBuffer=[];this.writeTimer=null;this.WRITE_BUFFER_SIZE=100;this.WRITE_BUFFER_TIMEOUT=5e3}async all(){try{return await F.offlineEvents.toArray()}catch(e){return[]}}async add(e){this.writeBuffer.push(...e),this.writeBuffer.length>=this.WRITE_BUFFER_SIZE?await this.flushBuffer():this.scheduleFlush()}async clear(){try{await F.offlineEvents.clear()}catch(e){}}async delete(e){try{e.length>0&&await F.offlineEvents.bulkDelete(e)}catch(t){}}async flushBuffer(){if(this.writeBuffer.length===0)return;let e=this.writeBuffer.splice(0);try{await F.offlineEvents.bulkAdd(e)}catch(t){}}scheduleFlush(){this.writeTimer||(this.writeTimer=setTimeout(()=>{this.flushBuffer(),this.writeTimer=null},this.WRITE_BUFFER_TIMEOUT))}async forceFlush(){this.writeTimer&&(clearTimeout(this.writeTimer),this.writeTimer=null),await this.flushBuffer()}},P=new te;var $=class{constructor(){this.high=[];this.normal=[];this.low=[]}push(e,t="normal"){let n={...e,priority:t};this[t].push(n)}pop(){return this.high.length>0?this.high.shift():this.normal.length>0?this.normal.shift():this.low.shift()}peek(){return this.high.length>0?this.high[0]:this.normal.length>0?this.normal[0]:this.low[0]}size(){return this.high.length+this.normal.length+this.low.length}isEmpty(){return this.size()===0}clear(){this.high=[],this.normal=[],this.low=[]}getBatch(e){let t=[];for(;t.length<e&&!this.isEmpty();){let n=this.pop();n&&t.push(n)}return t}getStats(){return{high:this.high.length,normal:this.normal.length,low:this.low.length,total:this.size()}}};function we(r){let e=["js_error","promise_error","session_start","session_end"],t=["scroll","page_view","performance"];return e.includes(r)?"high":t.includes(r)?"low":"normal"}var re=class{constructor(){this.queue=[],this.priorityQueue=new $,this.dedupe=new U(h.DEDUPE_CACHE_MAX_SIZE),this.stats={totalEvents:0,sendSuccessCount:0,sendFailCount:0,averageSendTime:0,lastSendTime:0},this.config=null,this.timer=null,this.retryTimers=[],this.offlineCheckTimer=null,this.cachedPressure=null,this.pressureCacheTime=0,this.PRESSURE_CACHE_TTL=1e3}init(e){this.config=e,this.startOfflineCheck()}calculatePressure(){if(!this.config)return 0;let e=Date.now();if(this.cachedPressure!==null&&e-this.pressureCacheTime<this.PRESSURE_CACHE_TTL)return this.cachedPressure;let t=this.queue.length/this.config.maxQueueSize;return this.cachedPressure=t,this.pressureCacheTime=e,t}getDynamicBatchSize(){if(!this.config)return h.DEFAULT_BATCH_SIZE;let e=this.calculatePressure(),t=this.config.batchSize;return e>h.QUEUE_PRESSURE_MEDIUM?t=Math.max(Math.floor(t*.8),h.MIN_BATCH_SIZE):e<h.QUEUE_PRESSURE_LOW&&(t=Math.min(Math.ceil(t*1.2),h.MAX_BATCH_SIZE)),Math.min(t,this.queue.length)}getDynamicInterval(){if(!this.config)return h.DEFAULT_BATCH_INTERVAL;let e=this.calculatePressure(),t=this.config.batchInterval;return e>h.QUEUE_PRESSURE_MEDIUM?t=Math.max(t*.5,h.MIN_BATCH_INTERVAL):e<h.QUEUE_PRESSURE_LOW&&(t=Math.min(t*1.5,h.MAX_BATCH_INTERVAL)),t}handleQueueFull(){if(!this.config)return;let e=this.calculatePressure(),t=1;e>h.QUEUE_PRESSURE_VERY_HIGH?t=Math.min(Math.ceil(this.queue.length*h.QUEUE_CLEANUP_RATIO),h.MAX_CLEANUP_COUNT):e>h.QUEUE_PRESSURE_HIGH&&(t=Math.min(Math.ceil(this.queue.length*.05),5));let n=this.queue.splice(0,t);this.dedupe.removeBatch(n),this.config.debug&&console.log("[Node-Trace] Queue full, removed events:",t)}push(e){var o;if(this.dedupe.exists(e)){(o=this.config)!=null&&o.debug&&console.log("[Node-Trace] Event already exists, skipping:",e.event);return}if(!this.config){this.queue.push(e),this.dedupe.add(e);return}this.queue.length>=this.config.maxQueueSize&&this.handleQueueFull(),this.queue.push(e),this.dedupe.add(e),this.stats.totalEvents++;let t=we(e.event);this.priorityQueue.push(e,t),this.config.debug&&(console.log("[Node-Trace] Event pushed:",e.event,"priority:",t),console.log("[Node-Trace] Queue length:",this.queue.length)),this.cachedPressure=null,this.calculatePressure()>h.QUEUE_PRESSURE_HIGH?this.flush():this.schedule()}schedule(){if(this.timer)return;let e=this.getDynamicInterval();this.timer=setTimeout(()=>{this.flush()},e)}updateStats(e,t){this.stats.lastSendTime=Date.now(),t?this.stats.sendSuccessCount++:this.stats.sendFailCount++;let n=this.stats.sendSuccessCount+this.stats.sendFailCount;n>0&&(this.stats.averageSendTime=(this.stats.averageSendTime*(n-1)+e)/n)}async handleSendFailure(e){if(this.config){if(this.config.debug&&console.log("[Node-Trace] Send failed, batch size:",e.length),this.config.offlineEnabled&&c())try{await P.add(e),this.config.debug&&console.log("[Node-Trace] Events cached offline:",e.length)}catch(t){J(t,{eventCount:e.length})}else if(this.config.retryCount>0){let n=this.config.retryInterval*Math.pow(2,this.stats.sendFailCount%h.MAX_RETRY_COUNT),o=setTimeout(()=>{var i;this.queue.unshift(...e),e.forEach(a=>this.dedupe.add(a)),(i=this.config)!=null&&i.debug&&console.log("[Node-Trace] Retrying events:",e.length),this.schedule()},n);this.retryTimers.push(o)}}}async handleSendSuccess(e){var t;(t=this.config)!=null&&t.debug&&console.log("[Node-Trace] Events sent successfully:",e.length),c()&&(await P.forceFlush(),await P.clear())}applyBeforeSendHooks(e){let t=I.sort(),n=e;for(let o of t)if(o.beforeSend)try{n=o.beforeSend(n)}catch(i){_(i,{plugin:o.name,context:"beforeSend"})}return n}applyAfterSendHooks(e,t){let n=I.getAll();for(let o of n)if(o.afterSend)try{o.afterSend(e,t)}catch(i){_(i,{plugin:o.name,context:"afterSend"})}}async flush(){if(!this.config||this.queue.length===0)return;let e=this.getDynamicBatchSize(),t=this.priorityQueue.getBatch(e),n=new Set(t.map(s=>s.id)),o=this.queue.filter(s=>n.has(s.id));this.queue=this.queue.filter(s=>!n.has(s.id)),this.dedupe.removeBatch(o);let i=this.applyBeforeSendHooks(o),a=await ve.send({endpoint:this.config.endpoint,data:{appId:this.config.appId,appKey:this.config.appKey,events:i},timeout:this.config.timeout,headers:this.config.headers,debug:this.config.debug});this.updateStats(a.time,a.success),this.applyAfterSendHooks(i,a.success),a.success?await this.handleSendSuccess(i):await this.handleSendFailure(i),this.timer=null}startOfflineCheck(){var e;!c()||this.offlineCheckTimer||(e=this.config)!=null&&e.offlineEnabled&&(this.offlineCheckTimer=setInterval(async()=>{await this.restoreOfflineEvents()},h.OFFLINE_CHECK_INTERVAL))}async restoreOfflineEvents(){var e,t;if(c())try{let n=await P.all();if(n.length===0)return;let o=new Set;this.queue.forEach(a=>{let s=`${a.id}_${a.event}_${a.timestamp}`;o.add(s)});let i=n.filter(a=>{let s=`${a.id}_${a.event}_${a.timestamp}`;return!o.has(s)});if(i.length>0){let a=i.map(s=>s.id);a.length>0&&await P.delete(a),this.queue.unshift(...i),i.forEach(s=>this.dedupe.add(s)),(e=this.config)!=null&&e.debug&&console.log("[Node-Trace] Restored offline events:",i.length),this.schedule()}else await P.clear(),(t=this.config)!=null&&t.debug&&console.log("[Node-Trace] All offline events are duplicates, cleared")}catch(n){J(n,{eventCount:0})}}clearTimers(){this.timer&&(clearTimeout(this.timer),this.timer=null),this.retryTimers.forEach(e=>clearTimeout(e)),this.retryTimers=[],this.offlineCheckTimer&&(clearInterval(this.offlineCheckTimer),this.offlineCheckTimer=null)}getStats(){return{...this.stats}}length(){return this.queue.length}clear(){this.queue=[],this.priorityQueue.clear(),this.dedupe.clear()}},D=new re;function ye(r){D.push(r)}async function Fe(){await D.flush()}function $e(){D.clearTimers()}var Ve={appKey:"",debug:!1,sampleRate:1,blacklist:[],whitelist:void 0,batchSize:20,batchInterval:1e3,offlineEnabled:!1,maxQueueSize:1e3,retryCount:3,retryInterval:1e3,headers:{},timeout:3e4,beforeSend:void 0},m={options:null,queue:[],plugins:[],sortedPluginsCache:null},ne=class{constructor(){this.plugins=new Map}createPluginContext(){return{getPlugins:()=>Object.fromEntries(this.plugins),getPlugin:e=>this.plugins.get(e)||null,getAllPlugins:()=>this.getAll(),callPluginMethod:(e,t,...n)=>{let o=this.plugins.get(e);if(o&&typeof o[t]=="function"){let i=o[t];return i(...n)}return null}}}register(e){try{if(this.plugins.has(e.name))return console.warn(`[Node-Trace] Plugin ${e.name} already registered`),!1;if(e.dependencies&&e.dependencies.length>0){for(let t of e.dependencies)if(!this.plugins.has(t))return console.warn(`[Node-Trace] Plugin ${e.name} depends on ${t}, which is not registered`),!1}if(e.conflicts&&e.conflicts.length>0){for(let t of e.conflicts)if(this.plugins.has(t))return console.warn(`[Node-Trace] Plugin ${e.name} conflicts with ${t}`),!1}return e.lifecycle="idle",e.enabled=!0,e.priority=e.priority||0,this.plugins.set(e.name,e),m.sortedPluginsCache=null,!0}catch(t){return _(t,{plugin:e.name}),!1}}init(e){try{e.lifecycle="loading";let t=this.createPluginContext();return e.beforeInit&&e.beforeInit(t),e.setup&&e.setup(t),e.init&&e.init(t),e.activate&&e.activate(t),e.afterInit&&e.afterInit(t),e.lifecycle="active",!0}catch(t){return _(t,{plugin:e.name}),e.lifecycle="error",!1}}destroy(e){try{let t=this.createPluginContext();return e.beforeDestroy&&e.beforeDestroy(t),e.deactivate&&e.deactivate(t),e.destroy&&e.destroy(t),e.afterDestroy&&e.afterDestroy(t),e.lifecycle="destroyed",!0}catch(t){return _(t,{plugin:e.name}),!1}}get(e){return this.plugins.get(e)}getAll(){return Array.from(this.plugins.values())}getEnabled(){return Array.from(this.plugins.values()).filter(e=>e.enabled)}enable(e){let t=this.plugins.get(e);return t?(t.enabled=!0,m.sortedPluginsCache=null,!0):!1}disable(e){let t=this.plugins.get(e);return t?(t.enabled=!1,m.sortedPluginsCache=null,!0):!1}remove(e){let t=this.plugins.get(e);if(!t)return!1;this.destroy(t);let n=this.plugins.delete(e);return m.sortedPluginsCache=null,n}clear(){for(let e of this.plugins.values())this.destroy(e);this.plugins.clear(),m.sortedPluginsCache=null}sort(){return Array.from(this.plugins.values()).filter(e=>e.enabled).sort((e,t)=>(e.priority||0)-(t.priority||0))}},I=new ne;function Qe(r){m.options={...Ve,...r},D.init({maxQueueSize:r.maxQueueSize||1e3,batchSize:r.batchSize||20,batchInterval:r.batchInterval||1e3,retryCount:r.retryCount||3,retryInterval:r.retryInterval||1e3,offlineEnabled:r.offlineEnabled||!1,debug:r.debug||!1,endpoint:r.endpoint,appId:r.appId,appKey:r.appKey,headers:r.headers,timeout:r.timeout})}function Xe(r){if(!I.register(r)){console.warn(`[Node-Trace] Failed to register plugin ${r.name}`);return}I.init(r),m.plugins.push(r)}function ze(r){var t;let e=m.options;return e?!(e.sampleRate&&Math.random()>e.sampleRate||(t=e.blacklist)!=null&&t.includes(r)||e.whitelist&&!e.whitelist.includes(r)):!0}function v(r,e){var u,p,g;if(!ze(r))return;let n={id:W.generateEventId(),event:r,properties:e,timestamp:R()},o=m.sortedPluginsCache;o||(o=I.sort(),m.sortedPluginsCache=o);let i=[];for(let l of o){if(l.onTrack)try{let d=l.onTrack(n);if(d===null)return;n=d}catch(d){_(d,{plugin:l.name,event:r})}l.onTracked&&i.push(l)}let a=(p=(u=m.options)==null?void 0:u.beforeSend)==null?void 0:p.call(u,n);if(a===null)return;let s=a||n;ye(s);for(let l of i)try{(g=l.onTracked)==null||g.call(l,s)}catch(d){_(d,{plugin:l.name,event:r})}}function oe(r){var a,s,u,p,g,l,d;let e="unknown",t="0",n="0",o="Unknown",i="0";return/Chrome/.test(r)?(e="Chrome",t=((a=r.match(/Chrome\/(\d+)/))==null?void 0:a[1])||"0",n=t,o="Blink"):/Firefox/.test(r)?(e="Firefox",t=((s=r.match(/Firefox\/(\d+)/))==null?void 0:s[1])||"0",n=t,o="Gecko"):/Safari/.test(r)&&!/Chrome/.test(r)?(e="Safari",t=((u=r.match(/Version\/(\d+)/))==null?void 0:u[1])||"0",n=t,o="WebKit"):/Edge/.test(r)?(e="Edge",t=((p=r.match(/Edge\/(\d+)/))==null?void 0:p[1])||"0",n=t,o="Blink"):/MSIE|Trident/.test(r)&&(e="Internet Explorer",t=((g=r.match(/MSIE\s(\d+)|rv:(\d+)/))==null?void 0:g[1])||"0",n=t,o="Trident"),o==="WebKit"?i=((l=r.match(/WebKit\/(\d+)/))==null?void 0:l[1])||"0":o==="Gecko"&&(i=((d=r.match(/Gecko\/(\d+)/))==null?void 0:d[1])||"0"),{name:e,version:t,major:n,engine:o,engineVersion:i}}function ie(r){let e=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/.test(r)&&!/iPad/.test(r),t=/iPad/.test(r)||/Android/.test(r)&&!/Mobile/.test(r),n=!e&&!t,o="unknown";return e?o="mobile":t?o="tablet":n&&(o="desktop"),{isMobile:e,isTablet:t,isDesktop:n,type:o}}function Ye(r){let e=oe(r);return{name:e.name,major:e.major,engine:e.engine,engineVersion:e.engineVersion}}function Ke(r){let e=ie(r);return{isMobile:e.isMobile,isTablet:e.isTablet,isDesktop:e.isDesktop}}function Ee(){return!c()||typeof navigator=="undefined"?{app_code_name:"",app_name:"",language:"",platform:"",browser_version:"",user_agent:"non-browser"}:{app_code_name:navigator.appCodeName,app_name:navigator.appName,language:navigator.language,platform:navigator.platform,browser_version:navigator.appVersion,user_agent:navigator.userAgent}}function _e(r){let e=Ye(r);return{browser_name:e.name,browser_major_version:e.major,engine_name:e.engine,engine_version:e.engineVersion}}function Te(r){if(!c()||typeof window=="undefined")return{is_mobile:!1,is_tablet:!1,is_desktop:!0,device_width:0,device_height:0,device_pixel_ratio:1};let e=Ke(r);return{is_mobile:e.isMobile,is_tablet:e.isTablet,is_desktop:e.isDesktop,device_width:window.innerWidth,device_height:window.innerHeight,device_pixel_ratio:window.devicePixelRatio}}function be(){var r,e,t,n;return!c()||typeof navigator=="undefined"?{is_online:!0,connection_type:"unknown",downlink:void 0,effective_type:void 0,rtt:void 0}:{is_online:navigator.onLine,connection_type:((r=navigator.connection)==null?void 0:r.type)||"unknown",downlink:(e=navigator.connection)==null?void 0:e.downlink,effective_type:(t=navigator.connection)==null?void 0:t.effectiveType,rtt:(n=navigator.connection)==null?void 0:n.rtt}}var Se={getNetworkState:()=>{if(!c()||typeof navigator=="undefined")return{type:"offline",effectiveType:"unknown",rtt:0,downlink:0};let r=navigator.onLine?"online":"offline",e="unknown",t=0,n=0;if("connection"in navigator){let o=navigator.connection;e=(o==null?void 0:o.effectiveType)||"unknown",t=(o==null?void 0:o.rtt)||0,n=(o==null?void 0:o.downlink)||0}return{type:r,effectiveType:e,rtt:t,downlink:n}}};function Pe(){return!c()||typeof window=="undefined"||typeof document=="undefined"?{current_url:"",pathname:"",hostname:"",protocol:"",port:"",search:"",hash:"",document_url:"",referrer_url:"",content_type:"",document_title:"",document_charset:"",document_ready_state:"loading"}:{current_url:window.location.href,pathname:window.location.pathname,hostname:window.location.hostname,protocol:window.location.protocol,port:window.location.port,search:window.location.search,hash:window.location.hash,document_url:document.URL,referrer_url:document.referrer,content_type:document.contentType||"",document_title:document.title,document_charset:document.characterSet||document.charset||"",document_ready_state:document.readyState}}function Ie(){return!c()||typeof window=="undefined"||typeof document=="undefined"?{scroll_x:0,scroll_y:0}:{scroll_x:window.pageXOffset||document.documentElement.scrollLeft||0,scroll_y:window.pageYOffset||document.documentElement.scrollTop||0}}function ke(){return!c()||typeof screen=="undefined"?{screen_width:0,screen_height:0,screen_available_width:0,screen_available_height:0,screen_color_depth:0}:{screen_width:screen.width,screen_height:screen.height,screen_available_width:screen.availWidth,screen_available_height:screen.availHeight,screen_color_depth:screen.colorDepth}}var f={get:(r,e)=>{if(!c()||typeof localStorage=="undefined")return null;try{let t=localStorage.getItem(r);return t===null?null:e?e(t):t}catch(t){return null}},set:(r,e)=>{if(!c()||typeof localStorage=="undefined")return!1;try{let t=typeof e=="string"?e:JSON.stringify(e);return localStorage.setItem(r,t),!0}catch(t){return!1}},remove:r=>{if(!c()||typeof localStorage=="undefined")return!1;try{return localStorage.removeItem(r),!0}catch(e){return!1}},clear:()=>{if(!c()||typeof localStorage=="undefined")return!1;try{return localStorage.clear(),!0}catch(r){return!1}}};var We={getBrowser:()=>{if(!c()||typeof navigator=="undefined")return{name:"unknown",version:"0",platform:"unknown"};let r=oe(navigator.userAgent);return{name:r.name,version:r.version,platform:navigator.platform}},getDeviceType:()=>!c()||typeof navigator=="undefined"?"unknown":ie(navigator.userAgent).type,getNetworkState:Se.getNetworkState};function V(){var r,e,t,n,o,i,a,s,u,p,g,l,d;if(!c())return{device_id:T(),event:"pageview",user_agent:"non-browser",device_width:0,device_height:0,is_online:!0,connection_type:"unknown",app_code_name:"",app_name:"",language:"",platform:"",time_zone:Intl.DateTimeFormat().resolvedOptions().timeZone,browser_version:"",browser_name:"non-browser",browser_major_version:"0",engine_name:"unknown",engine_version:"0",device_pixel_ratio:1,is_mobile:!1,is_tablet:!1,is_desktop:!0,current_url:"",pathname:"",hostname:"",protocol:"",port:"",search:"",hash:"",document_url:"",referrer_url:"",content_type:"",document_title:"",document_charset:"",document_ready_state:"loading",screen_width:0,screen_height:0,screen_available_width:0,screen_available_height:0,screen_color_depth:0,scroll_x:0,scroll_y:0,begin_time:Date.now()};try{let E=Ee(),De=_e(E.user_agent),Ne=Te(E.user_agent),Le=be(),Me=ke(),Ae=Pe(),Be=Ie();return{device_id:T(),event:"pageview",...E,...Ne,...Le,...De,...Me,...Ae,...Be,time_zone:Intl.DateTimeFormat().resolvedOptions().timeZone,begin_time:Date.now()}}catch(E){return{device_id:T(),event:"pageview",user_agent:(navigator==null?void 0:navigator.userAgent)||"unknown",device_width:(window==null?void 0:window.innerWidth)||0,device_height:(window==null?void 0:window.innerHeight)||0,is_online:(navigator==null?void 0:navigator.onLine)||!1,connection_type:((r=navigator==null?void 0:navigator.connection)==null?void 0:r.type)||"unknown",downlink:(e=navigator==null?void 0:navigator.connection)==null?void 0:e.downlink,effective_type:(t=navigator==null?void 0:navigator.connection)==null?void 0:t.effectiveType,rtt:(n=navigator==null?void 0:navigator.connection)==null?void 0:n.rtt,app_code_name:(navigator==null?void 0:navigator.appCodeName)||"",app_name:(navigator==null?void 0:navigator.appName)||"",language:(navigator==null?void 0:navigator.language)||"",platform:(navigator==null?void 0:navigator.platform)||"",time_zone:Intl.DateTimeFormat().resolvedOptions().timeZone,browser_version:navigator==null?void 0:navigator.appVersion,device_pixel_ratio:(window==null?void 0:window.devicePixelRatio)||1,is_mobile:!1,is_tablet:!1,is_desktop:!0,current_url:((o=window==null?void 0:window.location)==null?void 0:o.href)||"",pathname:((i=window==null?void 0:window.location)==null?void 0:i.pathname)||"",hostname:((a=window==null?void 0:window.location)==null?void 0:a.hostname)||"",protocol:((s=window==null?void 0:window.location)==null?void 0:s.protocol)||"",port:((u=window==null?void 0:window.location)==null?void 0:u.port)||"",search:((p=window==null?void 0:window.location)==null?void 0:p.search)||"",hash:((g=window==null?void 0:window.location)==null?void 0:g.hash)||"",document_url:(document==null?void 0:document.URL)||"",referrer_url:(document==null?void 0:document.referrer)||"",content_type:(document==null?void 0:document.contentType)||"",document_title:(document==null?void 0:document.title)||"",document_charset:(document==null?void 0:document.characterSet)||(document==null?void 0:document.charset)||"",document_ready_state:document==null?void 0:document.readyState,screen_width:(screen==null?void 0:screen.width)||0,screen_height:(screen==null?void 0:screen.height)||0,screen_available_width:(screen==null?void 0:screen.availWidth)||0,screen_available_height:(screen==null?void 0:screen.availHeight)||0,screen_color_depth:(screen==null?void 0:screen.colorDepth)||0,scroll_x:(window==null?void 0:window.pageXOffset)||((l=document==null?void 0:document.documentElement)==null?void 0:l.scrollLeft)||0,scroll_y:(window==null?void 0:window.pageYOffset)||((d=document==null?void 0:document.documentElement)==null?void 0:d.scrollTop)||0,begin_time:Date.now()}}}var je={name:"browser",version:"1.0.0",description:"Browser data collection plugin",priority:20,onTrack(r){let e=V();return{...r,...e}},getInfo(){return{name:this.name,version:this.version,description:this.description}}};var se="__analytics_device_id__",A="__analytics_user_id__",ae=null,k=null,Q=32;async function Ze(r){if(c()&&typeof crypto!="undefined"&&crypto.subtle){let t=new TextEncoder().encode(r),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(i=>i.toString(16).padStart(2,"0")).join("")}else if(!c()&&typeof z!="undefined")try{return z("crypto").createHash("sha256").update(r).digest("hex")}catch(e){return ce(r)}else return ce(r)}function ce(r){let n=2166136261;for(let s=0;s<r.length;s++)n^=r.charCodeAt(s),n=Math.imul(n,16777619);let o=(n>>>0).toString(36);if(o.length>=Q)return o.substring(0,Q);let i=Math.random().toString(36).slice(2,10);return`${o}${i}`.substring(0,Q)}function Re(){if(!c())return"non-browser";try{let r=navigator,e={userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,hardwareConcurrency:navigator.hardwareConcurrency||0,deviceMemory:r.deviceMemory||0,screen:{width:screen.width,height:screen.height,colorDepth:screen.colorDepth},vendor:navigator.vendor,appVersion:navigator.appVersion,product:navigator.product,productSub:navigator.productSub};return JSON.stringify(e)}catch(r){return O(r,{context:"fingerprint_collection"}),"fallback-fingerprint"}}function ue(){if(!c()){if(!ae){let r=Date.now().toString(36),e=Math.random().toString(36).slice(2,10);ae=`${r}_${e}`}return ae}if(k)return k;try{let r=Re(),e=ce(r);return k=e,e}catch(r){O(r,{context:"device_id_generation"});let e=Date.now().toString(36),t=Math.random().toString(36).slice(2,10),n=`${e}_${t}`;return k=n,n}}async function Ge(){if(!c())return ue();if(k)return k;try{let r=Re(),t=(await Ze(r)).substring(0,Q);return k=t,t}catch(r){return O(r,{context:"device_id_generation_async"}),ue()}}function xe(){return ue()}async function Je(){return Ge()}function T(){if(!c())return xe();let r=f.get(se);if(r)return r;let e=xe();return f.set(se,e)||H(new Error("Failed to set device ID in localStorage"),{key:se,operation:"set"}),e}function et(r){if(!c())return;f.set(A,r)||H(new Error("Failed to set user ID in localStorage"),{key:A,operation:"set"})}function le(){if(!c())return T();let r=f.get(A);return r||T()}function tt(){if(!c())return;f.remove(A)||H(new Error("Failed to remove user ID from localStorage"),{key:A,operation:"remove"})}var rt={name:"user",version:"1.0.0",description:"User management plugin for device ID and user ID generation and management",priority:10,onTrack(r){return{...r,device_id:T(),user_id:le()}},getInfo(){return{name:this.name,version:this.version,description:this.description,deviceId:T(),userId:le(),isBrowser:c()}}};var N="__analytics_session_id__",L="__analytics_session_start__",x="__analytics_session_last_active__",he={TIMEOUT:1800*1e3,SYNC_INTERVAL:5e3},de=class{constructor(){this.session=null;this.timeoutId=null;this.storageCache={};this.lastStorageSync=0;this.syncInterval=he.SYNC_INTERVAL}start(){if(c())try{this.session=this.getOrCreateSession(),this.startSessionTimeout(),this.updateLastActive()}catch(e){q(e,{context:"start"})}}updateLastActive(){if(!(!c()||!this.session))try{let e=Date.now();this.session.lastActive=e,this.storageCache[x]=e.toString(),this.syncStorage(),this.resetSessionTimeout()}catch(e){q(e,{context:"updateLastActive"})}}getID(){var e;return this.session||this.start(),((e=this.session)==null?void 0:e.id)||null}getStartTime(){var e;return this.session||this.start(),((e=this.session)==null?void 0:e.startTime)||null}getDuration(){return this.session||this.start(),this.session?Date.now()-this.session.startTime:0}isNew(){var e;return this.session||this.start(),((e=this.session)==null?void 0:e.isNew)||!1}clearTimeout(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}incrementPageViews(){this.session&&this.session.pageViews++}incrementEvents(){this.session&&this.session.events++}getStats(){var e,t;return this.session||this.start(),{pageViews:((e=this.session)==null?void 0:e.pageViews)||0,events:((t=this.session)==null?void 0:t.events)||0,duration:this.session?Date.now()-this.session.startTime:0}}getContext(){var e,t,n,o,i;return this.session||this.start(),{session_id:((e=this.session)==null?void 0:e.id)||"",session_start:((t=this.session)==null?void 0:t.startTime)||0,session_duration:this.session?Date.now()-this.session.startTime:0,session_page_views:((n=this.session)==null?void 0:n.pageViews)||0,session_events:((o=this.session)==null?void 0:o.events)||0,session_is_new:((i=this.session)==null?void 0:i.isNew)||!1}}stop(){if(c())try{f.remove(N),f.remove(L),f.remove(x),delete this.storageCache[N],delete this.storageCache[L],delete this.storageCache[x],this.session=null,this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}catch(e){q(e,{context:"stop"})}}startSessionTimeout(){this.resetSessionTimeout()}resetSessionTimeout(){this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.stop()},he.TIMEOUT)}syncStorage(){let e=Date.now();e-this.lastStorageSync<this.syncInterval||(Object.entries(this.storageCache).forEach(([t,n])=>{f.set(t,n)}),this.lastStorageSync=e)}getOrCreateSession(){let e=this.storageCache[N],t=this.storageCache[L],n=this.storageCache[x];(!e||!t||!n)&&(e=f.get(N),t=f.get(L),n=f.get(x),e&&(this.storageCache[N]=e),t&&(this.storageCache[L]=t),n&&(this.storageCache[x]=n));let o=t?Number(t):null,i=n?Number(n):null;if(e&&o&&i&&Date.now()-i<he.TIMEOUT)return{id:e,startTime:o,lastActive:i,pageViews:0,events:0,isNew:!1};let a=this.generateSessionId(),s=Date.now();return this.storageCache[N]=a,this.storageCache[L]=s.toString(),this.storageCache[x]=s.toString(),this.syncStorage(),{id:a,startTime:s,lastActive:s,pageViews:0,events:0,isNew:!0}}generateSessionId(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}},w=new de,nt={name:"session",version:"1.0.0",description:"Session management plugin for tracking user sessions",priority:10,init(r){w.start()},onTrack(r){w.updateLastActive(),w.incrementEvents(),r.event==="page_view"&&w.incrementPageViews();let e=w.getContext();return{...r,properties:{...r.properties,...e}}},state:{sessions:w},getInfo(){return{name:this.name,version:this.version,description:this.description,sessionId:w.getID(),sessionStartTime:w.getStartTime(),sessionDuration:w.getDuration(),sessionIsNew:w.isNew(),sessionPageViews:w.getStats().pageViews,sessionEvents:w.getStats().events}}};var pe="__analytics_behavior_path__",b={MAX_STEPS:50,SAVE_INTERVAL:2e3,DEFAULT_RECENT_BEHAVIORS_LIMIT:10,CONTEXT_RECENT_BEHAVIORS_LIMIT:5,ANALYSIS_RESULT_LIMIT:5,SESSION_TIMEOUT:1800*1e3},fe=class{constructor(){this.behaviorPath=[];this.saveTimeoutId=null;this.lastSaveTime=0;this.saveInterval=b.SAVE_INTERVAL}init(){if(c())try{this.behaviorPath=this.loadBehaviorPath()}catch(e){C(e,{context:"init"}),this.behaviorPath=[]}}loadBehaviorPath(){let e=f.get(pe);if(!e)return[];try{let t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(t){return[]}}saveBehaviorPath(){if(!c())return;if(this.saveTimeoutId&&(clearTimeout(this.saveTimeoutId),this.saveTimeoutId=null),Date.now()-this.lastSaveTime<this.saveInterval){this.saveTimeoutId=setTimeout(()=>{this.saveBehaviorPathToStorage()},this.saveInterval);return}this.saveBehaviorPathToStorage()}saveBehaviorPathToStorage(){try{this.behaviorPath.length>b.MAX_STEPS&&(this.behaviorPath=this.behaviorPath.slice(-b.MAX_STEPS)),f.set(pe,JSON.stringify(this.behaviorPath)),this.lastSaveTime=Date.now()}catch(e){C(e,{context:"saveBehaviorPathToStorage"})}}track(e,t={}){if(c())try{let n={event:e,timestamp:Date.now(),properties:t,path:window.location.pathname,referrer:document.referrer};this.behaviorPath.push(n),this.saveBehaviorPath()}catch(n){C(n,{context:"track",event:e})}}trackView(e={}){if(c())try{let t={event:"pageview",timestamp:Date.now(),properties:e,path:window.location.pathname,referrer:document.referrer};this.behaviorPath.push(t),this.saveBehaviorPath()}catch(t){C(t,{context:"trackView"})}}getPath(){return[...this.behaviorPath]}getRecent(e=b.DEFAULT_RECENT_BEHAVIORS_LIMIT){return this.behaviorPath.slice(-e)}getStats(){let e=this.behaviorPath.length,t=new Set(this.behaviorPath.map(o=>o.event)).size,n=0;if(e>1){let o=0;for(let i=1;i<e;i++)o+=this.behaviorPath[i].timestamp-this.behaviorPath[i-1].timestamp;n=o/(e-1)}return{totalSteps:e,uniqueEvents:t,averageTimeBetweenSteps:n}}getContext(){var n,o;let e=this.getRecent(b.CONTEXT_RECENT_BEHAVIORS_LIMIT),t=this.getStats();return{behavior_steps:e.length,behavior_unique_events:t.uniqueEvents,behavior_avg_time_between_steps:Math.round(t.averageTimeBetweenSteps),last_event:((n=e[e.length-1])==null?void 0:n.event)||"",last_event_time:((o=e[e.length-1])==null?void 0:o.timestamp)||0}}clear(){if(c())try{this.clearTimeouts(),this.behaviorPath=[],f.remove(pe),this.lastSaveTime=0}catch(e){C(e,{context:"clear"})}}clearTimeouts(){this.saveTimeoutId&&(clearTimeout(this.saveTimeoutId),this.saveTimeoutId=null)}analyze(){let e={};for(let s of this.behaviorPath)e[s.event]=(e[s.event]||0)+1;let t=Object.entries(e).map(([s,u])=>({event:s,count:u})).sort((s,u)=>u.count-s.count).slice(0,b.ANALYSIS_RESULT_LIMIT),n={};for(let s of this.behaviorPath)n[s.path]=(n[s.path]||0)+1;let o=Object.entries(n).map(([s,u])=>({path:s,count:u})).sort((s,u)=>u.count-s.count).slice(0,b.ANALYSIS_RESULT_LIMIT),i=this.extractSessions(),a=i.length>0?i.reduce((s,u)=>s+u.duration,0)/i.length:0;return{mostFrequentEvents:t,commonPaths:o,averageSessionDuration:a}}extractSessions(){let e=[];if(this.behaviorPath.length===0)return e;let t=[this.behaviorPath[0]],n=this.behaviorPath[0].timestamp;for(let o=1;o<this.behaviorPath.length;o++){let i=this.behaviorPath[o];if(i.timestamp-t[t.length-1].timestamp>b.SESSION_TIMEOUT){let s=t[t.length-1].timestamp;e.push({startTime:n,endTime:s,duration:s-n,steps:[...t]}),t=[i],n=i.timestamp}else t.push(i)}if(t.length>0){let o=t[t.length-1].timestamp;e.push({startTime:n,endTime:o,duration:o-n,steps:[...t]})}return e}},S=new fe,ot={name:"behavior",version:"1.0.0",description:"Behavior tracking plugin for tracking user behavior and page views",priority:20,dependencies:["session"],setup(r){if(!r.getPlugin("session")){console.warn("[Node-Trace] behavior plugin requires session plugin to be registered");return}},init(r){S.init()},onTrack(r){S.track(r.event,r.properties||{}),r.event==="page_view"&&S.trackView(r.properties||{});let e=S.getContext();return{...r,properties:{...r.properties,...e}}},state:{behaviors:S},getInfo(){return{name:this.name,version:this.version,description:this.description,behaviorStats:S.getStats(),recentBehaviors:S.getRecent(5)}}};var it={name:"error",setup(r){c()&&(window.addEventListener("error",e=>{try{v("js_error",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})}catch(t){}}),window.addEventListener("unhandledrejection",e=>{var t;try{v("promise_error",{reason:String(e.reason),message:((t=e.reason)==null?void 0:t.message)||String(e.reason)})}catch(n){}}))}};function Ce(){var r,e;if(c())try{let t=window.performance;if(!t||!t.getEntriesByType)return;let n=t.getEntriesByType("navigation");if(n.length>0){let i=n[0];v("page_performance",{loadTime:i.loadEventEnd-i.fetchStart,ttfb:i.responseStart-i.fetchStart,domContentLoaded:i.domContentLoadedEventEnd-i.fetchStart,redirectTime:i.redirectEnd-i.redirectStart,dnsTime:i.domainLookupEnd-i.domainLookupStart,tcpTime:i.connectEnd-i.connectStart,sslTime:i.secureConnectionStart?i.connectEnd-i.secureConnectionStart:0,firstPaint:((r=t.getEntriesByType("paint").find(a=>a.name==="first-paint"))==null?void 0:r.startTime)||0,firstContentfulPaint:((e=t.getEntriesByType("paint").find(a=>a.name==="first-contentful-paint"))==null?void 0:e.startTime)||0})}let o=t.getEntriesByType("resource");if(o.length>0){let i={total:o.length,scripts:0,stylesheets:0,images:0,fonts:0,other:0,totalLoadTime:0};o.forEach(a=>{let s=a;i.totalLoadTime+=s.duration,s.name.includes(".js")?i.scripts++:s.name.includes(".css")?i.stylesheets++:/(jpg|jpeg|png|gif|webp|svg)$/i.test(s.name)?i.images++:/(woff|woff2|ttf|otf)$/i.test(s.name)?i.fonts++:i.other++}),v("resource_performance",i)}}catch(t){}}var st={name:"performance",setup(r){c()&&(document.readyState==="complete"?Ce():window.addEventListener("load",Ce))}};function B(){if(c())try{let r=V();v("page_view",{...r,url:window.location.href,pathname:window.location.pathname,referrer:document.referrer,title:document.title})}catch(r){}}function at(){if(!c())return;window.addEventListener("hashchange",B);let r=history.pushState,e=history.replaceState;history.pushState=function(...t){r.apply(this,t),B()},history.replaceState=function(...t){e.apply(this,t),B()},window.addEventListener("popstate",B)}var ct={name:"pageview",dependencies:["session","behavior"],setup(r){if(!c())return;let e=r.getPlugin("session"),t=r.getPlugin("behavior");if(!e){console.warn("[Node-Trace] pageview plugin requires session plugin to be registered");return}if(!t){console.warn("[Node-Trace] pageview plugin requires behavior plugin to be registered");return}B(),at()}};function X(r){try{let e=m.options;if(!(e!=null&&e.endpoint))return!1;let t=new URL(e.endpoint),n=new URL(r,window.location.origin);return t.protocol===n.protocol&&t.host===n.host&&t.pathname===n.pathname}catch(e){return!1}}function ut(){if(!c()||!window.XMLHttpRequest)return;let r=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,n,o,i,a){let s=this;return s._requestStartTime=Date.now(),s._requestMethod=t,s._requestUrl=n,r.call(this,t,n,o!==!1,i,a)},XMLHttpRequest.prototype.send=function(t){let n=this;return this.addEventListener("load",function(){var o;try{let i=((o=n._requestUrl)==null?void 0:o.toString())||"";if(X(i))return;let a=Date.now()-(n._requestStartTime||Date.now());v("network_request",{method:n._requestMethod||"GET",url:i,status:n.status,statusText:n.statusText,duration:a,type:"xhr",success:n.status>=200&&n.status<300})}catch(i){}}),this.addEventListener("error",function(){var o;try{let i=((o=n._requestUrl)==null?void 0:o.toString())||"";if(X(i))return;let a=Date.now()-(n._requestStartTime||Date.now());v("network_request",{method:n._requestMethod||"GET",url:i,status:0,statusText:"Error",duration:a,type:"xhr",success:!1})}catch(i){}}),this.addEventListener("abort",function(){var o;try{let i=((o=n._requestUrl)==null?void 0:o.toString())||"";if(X(i))return;let a=Date.now()-(n._requestStartTime||Date.now());v("network_request",{method:n._requestMethod||"GET",url:i,status:0,statusText:"Aborted",duration:a,type:"xhr",success:!1})}catch(i){}}),e.call(this,t)}}function lt(){if(!c()||!window.fetch)return;let r=window.fetch;window.fetch=async function(...e){let t=Date.now(),n=e[0],i=(e[1]||{}).method||"GET";if(X(n))return r.apply(this,e);try{let a=await r.apply(this,e),s=Date.now()-t;return v("network_request",{method:i,url:n,status:a.status,statusText:a.statusText,duration:s,type:"fetch",success:a.ok}),a}catch(a){let s=Date.now()-t;throw v("network_request",{method:i,url:n,status:0,statusText:a instanceof Error?a.message:"Error",duration:s,type:"fetch",success:!1}),a}}}var ht={name:"network",setup(r){c()&&(ut(),lt())}};export{M as ErrorHandler,ot as behaviorPlugin,S as behaviors,je as browserPlugin,We as browserUtils,It as calculateErrorRate,Dt as captureError,xt as cleanupTimestamps,tt as clearID,$e as clearTimers,y as errorHandler,it as errorPlugin,Fe as flush,kt as generateErrorSummary,Je as generateStableDeviceIdAsync,V as getBrowserData,T as getDeviceId,le as getID,C as handleBehaviorError,O as handleBrowserError,Mt as handleDataError,Lt as handleDeviceError,J as handleNetworkError,_ as handlePluginError,Nt as handleQueueError,q as handleSessionError,H as handleStorageError,At as handleUnknownError,Qe as init,Pt as initializeStats,ht as networkPlugin,ct as pageviewPlugin,st as performancePlugin,I as plugins,nt as sessionPlugin,w as sessions,et as setID,f as storageUtils,v as track,Xe as use,rt as userPlugin};
//# sourceMappingURL=index.mjs.map