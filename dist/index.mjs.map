{"version":3,"sources":["../src/queue/constants.ts","../src/queue/dedupe.ts","../src/utils.ts","../src/queue/network.ts","../src/queue/sender.ts","../src/error.ts","../src/db.ts","../src/queue/manager.ts","../src/queue.ts","../src/core.ts","../src/plugins/browser.ts","../src/plugins/user.ts","../src/plugins/session.ts","../src/plugins/behavior.ts","../src/plugins/error.ts","../src/plugins/performance.ts","../src/plugins/pageview.ts","../src/plugins/network.ts"],"sourcesContent":["/**\n * 队列常量定义\n */\n\nexport const QUEUE_CONSTANTS = {\n  /**\n   * 默认最大队列大小\n   */\n  DEFAULT_MAX_QUEUE_SIZE: 1000,\n  /**\n   * 默认批量发送大小\n   */\n  DEFAULT_BATCH_SIZE: 20,\n  /**\n   * 默认批量发送间隔（毫秒）\n   */\n  DEFAULT_BATCH_INTERVAL: 1000,\n  /**\n   * 最大批量发送大小\n   */\n  MAX_BATCH_SIZE: 50,\n  /**\n   * 最小批量发送大小\n   */\n  MIN_BATCH_SIZE: 5,\n  /**\n   * 最大批量发送间隔（毫秒）\n   */\n  MAX_BATCH_INTERVAL: 3000,\n  /**\n   * 最小批量发送间隔（毫秒）\n   */\n  MIN_BATCH_INTERVAL: 200,\n  /**\n   * 队列压力阈值 - 高\n   */\n  QUEUE_PRESSURE_HIGH: 0.7,\n  /**\n   * 队列压力阈值 - 很高\n   */\n  QUEUE_PRESSURE_VERY_HIGH: 0.9,\n  /**\n   * 队列压力阈值 - 低\n   */\n  QUEUE_PRESSURE_LOW: 0.2,\n  /**\n   * 队列压力阈值 - 中\n   */\n  QUEUE_PRESSURE_MEDIUM: 0.6,\n  /**\n   * 网络状态检查间隔（毫秒）\n   */\n  NETWORK_CHECK_INTERVAL: 5000,\n  /**\n   * Beacon数据大小限制（字节）\n   */\n  BEACON_SIZE_LIMIT: 65536,\n  /**\n   * 小数据阈值（字节）\n   */\n  SMALL_DATA_THRESHOLD: 1024,\n  /**\n   * 最大重试次数\n   */\n  MAX_RETRY_COUNT: 5,\n  /**\n   * 默认超时时间（毫秒）\n   */\n  DEFAULT_TIMEOUT: 30000,\n  /**\n   * 队列清理比例\n   */\n  QUEUE_CLEANUP_RATIO: 0.1,\n  /**\n   * 最大清理事件数\n   */\n  MAX_CLEANUP_COUNT: 10,\n  /**\n   * 离线事件检查间隔（毫秒）\n   */\n  OFFLINE_CHECK_INTERVAL: 30000,\n  /**\n   * 事件去重缓存最大大小\n   */\n  DEDUPE_CACHE_MAX_SIZE: 10000,\n};\n","import type { Payload, EventProperties } from \"../types\";\n\n/**\n * LRU缓存实现（专门用于字符串键）\n */\nexport class LRUCache<V> {\n  private cache: Map<string, V>;\n  private maxSize: number;\n\n  constructor(maxSize: number = 10000) {\n    this.cache = new Map();\n    this.maxSize = maxSize;\n  }\n\n  has(key: string): boolean {\n    return this.cache.has(key);\n  }\n\n  set(key: string, value: V): void {\n    if (this.cache.size >= this.maxSize) {\n      const firstKey = this.cache.keys().next().value;\n      if (firstKey !== undefined) {\n        this.cache.delete(firstKey);\n      }\n    }\n    this.cache.set(key, value);\n  }\n\n  delete(key: string): void {\n    this.cache.delete(key);\n  }\n\n  clear(): void {\n    this.cache.clear();\n  }\n\n  size(): number {\n    return this.cache.size;\n  }\n\n  get(key: string): V | undefined {\n    const value = this.cache.get(key);\n    if (value !== undefined) {\n      this.cache.delete(key);\n      this.cache.set(key, value);\n    }\n    return value;\n  }\n}\n\n/**\n * 生成事件唯一键\n * @param event - 事件对象\n * @returns 事件唯一键\n */\nexport function generateEventKey<T extends EventProperties>(\n  event: Payload<T>,\n): string {\n  return `${event.id}_${event.event}_${event.timestamp}`;\n}\n\n/**\n * 事件去重管理器\n */\nexport class EventDedupe {\n  private cache: LRUCache<boolean>;\n\n  constructor(maxSize: number = 10000) {\n    this.cache = new LRUCache<boolean>(maxSize);\n  }\n\n  /**\n   * 检查事件是否已存在\n   */\n  exists<T extends EventProperties>(event: Payload<T>): boolean {\n    const key = generateEventKey(event);\n    return this.cache.has(key);\n  }\n\n  /**\n   * 添加事件到去重缓存\n   */\n  add<T extends EventProperties>(event: Payload<T>): void {\n    const key = generateEventKey(event);\n    this.cache.set(key, true);\n  }\n\n  /**\n   * 从去重缓存中移除事件\n   */\n  remove<T extends EventProperties>(event: Payload<T>): void {\n    const key = generateEventKey(event);\n    this.cache.delete(key);\n  }\n\n  /**\n   * 批量移除事件\n   */\n  removeBatch<T extends EventProperties>(events: Payload<T>[]): void {\n    events.forEach((event) => this.remove(event));\n  }\n\n  /**\n   * 清空去重缓存\n   */\n  clear(): void {\n    this.cache.clear();\n  }\n\n  /**\n   * 获取缓存大小\n   */\n  size(): number {\n    return this.cache.size();\n  }\n}\n","/**\n * 工具函数模块\n * 包含字符串、数字、对象、数组、时间等常用工具函数\n */\n\n/**\n * 常量定义\n */\nexport const CONSTANTS = {\n  /**\n   * 随机字符串默认长度\n   */\n  RANDOM_STRING_DEFAULT_LENGTH: 8,\n  /**\n   * 数字格式化默认小数位数\n   */\n  NUMBER_FORMAT_DEFAULT_DECIMALS: 2\n}\n\n/**\n * 字符串工具函数\n */\nexport const stringUtils = {\n  /**\n   * 生成随机字符串\n   * @param {number} [length=8] - 字符串长度\n   * @returns {string} 随机字符串\n   */\n  random: (length: number = CONSTANTS.RANDOM_STRING_DEFAULT_LENGTH): string => {\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'\n    let result = ''\n    for (let i = 0; i < length; i++) {\n      result += chars.charAt(Math.floor(Math.random() * chars.length))\n    }\n    return result\n  },\n\n  /**\n   * 生成唯一ID\n   * @returns {string} 唯一ID\n   */\n  uuid: (): string => {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n      const r = Math.random() * 16 | 0\n      const v = c === 'x' ? r : (r & 0x3 | 0x8)\n      return v.toString(16)\n    })\n  },\n\n  /**\n   * 生成事件ID\n   * @returns {string} 事件ID\n   */\n  generateEventId: (): string => {\n    const timestamp = now()\n    // 格式化为年月日时分毫秒\n    const date = new Date(timestamp)\n    const year = date.getFullYear()\n    const month = String(date.getMonth() + 1).padStart(2, '0')\n    const day = String(date.getDate()).padStart(2, '0')\n    const hours = String(date.getHours()).padStart(2, '0')\n    const minutes = String(date.getMinutes()).padStart(2, '0')\n    const seconds = String(date.getSeconds()).padStart(2, '0')\n    const milliseconds = String(date.getMilliseconds()).padStart(3, '0')\n    const formattedTime = `${year}${month}${day}${hours}${minutes}${seconds}${milliseconds}`\n    // 生成8位随机字符串\n    const randomPart = stringUtils.random(8)\n    return `${formattedTime}${randomPart}`\n  },\n\n  /**\n   * 截断字符串\n   * @param {string} str - 原始字符串\n   * @param {number} maxLength - 最大长度\n   * @param {string} [suffix=...] - 后缀\n   * @returns {string} 截断后的字符串\n   */\n  truncate: (str: string, maxLength: number, suffix: string = '...'): string => {\n    if (str.length <= maxLength) return str\n    return str.substring(0, maxLength - suffix.length) + suffix\n  }\n}\n\n/**\n * 数字工具函数\n */\nexport const numberUtils = {\n  /**\n   * 限制数字范围\n   * @param {number} value - 原始值\n   * @param {number} min - 最小值\n   * @param {number} max - 最大值\n   * @returns {number} 限制范围内的数字\n   */\n  clamp: (value: number, min: number, max: number): number => {\n    return Math.min(Math.max(value, min), max)\n  },\n\n  /**\n   * 生成随机数字\n   * @param {number} min - 最小值\n   * @param {number} max - 最大值\n   * @returns {number} 随机数字\n   */\n  random: (min: number, max: number): number => {\n    return Math.floor(Math.random() * (max - min + 1)) + min\n  },\n\n  /**\n   * 格式化数字\n   * @param {number} num - 原始数字\n   * @param {number} [decimals=2] - 小数位数\n   * @returns {string} 格式化后的数字字符串\n   */\n  format: (num: number, decimals: number = CONSTANTS.NUMBER_FORMAT_DEFAULT_DECIMALS): string => {\n    return num.toFixed(decimals)\n  }\n}\n\n/**\n * 对象工具函数\n */\nexport const objectUtils = {\n  /**\n   * 深度合并对象\n   * @template T\n   * @param {T} target - 目标对象\n   * @param {...Record<string, any>} sources - 源对象\n   * @returns {T} 合并后的对象\n   */\n  deepMerge: <T extends Record<string, any>>(target: T, ...sources: Record<string, any>[]): T => {\n    if (!sources.length) return target\n    \n    // 递归合并函数\n    const merge = (targetObj: Record<string, any>, sourceObj: Record<string, any>): Record<string, any> => {\n      const result = { ...targetObj }\n      \n      for (const key in sourceObj) {\n        if (Object.prototype.hasOwnProperty.call(sourceObj, key)) {\n          const sourceValue = sourceObj[key]\n          const targetValue = targetObj[key]\n          \n          if (sourceValue && typeof sourceValue === 'object' && targetValue && typeof targetValue === 'object') {\n            // 递归合并对象\n            result[key] = merge(targetValue, sourceValue)\n          } else {\n            // 直接替换值\n            result[key] = sourceValue\n          }\n        }\n      }\n      \n      return result\n    }\n    \n    // 合并所有源对象\n    let result = { ...target }\n    for (const source of sources) {\n      if (source) {\n        result = merge(result, source) as typeof result\n      }\n    }\n    \n    return result as T\n  },\n\n  /**\n   * 安全获取对象属性\n   * @template T\n   * @param {any} obj - 目标对象\n   * @param {string|string[]} path - 属性路径\n   * @param {T} defaultValue - 默认值\n   * @returns {T} 获取到的值或默认值\n   */\n  get: <T>(obj: any, path: string | string[], defaultValue: T): T => {\n    const travel = (regexp: RegExp, obj: any, path: string | string[]): any => {\n      const value = Array.isArray(path)\n        ? path.reduce((res, key) => (res !== null && res !== undefined ? res[key] : res), obj)\n        : regexp.test(path)\n        ? path.split(regexp).reduce((res, key) => (res !== null && res !== undefined ? res[key] : res), obj)\n        : obj[path]\n      return value === undefined || value === null ? defaultValue : value\n    }\n    return travel(/[\\[\\]\\.]+/, obj, path)\n  },\n\n  /**\n   * 移除对象中的空值\n   * @param {Record<string, any>} obj - 目标对象\n   * @returns {Record<string, any>} 移除空值后的对象\n   */\n  removeEmpty: (obj: Record<string, any>): Record<string, any> => {\n    const newObj: Record<string, any> = {}\n    Object.keys(obj).forEach(key => {\n      if (obj[key] !== null && obj[key] !== undefined) {\n        newObj[key] = obj[key]\n      }\n    })\n    return newObj\n  }\n}\n\n/**\n * 数组工具函数\n */\nexport const arrayUtils = {\n  /**\n   * 去重\n   * @template T\n   * @param {T[]} arr - 原始数组\n   * @returns {T[]} 去重后的数组\n   */\n  unique: <T>(arr: T[]): T[] => {\n    return [...new Set(arr)]\n  },\n\n  /**\n   * 随机打乱数组\n   * @template T\n   * @param {T[]} arr - 原始数组\n   * @returns {T[]} 打乱后的数组\n   */\n  shuffle: <T>(arr: T[]): T[] => {\n    const result = [...arr]\n    for (let i = result.length - 1; i > 0; i--) {\n      const j = Math.floor(Math.random() * (i + 1))\n      ;[result[i], result[j]] = [result[j], result[i]]\n    }\n    return result\n  },\n\n  /**\n   * 分批处理数组\n   * @template T\n   * @param {T[]} arr - 原始数组\n   * @param {number} size - 每批大小\n   * @returns {T[][]} 分批后的数组\n   */\n  chunk: <T>(arr: T[], size: number): T[][] => {\n    const result: T[][] = []\n    for (let i = 0; i < arr.length; i += size) {\n      result.push(arr.slice(i, i + size))\n    }\n    return result\n  }\n}\n\n/**\n * 时间工具函数\n */\nexport const timeUtils = {\n  /**\n   * 格式化时间戳\n   * @param {number} timestamp - 时间戳\n   * @param {string} [format=YYYY-MM-DD HH:mm:ss] - 格式化模板\n   * @returns {string} 格式化后的时间字符串\n   */\n  format: (timestamp: number, format: string = 'YYYY-MM-DD HH:mm:ss'): string => {\n    const date = new Date(timestamp)\n    const year = date.getFullYear()\n    const month = String(date.getMonth() + 1).padStart(2, '0')\n    const day = String(date.getDate()).padStart(2, '0')\n    const hours = String(date.getHours()).padStart(2, '0')\n    const minutes = String(date.getMinutes()).padStart(2, '0')\n    const seconds = String(date.getSeconds()).padStart(2, '0')\n\n    return format\n      .replace('YYYY', year.toString())\n      .replace('MM', month)\n      .replace('DD', day)\n      .replace('HH', hours)\n      .replace('mm', minutes)\n      .replace('ss', seconds)\n  },\n\n  /**\n   * 计算时间差\n   * @param {number} start - 开始时间戳\n   * @param {number} end - 结束时间戳\n   * @param {('ms'|'s'|'m'|'h'|'d')} [unit=ms] - 时间单位\n   * @returns {number} 时间差\n   */\n  diff: (start: number, end: number, unit: 'ms' | 's' | 'm' | 'h' | 'd' = 'ms'): number => {\n    const diff = end - start\n    switch (unit) {\n      case 's':\n        return diff / 1000\n      case 'm':\n        return diff / (1000 * 60)\n      case 'h':\n        return diff / (1000 * 60 * 60)\n      case 'd':\n        return diff / (1000 * 60 * 60 * 24)\n      default:\n        return diff\n    }\n  }\n}\n\n/**\n * 环境工具函数\n */\n\n/**\n * 检查是否在浏览器环境中\n * @returns {boolean} 是否在浏览器环境中\n */\nexport const isBrowser = () => typeof window !== \"undefined\"\n\n/**\n * 获取当前时间戳\n * @returns {number} 当前时间戳\n */\nexport const now = () => Date.now()\n","import { isBrowser, now } from \"../utils\";\nimport { QUEUE_CONSTANTS } from \"./constants\";\n\n/**\n * 网络类型\n */\nexport type NetworkType = \"unknown\" | \"online\" | \"offline\" | \"slow\";\n\n/**\n * 有效网络类型\n */\nexport type EffectiveNetworkType = \"2g\" | \"3g\" | \"4g\" | \"5g\" | \"unknown\";\n\n/**\n * 网络状态接口\n */\nexport interface NetworkState {\n  type: NetworkType;\n  lastCheckTime: number;\n  effectiveType: EffectiveNetworkType;\n  rtt: number;\n  downlink: number;\n}\n\n/**\n * 网络状态管理器\n */\nexport class NetworkManager {\n  private state: NetworkState;\n  private checkInterval: number;\n\n  constructor() {\n    this.state = {\n      type: \"unknown\",\n      lastCheckTime: 0,\n      effectiveType: \"4g\",\n      rtt: 0,\n      downlink: 0,\n    };\n    this.checkInterval = QUEUE_CONSTANTS.NETWORK_CHECK_INTERVAL;\n  }\n\n  /**\n   * 检查是否需要更新网络状态\n   */\n  private shouldUpdate(): boolean {\n    const nowTime = now();\n    return nowTime - this.state.lastCheckTime >= this.checkInterval;\n  }\n\n  /**\n   * 更新网络状态\n   */\n  update(): void {\n    if (!isBrowser() || typeof navigator === \"undefined\") {\n      return;\n    }\n\n    if (!this.shouldUpdate()) {\n      return;\n    }\n\n    this.state.lastCheckTime = now();\n    this.state.type = navigator.onLine ? \"online\" : \"offline\";\n\n    if (\"connection\" in navigator) {\n      const connection = navigator.connection as any;\n      this.state.effectiveType = connection.effectiveType || \"unknown\";\n      this.state.rtt = connection.rtt || 0;\n      this.state.downlink = connection.downlink || 0;\n\n      if (\n        this.state.effectiveType === \"2g\" ||\n        this.state.rtt > 1000 ||\n        this.state.downlink < 1\n      ) {\n        this.state.type = \"slow\";\n      }\n    }\n  }\n\n  /**\n   * 获取网络状态\n   */\n  getState(): NetworkState {\n    this.update();\n    return { ...this.state };\n  }\n\n  /**\n   * 获取网络类型\n   */\n  getType(): NetworkType {\n    this.update();\n    return this.state.type;\n  }\n\n  /**\n   * 检查是否在线\n   */\n  isOnline(): boolean {\n    this.update();\n    return this.state.type === \"online\";\n  }\n\n  /**\n   * 检查是否离线\n   */\n  isOffline(): boolean {\n    this.update();\n    return this.state.type === \"offline\";\n  }\n\n  /**\n   * 检查是否为慢速网络\n   */\n  isSlow(): boolean {\n    this.update();\n    return this.state.type === \"slow\";\n  }\n}\n\n/**\n * 网络管理器实例\n */\nexport const networkManager = new NetworkManager();\n","import { isBrowser } from \"../utils\";\nimport { QUEUE_CONSTANTS } from \"./constants\";\nimport { networkManager, type NetworkType } from \"./network\";\n\n/**\n * 发送策略类型\n */\nexport type SendStrategy = \"beacon\" | \"fetch\" | \"xhr\";\n\n/**\n * 发送结果\n */\nexport interface SendResult {\n  success: boolean;\n  strategy: SendStrategy;\n  time: number;\n}\n\n/**\n * 发送选项\n */\nexport interface SendOptions {\n  endpoint: string;\n  data: any;\n  timeout?: number;\n  headers?: Record<string, string>;\n  debug?: boolean;\n}\n\n/**\n * 发送策略选择器\n */\nexport class SendStrategySelector {\n  /**\n   * 选择发送策略\n   * @param body - 已序列化的数据\n   * @param bodySize - 数据大小\n   * @returns 发送策略\n   */\n  select(body: string, bodySize: number): SendStrategy {\n    const networkType = networkManager.getType();\n\n    if (networkType === \"offline\") {\n      return \"beacon\";\n    } else if (networkType === \"slow\") {\n      return \"fetch\";\n    }\n\n    if (bodySize > QUEUE_CONSTANTS.BEACON_SIZE_LIMIT) {\n      return \"fetch\";\n    } else if (bodySize < QUEUE_CONSTANTS.SMALL_DATA_THRESHOLD) {\n      return \"beacon\";\n    }\n\n    return \"fetch\";\n  }\n}\n\n/**\n * 使用 Beacon API 发送数据\n */\nasync function sendWithBeacon(\n  endpoint: string,\n  body: string,\n  debug?: boolean,\n): Promise<boolean> {\n  if (!isBrowser() || typeof navigator.sendBeacon === \"undefined\") {\n    return false;\n  }\n\n  try {\n    const success = navigator.sendBeacon(endpoint, body);\n    if (debug) {\n      console.log(\"[Node-Trace] Sent with beacon:\", success);\n    }\n    return success;\n  } catch (error) {\n    if (debug) {\n      console.log(\"[Node-Trace] Beacon failed:\", error);\n    }\n    return false;\n  }\n}\n\n/**\n * 使用 Fetch API 发送数据\n */\nasync function sendWithFetch(\n  endpoint: string,\n  body: string,\n  headers: Record<string, string>,\n  timeout: number,\n  debug?: boolean,\n): Promise<boolean> {\n  if (!isBrowser() || typeof fetch === \"undefined\") {\n    return false;\n  }\n\n  try {\n    const res = await fetch(endpoint, {\n      method: \"POST\",\n      body,\n      headers: {\n        \"Content-Type\": \"application/json\",\n        ...headers,\n      },\n      keepalive: true,\n      signal: timeout ? AbortSignal.timeout(timeout) : undefined,\n    });\n\n    if (debug) {\n      console.log(\"[Node-Trace] Sent with fetch:\", res.ok);\n    }\n    return res.ok;\n  } catch (error) {\n    if (debug) {\n      console.log(\"[Node-Trace] Fetch failed:\", error);\n    }\n    return false;\n  }\n}\n\n/**\n * 使用 XMLHttpRequest 发送数据（作为最终回退）\n */\nasync function sendWithXHR(\n  endpoint: string,\n  data: any,\n  timeout: number,\n  debug?: boolean,\n): Promise<boolean> {\n  if (!isBrowser() || typeof XMLHttpRequest === \"undefined\") {\n    return false;\n  }\n\n  return new Promise((resolve) => {\n    const xhr = new XMLHttpRequest();\n    const body = JSON.stringify(data);\n\n    xhr.open(\"POST\", endpoint, true);\n    xhr.setRequestHeader(\"Content-Type\", \"application/json\");\n\n    if (timeout > 0) {\n      xhr.timeout = timeout;\n    }\n\n    xhr.onload = function () {\n      const success = xhr.status >= 200 && xhr.status < 300;\n      if (debug) {\n        console.log(\"[Node-Trace] Sent with XHR:\", success);\n      }\n      resolve(success);\n    };\n\n    xhr.onerror = function () {\n      if (debug) {\n        console.log(\"[Node-Trace] XHR failed\");\n      }\n      resolve(false);\n    };\n\n    xhr.ontimeout = function () {\n      if (debug) {\n        console.log(\"[Node-Trace] XHR timeout\");\n      }\n      resolve(false);\n    };\n\n    xhr.send(body);\n  });\n}\n\n/**\n * 发送器\n */\nexport class Sender {\n  private strategySelector: SendStrategySelector;\n\n  constructor() {\n    this.strategySelector = new SendStrategySelector();\n  }\n\n  /**\n   * 发送数据\n   * @param options - 发送选项\n   * @returns 发送结果\n   */\n  async send(options: SendOptions): Promise<SendResult> {\n    if (!isBrowser()) {\n      return {\n        success: false,\n        strategy: \"fetch\",\n        time: 0,\n      };\n    }\n\n    const startTime = Date.now();\n    const {\n      endpoint,\n      data,\n      timeout = QUEUE_CONSTANTS.DEFAULT_TIMEOUT,\n      headers = {},\n      debug,\n    } = options;\n\n    const body = JSON.stringify(data);\n    const bodySize = body.length;\n\n    const strategy = this.strategySelector.select(body, bodySize);\n\n    let success = false;\n\n    if (strategy === \"beacon\") {\n      success = await sendWithBeacon(endpoint, body, debug);\n      if (!success) {\n        success = await sendWithFetch(endpoint, body, headers, timeout, debug);\n      }\n    }\n\n    if (strategy === \"fetch\" || !success) {\n      success = await sendWithFetch(endpoint, body, headers, timeout, debug);\n      if (!success) {\n        success = await sendWithXHR(endpoint, data, timeout, debug);\n      }\n    }\n\n    const time = Date.now() - startTime;\n\n    return {\n      success,\n      strategy,\n      time,\n    };\n  }\n}\n\n/**\n * 发送器实例\n */\nexport const sender = new Sender();\n","/**\n * 错误处理模块\n * 负责捕获、记录和处理各种类型的错误\n */\nimport { state } from './core'\n\n/**\n * 错误类型\n */\nexport type ErrorType = \n  | 'network'              // 网络错误\n  | 'network:timeout'      // 网络超时错误\n  | 'network:offline'      // 离线错误\n  | 'network:server'       // 服务器错误\n  | 'network:client'       // 客户端错误\n  | 'storage'              // 存储错误\n  | 'storage:quota'        // 存储配额错误\n  | 'storage:access'       // 存储访问错误\n  | 'browser'              // 浏览器 API 错误\n  | 'plugin'               // 插件错误\n  | 'plugin:init'          // 插件初始化错误\n  | 'plugin:execute'       // 插件执行错误\n  | 'queue'                // 队列错误\n  | 'queue:full'           // 队列满错误\n  | 'queue:overflow'       // 队列溢出错误\n  | 'device'               // 设备 ID 错误\n  | 'session'              // 会话错误\n  | 'session:timeout'      // 会话超时错误\n  | 'behavior'             // 行为错误\n  | 'data'                 // 数据处理错误\n  | 'data:validation'      // 数据验证错误\n  | 'data:serialization'   // 数据序列化错误\n  | 'config'               // 配置错误\n  | 'init'                 // 初始化错误\n  | 'runtime'              // 运行时错误\n  | 'unknown'              // 未知错误\n\n/**\n * 错误级别\n */\nexport type ErrorLevel = 'debug' | 'info' | 'warn' | 'error' | 'fatal'\n\n/**\n * 错误接口\n */\nexport interface TraceError {\n  /**\n   * 错误类型\n   */\n  type: ErrorType\n  /**\n   * 错误级别\n   */\n  level: ErrorLevel\n  /**\n   * 错误消息\n   */\n  message: string\n  /**\n   * 错误代码\n   */\n  code?: string\n  /**\n   * 错误堆栈\n   */\n  stack?: string\n  /**\n   * 错误上下文\n   */\n  context?: Record<string, any>\n  /**\n   * 错误详情\n   */\n  details?: Record<string, any>\n  /**\n   * 错误来源\n   */\n  source?: string\n  /**\n   * 错误发生的文件\n   */\n  file?: string\n  /**\n   * 错误发生的行号\n   */\n  line?: number\n  /**\n   * 时间戳\n   */\n  timestamp: number\n  /**\n   * 错误ID\n   */\n  id: string\n  /**\n   * 相关事件\n   */\n  event?: string\n  /**\n   * 用户ID\n   */\n  userId?: string\n  /**\n   * 设备ID\n   */\n  deviceId?: string\n}\n\n/**\n * 错误处理配置\n */\nexport interface ErrorHandlerConfig {\n  /**\n   * 是否捕获错误\n   */\n  capture: boolean\n  /**\n   * 日志级别\n   */\n  logLevel: ErrorLevel\n  /**\n   * 最大错误数量\n   */\n  maxErrors: number\n}\n\n/**\n * 错误处理类\n * 负责捕获、记录和处理错误\n */\nexport class ErrorHandler {\n  /**\n   * 配置\n   * @private\n   */\n  private config: ErrorHandlerConfig\n  \n  /**\n   * 错误队列\n   * @private\n   */\n  private errors: TraceError[] = []\n  \n  /**\n   * 错误统计\n   * @private\n   */\n  private stats: {\n    total: number\n    byType: Record<ErrorType, number>\n    byLevel: Record<ErrorLevel, number>\n    byCode: Record<string, number>\n    lastError: number\n    rate: {\n      lastMinute: number\n      lastHour: number\n    }\n    consecutiveErrors: number\n    maxConsecutiveErrors: number\n  } = {\n    total: 0,\n    byType: {} as Record<ErrorType, number>,\n    byLevel: {} as Record<ErrorLevel, number>,\n    byCode: {} as Record<string, number>,\n    lastError: 0,\n    rate: {\n      lastMinute: 0,\n      lastHour: 0\n    },\n    consecutiveErrors: 0,\n    maxConsecutiveErrors: 0\n  }\n  \n  /**\n   * 错误时间戳列表\n   * @private\n   */\n  private errorTimestamps: number[] = []\n\n  /**\n   * 构造函数\n   * @param {Partial<ErrorHandlerConfig>} [config] - 配置选项\n   */\n  constructor(config?: Partial<ErrorHandlerConfig>) {\n    this.config = {\n      capture: true,\n      logLevel: 'warn',\n      maxErrors: 100,\n      ...config\n    }\n    \n    // 初始化错误统计\n    this.initStats()\n  }\n  \n  /**\n   * 初始化错误统计\n   * @private\n   */\n  private initStats(): void {\n    // 初始化按类型统计\n    const errorTypes: ErrorType[] = [\n      'network', 'network:timeout', 'network:offline', 'network:server', 'network:client',\n      'storage', 'storage:quota', 'storage:access',\n      'browser',\n      'plugin', 'plugin:init', 'plugin:execute',\n      'queue', 'queue:full', 'queue:overflow',\n      'device',\n      'session', 'session:timeout',\n      'behavior',\n      'data', 'data:validation', 'data:serialization',\n      'config',\n      'init',\n      'runtime',\n      'unknown'\n    ]\n    \n    errorTypes.forEach(type => {\n      this.stats.byType[type] = 0\n    })\n    \n    // 初始化按级别统计\n    const errorLevels: ErrorLevel[] = ['debug', 'info', 'warn', 'error', 'fatal']\n    errorLevels.forEach(level => {\n      this.stats.byLevel[level] = 0\n    })\n  }\n\n  /**\n   * 生成错误ID\n   * @private\n   * @returns {string} 错误ID\n   */\n  private generateErrorId(): string {\n    return 'error_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)\n  }\n\n  /**\n   * 解析错误堆栈\n   * @private\n   * @param {string} stack - 错误堆栈\n   * @returns {Object} 解析结果\n   */\n  private parseStack(stack: string): { file?: string, line?: number } {\n    const stackLines = stack.split('\\n')\n    for (const line of stackLines) {\n      const match = line.match(/at \\s*(?:\\w+\\s+)?\\(?([^:]+):(\\d+):(\\d+)\\)?/)\n      if (match) {\n        return {\n          file: match[1],\n          line: parseInt(match[2])\n        }\n      }\n    }\n    return {}\n  }\n\n  /**\n   * 更新错误统计\n   * @private\n   * @param {TraceError} error - 错误对象\n   */\n  private updateStats(error: TraceError): void {\n    // 更新总错误数\n    this.stats.total++\n    \n    // 更新按类型统计\n    this.stats.byType[error.type] = (this.stats.byType[error.type] || 0) + 1\n    \n    // 更新按级别统计\n    this.stats.byLevel[error.level] = (this.stats.byLevel[error.level] || 0) + 1\n    \n    // 更新按代码统计\n    if (error.code) {\n      this.stats.byCode[error.code] = (this.stats.byCode[error.code] || 0) + 1\n    }\n    \n    // 更新最后错误时间\n    this.stats.lastError = error.timestamp\n    \n    // 更新错误时间戳列表\n    this.errorTimestamps.push(error.timestamp)\n    \n    // 清理过期的时间戳（只保留最近一小时的）\n    const oneHourAgo = Date.now() - 60 * 60 * 1000\n    this.errorTimestamps = this.errorTimestamps.filter(ts => ts > oneHourAgo)\n    \n    // 更新错误率\n    const oneMinuteAgo = Date.now() - 60 * 1000\n    this.stats.rate.lastMinute = this.errorTimestamps.filter(ts => ts > oneMinuteAgo).length\n    this.stats.rate.lastHour = this.errorTimestamps.length\n    \n    // 更新连续错误数\n    const timeSinceLastError = error.timestamp - this.stats.lastError\n    if (timeSinceLastError < 5000) {\n      // 5秒内的错误视为连续错误\n      this.stats.consecutiveErrors++\n      if (this.stats.consecutiveErrors > this.stats.maxConsecutiveErrors) {\n        this.stats.maxConsecutiveErrors = this.stats.consecutiveErrors\n      }\n    } else {\n      this.stats.consecutiveErrors = 1\n    }\n  }\n\n  /**\n   * 记录错误\n   * @param {ErrorType} type - 错误类型\n   * @param {string} message - 错误消息\n   * @param {any} [error] - 原始错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   * @param {ErrorLevel} [level=error] - 错误级别\n   * @param {string} [code] - 错误代码\n   * @param {string} [source] - 错误来源\n   */\n  public captureError(\n    type: ErrorType,\n    message: string,\n    error?: any,\n    context?: Record<string, any>,\n    level: ErrorLevel = 'error',\n    code?: string,\n    source?: string\n  ): TraceError {\n    if (!this.config.capture) {\n      const dummyError: TraceError = {\n        type,\n        level,\n        message,\n        code,\n        stack: error?.stack,\n        context,\n        timestamp: Date.now(),\n        id: this.generateErrorId()\n      }\n      return dummyError\n    }\n\n    // 解析错误堆栈\n    let file: string | undefined\n    let line: number | undefined\n    if (error?.stack) {\n      const stackInfo = this.parseStack(error.stack)\n      file = stackInfo.file\n      line = stackInfo.line\n    }\n\n    // 创建错误对象\n    const traceError: TraceError = {\n      type,\n      level,\n      message,\n      code,\n      stack: error?.stack,\n      context,\n      details: error?.details,\n      source: source || 'unknown',\n      file,\n      line,\n      timestamp: Date.now(),\n      id: this.generateErrorId(),\n      event: context?.event,\n      userId: context?.userId,\n      deviceId: context?.deviceId\n    }\n\n    // 添加到错误队列\n    this.errors.push(traceError)\n\n    // 限制错误队列大小\n    if (this.errors.length > this.config.maxErrors) {\n      this.errors.shift()\n    }\n\n    // 更新错误统计\n    this.updateStats(traceError)\n\n    // 记录错误日志\n    this.logError(traceError)\n    \n    // 检查错误率是否过高\n    this.checkErrorRate(traceError)\n    \n    return traceError\n  }\n\n  /**\n   * 检查错误率\n   * @private\n   * @param {TraceError} error - 错误对象\n   */\n  private checkErrorRate(error: TraceError): void {\n    // 检查错误率是否过高\n    if (this.stats.rate.lastMinute > 10) {\n      // 每分钟超过10个错误，可能存在问题\n      if (typeof console !== 'undefined') {\n        console.warn('[Node-Trace] High error rate detected:', {\n          errorsPerMinute: this.stats.rate.lastMinute,\n          consecutiveErrors: this.stats.consecutiveErrors,\n          maxConsecutiveErrors: this.stats.maxConsecutiveErrors\n        })\n      }\n    }\n    \n    // 检查连续错误数\n    if (this.stats.consecutiveErrors > 5) {\n      // 连续超过5个错误，可能存在严重问题\n      if (typeof console !== 'undefined') {\n        console.error('[Node-Trace] Critical error sequence detected:', {\n          consecutiveErrors: this.stats.consecutiveErrors,\n          lastError: error,\n          recentErrors: this.errors.slice(-3)\n        })\n      }\n    }\n  }\n\n  /**\n   * 记录错误日志\n   * @private\n   * @param {TraceError} error - 错误对象\n   */\n  private logError(error: TraceError): void {\n    const debugEnabled = state.options?.debug || false\n    const shouldLog = this.shouldLog(error.level)\n\n    if (debugEnabled && shouldLog) {\n      const prefix = `[Node-Trace] [${error.type.toUpperCase()}]${error.code ? ` [${error.code}]` : ''}`\n      const contextStr = error.context ? ` Context: ${JSON.stringify(error.context)}` : ''\n      const detailsStr = error.details ? ` Details: ${JSON.stringify(error.details)}` : ''\n      const stackStr = error.stack ? `\\nStack: ${error.stack}` : ''\n      const errorIdStr = ` ErrorID: ${error.id}`\n\n      switch (error.level) {\n        case 'debug':\n          console.debug(`${prefix} ${error.message}${errorIdStr}${contextStr}${detailsStr}${stackStr}`)\n          break\n        case 'info':\n          console.info(`${prefix} ${error.message}${errorIdStr}${contextStr}${detailsStr}${stackStr}`)\n          break\n        case 'warn':\n          console.warn(`${prefix} ${error.message}${errorIdStr}${contextStr}${detailsStr}${stackStr}`)\n          break\n        case 'error':\n          console.error(`${prefix} ${error.message}${errorIdStr}${contextStr}${detailsStr}${stackStr}`)\n          break\n        case 'fatal':\n          console.error(`${prefix} [FATAL] ${error.message}${errorIdStr}${contextStr}${detailsStr}${stackStr}`)\n          break\n      }\n    }\n  }\n\n  /**\n   * 获取错误统计\n   * @returns {Object} 错误统计信息\n   */\n  public getStats(): {\n    total: number\n    byType: Record<ErrorType, number>\n    byLevel: Record<ErrorLevel, number>\n    byCode: Record<string, number>\n    rate: {\n      lastMinute: number\n      lastHour: number\n    }\n    consecutiveErrors: number\n    maxConsecutiveErrors: number\n  } {\n    return {\n      ...this.stats\n    }\n  }\n\n  /**\n   * 获取最近的错误\n   * @param {number} [count=10] - 错误数量\n   * @returns {TraceError[]} 最近的错误列表\n   */\n  public getRecentErrors(count: number = 10): TraceError[] {\n    return this.errors.slice(-count)\n  }\n\n  \n\n  /**\n   * 检查是否有错误\n   * @returns {boolean} 是否有错误\n   */\n  public hasErrors(): boolean {\n    return this.errors.length > 0\n  }\n\n  /**\n   * 获取错误摘要\n   * @returns {Object} 错误摘要\n   */\n  public getErrorSummary(): {\n    total: number\n    lastError: TraceError | null\n    mostFrequentType: ErrorType | null\n    mostFrequentLevel: ErrorLevel | null\n    rate: {\n      lastMinute: number\n      lastHour: number\n    }\n  } {\n    if (this.errors.length === 0) {\n      return {\n        total: 0,\n        lastError: null,\n        mostFrequentType: null,\n        mostFrequentLevel: null,\n        rate: {\n          lastMinute: 0,\n          lastHour: 0\n        }\n      }\n    }\n\n    // 找到最频繁的错误类型\n    let mostFrequentType: ErrorType | null = null\n    let maxTypeCount = 0\n    Object.entries(this.stats.byType).forEach(([type, count]) => {\n      if (count > maxTypeCount) {\n        maxTypeCount = count\n        mostFrequentType = type as ErrorType\n      }\n    })\n\n    // 找到最频繁的错误级别\n    let mostFrequentLevel: ErrorLevel | null = null\n    let maxLevelCount = 0\n    Object.entries(this.stats.byLevel).forEach(([level, count]) => {\n      if (count > maxLevelCount) {\n        maxLevelCount = count\n        mostFrequentLevel = level as ErrorLevel\n      }\n    })\n\n    return {\n      total: this.stats.total,\n      lastError: this.errors[this.errors.length - 1],\n      mostFrequentType,\n      mostFrequentLevel,\n      rate: {\n        lastMinute: this.stats.rate.lastMinute,\n        lastHour: this.stats.rate.lastHour\n      }\n    }\n  }\n\n  /**\n   * 检查是否应该记录该级别的错误\n   * @private\n   * @param {ErrorLevel} level - 错误级别\n   * @returns {boolean} 是否应该记录\n   */\n  private shouldLog(level: ErrorLevel): boolean {\n    const levelOrder = ['debug', 'info', 'warn', 'error', 'fatal']\n    const configLevelIndex = levelOrder.indexOf(this.config.logLevel)\n    const errorLevelIndex = levelOrder.indexOf(level)\n    return errorLevelIndex >= configLevelIndex\n  }\n\n  /**\n   * 获取错误队列\n   * @returns {TraceError[]} 错误队列\n   */\n  public getErrors(): TraceError[] {\n    return [...this.errors]\n  }\n\n  /**\n   * 清空错误队列\n   */\n  public clearErrors(): void {\n    this.errors = []\n  }\n\n  /**\n   * 处理网络错误\n   * @param {any} error - 错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   */\n  public handleNetworkError(error: any, context?: Record<string, any>): void {\n    this.captureError('network', 'Network error occurred', error, context)\n  }\n\n  /**\n   * 处理存储错误\n   * @param {any} error - 错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   */\n  public handleStorageError(error: any, context?: Record<string, any>): void {\n    this.captureError('storage', 'Storage error occurred', error, context, 'warn')\n  }\n\n  /**\n   * 处理浏览器 API 错误\n   * @param {any} error - 错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   */\n  public handleBrowserError(error: any, context?: Record<string, any>): void {\n    this.captureError('browser', 'Browser API error occurred', error, context, 'warn')\n  }\n\n  /**\n   * 处理插件错误\n   * @param {any} error - 错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   */\n  public handlePluginError(error: any, context?: Record<string, any>): void {\n    this.captureError('plugin', 'Plugin error occurred', error, context)\n  }\n\n  /**\n   * 处理队列错误\n   * @param {any} error - 错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   */\n  public handleQueueError(error: any, context?: Record<string, any>): void {\n    this.captureError('queue', 'Queue error occurred', error, context)\n  }\n\n  /**\n   * 处理设备 ID 错误\n   * @param {any} error - 错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   */\n  public handleDeviceError(error: any, context?: Record<string, any>): void {\n    this.captureError('device', 'Device ID error occurred', error, context, 'warn')\n  }\n\n  /**\n   * 处理会话错误\n   * @param {any} error - 错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   */\n  public handleSessionError(error: any, context?: Record<string, any>): void {\n    this.captureError('session', 'Session error occurred', error, context, 'warn')\n  }\n\n  /**\n   * 处理行为错误\n   * @param {any} error - 错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   */\n  public handleBehaviorError(error: any, context?: Record<string, any>): void {\n    this.captureError('behavior', 'Behavior error occurred', error, context, 'warn')\n  }\n\n  /**\n   * 处理数据错误\n   * @param {any} error - 错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   */\n  public handleDataError(error: any, context?: Record<string, any>): void {\n    this.captureError('data', 'Data processing error occurred', error, context)\n  }\n\n  /**\n   * 处理未知错误\n   * @param {any} error - 错误对象\n   * @param {Record<string, any>} [context] - 错误上下文\n   */\n  public handleUnknownError(error: any, context?: Record<string, any>): void {\n    this.captureError('unknown', 'Unknown error occurred', error, context)\n  }\n}\n\n/**\n * 错误处理器实例\n */\nexport const errorHandler = new ErrorHandler()\n\n/**\n * 记录错误\n * @param {ErrorType} type - 错误类型\n * @param {string} message - 错误消息\n * @param {any} [error] - 原始错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n * @param {ErrorLevel} [level=error] - 错误级别\n */\nexport function captureError(\n  type: ErrorType,\n  message: string,\n  error?: any,\n  context?: Record<string, any>,\n  level: ErrorLevel = 'error'\n): void {\n  errorHandler.captureError(type, message, error, context, level)\n}\n\n/**\n * 处理网络错误\n * @param {any} error - 错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n */\nexport function handleNetworkError(error: any, context?: Record<string, any>): void {\n  errorHandler.handleNetworkError(error, context)\n}\n\n/**\n * 处理存储错误\n * @param {any} error - 错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n */\nexport function handleStorageError(error: any, context?: Record<string, any>): void {\n  errorHandler.handleStorageError(error, context)\n}\n\n/**\n * 处理浏览器 API 错误\n * @param {any} error - 错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n */\nexport function handleBrowserError(error: any, context?: Record<string, any>): void {\n  errorHandler.handleBrowserError(error, context)\n}\n\n/**\n * 处理插件错误\n * @param {any} error - 错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n */\nexport function handlePluginError(error: any, context?: Record<string, any>): void {\n  errorHandler.handlePluginError(error, context)\n}\n\n/**\n * 处理队列错误\n * @param {any} error - 错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n */\nexport function handleQueueError(error: any, context?: Record<string, any>): void {\n  errorHandler.handleQueueError(error, context)\n}\n\n/**\n * 处理设备 ID 错误\n * @param {any} error - 错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n */\nexport function handleDeviceError(error: any, context?: Record<string, any>): void {\n  errorHandler.handleDeviceError(error, context)\n}\n\n/**\n * 处理会话错误\n * @param {any} error - 错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n */\nexport function handleSessionError(error: any, context?: Record<string, any>): void {\n  errorHandler.handleSessionError(error, context)\n}\n\n/**\n * 处理行为错误\n * @param {any} error - 错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n */\nexport function handleBehaviorError(error: any, context?: Record<string, any>): void {\n  errorHandler.handleBehaviorError(error, context)\n}\n\n/**\n * 处理数据错误\n * @param {any} error - 错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n */\nexport function handleDataError(error: any, context?: Record<string, any>): void {\n  errorHandler.handleDataError(error, context)\n}\n\n/**\n * 处理未知错误\n * @param {any} error - 错误对象\n * @param {Record<string, any>} [context] - 错误上下文\n */\nexport function handleUnknownError(error: any, context?: Record<string, any>): void {\n  errorHandler.handleUnknownError(error, context)\n}\n","/**\n * 导入Dexie数据库库\n */\nimport Dexie, { Table } from \"dexie\";\n/**\n * 导入事件负载类型\n */\nimport { Payload } from \"./types\";\n\n/**\n * NodeTrace数据库类\n * 扩展自Dexie，用于存储离线事件\n */\nclass NodeTraceDB extends Dexie {\n  /**\n   * 离线事件表\n   */\n  offlineEvents!: Table<Payload>;\n\n  /**\n   * 构造函数\n   */\n  constructor() {\n    super(\"nodeTraceDb\");\n    this.version(1).stores({\n      offlineEvents: \"id, event, timestamp\",\n    });\n  }\n}\n\n\n/**\n * 数据库实例\n */\nconst db = new NodeTraceDB();\n\n/**\n * Dexie存储类\n * 用于管理离线事件的存储操作\n */\nexport class DexieStorage {\n  /**\n   * 获取所有离线事件\n   * @returns {Promise<Payload[]>} 离线事件数组\n   */\n  async all(): Promise<Payload[]> {\n    try {\n      return await db.offlineEvents.toArray();\n    } catch {\n      return [];\n    }\n  }\n\n  /**\n   * 添加离线事件\n   * @param {Payload[]} events - 要添加的事件数组\n   * @returns {Promise<void>}\n   */\n  async add(events: Payload[]): Promise<void> {\n    try {\n      await db.offlineEvents.bulkAdd(events);\n    } catch {\n      // 忽略存储错误\n    }\n  }\n\n  /**\n * 清除所有离线事件\n * @returns {Promise<void>}\n */\nasync clear(): Promise<void> {\n  try {\n    await db.offlineEvents.clear();\n  } catch {\n    // 忽略存储错误\n  }\n}\n\n/**\n * 根据ID删除离线事件\n * @param {string[]} ids - 要删除的事件ID数组\n * @returns {Promise<void>}\n */\nasync delete(ids: string[]): Promise<void> {\n  try {\n    if (ids.length > 0) {\n      await db.offlineEvents.bulkDelete(ids);\n    }\n  } catch {\n    // 忽略存储错误\n  }\n}\n}\n\n\n/**\n * Dexie存储实例\n */\nexport const DB = new DexieStorage();","import type { Payload, EventProperties } from \"../types\";\nimport { QUEUE_CONSTANTS } from \"./constants\";\nimport { EventDedupe } from \"./dedupe\";\nimport { sender } from \"./sender\";\nimport { plugins } from \"../core\";\nimport { handleNetworkError, handlePluginError } from \"../error\";\nimport { DB } from \"../db\";\nimport { isBrowser } from \"../utils\";\n\n/**\n * 队列统计信息\n */\nexport interface QueueStats {\n  totalEvents: number;\n  sendSuccessCount: number;\n  sendFailCount: number;\n  averageSendTime: number;\n  lastSendTime: number;\n}\n\n/**\n * 队列配置\n */\nexport interface QueueConfig {\n  maxQueueSize: number;\n  batchSize: number;\n  batchInterval: number;\n  retryCount: number;\n  retryInterval: number;\n  offlineEnabled: boolean;\n  debug: boolean;\n  endpoint: string;\n  appId: string;\n  appKey?: string;\n  headers?: Record<string, string>;\n  timeout?: number;\n}\n\n/**\n * 队列管理器\n */\nexport class QueueManager {\n  private queue: Payload<EventProperties>[];\n  private dedupe: EventDedupe;\n  private stats: QueueStats;\n  private config: QueueConfig | null;\n  private timer: ReturnType<typeof setTimeout> | null;\n  private retryTimers: ReturnType<typeof setTimeout>[];\n  private offlineCheckTimer: ReturnType<typeof setInterval> | null;\n\n  constructor() {\n    this.queue = [];\n    this.dedupe = new EventDedupe(QUEUE_CONSTANTS.DEDUPE_CACHE_MAX_SIZE);\n    this.stats = {\n      totalEvents: 0,\n      sendSuccessCount: 0,\n      sendFailCount: 0,\n      averageSendTime: 0,\n      lastSendTime: 0,\n    };\n    this.config = null;\n    this.timer = null;\n    this.retryTimers = [];\n    this.offlineCheckTimer = null;\n  }\n\n  /**\n   * 初始化队列\n   */\n  init(config: QueueConfig): void {\n    this.config = config;\n    this.startOfflineCheck();\n  }\n\n  /**\n   * 计算队列压力 (0-1)\n   */\n  private calculatePressure(): number {\n    if (!this.config) return 0;\n    return this.queue.length / this.config.maxQueueSize;\n  }\n\n  /**\n   * 获取动态批量大小\n   */\n  private getDynamicBatchSize(): number {\n    if (!this.config) return QUEUE_CONSTANTS.DEFAULT_BATCH_SIZE;\n\n    const pressure = this.calculatePressure();\n    let batchSize = this.config.batchSize;\n\n    if (pressure > QUEUE_CONSTANTS.QUEUE_PRESSURE_MEDIUM) {\n      batchSize = Math.max(\n        Math.floor(batchSize * 0.8),\n        QUEUE_CONSTANTS.MIN_BATCH_SIZE,\n      );\n    } else if (pressure < QUEUE_CONSTANTS.QUEUE_PRESSURE_LOW) {\n      batchSize = Math.min(\n        Math.ceil(batchSize * 1.2),\n        QUEUE_CONSTANTS.MAX_BATCH_SIZE,\n      );\n    }\n\n    return Math.min(batchSize, this.queue.length);\n  }\n\n  /**\n   * 获取动态发送间隔\n   */\n  private getDynamicInterval(): number {\n    if (!this.config) return QUEUE_CONSTANTS.DEFAULT_BATCH_INTERVAL;\n\n    const pressure = this.calculatePressure();\n    let interval = this.config.batchInterval;\n\n    if (pressure > QUEUE_CONSTANTS.QUEUE_PRESSURE_MEDIUM) {\n      interval = Math.max(interval * 0.5, QUEUE_CONSTANTS.MIN_BATCH_INTERVAL);\n    } else if (pressure < QUEUE_CONSTANTS.QUEUE_PRESSURE_LOW) {\n      interval = Math.min(interval * 1.5, QUEUE_CONSTANTS.MAX_BATCH_INTERVAL);\n    }\n\n    return interval;\n  }\n\n  /**\n   * 处理队列满的情况\n   */\n  private handleQueueFull(): void {\n    if (!this.config) return;\n\n    const pressure = this.calculatePressure();\n    let removeCount = 1;\n\n    if (pressure > QUEUE_CONSTANTS.QUEUE_PRESSURE_VERY_HIGH) {\n      removeCount = Math.min(\n        Math.ceil(this.queue.length * QUEUE_CONSTANTS.QUEUE_CLEANUP_RATIO),\n        QUEUE_CONSTANTS.MAX_CLEANUP_COUNT,\n      );\n    } else if (pressure > QUEUE_CONSTANTS.QUEUE_PRESSURE_HIGH) {\n      removeCount = Math.min(Math.ceil(this.queue.length * 0.05), 5);\n    }\n\n    const removedEvents = this.queue.splice(0, removeCount);\n    this.dedupe.removeBatch(removedEvents);\n\n    if (this.config.debug) {\n      console.log(\"[Node-Trace] Queue full, removed events:\", removeCount);\n    }\n  }\n\n  /**\n   * 推送事件到队列\n   */\n  push<T extends EventProperties>(event: Payload<T>): void {\n    if (this.dedupe.exists(event)) {\n      if (this.config?.debug) {\n        console.log(\n          \"[Node-Trace] Event already exists, skipping:\",\n          event.event,\n        );\n      }\n      return;\n    }\n\n    if (!this.config) {\n      this.queue.push(event);\n      this.dedupe.add(event);\n      return;\n    }\n\n    if (this.queue.length >= this.config.maxQueueSize) {\n      this.handleQueueFull();\n    }\n\n    this.queue.push(event);\n    this.dedupe.add(event);\n    this.stats.totalEvents++;\n\n    if (this.config.debug) {\n      console.log(\"[Node-Trace] Event pushed:\", event.event);\n      console.log(\"[Node-Trace] Queue length:\", this.queue.length);\n    }\n\n    const pressure = this.calculatePressure();\n    if (pressure > QUEUE_CONSTANTS.QUEUE_PRESSURE_HIGH) {\n      this.flush();\n    } else {\n      this.schedule();\n    }\n  }\n\n  /**\n   * 调度发送任务\n   */\n  private schedule(): void {\n    if (this.timer) return;\n\n    const interval = this.getDynamicInterval();\n    this.timer = setTimeout(() => {\n      this.flush();\n    }, interval);\n  }\n\n  /**\n   * 更新发送统计\n   */\n  private updateStats(sendTime: number, success: boolean): void {\n    this.stats.lastSendTime = Date.now();\n\n    if (success) {\n      this.stats.sendSuccessCount++;\n    } else {\n      this.stats.sendFailCount++;\n    }\n\n    const totalSends = this.stats.sendSuccessCount + this.stats.sendFailCount;\n    if (totalSends > 0) {\n      this.stats.averageSendTime =\n        (this.stats.averageSendTime * (totalSends - 1) + sendTime) / totalSends;\n    }\n  }\n\n  /**\n   * 处理发送失败\n   */\n  private async handleSendFailure(\n    batch: Payload<EventProperties>[],\n  ): Promise<void> {\n    if (!this.config) return;\n\n    if (this.config.debug) {\n      console.log(\"[Node-Trace] Send failed, batch size:\", batch.length);\n    }\n\n    if (this.config.offlineEnabled && isBrowser()) {\n      try {\n        await DB.add(batch);\n        if (this.config.debug) {\n          console.log(\"[Node-Trace] Events cached offline:\", batch.length);\n        }\n      } catch (error) {\n        handleNetworkError(error, { eventCount: batch.length });\n      }\n    } else if (this.config.retryCount > 0) {\n      const baseInterval = this.config.retryInterval;\n      const retryInterval =\n        baseInterval *\n        Math.pow(2, this.stats.sendFailCount % QUEUE_CONSTANTS.MAX_RETRY_COUNT);\n\n      const retryTimer = setTimeout(() => {\n        this.queue.unshift(...batch);\n        batch.forEach((event) => this.dedupe.add(event));\n        if (this.config?.debug) {\n          console.log(\"[Node-Trace] Retrying events:\", batch.length);\n        }\n        this.schedule();\n      }, retryInterval);\n\n      this.retryTimers.push(retryTimer);\n    }\n  }\n\n  /**\n   * 处理发送成功\n   */\n  private async handleSendSuccess(\n    batch: Payload<EventProperties>[],\n  ): Promise<void> {\n    if (this.config?.debug) {\n      console.log(\"[Node-Trace] Events sent successfully:\", batch.length);\n    }\n\n    if (isBrowser()) {\n      await DB.clear();\n    }\n  }\n\n  /**\n   * 调用插件的 beforeSend 钩子\n   */\n  private applyBeforeSendHooks(\n    batch: Payload<EventProperties>[],\n  ): Payload<EventProperties>[] {\n    const sortedPlugins = plugins.sort();\n    let result = batch;\n\n    for (const plugin of sortedPlugins) {\n      if (plugin.beforeSend) {\n        try {\n          result = plugin.beforeSend(result);\n        } catch (error) {\n          handlePluginError(error, {\n            plugin: plugin.name,\n            context: \"beforeSend\",\n          });\n        }\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * 调用插件的 afterSend 钩子\n   */\n  private applyAfterSendHooks(\n    batch: Payload<EventProperties>[],\n    success: boolean,\n  ): void {\n    const sortedPlugins = plugins.getAll();\n\n    for (const plugin of sortedPlugins) {\n      if (plugin.afterSend) {\n        try {\n          plugin.afterSend(batch, success);\n        } catch (error) {\n          handlePluginError(error, {\n            plugin: plugin.name,\n            context: \"afterSend\",\n          });\n        }\n      }\n    }\n  }\n\n  /**\n   * 发送队列中的事件\n   */\n  async flush(): Promise<void> {\n    if (!this.config || this.queue.length === 0) {\n      return;\n    }\n\n    const batchSize = this.getDynamicBatchSize();\n    const batch = this.queue.splice(0, batchSize);\n    this.dedupe.removeBatch(batch);\n\n    const processedBatch = this.applyBeforeSendHooks(batch);\n\n    const result = await sender.send({\n      endpoint: this.config.endpoint,\n      data: {\n        appId: this.config.appId,\n        appKey: this.config.appKey,\n        events: processedBatch,\n      },\n      timeout: this.config.timeout,\n      headers: this.config.headers,\n      debug: this.config.debug,\n    });\n\n    this.updateStats(result.time, result.success);\n    this.applyAfterSendHooks(processedBatch, result.success);\n\n    if (result.success) {\n      await this.handleSendSuccess(processedBatch);\n    } else {\n      await this.handleSendFailure(processedBatch);\n    }\n\n    this.timer = null;\n  }\n\n  /**\n   * 启动离线事件检查\n   */\n  private startOfflineCheck(): void {\n    if (!isBrowser() || this.offlineCheckTimer) {\n      return;\n    }\n\n    if (!this.config?.offlineEnabled) {\n      return;\n    }\n\n    this.offlineCheckTimer = setInterval(async () => {\n      await this.restoreOfflineEvents();\n    }, QUEUE_CONSTANTS.OFFLINE_CHECK_INTERVAL);\n  }\n\n  /**\n   * 恢复离线事件\n   */\n  async restoreOfflineEvents(): Promise<void> {\n    if (!isBrowser()) return;\n\n    try {\n      const offlineEvents = await DB.all();\n      if (offlineEvents.length === 0) {\n        return;\n      }\n\n      const queueEventKeys = new Set<string>();\n      this.queue.forEach((event) => {\n        const key = `${event.id}_${event.event}_${event.timestamp}`;\n        queueEventKeys.add(key);\n      });\n\n      const eventsToAdd = offlineEvents.filter((offlineEvent) => {\n        const key = `${offlineEvent.id}_${offlineEvent.event}_${offlineEvent.timestamp}`;\n        return !queueEventKeys.has(key);\n      });\n\n      if (eventsToAdd.length > 0) {\n        const idsToDelete = eventsToAdd.map((event) => event.id);\n\n        if (idsToDelete.length > 0) {\n          await DB.delete(idsToDelete);\n        }\n\n        this.queue.unshift(...eventsToAdd);\n        eventsToAdd.forEach((event) => this.dedupe.add(event));\n\n        if (this.config?.debug) {\n          console.log(\n            \"[Node-Trace] Restored offline events:\",\n            eventsToAdd.length,\n          );\n        }\n\n        this.schedule();\n      } else {\n        await DB.clear();\n\n        if (this.config?.debug) {\n          console.log(\n            \"[Node-Trace] All offline events are duplicates, cleared\",\n          );\n        }\n      }\n    } catch (error) {\n      handleNetworkError(error, { eventCount: 0 });\n    }\n  }\n\n  /**\n   * 清除所有定时器\n   */\n  clearTimers(): void {\n    if (this.timer) {\n      clearTimeout(this.timer);\n      this.timer = null;\n    }\n\n    this.retryTimers.forEach((t) => clearTimeout(t));\n    this.retryTimers = [];\n\n    if (this.offlineCheckTimer) {\n      clearInterval(this.offlineCheckTimer);\n      this.offlineCheckTimer = null;\n    }\n  }\n\n  /**\n   * 获取队列统计信息\n   */\n  getStats(): QueueStats {\n    return { ...this.stats };\n  }\n\n  /**\n   * 获取队列长度\n   */\n  length(): number {\n    return this.queue.length;\n  }\n\n  /**\n   * 清空队列\n   */\n  clear(): void {\n    this.queue = [];\n    this.dedupe.clear();\n  }\n}\n\n/**\n * 队列管理器实例\n */\nexport const queueManager = new QueueManager();\n","/**\n * 队列管理模块\n * 负责事件的推送、调度、发送和离线缓存等功能\n * 重构为模块化架构，提高可维护性和可测试性\n */\n\nimport type { Payload, EventProperties } from './types'\nimport { queueManager } from './queue/manager'\nimport { QUEUE_CONSTANTS } from './queue/constants'\n\n/**\n * 推送事件到队列\n * @template T\n * @param {Payload<T>} event - 事件数据\n */\nexport function push<T extends EventProperties>(event: Payload<T>) {\n  queueManager.push(event)\n}\n\n/**\n * 发送队列中的事件\n */\nexport async function flush() {\n  await queueManager.flush()\n}\n\n/**\n * 清除所有定时器\n */\nexport function clearTimers() {\n  queueManager.clearTimers()\n}\n\n/**\n * 启动离线事件检查定时器\n */\nexport function startOfflineCheckTimer() {\n  // 队列管理器会在 init 时启动离线检查\n  // 这里保留为空函数以保持向后兼容\n}\n\n/**\n * 导出队列常量\n */\nexport { QUEUE_CONSTANTS }\n","/**\n * 核心模块\n * 包含初始化、事件跟踪、插件管理等核心功能\n */\n\nimport { push, startOfflineCheckTimer, clearTimers } from './queue'\nimport { queueManager } from './queue/manager'\nimport { now, stringUtils } from './utils'\nimport { handlePluginError } from './error'\nimport type { Options, Payload, IPlugin, IPluginContext, EventProperties, PluginLifecycle } from './types'\n\n/**\n * 默认配置常量\n */\nexport const DEFAULT_OPTIONS = {\n  /**\n   * 默认应用密钥\n   */\n  appKey: '',\n  /**\n   * 默认调试模式\n   */\n  debug: false,\n  /**\n   * 默认采样率\n   */\n  sampleRate: 1,\n  /**\n   * 默认黑名单\n   */\n  blacklist: [],\n  /**\n   * 默认白名单\n   */\n  whitelist: undefined,\n  /**\n   * 默认批量发送大小\n   */\n  batchSize: 20,\n  /**\n   * 默认批量发送间隔（毫秒）\n   */\n  batchInterval: 1000,\n  /**\n   * 默认离线缓存启用状态\n   */\n  offlineEnabled: false,\n  /**\n   * 默认最大队列大小\n   */\n  maxQueueSize: 1000,\n  /**\n   * 默认重试次数\n   */\n  retryCount: 3,\n  /**\n   * 默认重试间隔（毫秒）\n   */\n  retryInterval: 1000,\n  /**\n   * 默认请求头\n   */\n  headers: {},\n  /**\n   * 默认超时时间（毫秒）\n   */\n  timeout: 30000,\n  /**\n   * 默认发送前回调\n   */\n  beforeSend: undefined,\n}\n\n/**\n * 全局状态管理\n */\nexport const state = {\n  /**\n   * 配置选项\n   * @type {Options | null}\n   */\n  options: null as Options | null,\n  /**\n   * 事件队列\n   * @type {Payload<EventProperties>[]}\n   */\n  queue: [] as Payload<EventProperties>[],\n  /**\n   * 插件列表\n   * @type {IPlugin[]}\n   */\n  plugins: [] as IPlugin[],\n  /**\n   * 排序后的插件缓存\n   * @type {IPlugin[] | null}\n   */\n  sortedPluginsCache: null as IPlugin[] | null\n}\n\n/**\n * 插件管理器\n * 负责插件的注册、初始化、销毁等操作\n */\nclass Plugins {\n  /**\n   * 插件映射\n   * @private\n   * @type {Map<string, IPlugin>}\n   */\n  private plugins: Map<string, IPlugin> = new Map()\n\n  /**\n   * 创建插件上下文\n   * @private\n   * @returns {IPluginContext} 插件上下文\n   */\n  private createPluginContext(): IPluginContext {\n    return {\n      getPlugins: () => this,\n      getPlugin: (name: string) => this.plugins.get(name) || null,\n      getAllPlugins: () => this.getAll(),\n      callPluginMethod: (pluginName: string, methodName: string, ...args: any[]) => {\n        const plugin = this.plugins.get(pluginName)\n        if (plugin && typeof (plugin as any)[methodName] === 'function') {\n          return (plugin as any)[methodName](...args)\n        }\n        return null\n      }\n    }\n  }\n\n  /**\n   * 注册插件\n   * @param {IPlugin} plugin - 插件实例\n   * @returns {boolean} 是否注册成功\n   */\n  register(plugin: IPlugin): boolean {\n    try {\n      // 检查插件名称是否已存在\n      if (this.plugins.has(plugin.name)) {\n        console.warn(`[Node-Trace] Plugin ${plugin.name} already registered`)\n        return false\n      }\n\n      // 检查插件依赖\n      if (plugin.dependencies && plugin.dependencies.length > 0) {\n        for (const dep of plugin.dependencies) {\n          if (!this.plugins.has(dep)) {\n            console.warn(`[Node-Trace] Plugin ${plugin.name} depends on ${dep}, which is not registered`)\n            return false\n          }\n        }\n      }\n\n      // 检查插件冲突\n      if (plugin.conflicts && plugin.conflicts.length > 0) {\n        for (const conflict of plugin.conflicts) {\n          if (this.plugins.has(conflict)) {\n            console.warn(`[Node-Trace] Plugin ${plugin.name} conflicts with ${conflict}`)\n            return false\n          }\n        }\n      }\n\n      // 初始化插件状态\n      plugin.lifecycle = 'idle'\n      plugin.enabled = true\n      plugin.priority = plugin.priority || 0\n\n      // 注册插件\n      this.plugins.set(plugin.name, plugin)\n      \n      // 清除插件排序缓存\n      state.sortedPluginsCache = null\n      \n      return true\n    } catch (error) {\n      handlePluginError(error, { plugin: plugin.name })\n      return false\n    }\n  }\n\n  /**\n   * 初始化插件\n   * @param {IPlugin} plugin - 插件实例\n   * @returns {boolean} 是否初始化成功\n   */\n  init(plugin: IPlugin): boolean {\n    try {\n      // 更新插件生命周期\n      plugin.lifecycle = 'loading'\n\n      const context = this.createPluginContext()\n\n      // 调用插件的 beforeInit 方法\n      if (plugin.beforeInit) {\n        plugin.beforeInit(context)\n      }\n\n      // 调用插件的 setup 方法\n      if (plugin.setup) {\n        plugin.setup(context)\n      }\n\n      // 调用插件的 init 方法\n      if (plugin.init) {\n        plugin.init(context)\n      }\n\n      // 调用插件的 activate 方法\n      if (plugin.activate) {\n        plugin.activate(context)\n      }\n\n      // 调用插件的 afterInit 方法\n      if (plugin.afterInit) {\n        plugin.afterInit(context)\n      }\n\n      // 更新插件生命周期\n      plugin.lifecycle = 'active'\n      return true\n    } catch (error) {\n      handlePluginError(error, { plugin: plugin.name })\n      plugin.lifecycle = 'error'\n      return false\n    }\n  }\n\n  /**\n   * 销毁插件\n   * @param {IPlugin} plugin - 插件实例\n   * @returns {boolean} 是否销毁成功\n   */\n  destroy(plugin: IPlugin): boolean {\n    try {\n      const context = this.createPluginContext()\n\n      // 调用插件的 beforeDestroy 方法\n      if (plugin.beforeDestroy) {\n        plugin.beforeDestroy(context)\n      }\n\n      // 调用插件的 deactivate 方法\n      if (plugin.deactivate) {\n        plugin.deactivate(context)\n      }\n\n      // 调用插件的 destroy 方法\n      if (plugin.destroy) {\n        plugin.destroy(context)\n      }\n\n      // 调用插件的 afterDestroy 方法\n      if (plugin.afterDestroy) {\n        plugin.afterDestroy(context)\n      }\n\n      // 更新插件生命周期\n      plugin.lifecycle = 'destroyed'\n      return true\n    } catch (error) {\n      handlePluginError(error, { plugin: plugin.name })\n      return false\n    }\n  }\n\n  /**\n   * 获取插件\n   * @param {string} name - 插件名称\n   * @returns {IPlugin | undefined} 插件实例\n   */\n  get(name: string): IPlugin | undefined {\n    return this.plugins.get(name)\n  }\n\n  /**\n   * 获取所有插件\n   * @returns {IPlugin[]} 插件列表\n   */\n  getAll(): IPlugin[] {\n    return Array.from(this.plugins.values())\n  }\n\n  /**\n   * 获取启用的插件\n   * @returns {IPlugin[]} 启用的插件列表\n   */\n  getEnabled(): IPlugin[] {\n    return Array.from(this.plugins.values()).filter(plugin => plugin.enabled)\n  }\n\n  /**\n   * 启用插件\n   * @param {string} name - 插件名称\n   * @returns {boolean} 是否启用成功\n   */\n  enable(name: string): boolean {\n    const plugin = this.plugins.get(name)\n    if (!plugin) return false\n\n    plugin.enabled = true\n    \n    // 清除插件排序缓存\n    state.sortedPluginsCache = null\n    \n    return true\n  }\n\n  /**\n   * 禁用插件\n   * @param {string} name - 插件名称\n   * @returns {boolean} 是否禁用成功\n   */\n  disable(name: string): boolean {\n    const plugin = this.plugins.get(name)\n    if (!plugin) return false\n\n    plugin.enabled = false\n    \n    // 清除插件排序缓存\n    state.sortedPluginsCache = null\n    \n    return true\n  }\n\n  /**\n   * 移除插件\n   * @param {string} name - 插件名称\n   * @returns {boolean} 是否移除成功\n   */\n  remove(name: string): boolean {\n    const plugin = this.plugins.get(name)\n    if (!plugin) return false\n\n    // 销毁插件\n    this.destroy(plugin)\n\n    // 从插件列表中移除\n    const result = this.plugins.delete(name)\n    \n    // 清除插件排序缓存\n    state.sortedPluginsCache = null\n    \n    return result\n  }\n\n  /**\n   * 清空插件\n   */\n  clear(): void {\n    for (const plugin of this.plugins.values()) {\n      this.destroy(plugin)\n    }\n    this.plugins.clear()\n    \n    // 清除插件排序缓存\n    state.sortedPluginsCache = null\n  }\n\n  /**\n   * 按优先级排序插件\n   * @returns {IPlugin[]} 排序后的插件列表\n   */\n  sort(): IPlugin[] {\n    return Array.from(this.plugins.values())\n      .filter(plugin => plugin.enabled)\n      .sort((a, b) => (a.priority || 0) - (b.priority || 0))\n  }\n}\n\n/**\n * 插件管理器实例\n * @type {PluginManager}\n */\nexport const plugins = new Plugins()\n\n/**\n * 初始化配置\n * @param {Options} options - 配置选项\n */\nexport function init(options: Options) {\n  state.options = {\n    ...DEFAULT_OPTIONS,\n    ...options\n  }\n\n  // 初始化队列管理器\n  queueManager.init({\n    maxQueueSize: options.maxQueueSize || 1000,\n    batchSize: options.batchSize || 20,\n    batchInterval: options.batchInterval || 1000,\n    retryCount: options.retryCount || 3,\n    retryInterval: options.retryInterval || 1000,\n    offlineEnabled: options.offlineEnabled || false,\n    debug: options.debug || false,\n    endpoint: options.endpoint,\n    appId: options.appId,\n    appKey: options.appKey,\n    headers: options.headers,\n    timeout: options.timeout,\n  })\n\n  // 启动离线事件检查定时器\n  startOfflineCheckTimer()\n}\n\n/**\n * 使用插件\n * @param {IPlugin} plugin - 插件实例\n */\nexport function use(plugin: IPlugin) {\n  // 注册插件\n  const registered = plugins.register(plugin)\n  if (!registered) {\n    console.warn(`[Node-Trace] Failed to register plugin ${plugin.name}`)\n    return\n  }\n\n  // 初始化插件\n  plugins.init(plugin)\n\n  // 添加到状态中的插件列表\n  state.plugins.push(plugin)\n}\n\n/**\n * 检查是否应该发送事件\n * @param {string} event - 事件名称\n * @returns {boolean} 是否应该发送\n */\nfunction shouldSend(event: string) {\n  const opt = state.options\n  if (!opt) return true\n\n  if (opt.sampleRate && Math.random() > opt.sampleRate) return false\n  if (opt.blacklist?.includes(event)) return false\n  if (opt.whitelist && !opt.whitelist.includes(event)) return false\n\n  return true\n}\n\n/**\n * 跟踪事件\n * @template T\n * @param {string} event - 事件名称\n * @param {T} [properties] - 事件属性\n * @returns {void}\n */\nexport function track<T extends EventProperties>(event: string, properties?: T) {\n  if (!shouldSend(event)) return\n\n  // 生成唯一事件ID\n  const eventId = stringUtils.generateEventId()\n  let payload: Payload<T> = { id: eventId, event, properties, timestamp: now() }\n\n  // 使用排序后的插件列表，确保插件按优先级执行（缓存结果）\n  let allPlugins = state.sortedPluginsCache\n  if (!allPlugins) {\n    allPlugins = plugins.sort()  \n    state.sortedPluginsCache = allPlugins\n  }\n  for (const p of allPlugins) { \n    if (p.onTrack) {\n      try {\n        const r = p.onTrack(payload)\n        if (r === null) return\n        payload = r\n      } catch (error) {\n        handlePluginError(error, { plugin: p.name, event: event })\n      }\n    }\n  }\n\n  const final = state.options?.beforeSend?.(payload)\n  if (final === null) return\n\n  const eventToPush = final || payload\n  push(eventToPush)\n\n  // 调用插件的 onTracked 方法\n  for (const p of allPlugins) {\n    if (p.onTracked) {\n      try {\n        p.onTracked(eventToPush)\n      } catch (error) {\n        handlePluginError(error, { plugin: p.name, event: event })\n      }\n    }\n  }\n}\n","/**\n * 浏览器信息插件\n * 负责获取浏览器数据、设备信息和存储操作\n */\n\nimport { isBrowser } from \"../utils\";\nimport { getDeviceId } from \"./user\";\nimport type { IPlugin, EventProperties, Payload } from \"../types\";\n\n/**\n * 浏览器信息接口\n */\ninterface BrowserInfo {\n  /**\n   * 浏览器名称\n   */\n  name: string;\n  /**\n   * 浏览器主版本\n   */\n  major: string;\n  /**\n   * 渲染引擎\n   */\n  engine: string;\n  /**\n   * 引擎版本\n   */\n  engineVersion: string;\n}\n\n/**\n * 设备类型接口\n */\ninterface DeviceType {\n  /**\n   * 是否为移动设备\n   */\n  isMobile: boolean;\n  /**\n   * 是否为平板设备\n   */\n  isTablet: boolean;\n  /**\n   * 是否为桌面设备\n   */\n  isDesktop: boolean;\n}\n\n/**\n * 浏览器检测结果接口\n */\ninterface BrowserDetectionResult {\n  name: string;\n  version: string;\n  major: string;\n  engine: string;\n  engineVersion: string;\n}\n\n/**\n * 设备检测结果接口\n */\ninterface DeviceDetectionResult {\n  isMobile: boolean;\n  isTablet: boolean;\n  isDesktop: boolean;\n  type: \"mobile\" | \"tablet\" | \"desktop\" | \"unknown\";\n}\n\n/**\n * 浏览器数据接口\n */\nexport interface BrowserData {\n  /**\n   * 设备ID\n   */\n  device_id: string;\n  /**\n   * 事件名称\n   */\n  event: string;\n\n  /**\n   * 用户代理字符串\n   */\n  user_agent: string;\n  /**\n   * 设备宽度\n   */\n  device_width: number;\n  /**\n   * 设备高度\n   */\n  device_height: number;\n  /**\n   * 是否在线\n   */\n  is_online: boolean;\n  /**\n   * 连接类型\n   */\n  connection_type?: string;\n  /**\n   * 下行速度\n   */\n  downlink?: number;\n  /**\n   * 有效连接类型\n   */\n  effective_type?: string;\n  /**\n   * 往返时间\n   */\n  rtt?: number;\n\n  /**\n   * 应用代码名称\n   */\n  app_code_name: string;\n  /**\n   * 应用名称\n   */\n  app_name: string;\n  /**\n   * 语言\n   */\n  language: string;\n  /**\n   * 平台\n   */\n  platform: string;\n  /**\n   * 时区\n   */\n  time_zone: string;\n  /**\n   * 浏览器版本\n   */\n  browser_version?: string;\n  /**\n   * 浏览器名称\n   */\n  browser_name?: string;\n  /**\n   * 浏览器主版本\n   */\n  browser_major_version?: string;\n  /**\n   * 引擎名称\n   */\n  engine_name?: string;\n  /**\n   * 引擎版本\n   */\n  engine_version?: string;\n\n  /**\n   * 设备像素比\n   */\n  device_pixel_ratio: number;\n  /**\n   * 是否为移动设备\n   */\n  is_mobile?: boolean;\n  /**\n   * 是否为平板设备\n   */\n  is_tablet?: boolean;\n  /**\n   * 是否为桌面设备\n   */\n  is_desktop?: boolean;\n\n  /**\n   * 当前URL\n   */\n  current_url: string;\n  /**\n   * 路径名\n   */\n  pathname: string;\n  /**\n   * 主机名\n   */\n  hostname: string;\n  /**\n   * 协议\n   */\n  protocol: string;\n  /**\n   * 端口\n   */\n  port?: string;\n  /**\n   * 搜索参数\n   */\n  search?: string;\n  /**\n   * 哈希\n   */\n  hash?: string;\n\n  /**\n   * 文档URL\n   */\n  document_url: string;\n  /**\n   * 来源URL\n   */\n  referrer_url: string;\n  /**\n   * 内容类型\n   */\n  content_type: string;\n  /**\n   * 文档标题\n   */\n  document_title: string;\n  /**\n   * 文档字符集\n   */\n  document_charset: string;\n  /**\n   * 文档就绪状态\n   */\n  document_ready_state?: string;\n\n  /**\n   * 屏幕宽度\n   */\n  screen_width: number;\n  /**\n   * 屏幕高度\n   */\n  screen_height: number;\n  /**\n   * 可用屏幕宽度\n   */\n  screen_available_width: number;\n  /**\n   * 可用屏幕高度\n   */\n  screen_available_height: number;\n  /**\n   * 屏幕颜色深度\n   */\n  screen_color_depth: number;\n\n  /**\n   * 滚动X坐标\n   */\n  scroll_x: number;\n  /**\n   * 滚动Y坐标\n   */\n  scroll_y: number;\n\n  /**\n   * 国家\n   */\n  country?: string;\n  /**\n   * 地区\n   */\n  region?: string;\n  /**\n   * 城市\n   */\n  city?: string;\n\n  /**\n   * 开始时间\n   */\n  begin_time: number;\n  /**\n   * 其他属性\n   */\n  [propName: string]: unknown;\n}\n\n/**\n * 检测浏览器信息（公共函数）\n * @param {string} userAgent - 用户代理字符串\n * @returns {BrowserDetectionResult} 浏览器检测结果\n */\nfunction detectBrowser(userAgent: string): BrowserDetectionResult {\n  let name = \"unknown\";\n  let version = \"0\";\n  let major = \"0\";\n  let engine = \"Unknown\";\n  let engineVersion = \"0\";\n\n  if (/Chrome/.test(userAgent)) {\n    name = \"Chrome\";\n    version = userAgent.match(/Chrome\\/(\\d+)/)?.[1] || \"0\";\n    major = version;\n    engine = \"Blink\";\n  } else if (/Firefox/.test(userAgent)) {\n    name = \"Firefox\";\n    version = userAgent.match(/Firefox\\/(\\d+)/)?.[1] || \"0\";\n    major = version;\n    engine = \"Gecko\";\n  } else if (/Safari/.test(userAgent) && !/Chrome/.test(userAgent)) {\n    name = \"Safari\";\n    version = userAgent.match(/Version\\/(\\d+)/)?.[1] || \"0\";\n    major = version;\n    engine = \"WebKit\";\n  } else if (/Edge/.test(userAgent)) {\n    name = \"Edge\";\n    version = userAgent.match(/Edge\\/(\\d+)/)?.[1] || \"0\";\n    major = version;\n    engine = \"Blink\";\n  } else if (/MSIE|Trident/.test(userAgent)) {\n    name = \"Internet Explorer\";\n    version = userAgent.match(/MSIE\\s(\\d+)|rv:(\\d+)/)?.[1] || \"0\";\n    major = version;\n    engine = \"Trident\";\n  }\n\n  if (engine === \"WebKit\") {\n    engineVersion = userAgent.match(/WebKit\\/(\\d+)/)?.[1] || \"0\";\n  } else if (engine === \"Gecko\") {\n    engineVersion = userAgent.match(/Gecko\\/(\\d+)/)?.[1] || \"0\";\n  }\n\n  return { name, version, major, engine, engineVersion };\n}\n\n/**\n * 检测设备类型（公共函数）\n * @param {string} userAgent - 用户代理字符串\n * @returns {DeviceDetectionResult} 设备检测结果\n */\nfunction detectDevice(userAgent: string): DeviceDetectionResult {\n  const isMobile =\n    /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/.test(userAgent) &&\n    !/iPad/.test(userAgent);\n  const isTablet =\n    /iPad/.test(userAgent) ||\n    (/Android/.test(userAgent) && !/Mobile/.test(userAgent));\n  const isDesktop = !isMobile && !isTablet;\n\n  let type: \"mobile\" | \"tablet\" | \"desktop\" | \"unknown\" = \"unknown\";\n  if (isMobile) type = \"mobile\";\n  else if (isTablet) type = \"tablet\";\n  else if (isDesktop) type = \"desktop\";\n\n  return { isMobile, isTablet, isDesktop, type };\n}\n\n/**\n * 解析浏览器信息（保留以兼容旧代码）\n * @param {string} userAgent - 用户代理字符串\n * @returns {BrowserInfo} 浏览器信息\n */\nfunction parseBrowserInfo(userAgent: string): BrowserInfo {\n  const result = detectBrowser(userAgent);\n  return {\n    name: result.name,\n    major: result.major,\n    engine: result.engine,\n    engineVersion: result.engineVersion,\n  };\n}\n\n/**\n * 解析设备类型（保留以兼容旧代码）\n * @param {string} userAgent - 用户代理字符串\n * @returns {DeviceType} 设备类型\n */\nfunction parseDeviceType(userAgent: string): DeviceType {\n  const result = detectDevice(userAgent);\n  return {\n    isMobile: result.isMobile,\n    isTablet: result.isTablet,\n    isDesktop: result.isDesktop,\n  };\n}\n\n/**\n * 获取基本浏览器信息\n * @returns {Object} 基本浏览器信息\n */\nfunction getBasicBrowserInfo(): {\n  app_code_name: string;\n  app_name: string;\n  language: string;\n  platform: string;\n  browser_version: string | undefined;\n  user_agent: string;\n} {\n  if (!isBrowser() || typeof navigator === \"undefined\") {\n    return {\n      app_code_name: \"\",\n      app_name: \"\",\n      language: \"\",\n      platform: \"\",\n      browser_version: \"\",\n      user_agent: \"non-browser\",\n    };\n  }\n\n  return {\n    app_code_name: navigator.appCodeName,\n    app_name: navigator.appName,\n    language: navigator.language,\n    platform: navigator.platform,\n    browser_version: (navigator as any).appVersion,\n    user_agent: navigator.userAgent,\n  };\n}\n\n/**\n * 获取浏览器详细信息\n * @param {string} userAgent - 用户代理字符串\n * @returns {Object} 浏览器详细信息\n */\nfunction getDetailedBrowserInfo(userAgent: string): {\n  browser_name: string;\n  browser_major_version: string;\n  engine_name: string;\n  engine_version: string;\n} {\n  const browserInfo = parseBrowserInfo(userAgent);\n  return {\n    browser_name: browserInfo.name,\n    browser_major_version: browserInfo.major,\n    engine_name: browserInfo.engine,\n    engine_version: browserInfo.engineVersion,\n  };\n}\n\n/**\n * 获取设备信息\n * @param {string} userAgent - 用户代理字符串\n * @returns {Object} 设备信息\n */\nfunction getDeviceInfo(userAgent: string): {\n  is_mobile: boolean;\n  is_tablet: boolean;\n  is_desktop: boolean;\n  device_width: number;\n  device_height: number;\n  device_pixel_ratio: number;\n} {\n  if (!isBrowser() || typeof window === \"undefined\") {\n    return {\n      is_mobile: false,\n      is_tablet: false,\n      is_desktop: true,\n      device_width: 0,\n      device_height: 0,\n      device_pixel_ratio: 1,\n    };\n  }\n\n  const deviceType = parseDeviceType(userAgent);\n  return {\n    is_mobile: deviceType.isMobile,\n    is_tablet: deviceType.isTablet,\n    is_desktop: deviceType.isDesktop,\n    device_width: window.innerWidth,\n    device_height: window.innerHeight,\n    device_pixel_ratio: window.devicePixelRatio,\n  };\n}\n\n/**\n * 获取网络状态信息\n * @returns {Object} 网络状态信息\n */\nfunction getNetworkInfo(): {\n  is_online: boolean;\n  connection_type: string;\n  downlink: number | undefined;\n  effective_type: string | undefined;\n  rtt: number | undefined;\n} {\n  if (!isBrowser() || typeof navigator === \"undefined\") {\n    return {\n      is_online: true,\n      connection_type: \"unknown\",\n      downlink: undefined,\n      effective_type: undefined,\n      rtt: undefined,\n    };\n  }\n\n  return {\n    is_online: navigator.onLine,\n    connection_type: (navigator as any).connection?.type || \"unknown\",\n    downlink: (navigator as any).connection?.downlink,\n    effective_type: (navigator as any).connection?.effectiveType,\n    rtt: (navigator as any).connection?.rtt,\n  };\n}\n\n/**\n * 获取屏幕信息\n * @returns {Object} 屏幕信息\n */\nfunction getScreenInfo(): {\n  screen_width: number;\n  screen_height: number;\n  screen_available_width: number;\n  screen_available_height: number;\n  screen_color_depth: number;\n} {\n  if (!isBrowser() || typeof screen === \"undefined\") {\n    return {\n      screen_width: 0,\n      screen_height: 0,\n      screen_available_width: 0,\n      screen_available_height: 0,\n      screen_color_depth: 0,\n    };\n  }\n\n  return {\n    screen_width: screen.width,\n    screen_height: screen.height,\n    screen_available_width: screen.availWidth,\n    screen_available_height: screen.availHeight,\n    screen_color_depth: screen.colorDepth,\n  };\n}\n\n/**\n * 获取页面信息\n * @returns {Object} 页面信息\n */\nfunction getPageInfo(): {\n  current_url: string;\n  pathname: string;\n  hostname: string;\n  protocol: string;\n  port: string;\n  search: string;\n  hash: string;\n  document_url: string;\n  referrer_url: string;\n  content_type: string;\n  document_title: string;\n  document_charset: string;\n  document_ready_state: string;\n} {\n  if (\n    !isBrowser() ||\n    typeof window === \"undefined\" ||\n    typeof document === \"undefined\"\n  ) {\n    return {\n      current_url: \"\",\n      pathname: \"\",\n      hostname: \"\",\n      protocol: \"\",\n      port: \"\",\n      search: \"\",\n      hash: \"\",\n      document_url: \"\",\n      referrer_url: \"\",\n      content_type: \"\",\n      document_title: \"\",\n      document_charset: \"\",\n      document_ready_state: \"loading\",\n    };\n  }\n\n  return {\n    current_url: window.location.href,\n    pathname: window.location.pathname,\n    hostname: window.location.hostname,\n    protocol: window.location.protocol,\n    port: window.location.port,\n    search: window.location.search,\n    hash: window.location.hash,\n    document_url: document.URL,\n    referrer_url: document.referrer,\n    content_type: document.contentType || \"\",\n    document_title: document.title,\n    document_charset: document.characterSet || document.charset || \"\",\n    document_ready_state: document.readyState,\n  };\n}\n\n/**\n * 获取滚动位置信息\n * @returns {Object} 滚动位置信息\n */\nfunction getScrollInfo(): {\n  scroll_x: number;\n  scroll_y: number;\n} {\n  if (\n    !isBrowser() ||\n    typeof window === \"undefined\" ||\n    typeof document === \"undefined\"\n  ) {\n    return {\n      scroll_x: 0,\n      scroll_y: 0,\n    };\n  }\n\n  return {\n    scroll_x: window.pageXOffset || document.documentElement.scrollLeft || 0,\n    scroll_y: window.pageYOffset || document.documentElement.scrollTop || 0,\n  };\n}\n\n/**\n * 浏览器工具函数\n */\nexport const browserUtils = {\n  /**\n   * 检测浏览器类型\n   * @returns {Object} 浏览器信息\n   * @returns {string} name - 浏览器名称\n   * @returns {string} version - 浏览器版本\n   * @returns {string} platform - 平台\n   */\n  getBrowser: (): {\n    name: string;\n    version: string;\n    platform: string;\n  } => {\n    if (!isBrowser() || typeof navigator === \"undefined\") {\n      return {\n        name: \"unknown\",\n        version: \"0\",\n        platform: \"unknown\",\n      };\n    }\n\n    const result = detectBrowser(navigator.userAgent);\n    return {\n      name: result.name,\n      version: result.version,\n      platform: navigator.platform,\n    };\n  },\n\n  /**\n   * 检测设备类型\n   * @returns {('mobile'|'tablet'|'desktop'|'unknown')} 设备类型\n   */\n  getDeviceType: (): \"mobile\" | \"tablet\" | \"desktop\" | \"unknown\" => {\n    if (!isBrowser() || typeof navigator === \"undefined\") {\n      return \"unknown\";\n    }\n\n    const result = detectDevice(navigator.userAgent);\n    return result.type;\n  },\n\n  /**\n   * 检测网络状态\n   * @returns {Object} 网络状态\n   * @returns {('online'|'offline')} type - 网络类型\n   * @returns {('2g'|'3g'|'4g'|'5g'|'unknown')} effectiveType - 有效网络类型\n   * @returns {number} rtt - 往返时间\n   * @returns {number} downlink - 下行速度\n   */\n  getNetworkState: (): {\n    type: \"online\" | \"offline\";\n    effectiveType: \"2g\" | \"3g\" | \"4g\" | \"5g\" | \"unknown\";\n    rtt: number;\n    downlink: number;\n  } => {\n    if (!isBrowser() || typeof navigator === \"undefined\") {\n      return {\n        type: \"offline\",\n        effectiveType: \"unknown\",\n        rtt: 0,\n        downlink: 0,\n      };\n    }\n\n    const type = navigator.onLine ? \"online\" : \"offline\";\n    let effectiveType: \"2g\" | \"3g\" | \"4g\" | \"5g\" | \"unknown\" = \"unknown\";\n    let rtt = 0;\n    let downlink = 0;\n\n    if (\"connection\" in navigator) {\n      const connection = navigator.connection as any;\n      effectiveType = connection.effectiveType || \"unknown\";\n      rtt = connection.rtt || 0;\n      downlink = connection.downlink || 0;\n    }\n\n    return {\n      type,\n      effectiveType,\n      rtt,\n      downlink,\n    };\n  },\n};\n\n/**\n * 存储工具函数\n */\nexport const storageUtils = {\n  /**\n   * 安全获取本地存储\n   * @param {string} key - 存储键\n   * @param {Function} [parser] - 解析函数\n   * @returns {any} 存储值\n   */\n  get: (key: string, parser?: (value: string) => any): any => {\n    if (!isBrowser() || typeof localStorage === \"undefined\") {\n      return null;\n    }\n    try {\n      const value = localStorage.getItem(key);\n      if (value === null) return null;\n      return parser ? parser(value) : value;\n    } catch {\n      return null;\n    }\n  },\n\n  /**\n   * 安全设置本地存储\n   * @param {string} key - 存储键\n   * @param {any} value - 存储值\n   * @returns {boolean} 是否设置成功\n   */\n  set: (key: string, value: any): boolean => {\n    if (!isBrowser() || typeof localStorage === \"undefined\") {\n      return false;\n    }\n    try {\n      const stringValue =\n        typeof value === \"string\" ? value : JSON.stringify(value);\n      localStorage.setItem(key, stringValue);\n      return true;\n    } catch {\n      return false;\n    }\n  },\n\n  /**\n   * 安全移除本地存储\n   * @param {string} key - 存储键\n   * @returns {boolean} 是否移除成功\n   */\n  remove: (key: string): boolean => {\n    if (!isBrowser() || typeof localStorage === \"undefined\") {\n      return false;\n    }\n    try {\n      localStorage.removeItem(key);\n      return true;\n    } catch {\n      return false;\n    }\n  },\n\n  /**\n   * 安全清空本地存储\n   * @returns {boolean} 是否清空成功\n   */\n  clear: (): boolean => {\n    if (!isBrowser() || typeof localStorage === \"undefined\") {\n      return false;\n    }\n    try {\n      localStorage.clear();\n      return true;\n    } catch {\n      return false;\n    }\n  },\n};\n\n/**\n * 获取浏览器数据\n * @returns {BrowserData} 浏览器数据\n */\nexport function getBrowserData(): BrowserData {\n  if (!isBrowser()) {\n    return {\n      device_id: getDeviceId(),\n      event: \"pageview\",\n      user_agent: \"non-browser\",\n      device_width: 0,\n      device_height: 0,\n      is_online: true,\n      connection_type: \"unknown\",\n      app_code_name: \"\",\n      app_name: \"\",\n      language: \"\",\n      platform: \"\",\n      time_zone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n      browser_version: \"\",\n      browser_name: \"non-browser\",\n      browser_major_version: \"0\",\n      engine_name: \"unknown\",\n      engine_version: \"0\",\n      device_pixel_ratio: 1,\n      is_mobile: false,\n      is_tablet: false,\n      is_desktop: true,\n      current_url: \"\",\n      pathname: \"\",\n      hostname: \"\",\n      protocol: \"\",\n      port: \"\",\n      search: \"\",\n      hash: \"\",\n      document_url: \"\",\n      referrer_url: \"\",\n      content_type: \"\",\n      document_title: \"\",\n      document_charset: \"\",\n      document_ready_state: \"loading\",\n      screen_width: 0,\n      screen_height: 0,\n      screen_available_width: 0,\n      screen_available_height: 0,\n      screen_color_depth: 0,\n      scroll_x: 0,\n      scroll_y: 0,\n      begin_time: Date.now(),\n    };\n  }\n\n  try {\n    const basicBrowserInfo = getBasicBrowserInfo();\n    const detailedBrowserInfo = getDetailedBrowserInfo(\n      basicBrowserInfo.user_agent,\n    );\n    const deviceInfo = getDeviceInfo(basicBrowserInfo.user_agent);\n    const networkInfo = getNetworkInfo();\n    const screenInfo = getScreenInfo();\n    const pageInfo = getPageInfo();\n    const scrollInfo = getScrollInfo();\n\n    return {\n      device_id: getDeviceId(),\n      event: \"pageview\",\n      ...basicBrowserInfo,\n      ...deviceInfo,\n      ...networkInfo,\n      ...detailedBrowserInfo,\n      ...screenInfo,\n      ...pageInfo,\n      ...scrollInfo,\n      time_zone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n      begin_time: Date.now(),\n    };\n  } catch (error) {\n    // 如果获取某些信息失败，返回基本数据\n    return {\n      device_id: getDeviceId(),\n      event: \"pageview\",\n      user_agent: navigator?.userAgent || \"unknown\",\n      device_width: window?.innerWidth || 0,\n      device_height: window?.innerHeight || 0,\n      is_online: navigator?.onLine || false,\n      connection_type: (navigator as any)?.connection?.type || \"unknown\",\n      downlink: (navigator as any)?.connection?.downlink,\n      effective_type: (navigator as any)?.connection?.effectiveType,\n      rtt: (navigator as any)?.connection?.rtt,\n      app_code_name: navigator?.appCodeName || \"\",\n      app_name: navigator?.appName || \"\",\n      language: navigator?.language || \"\",\n      platform: navigator?.platform || \"\",\n      time_zone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n      browser_version: (navigator as any)?.appVersion,\n      device_pixel_ratio: window?.devicePixelRatio || 1,\n      is_mobile: false,\n      is_tablet: false,\n      is_desktop: true,\n      current_url: window?.location?.href || \"\",\n      pathname: window?.location?.pathname || \"\",\n      hostname: window?.location?.hostname || \"\",\n      protocol: window?.location?.protocol || \"\",\n      port: window?.location?.port || \"\",\n      search: window?.location?.search || \"\",\n      hash: window?.location?.hash || \"\",\n      document_url: document?.URL || \"\",\n      referrer_url: document?.referrer || \"\",\n      content_type: document?.contentType || \"\",\n      document_title: document?.title || \"\",\n      document_charset: document?.characterSet || document?.charset || \"\",\n      document_ready_state: document?.readyState || \"loading\",\n      screen_width: screen?.width || 0,\n      screen_height: screen?.height || 0,\n      screen_available_width: screen?.availWidth || 0,\n      screen_available_height: screen?.availHeight || 0,\n      screen_color_depth: screen?.colorDepth || 0,\n      scroll_x:\n        window?.pageXOffset || document?.documentElement?.scrollLeft || 0,\n      scroll_y:\n        window?.pageYOffset || document?.documentElement?.scrollTop || 0,\n      begin_time: Date.now(),\n    };\n  }\n}\n\n/**\n * 浏览器插件\n */\nexport const browserPlugin: IPlugin = {\n  name: \"browser\",\n  version: \"1.0.0\",\n  description:\n    \"Browser information plugin for collecting browser data and device information\",\n  priority: 30,\n\n  /**\n   * 事件跟踪前回调\n   */\n  onTrack<T extends EventProperties>(payload: Payload<T>): Payload<T> {\n    // 添加浏览器数据到事件属性\n    try {\n      const browserData = getBrowserData();\n      // 只添加部分关键的浏览器信息，避免事件过大\n      const browserContext = {\n        browser_name: browserData.browser_name,\n        browser_version: browserData.browser_version,\n        device_type: browserData.is_mobile\n          ? \"mobile\"\n          : browserData.is_tablet\n            ? \"tablet\"\n            : \"desktop\",\n        platform: browserData.platform,\n        user_agent: browserData.user_agent,\n        screen_width: browserData.screen_width,\n        screen_height: browserData.screen_height,\n        is_online: browserData.is_online,\n        connection_type: browserData.connection_type,\n        current_url: browserData.current_url,\n        referrer_url: browserData.referrer_url,\n      };\n\n      return {\n        ...payload,\n        properties: {\n          ...payload.properties,\n          ...browserContext,\n        } as unknown as T,\n      };\n    } catch (error) {\n      // 如果获取浏览器数据失败，返回原始payload\n      return payload;\n    }\n  },\n\n  /**\n   * 获取插件信息\n   */\n  getInfo(): Record<string, any> {\n    return {\n      name: this.name,\n      version: this.version,\n      description: this.description,\n      browserData: getBrowserData(),\n      browserUtils: browserUtils.getBrowser(),\n      deviceType: browserUtils.getDeviceType(),\n      networkState: browserUtils.getNetworkState(),\n    };\n  },\n};\n","/**\n * 用户管理插件\n * 负责设备ID和用户ID的生成、存储和管理\n */\n\nimport { isBrowser } from \"../utils\";\nimport { handleBrowserError, handleStorageError } from \"../error\";\nimport { storageUtils } from \"./browser\";\nimport type { IPlugin, EventProperties, Payload } from \"../types\";\n\n/**\n * 设备ID存储键\n */\nconst DEVICE_ID_KEY = \"__analytics_device_id__\";\n\n/**\n * 用户ID存储键\n */\nconst USER_ID_KEY = \"__analytics_user_id__\";\n\n/**\n * 存储非浏览器环境的设备 ID\n */\nlet nonBrowserDeviceId: string | null = null;\n\n/**\n * 默认设备ID长度\n */\nconst DEFAULT_DEVICE_ID_LENGTH = 32;\n\n/**\n * 生成SHA-256哈希\n * @param {string} input - 输入字符串\n * @returns {Promise<string>} SHA-256哈希值\n */\nasync function generateSHA256Hash(input: string): Promise<string> {\n  if (isBrowser() && typeof crypto !== \"undefined\" && crypto.subtle) {\n    // 浏览器环境使用Web Crypto API\n    const encoder = new TextEncoder();\n    const data = encoder.encode(input);\n    const hashBuffer = await crypto.subtle.digest(\"SHA-256\", data);\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\n    return hashArray.map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n  } else if (!isBrowser() && typeof require !== \"undefined\") {\n    // Node.js环境使用crypto模块\n    try {\n      const crypto = require(\"crypto\");\n      return crypto.createHash(\"sha256\").update(input).digest(\"hex\");\n    } catch {\n      // 如果crypto模块不可用，使用回退方案\n      return simpleHash(input);\n    }\n  } else {\n    // 其他环境使用简单哈希作为回退\n    return simpleHash(input);\n  }\n}\n\n/**\n * 简单哈希函数作为回退（改进版，生成更长的哈希值）\n * @param {string} input - 输入字符串\n * @returns {string} 哈希值\n */\nfunction simpleHash(input: string): string {\n  let hash = 0;\n  for (let i = 0; i < input.length; i++) {\n    const char = input.charCodeAt(i);\n    hash = (hash << 5) - hash + char;\n    hash = hash & hash;\n  }\n\n  // 生成更长的哈希值\n  const baseHash = Math.abs(hash).toString(36);\n\n  // 如果哈希值太短，添加额外的随机部分\n  if (baseHash.length < DEFAULT_DEVICE_ID_LENGTH) {\n    const randomPart = Math.random().toString(36).slice(2, 10);\n    return `${baseHash}_${randomPart}`;\n  }\n\n  // 确保哈希值至少有32个字符\n  return baseHash.substring(0, DEFAULT_DEVICE_ID_LENGTH);\n}\n\n/**\n * 同步版本的设备ID生成\n * @returns {string} 设备ID\n */\nfunction generateStableDeviceIdSync(): string {\n  if (!isBrowser()) {\n    // 非浏览器环境，使用固定的 ID\n    if (!nonBrowserDeviceId) {\n      // 首次调用时生成一个固定的 ID\n      const timestamp = Date.now().toString(36);\n      const random = Math.random().toString(36).slice(2, 10);\n      nonBrowserDeviceId = `${timestamp}_${random}`;\n    }\n    return nonBrowserDeviceId;\n  }\n\n  try {\n    // 收集浏览器特征信息\n    const navigatorInfo = {\n      userAgent: navigator.userAgent,\n      platform: navigator.platform,\n      language: navigator.language,\n      hardwareConcurrency: navigator.hardwareConcurrency,\n      deviceMemory: (navigator as any).deviceMemory,\n      screen: {\n        width: screen.width,\n        height: screen.height,\n        colorDepth: screen.colorDepth,\n      },\n      // 增加更多特征信息，提高唯一性\n      vendor: navigator.vendor,\n      appVersion: navigator.appVersion,\n      product: navigator.product,\n      productSub: navigator.productSub,\n      // 增加时间戳的哈希，确保即使特征相同也能生成不同的ID\n      timestampHash: Math.floor(Date.now() / (24 * 60 * 60 * 1000)).toString(), // 每天一个新的哈希\n    };\n\n    // 将特征信息转换为字符串\n    const infoString = JSON.stringify(navigatorInfo);\n\n    // 使用简单哈希作为同步回退\n    return simpleHash(infoString);\n  } catch (error) {\n    // 如果获取浏览器信息失败，使用回退方案\n    handleBrowserError(error, { context: \"device_id_generation\" });\n    const timestamp = Date.now().toString(36);\n    const random = Math.random().toString(36).slice(2, 10);\n    return `${timestamp}_${random}`;\n  }\n}\n\n/**\n * 异步版本的设备ID生成\n * @returns {Promise<string>} 设备ID\n */\nasync function generateDeviceIdAsync(): Promise<string> {\n  if (!isBrowser()) {\n    return generateStableDeviceIdSync();\n  }\n\n  try {\n    // 收集浏览器特征信息\n    const navigatorInfo = {\n      userAgent: navigator.userAgent,\n      platform: navigator.platform,\n      language: navigator.language,\n      hardwareConcurrency: navigator.hardwareConcurrency,\n      deviceMemory: (navigator as any).deviceMemory,\n      screen: {\n        width: screen.width,\n        height: screen.height,\n        colorDepth: screen.colorDepth,\n      },\n      // 增加更多特征信息，提高唯一性\n      vendor: navigator.vendor,\n      appVersion: navigator.appVersion,\n      product: navigator.product,\n      productSub: navigator.productSub,\n    };\n\n    // 将特征信息转换为字符串\n    const infoString = JSON.stringify(navigatorInfo);\n\n    // 使用SHA-256生成哈希\n    const hash = await generateSHA256Hash(infoString);\n    // 取前32位作为设备ID，确保长度合理\n    return hash.substring(0, 32);\n  } catch {\n    // 如果获取浏览器信息失败，使用同步回退方案\n    return generateStableDeviceIdSync();\n  }\n}\n\n/**\n * 设备ID生成函数\n * @returns {string} 设备ID\n */\nfunction generateStableDeviceId(): string {\n  // 优先使用同步版本，确保函数返回类型一致\n  return generateStableDeviceIdSync();\n}\n\n/**\n * 异步版本的设备ID生成\n * @returns {Promise<string>} 设备ID\n */\nexport async function generateStableDeviceIdAsync(): Promise<string> {\n  return generateDeviceIdAsync();\n}\n\n/**\n * 获取设备ID\n * @returns {string} 设备ID\n */\nexport function getDeviceId(): string {\n  if (!isBrowser()) {\n    return generateStableDeviceId();\n  }\n\n  const existingId = storageUtils.get(DEVICE_ID_KEY);\n  if (existingId) {\n    return existingId;\n  }\n\n  const newId = generateStableDeviceId();\n  const success = storageUtils.set(DEVICE_ID_KEY, newId);\n  if (!success) {\n    handleStorageError(new Error(\"Failed to set device ID in localStorage\"), {\n      key: DEVICE_ID_KEY,\n      operation: \"set\",\n    });\n  }\n  return newId;\n}\n\n/**\n * 设置用户ID\n * @param {string} id - 用户ID\n */\nexport function setID(id: string): void {\n  if (!isBrowser()) {\n    return;\n  }\n\n  const success = storageUtils.set(USER_ID_KEY, id);\n  if (!success) {\n    handleStorageError(new Error(\"Failed to set user ID in localStorage\"), {\n      key: USER_ID_KEY,\n      operation: \"set\",\n    });\n  }\n}\n\n/**\n * 获取用户ID\n * @returns {string} 用户ID\n */\nexport function getID(): string {\n  if (!isBrowser()) {\n    return getDeviceId();\n  }\n\n  const userId = storageUtils.get(USER_ID_KEY);\n  if (userId) {\n    return userId;\n  }\n  // 如果没有设置 ID，使用设备唯一标识作为 ID\n  return getDeviceId();\n}\n\n/**\n * 清除用户ID\n */\nexport function clearID(): void {\n  if (!isBrowser()) {\n    return;\n  }\n\n  const success = storageUtils.remove(USER_ID_KEY);\n  if (!success) {\n    handleStorageError(\n      new Error(\"Failed to remove user ID from localStorage\"),\n      { key: USER_ID_KEY, operation: \"remove\" },\n    );\n  }\n}\n\n/**\n * 用户插件\n */\nexport const userPlugin: IPlugin = {\n  name: \"user\",\n  version: \"1.0.0\",\n  description:\n    \"User management plugin for device ID and user ID generation and management\",\n  priority: 10,\n\n  /**\n   * 事件跟踪前回调\n   */\n  onTrack<T extends EventProperties>(payload: Payload<T>): Payload<T> {\n    // 添加用户上下文到 Payload 顶层\n    return {\n      ...payload,\n      device_id: getDeviceId(),\n      user_id: getID(),\n    };\n  },\n\n  /**\n   * 获取插件信息\n   */\n  getInfo(): Record<string, any> {\n    return {\n      name: this.name,\n      version: this.version,\n      description: this.description,\n      deviceId: getDeviceId(),\n      userId: getID(),\n      isBrowser: isBrowser(),\n    };\n  },\n};\n","/**\n * 会话管理插件\n * 负责会话的创建、维护、超时处理和会话数据的收集\n */\n\nimport { isBrowser } from \"../utils\";\nimport { storageUtils } from \"./browser\";\nimport { handleSessionError } from \"../error\";\nimport type {\n  EventProperties,\n  IPlugin,\n  IPluginContext,\n  Payload,\n} from \"../types\";\n\n/**\n * 会话ID存储键\n */\nconst SESSION_ID_KEY = \"__analytics_session_id__\";\n\n/**\n * 会话开始时间存储键\n */\nconst SESSION_START_KEY = \"__analytics_session_start__\";\n\n/**\n * 会话最后活动时间存储键\n */\nconst SESSION_LAST_ACTIVE_KEY = \"__analytics_session_last_active__\";\n\n/**\n * 会话常量定义\n */\nexport const SESSION_CONSTANTS = {\n  /**\n   * 会话超时时间（30分钟）\n   */\n  TIMEOUT: 30 * 60 * 1000,\n  /**\n   * 存储同步间隔（毫秒）\n   */\n  SYNC_INTERVAL: 5000,\n};\n\n/**\n * 会话状态接口\n */\ninterface SessionState {\n  /**\n   * 会话ID\n   */\n  id: string;\n  /**\n   * 会话开始时间\n   */\n  startTime: number;\n  /**\n   * 会话最后活动时间\n   */\n  lastActive: number;\n  /**\n   * 页面浏览次数\n   */\n  pageViews: number;\n  /**\n   * 事件次数\n   */\n  events: number;\n  /**\n   * 是否为新会话\n   */\n  isNew: boolean;\n}\n\n/**\n * 会话管理器类\n */\nclass Sessions {\n  /**\n   * 会话状态\n   */\n  private session: SessionState | null = null;\n  /**\n   * 超时定时器ID\n   */\n  private timeoutId: ReturnType<typeof setTimeout> | null = null;\n  /**\n   * 内存缓存\n   */\n  private storageCache: Record<string, string> = {};\n  /**\n   * 上次存储同步时间\n   */\n  private lastStorageSync: number = 0;\n  /**\n   * 存储同步间隔（毫秒）\n   */\n  private syncInterval: number = SESSION_CONSTANTS.SYNC_INTERVAL;\n\n  /**\n   * 初始化会话\n   */\n  start(): void {\n    if (!isBrowser()) return;\n\n    try {\n      this.session = this.getOrCreateSession();\n      this.startSessionTimeout();\n      this.updateLastActive();\n    } catch (error) {\n      handleSessionError(error, { context: \"start\" });\n    }\n  }\n  /**\n   * 更新会话最后活动时间\n   */\n  updateLastActive(): void {\n    if (!isBrowser() || !this.session) return;\n\n    try {\n      const now = Date.now();\n      this.session.lastActive = now;\n\n      // 更新内存缓存\n      this.storageCache[SESSION_LAST_ACTIVE_KEY] = now.toString();\n\n      // 异步同步到存储\n      this.syncStorage();\n\n      this.resetSessionTimeout();\n    } catch (error) {\n      handleSessionError(error, { context: \"updateLastActive\" });\n    }\n  }\n\n  /**\n   * 获取会话ID\n   * @returns {string | null} 会话ID\n   */\n  getID(): string | null {\n    if (!this.session) {\n      this.start();\n    }\n    return this.session?.id || null;\n  }\n\n  /**\n   * 获取会话开始时间\n   * @returns {number | null} 会话开始时间\n   */\n  getStartTime(): number | null {\n    if (!this.session) {\n      this.start();\n    }\n    return this.session?.startTime || null;\n  }\n\n  /**\n   * 获取会话持续时间\n   * @returns {number} 会话持续时间\n   */\n  getDuration(): number {\n    if (!this.session) {\n      this.start();\n    }\n    return this.session ? Date.now() - this.session.startTime : 0;\n  }\n\n  /**\n   * 检查是否为新会话\n   * @returns {boolean} 是否为新会话\n   */\n  isNew(): boolean {\n    if (!this.session) {\n      this.start();\n    }\n    return this.session?.isNew || false;\n  }\n\n  /**\n   * 清理定时器\n   */\n  clearTimeout(): void {\n    if (this.timeoutId) {\n      clearTimeout(this.timeoutId);\n      this.timeoutId = null;\n    }\n  }\n\n  /**\n   * 增加页面浏览次数\n   */\n  incrementPageViews(): void {\n    if (this.session) {\n      this.session.pageViews++;\n    }\n  }\n\n  /**\n   * 增加事件次数\n   */\n  incrementEvents(): void {\n    if (this.session) {\n      this.session.events++;\n    }\n  }\n\n  /**\n   * 获取会话统计信息\n   * @returns {Object} 会话统计信息\n   */\n  getStats(): {\n    pageViews: number;\n    events: number;\n    duration: number;\n  } {\n    if (!this.session) {\n      this.start();\n    }\n    return {\n      pageViews: this.session?.pageViews || 0,\n      events: this.session?.events || 0,\n      duration: this.session ? Date.now() - this.session.startTime : 0,\n    };\n  }\n\n  /**\n   * 获取会话上下文\n   * @returns {EventProperties} 会话上下文\n   */\n  getContext(): EventProperties {\n    if (!this.session) {\n      this.start();\n    }\n    return {\n      session_id: this.session?.id || \"\",\n      session_start: this.session?.startTime || 0,\n      session_duration: this.session ? Date.now() - this.session.startTime : 0,\n      session_page_views: this.session?.pageViews || 0,\n      session_events: this.session?.events || 0,\n      session_is_new: this.session?.isNew || false,\n    };\n  }\n  /**\n   * 结束会话\n   */\n  stop(): void {\n    if (!isBrowser()) return;\n\n    try {\n      // 清理存储\n      storageUtils.remove(SESSION_ID_KEY);\n      storageUtils.remove(SESSION_START_KEY);\n      storageUtils.remove(SESSION_LAST_ACTIVE_KEY);\n\n      // 清理内存缓存\n      delete this.storageCache[SESSION_ID_KEY];\n      delete this.storageCache[SESSION_START_KEY];\n      delete this.storageCache[SESSION_LAST_ACTIVE_KEY];\n\n      this.session = null;\n\n      if (this.timeoutId) {\n        clearTimeout(this.timeoutId);\n        this.timeoutId = null;\n      }\n    } catch (error) {\n      handleSessionError(error, { context: \"stop\" });\n    }\n  }\n\n  /**\n   * 开始会话超时定时器\n   */\n  private startSessionTimeout(): void {\n    this.resetSessionTimeout();\n  }\n\n  /**\n   * 重置会话超时定时器\n   */\n  private resetSessionTimeout(): void {\n    if (this.timeoutId) {\n      clearTimeout(this.timeoutId);\n    }\n\n    this.timeoutId = setTimeout(() => {\n      this.stop();\n    }, SESSION_CONSTANTS.TIMEOUT);\n  }\n\n  /**\n   * 同步存储缓存\n   */\n  private syncStorage(): void {\n    const now = Date.now();\n    if (now - this.lastStorageSync < this.syncInterval) {\n      return;\n    }\n\n    // 将内存缓存中的数据写入存储\n    Object.entries(this.storageCache).forEach(([key, value]) => {\n      storageUtils.set(key, value);\n    });\n\n    this.lastStorageSync = now;\n  }\n\n  /**\n   * 获取或创建会话\n   * @returns {SessionState} 会话状态\n   */\n  private getOrCreateSession(): SessionState {\n    // 首先检查内存缓存\n    let sessionId = this.storageCache[SESSION_ID_KEY];\n    let startTimeStr = this.storageCache[SESSION_START_KEY];\n    let lastActiveStr = this.storageCache[SESSION_LAST_ACTIVE_KEY];\n\n    // 如果内存缓存中没有，从存储中读取\n    if (!sessionId || !startTimeStr || !lastActiveStr) {\n      sessionId = storageUtils.get(SESSION_ID_KEY);\n      startTimeStr = storageUtils.get(SESSION_START_KEY);\n      lastActiveStr = storageUtils.get(SESSION_LAST_ACTIVE_KEY);\n\n      // 更新内存缓存\n      if (sessionId) this.storageCache[SESSION_ID_KEY] = sessionId;\n      if (startTimeStr) this.storageCache[SESSION_START_KEY] = startTimeStr;\n      if (lastActiveStr)\n        this.storageCache[SESSION_LAST_ACTIVE_KEY] = lastActiveStr;\n    }\n\n    const startTime = startTimeStr ? Number(startTimeStr) : null;\n    const lastActive = lastActiveStr ? Number(lastActiveStr) : null;\n\n    // 检查会话是否存在且未超时\n    if (sessionId && startTime && lastActive) {\n      const now = Date.now();\n      if (now - lastActive < SESSION_CONSTANTS.TIMEOUT) {\n        // 会话有效，返回现有会话\n        return {\n          id: sessionId,\n          startTime,\n          lastActive,\n          pageViews: 0,\n          events: 0,\n          isNew: false,\n        };\n      }\n    }\n\n    // 创建新会话\n    const newSessionId = this.generateSessionId();\n    const newStartTime = Date.now();\n\n    // 更新内存缓存\n    this.storageCache[SESSION_ID_KEY] = newSessionId;\n    this.storageCache[SESSION_START_KEY] = newStartTime.toString();\n    this.storageCache[SESSION_LAST_ACTIVE_KEY] = newStartTime.toString();\n\n    // 立即同步到存储\n    this.syncStorage();\n\n    return {\n      id: newSessionId,\n      startTime: newStartTime,\n      lastActive: newStartTime,\n      pageViews: 0,\n      events: 0,\n      isNew: true,\n    };\n  }\n\n  /**\n   * 生成会话ID\n   * @returns {string} 会话ID\n   */\n  private generateSessionId(): string {\n    return (\n      \"session_\" + Date.now() + \"_\" + Math.random().toString(36).substr(2, 9)\n    );\n  }\n}\n\n/**\n * 会话管理器实例\n */\nconst sessions = new Sessions();\n\n/**\n * 会话插件\n */\nexport const sessionPlugin: IPlugin = {\n  name: \"session\",\n  version: \"1.0.0\",\n  description: \"Session management plugin for tracking user sessions\",\n  priority: 10,\n\n  /**\n   * 初始化插件\n   */\n  init(context: IPluginContext): void {\n    sessions.start();\n  },\n\n  /**\n   * 事件跟踪前回调\n   */\n  onTrack<T extends EventProperties>(payload: Payload<T>): Payload<T> {\n    // 更新会话活动时间和事件计数\n    sessions.updateLastActive();\n    sessions.incrementEvents();\n\n    // 如果是页面浏览事件，增加页面浏览次数\n    if (payload.event === \"page_view\") {\n      sessions.incrementPageViews();\n    }\n\n    // 添加会话上下文\n    const sessionContext = sessions.getContext();\n    return {\n      ...payload,\n      properties: {\n        ...payload.properties,\n        ...sessionContext,\n      } as T,\n    };\n  },\n\n  /**\n   * 插件状态\n   */\n  state: {\n    sessions,\n  },\n\n  /**\n   * 获取插件信息\n   */\n  getInfo(): Record<string, any> {\n    return {\n      name: this.name,\n      version: this.version,\n      description: this.description,\n      sessionId: sessions.getID(),\n      sessionStartTime: sessions.getStartTime(),\n      sessionDuration: sessions.getDuration(),\n      sessionIsNew: sessions.isNew(),\n      sessionPageViews: sessions.getStats().pageViews,\n      sessionEvents: sessions.getStats().events,\n    };\n  },\n};\n\n/**\n * 导出会话管理器实例，以便在其他地方使用\n */\nexport { sessions };\n","/**\n * 行为管理插件\n * 负责跟踪用户行为、页面浏览和行为分析\n */\n\nimport { isBrowser } from \"../utils\";\nimport { storageUtils } from \"./browser\";\nimport { handleBehaviorError } from \"../error\";\nimport type {\n  EventProperties,\n  IPlugin,\n  IPluginContext,\n  Payload,\n} from \"../types\";\n\n/**\n * 行为路径存储键\n */\nconst BEHAVIOR_PATH_KEY = \"__analytics_behavior_path__\";\n\n/**\n * 行为常量定义\n */\nexport const BEHAVIOR_CONSTANTS = {\n  /**\n   * 最大行为路径长度\n   */\n  MAX_STEPS: 50,\n  /**\n   * 保存间隔（毫秒）\n   */\n  SAVE_INTERVAL: 2000,\n  /**\n   * 默认最近行为数量\n   */\n  DEFAULT_RECENT_BEHAVIORS_LIMIT: 10,\n  /**\n   * 行为上下文最近行为数量\n   */\n  CONTEXT_RECENT_BEHAVIORS_LIMIT: 5,\n  /**\n   * 分析结果限制数量\n   */\n  ANALYSIS_RESULT_LIMIT: 5,\n  /**\n   * 会话超时时间（毫秒）\n   */\n  SESSION_TIMEOUT: 30 * 60 * 1000,\n};\n\n/**\n * 行为步骤接口\n */\ninterface BehaviorStep {\n  /**\n   * 事件名称\n   */\n  event: string;\n  /**\n   * 时间戳\n   */\n  timestamp: number;\n  /**\n   * 事件属性\n   */\n  properties: EventProperties;\n  /**\n   * 路径\n   */\n  path: string;\n  /**\n   * 来源\n   */\n  referrer: string;\n}\n\n/**\n * 行为管理器\n * 负责跟踪和管理用户行为\n */\nclass Behaviors {\n  /**\n   * 行为路径\n   * @private\n   */\n  private behaviorPath: BehaviorStep[] = [];\n\n  /**\n   * 保存定时器ID\n   * @private\n   */\n  private saveTimeoutId: ReturnType<typeof setTimeout> | null = null;\n\n  /**\n   * 最后保存时间\n   * @private\n   */\n  private lastSaveTime: number = 0;\n\n  /**\n   * 保存间隔（毫秒）\n   * @private\n   */\n  private saveInterval: number = BEHAVIOR_CONSTANTS.SAVE_INTERVAL;\n\n  /**\n   * 初始化行为管理器\n   */\n  init(): void {\n    if (!isBrowser()) return;\n\n    try {\n      this.behaviorPath = this.loadBehaviorPath();\n    } catch (error) {\n      handleBehaviorError(error, { context: \"init\" });\n      this.behaviorPath = [];\n    }\n  }\n\n  /**\n   * 加载行为路径\n   * @private\n   * @returns {BehaviorStep[]} 行为路径\n   */\n  private loadBehaviorPath(): BehaviorStep[] {\n    const pathStr = storageUtils.get(BEHAVIOR_PATH_KEY);\n    if (!pathStr) return [];\n    try {\n      const path = JSON.parse(pathStr);\n      return Array.isArray(path) ? path : [];\n    } catch {\n      return [];\n    }\n  }\n\n  /**\n   * 保存行为路径\n   * @private\n   */\n  private saveBehaviorPath(): void {\n    if (!isBrowser()) return;\n\n    // 清除之前的定时器\n    if (this.saveTimeoutId) {\n      clearTimeout(this.saveTimeoutId);\n      this.saveTimeoutId = null;\n    }\n\n    // 使用节流机制，避免频繁写入\n    const now = Date.now();\n    if (now - this.lastSaveTime < this.saveInterval) {\n      // 设置定时器，延迟保存\n      this.saveTimeoutId = setTimeout(() => {\n        this.saveBehaviorPathToStorage();\n      }, this.saveInterval);\n      return;\n    }\n\n    // 立即保存\n    this.saveBehaviorPathToStorage();\n  }\n\n  /**\n   * 实际保存行为路径到存储\n   * @private\n   */\n  private saveBehaviorPathToStorage(): void {\n    try {\n      // 限制行为路径长度\n      if (this.behaviorPath.length > BEHAVIOR_CONSTANTS.MAX_STEPS) {\n        this.behaviorPath = this.behaviorPath.slice(\n          -BEHAVIOR_CONSTANTS.MAX_STEPS,\n        );\n      }\n      storageUtils.set(BEHAVIOR_PATH_KEY, JSON.stringify(this.behaviorPath));\n      this.lastSaveTime = Date.now();\n    } catch (error) {\n      handleBehaviorError(error, { context: \"saveBehaviorPathToStorage\" });\n    }\n  }\n\n  /**\n   * 记录行为\n   * @param {string} event - 事件名称\n   * @param {EventProperties} [properties={}] - 事件属性\n   */\n  track(event: string, properties: EventProperties = {}): void {\n    if (!isBrowser()) return;\n\n    try {\n      const step: BehaviorStep = {\n        event,\n        timestamp: Date.now(),\n        properties,\n        path: window.location.pathname,\n        referrer: document.referrer,\n      };\n\n      this.behaviorPath.push(step);\n      this.saveBehaviorPath();\n    } catch (error) {\n      handleBehaviorError(error, { context: \"track\", event });\n    }\n  }\n\n  /**\n   * 记录页面浏览\n   * @param {EventProperties} [properties={}] - 页面属性\n   */\n  trackView(properties: EventProperties = {}): void {\n    if (!isBrowser()) return;\n\n    try {\n      const step: BehaviorStep = {\n        event: \"pageview\",\n        timestamp: Date.now(),\n        properties,\n        path: window.location.pathname,\n        referrer: document.referrer,\n      };\n\n      this.behaviorPath.push(step);\n      this.saveBehaviorPath();\n    } catch (error) {\n      handleBehaviorError(error, { context: \"trackView\" });\n    }\n  }\n\n  /**\n   * 获取行为路径\n   * @returns {BehaviorStep[]} 行为路径\n   */\n  getPath(): BehaviorStep[] {\n    return [...this.behaviorPath];\n  }\n\n  /**\n   * 获取最近的行为\n   * @param {number} [limit=10] - 限制数量\n   * @returns {BehaviorStep[]} 最近的行为\n   */\n  getRecent(\n    limit: number = BEHAVIOR_CONSTANTS.DEFAULT_RECENT_BEHAVIORS_LIMIT,\n  ): BehaviorStep[] {\n    return this.behaviorPath.slice(-limit);\n  }\n\n  /**\n   * 获取行为路径统计\n   * @returns {Object} 行为统计信息\n   * @returns {number} totalSteps - 总步骤数\n   * @returns {number} uniqueEvents - 唯一事件数\n   * @returns {number} averageTimeBetweenSteps - 步骤间平均时间\n   */\n  getStats(): {\n    totalSteps: number;\n    uniqueEvents: number;\n    averageTimeBetweenSteps: number;\n  } {\n    const totalSteps = this.behaviorPath.length;\n    const uniqueEvents = new Set(this.behaviorPath.map((step) => step.event))\n      .size;\n\n    let averageTimeBetweenSteps = 0;\n    if (totalSteps > 1) {\n      let totalTime = 0;\n      for (let i = 1; i < totalSteps; i++) {\n        totalTime +=\n          this.behaviorPath[i].timestamp - this.behaviorPath[i - 1].timestamp;\n      }\n      averageTimeBetweenSteps = totalTime / (totalSteps - 1);\n    }\n\n    return {\n      totalSteps,\n      uniqueEvents,\n      averageTimeBetweenSteps,\n    };\n  }\n\n  /**\n   * 获取行为路径上下文\n   * @returns {EventProperties} 行为上下文\n   */\n  getContext(): EventProperties {\n    const recentBehaviors = this.getRecent(\n      BEHAVIOR_CONSTANTS.CONTEXT_RECENT_BEHAVIORS_LIMIT,\n    );\n    const behaviorStats = this.getStats();\n\n    return {\n      behavior_steps: recentBehaviors.length,\n      behavior_unique_events: behaviorStats.uniqueEvents,\n      behavior_avg_time_between_steps: Math.round(\n        behaviorStats.averageTimeBetweenSteps,\n      ),\n      last_event: recentBehaviors[recentBehaviors.length - 1]?.event || \"\",\n      last_event_time:\n        recentBehaviors[recentBehaviors.length - 1]?.timestamp || 0,\n    };\n  }\n\n  /**\n   * 清空行为路径\n   */\n  clear(): void {\n    if (!isBrowser()) return;\n\n    try {\n      this.clearTimeouts();\n\n      this.behaviorPath = [];\n      storageUtils.remove(BEHAVIOR_PATH_KEY);\n      this.lastSaveTime = 0;\n    } catch (error) {\n      handleBehaviorError(error, { context: \"clear\" });\n    }\n  }\n\n  /**\n   * 清除定时器\n   */\n  clearTimeouts(): void {\n    if (this.saveTimeoutId) {\n      clearTimeout(this.saveTimeoutId);\n      this.saveTimeoutId = null;\n    }\n  }\n\n  /**\n   * 分析行为路径\n   * @returns {Object} 行为分析结果\n   * @returns {Array} mostFrequentEvents - 最频繁的事件\n   * @returns {Array} commonPaths - 常见路径\n   * @returns {number} averageSessionDuration - 平均会话持续时间\n   */\n  analyze(): {\n    mostFrequentEvents: Array<{ event: string; count: number }>;\n    commonPaths: Array<{ path: string; count: number }>;\n    averageSessionDuration: number;\n  } {\n    const eventCounts: Record<string, number> = {};\n    for (const step of this.behaviorPath) {\n      eventCounts[step.event] = (eventCounts[step.event] || 0) + 1;\n    }\n\n    const mostFrequentEvents = Object.entries(eventCounts)\n      .map(([event, count]) => ({ event, count }))\n      .sort((a, b) => b.count - a.count)\n      .slice(0, BEHAVIOR_CONSTANTS.ANALYSIS_RESULT_LIMIT);\n\n    const pathCounts: Record<string, number> = {};\n    for (const step of this.behaviorPath) {\n      pathCounts[step.path] = (pathCounts[step.path] || 0) + 1;\n    }\n\n    const commonPaths = Object.entries(pathCounts)\n      .map(([path, count]) => ({ path, count }))\n      .sort((a, b) => b.count - a.count)\n      .slice(0, BEHAVIOR_CONSTANTS.ANALYSIS_RESULT_LIMIT);\n\n    const sessions = this.extractSessions();\n    const averageSessionDuration =\n      sessions.length > 0\n        ? sessions.reduce((total, session) => total + session.duration, 0) /\n          sessions.length\n        : 0;\n\n    return {\n      mostFrequentEvents,\n      commonPaths,\n      averageSessionDuration,\n    };\n  }\n\n  /**\n   * 提取会话\n   * @private\n   * @returns {Array} 会话列表\n   */\n  private extractSessions(): Array<{\n    startTime: number;\n    endTime: number;\n    duration: number;\n    steps: BehaviorStep[];\n  }> {\n    const sessions: Array<{\n      startTime: number;\n      endTime: number;\n      duration: number;\n      steps: BehaviorStep[];\n    }> = [];\n    if (this.behaviorPath.length === 0) return sessions;\n\n    let currentSession: BehaviorStep[] = [this.behaviorPath[0]];\n    let startTime = this.behaviorPath[0].timestamp;\n\n    for (let i = 1; i < this.behaviorPath.length; i++) {\n      const step = this.behaviorPath[i];\n      const timeDiff =\n        step.timestamp - currentSession[currentSession.length - 1].timestamp;\n\n      // 会话超时检查\n      if (timeDiff > BEHAVIOR_CONSTANTS.SESSION_TIMEOUT) {\n        // 结束当前会话\n        const endTime = currentSession[currentSession.length - 1].timestamp;\n        sessions.push({\n          startTime,\n          endTime,\n          duration: endTime - startTime,\n          steps: [...currentSession],\n        });\n\n        // 开始新会话\n        currentSession = [step];\n        startTime = step.timestamp;\n      } else {\n        currentSession.push(step);\n      }\n    }\n\n    // 添加最后一个会话\n    if (currentSession.length > 0) {\n      const endTime = currentSession[currentSession.length - 1].timestamp;\n      sessions.push({\n        startTime,\n        endTime,\n        duration: endTime - startTime,\n        steps: [...currentSession],\n      });\n    }\n\n    return sessions;\n  }\n}\n\n/**\n * 行为管理器实例\n */\nconst behaviors = new Behaviors();\n\n/**\n * 行为插件\n */\nexport const behaviorPlugin: IPlugin = {\n  name: \"behavior\",\n  version: \"1.0.0\",\n  description:\n    \"Behavior tracking plugin for tracking user behavior and page views\",\n  priority: 20,\n  dependencies: [\"session\"],\n\n  setup(context: IPluginContext): void {\n    const sessionPlugin = context.getPlugin(\"session\");\n    if (!sessionPlugin) {\n      console.warn(\n        \"[Node-Trace] behavior plugin requires session plugin to be registered\",\n      );\n      return;\n    }\n  },\n\n  init(context: IPluginContext): void {\n    behaviors.init();\n  },\n\n  /**\n   * 事件跟踪前回调\n   */\n  onTrack<T extends EventProperties>(payload: Payload<T>): Payload<T> {\n    behaviors.track(payload.event, payload.properties || {});\n\n    if (payload.event === \"page_view\") {\n      behaviors.trackView(payload.properties || {});\n    }\n\n    const behaviorContext = behaviors.getContext();\n    return {\n      ...payload,\n      properties: {\n        ...payload.properties,\n        ...behaviorContext,\n      } as T,\n    };\n  },\n\n  state: {\n    behaviors,\n  },\n\n  getInfo(): Record<string, any> {\n    return {\n      name: this.name,\n      version: this.version,\n      description: this.description,\n      behaviorStats: behaviors.getStats(),\n      recentBehaviors: behaviors.getRecent(5),\n    };\n  },\n};\n\n/**\n * 导出行为管理器实例，以便在其他地方使用\n */\nexport { behaviors };\n","/**\n * 错误插件\n * 负责监听和捕获JavaScript错误和未处理的Promise拒绝\n */\n\nimport { track } from \"../core\";\nimport type { IPlugin, IPluginContext } from \"../types\";\nimport { isBrowser } from \"../utils\";\n\n/**\n * 错误插件\n */\nexport const errorPlugin: IPlugin = {\n  /**\n   * 插件名称\n   */\n  name: \"error\",\n\n  /**\n   * 插件设置方法\n   */\n  setup(context: IPluginContext) {\n    if (!isBrowser()) return;\n\n    // 监听JavaScript错误\n    window.addEventListener(\"error\", (e) => {\n      try {\n        track(\"js_error\", {\n          message: e.message,\n          filename: e.filename,\n          lineno: e.lineno,\n          colno: e.colno,\n        });\n      } catch {\n        // 忽略错误，避免无限循环\n      }\n    });\n\n    // 监听未处理的Promise拒绝\n    window.addEventListener(\"unhandledrejection\", (e) => {\n      try {\n        track(\"promise_error\", {\n          reason: String(e.reason),\n          message: e.reason?.message || String(e.reason),\n        });\n      } catch {\n        // 忽略错误，避免无限循环\n      }\n    });\n  },\n};\n","/**\n * 性能插件\n * 负责收集和发送页面性能数据，包括加载时间、首字节时间、DOM解析时间等\n */\n\nimport { track } from \"../core\";\nimport type { IPlugin, IPluginContext } from \"../types\";\nimport { isBrowser } from \"../utils\";\n\n/**\n * 发送性能数据\n */\nfunction sendPerformanceData() {\n  if (!isBrowser()) return;\n\n  try {\n    const performance = window.performance;\n    if (!performance || !performance.getEntriesByType) return;\n\n    // 获取导航性能数据\n    const navigationEntries = performance.getEntriesByType(\"navigation\");\n    if (navigationEntries.length > 0) {\n      const navEntry = navigationEntries[0] as PerformanceNavigationTiming;\n\n      track(\"page_performance\", {\n        // 页面加载时间\n        loadTime: navEntry.loadEventEnd - navEntry.fetchStart,\n        // 首字节时间\n        ttfb: navEntry.responseStart - navEntry.fetchStart,\n        // 解析 DOM 时间\n        domContentLoaded:\n          navEntry.domContentLoadedEventEnd - navEntry.fetchStart,\n        // 重定向时间\n        redirectTime: navEntry.redirectEnd - navEntry.redirectStart,\n        // DNS 查询时间\n        dnsTime: navEntry.domainLookupEnd - navEntry.domainLookupStart,\n        // TCP 连接时间\n        tcpTime: navEntry.connectEnd - navEntry.connectStart,\n        // SSL 握手时间\n        sslTime: (navEntry as any).secureConnectionStart\n          ? navEntry.connectEnd - (navEntry as any).secureConnectionStart\n          : 0,\n        // 首屏时间（估算）\n        firstPaint:\n          (performance as any)\n            .getEntriesByType(\"paint\")\n            .find((e: any) => e.name === \"first-paint\")?.startTime || 0,\n        firstContentfulPaint:\n          (performance as any)\n            .getEntriesByType(\"paint\")\n            .find((e: any) => e.name === \"first-contentful-paint\")?.startTime ||\n          0,\n      });\n    }\n\n    // 获取资源加载性能数据\n    const resourceEntries = performance.getEntriesByType(\"resource\");\n    if (resourceEntries.length > 0) {\n      const resourceStats = {\n        total: resourceEntries.length,\n        scripts: 0,\n        stylesheets: 0,\n        images: 0,\n        fonts: 0,\n        other: 0,\n        totalLoadTime: 0,\n      };\n\n      resourceEntries.forEach((entry) => {\n        const resourceEntry = entry as PerformanceResourceTiming;\n        resourceStats.totalLoadTime += resourceEntry.duration;\n\n        if (resourceEntry.name.includes(\".js\")) {\n          resourceStats.scripts++;\n        } else if (resourceEntry.name.includes(\".css\")) {\n          resourceStats.stylesheets++;\n        } else if (/(jpg|jpeg|png|gif|webp|svg)$/i.test(resourceEntry.name)) {\n          resourceStats.images++;\n        } else if (/(woff|woff2|ttf|otf)$/i.test(resourceEntry.name)) {\n          resourceStats.fonts++;\n        } else {\n          resourceStats.other++;\n        }\n      });\n\n      track(\"resource_performance\", resourceStats);\n    }\n  } catch {\n    // 忽略错误，避免无限循环\n  }\n}\n\n/**\n * 性能插件\n */\nexport const performancePlugin: IPlugin = {\n  /**\n   * 插件名称\n   */\n  name: \"performance\",\n\n  /**\n   * 插件设置方法\n   */\n  setup(context: IPluginContext) {\n    if (!isBrowser()) return;\n\n    // 等待页面加载完成\n    if (document.readyState === \"complete\") {\n      sendPerformanceData();\n    } else {\n      window.addEventListener(\"load\", sendPerformanceData);\n    }\n  },\n};\n","/**\n * 页面浏览插件\n * 负责监控和跟踪页面浏览事件，包括初始加载和路由变化\n */\n\nimport { track } from \"../core\";\nimport { getBrowserData } from \"./browser\";\nimport type { IPlugin, IPluginContext } from \"../types\";\nimport { isBrowser } from \"../utils\";\n\n/**\n * 发送页面浏览事件\n */\nfunction sendPageView() {\n  if (!isBrowser()) return;\n\n  try {\n    // 页面浏览事件会通过插件系统自动触发会话和行为更新\n    const browserData = getBrowserData();\n    track(\"page_view\", {\n      ...browserData,\n      url: window.location.href,\n      pathname: window.location.pathname,\n      referrer: document.referrer,\n      title: document.title,\n    });\n  } catch {\n    // 忽略错误，避免无限循环\n  }\n}\n\n/**\n * 监听路由变化\n */\nfunction listenForRouteChanges() {\n  if (!isBrowser()) return;\n\n  // 监听 hash 变化\n  window.addEventListener(\"hashchange\", sendPageView);\n\n  // 监听 history 变化\n  const originalPushState = history.pushState;\n  const originalReplaceState = history.replaceState;\n\n  history.pushState = function (...args) {\n    originalPushState.apply(this, args);\n    sendPageView();\n  };\n\n  history.replaceState = function (...args) {\n    originalReplaceState.apply(this, args);\n    sendPageView();\n  };\n\n  // 监听前进/后退按钮\n  window.addEventListener(\"popstate\", sendPageView);\n}\n\n/**\n * 页面浏览插件\n */\nexport const pageviewPlugin: IPlugin = {\n  /**\n   * 插件名称\n   */\n  name: \"pageview\",\n\n  /**\n   * 插件依赖\n   */\n  dependencies: [\"session\", \"behavior\"],\n\n  /**\n   * 插件设置方法\n   */\n  setup(context: IPluginContext) {\n    if (!isBrowser()) return;\n\n    const sessionPlugin = context.getPlugin(\"session\");\n    const behaviorPlugin = context.getPlugin(\"behavior\");\n\n    if (!sessionPlugin) {\n      console.warn(\n        \"[Node-Trace] pageview plugin requires session plugin to be registered\",\n      );\n      return;\n    }\n\n    if (!behaviorPlugin) {\n      console.warn(\n        \"[Node-Trace] pageview plugin requires behavior plugin to be registered\",\n      );\n      return;\n    }\n\n    sendPageView();\n    listenForRouteChanges();\n  },\n};\n","/**\n * 网络插件\n * 负责监控和跟踪网络请求，包括XMLHttpRequest和fetch请求\n */\n\nimport { track, state } from \"../core\";\nimport type { IPlugin, IPluginContext } from \"../types\";\nimport { isBrowser } from \"../utils\";\n\n/**\n * 扩展XMLHttpRequest接口，添加自定义属性\n */\ninterface XMLHttpRequestWithCustomProps extends XMLHttpRequest {\n  /**\n   * 请求开始时间\n   */\n  _requestStartTime?: number;\n  /**\n   * 请求方法\n   */\n  _requestMethod?: string;\n  /**\n   * 请求URL\n   */\n  _requestUrl?: string | URL;\n}\n\n/**\n * 检查URL是否是SDK自身的上报接口\n * @param url 要检查的URL\n * @returns 是否是SDK自身的上报接口\n */\nfunction isSdkEndpoint(url: string): boolean {\n  try {\n    const options = state.options;\n    if (!options?.endpoint) return false;\n\n    const sdkUrl = new URL(options.endpoint);\n    const requestUrl = new URL(url, window.location.origin);\n\n    // 比较协议、主机和路径\n    return (\n      sdkUrl.protocol === requestUrl.protocol &&\n      sdkUrl.host === requestUrl.host &&\n      sdkUrl.pathname === requestUrl.pathname\n    );\n  } catch {\n    return false;\n  }\n}\n\n/**\n * 补丁XMLHttpRequest，监控网络请求\n */\nfunction patchXMLHttpRequest() {\n  if (!isBrowser() || !window.XMLHttpRequest) return;\n\n  const originalOpen = XMLHttpRequest.prototype.open;\n  const originalSend = XMLHttpRequest.prototype.send;\n\n  XMLHttpRequest.prototype.open = function (\n    method: string,\n    url: string | URL,\n    async?: boolean,\n    username?: string | null,\n    password?: string | null,\n  ) {\n    const xhr = this as XMLHttpRequestWithCustomProps;\n    xhr._requestStartTime = Date.now();\n    xhr._requestMethod = method;\n    xhr._requestUrl = url;\n    return originalOpen.call(\n      this,\n      method,\n      url,\n      async !== false,\n      username,\n      password,\n    );\n  };\n\n  XMLHttpRequest.prototype.send = function (\n    body?: Document | XMLHttpRequestBodyInit | null,\n  ) {\n    const xhr = this as XMLHttpRequestWithCustomProps;\n\n    this.addEventListener(\"load\", function () {\n      try {\n        const url = xhr._requestUrl?.toString() || \"\";\n        // 排除SDK自身的上报接口\n        if (isSdkEndpoint(url)) return;\n\n        const duration = Date.now() - (xhr._requestStartTime || Date.now());\n        track(\"network_request\", {\n          method: xhr._requestMethod || \"GET\",\n          url,\n          status: xhr.status,\n          statusText: xhr.statusText,\n          duration,\n          type: \"xhr\",\n          success: xhr.status >= 200 && xhr.status < 300,\n        });\n      } catch {\n        // 忽略错误，避免无限循环\n      }\n    });\n\n    this.addEventListener(\"error\", function () {\n      try {\n        const url = xhr._requestUrl?.toString() || \"\";\n        // 排除SDK自身的上报接口\n        if (isSdkEndpoint(url)) return;\n\n        const duration = Date.now() - (xhr._requestStartTime || Date.now());\n        track(\"network_request\", {\n          method: xhr._requestMethod || \"GET\",\n          url,\n          status: 0,\n          statusText: \"Error\",\n          duration,\n          type: \"xhr\",\n          success: false,\n        });\n      } catch {\n        // 忽略错误，避免无限循环\n      }\n    });\n\n    this.addEventListener(\"abort\", function () {\n      try {\n        const url = xhr._requestUrl?.toString() || \"\";\n        // 排除SDK自身的上报接口\n        if (isSdkEndpoint(url)) return;\n\n        const duration = Date.now() - (xhr._requestStartTime || Date.now());\n        track(\"network_request\", {\n          method: xhr._requestMethod || \"GET\",\n          url,\n          status: 0,\n          statusText: \"Aborted\",\n          duration,\n          type: \"xhr\",\n          success: false,\n        });\n      } catch {\n        // 忽略错误，避免无限循环\n      }\n    });\n\n    return originalSend.call(this, body);\n  };\n}\n\n/**\n * 补丁fetch，监控网络请求\n */\nfunction patchFetch() {\n  if (!isBrowser() || !window.fetch) return;\n\n  const originalFetch = window.fetch;\n\n  window.fetch = async function (...args) {\n    const startTime = Date.now();\n    const url = args[0] as string;\n    const options = args[1] || {};\n    const method = options.method || \"GET\";\n\n    // 排除SDK自身的上报接口\n    if (isSdkEndpoint(url)) {\n      return originalFetch.apply(this, args);\n    }\n\n    try {\n      const response = await originalFetch.apply(this, args);\n      const duration = Date.now() - startTime;\n\n      track(\"network_request\", {\n        method,\n        url,\n        status: response.status,\n        statusText: response.statusText,\n        duration,\n        type: \"fetch\",\n        success: response.ok,\n      });\n\n      return response;\n    } catch (error) {\n      const duration = Date.now() - startTime;\n\n      track(\"network_request\", {\n        method,\n        url,\n        status: 0,\n        statusText: error instanceof Error ? error.message : \"Error\",\n        duration,\n        type: \"fetch\",\n        success: false,\n      });\n\n      throw error;\n    }\n  };\n}\n\n/**\n * 网络插件\n */\nexport const networkPlugin: IPlugin = {\n  /**\n   * 插件名称\n   */\n  name: \"network\",\n\n  /**\n   * 插件设置方法\n   */\n  setup(context: IPluginContext) {\n    if (!isBrowser()) return;\n\n    // 补丁 XMLHttpRequest\n    patchXMLHttpRequest();\n\n    // 补丁 fetch\n    patchFetch();\n  },\n};\n"],"mappings":"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","names":["QUEUE_CONSTANTS","LRUCache","maxSize","key","value","firstKey","generateEventKey","event","EventDedupe","events","CONSTANTS","stringUtils","length","chars","result","i","c","r","timestamp","now","date","year","month","day","hours","minutes","seconds","milliseconds","formattedTime","randomPart","str","maxLength","suffix","isBrowser","now","NetworkManager","QUEUE_CONSTANTS","now","isBrowser","connection","networkManager","SendStrategySelector","body","bodySize","networkType","networkManager","QUEUE_CONSTANTS","sendWithBeacon","endpoint","debug","isBrowser","success","error","sendWithFetch","headers","timeout","res","sendWithXHR","data","resolve","xhr","Sender","options","startTime","strategy","time","sender","ErrorHandler","config","type","level","stack","stackLines","line","match","error","oneHourAgo","ts","oneMinuteAgo","message","context","code","source","file","stackInfo","traceError","_a","debugEnabled","state","shouldLog","prefix","contextStr","detailsStr","stackStr","errorIdStr","count","mostFrequentType","maxTypeCount","mostFrequentLevel","maxLevelCount","levelOrder","configLevelIndex","errorHandler","handleNetworkError","error","context","errorHandler","handleStorageError","handleBrowserError","handlePluginError","handleSessionError","error","context","errorHandler","handleBehaviorError","Dexie","NodeTraceDB","db","DexieStorage","events","e","ids","DB","QueueManager","EventDedupe","QUEUE_CONSTANTS","config","pressure","batchSize","interval","removeCount","removedEvents","event","_a","sendTime","success","totalSends","batch","isBrowser","DB","error","handleNetworkError","retryInterval","retryTimer","sortedPlugins","plugins","result","plugin","handlePluginError","processedBatch","sender","_b","offlineEvents","queueEventKeys","key","eventsToAdd","offlineEvent","idsToDelete","t","queueManager","push","event","queueManager","flush","clearTimers","DEFAULT_OPTIONS","state","Plugins","name","pluginName","methodName","args","plugin","dep","conflict","error","handlePluginError","context","result","a","b","plugins","init","options","queueManager","use","shouldSend","event","_a","opt","track","properties","_b","payload","stringUtils","now","allPlugins","p","r","final","eventToPush","push","detectBrowser","userAgent","_a","_b","_c","_d","_e","_f","_g","name","version","major","engine","engineVersion","detectDevice","isMobile","isTablet","isDesktop","type","parseBrowserInfo","result","parseDeviceType","getBasicBrowserInfo","isBrowser","getDetailedBrowserInfo","browserInfo","getDeviceInfo","deviceType","getNetworkInfo","getScreenInfo","getPageInfo","getScrollInfo","browserUtils","effectiveType","rtt","downlink","connection","storageUtils","key","parser","value","e","stringValue","getBrowserData","_h","_i","_j","_k","_l","_m","getDeviceId","basicBrowserInfo","detailedBrowserInfo","deviceInfo","networkInfo","screenInfo","pageInfo","scrollInfo","error","browserPlugin","payload","browserData","browserContext","DEVICE_ID_KEY","USER_ID_KEY","nonBrowserDeviceId","DEFAULT_DEVICE_ID_LENGTH","generateSHA256Hash","input","isBrowser","data","hashBuffer","b","__require","simpleHash","hash","i","char","baseHash","randomPart","generateStableDeviceIdSync","timestamp","random","navigatorInfo","infoString","error","handleBrowserError","generateDeviceIdAsync","e","generateStableDeviceId","generateStableDeviceIdAsync","getDeviceId","existingId","storageUtils","newId","handleStorageError","setID","id","getID","userId","clearID","userPlugin","payload","SESSION_ID_KEY","SESSION_START_KEY","SESSION_LAST_ACTIVE_KEY","SESSION_CONSTANTS","Sessions","isBrowser","error","handleSessionError","now","_a","_b","_c","_d","_e","storageUtils","key","value","sessionId","startTimeStr","lastActiveStr","startTime","lastActive","newSessionId","newStartTime","sessions","sessionPlugin","context","payload","sessionContext","BEHAVIOR_PATH_KEY","BEHAVIOR_CONSTANTS","Behaviors","isBrowser","error","handleBehaviorError","pathStr","storageUtils","path","e","event","properties","step","limit","totalSteps","uniqueEvents","averageTimeBetweenSteps","totalTime","i","_a","_b","recentBehaviors","behaviorStats","eventCounts","mostFrequentEvents","count","a","b","pathCounts","commonPaths","sessions","averageSessionDuration","total","session","currentSession","startTime","endTime","behaviors","behaviorPlugin","context","payload","behaviorContext","errorPlugin","context","isBrowser","track","e","_a","sendPerformanceData","_a","_b","isBrowser","performance","navigationEntries","navEntry","track","e","resourceEntries","resourceStats","entry","resourceEntry","performancePlugin","context","sendPageView","isBrowser","browserData","getBrowserData","track","e","listenForRouteChanges","originalPushState","originalReplaceState","args","pageviewPlugin","context","sessionPlugin","behaviorPlugin","isSdkEndpoint","url","options","state","sdkUrl","requestUrl","patchXMLHttpRequest","isBrowser","originalOpen","originalSend","method","async","username","password","xhr","body","_a","duration","track","e","patchFetch","originalFetch","args","startTime","response","error","networkPlugin","context"]}