{"version":3,"sources":["../src/queue/constants.ts","../src/queue/dedupe.ts","../src/utils.ts","../src/queue/network.ts","../src/queue/sender.ts","../src/error/handler.ts","../src/error/stats.ts","../src/error/index.ts","../src/db.ts","../src/queue/priority.ts","../src/queue/manager.ts","../src/queue.ts","../src/core.ts","../src/plugins/browser/detection.ts","../src/plugins/browser/network.ts","../src/plugins/browser/page.ts","../src/plugins/browser/screen.ts","../src/plugins/browser/storage.ts","../src/plugins/browser/index.ts","../src/plugins/user.ts","../src/plugins/session.ts","../src/plugins/behavior.ts","../src/plugins/error.ts","../src/plugins/performance.ts","../src/plugins/pageview.ts","../src/plugins/network.ts"],"sourcesContent":["/**\n * Queue constants definition\n */\n\nexport const QUEUE_CONSTANTS = {\n  /**\n   * Default max queue size\n   */\n  DEFAULT_MAX_QUEUE_SIZE: 1000,\n  /**\n   * Default batch size\n   */\n  DEFAULT_BATCH_SIZE: 20,\n  /**\n   * Default batch interval (milliseconds)\n   */\n  DEFAULT_BATCH_INTERVAL: 1000,\n  /**\n   * Max batch size\n   */\n  MAX_BATCH_SIZE: 50,\n  /**\n   * Min batch size\n   */\n  MIN_BATCH_SIZE: 5,\n  /**\n   * Max batch interval (milliseconds)\n   */\n  MAX_BATCH_INTERVAL: 3000,\n  /**\n   * Min batch interval (milliseconds)\n   */\n  MIN_BATCH_INTERVAL: 200,\n  /**\n   * Queue pressure threshold - high\n   */\n  QUEUE_PRESSURE_HIGH: 0.7,\n  /**\n   * Queue pressure threshold - very high\n   */\n  QUEUE_PRESSURE_VERY_HIGH: 0.9,\n  /**\n   * Queue pressure threshold - low\n   */\n  QUEUE_PRESSURE_LOW: 0.2,\n  /**\n   * Queue pressure threshold - medium\n   */\n  QUEUE_PRESSURE_MEDIUM: 0.6,\n  /**\n   * Network status check interval (milliseconds)\n   */\n  NETWORK_CHECK_INTERVAL: 5000,\n  /**\n   * Beacon data size limit (bytes)\n   */\n  BEACON_SIZE_LIMIT: 65536,\n  /**\n   * Small data threshold (bytes)\n   */\n  SMALL_DATA_THRESHOLD: 1024,\n  /**\n   * Max retry count\n   */\n  MAX_RETRY_COUNT: 5,\n  /**\n   * Default timeout (milliseconds)\n   */\n  DEFAULT_TIMEOUT: 30000,\n  /**\n   * Queue cleanup ratio\n   */\n  QUEUE_CLEANUP_RATIO: 0.1,\n  /**\n   * Max cleanup event count\n   */\n  MAX_CLEANUP_COUNT: 10,\n  /**\n   * Offline event check interval (milliseconds)\n   */\n  OFFLINE_CHECK_INTERVAL: 30000,\n  /**\n   * Event deduplication cache max size\n   */\n  DEDUPE_CACHE_MAX_SIZE: 10000,\n};\n","import type { Payload, EventProperties } from \"../types\";\n\n/**\n * LRU cache implementation (specifically for string keys)\n */\nexport class LRUCache<V> {\n  private cache: Map<string, V>;\n  private maxSize: number;\n\n  constructor(maxSize: number = 10000) {\n    this.cache = new Map();\n    this.maxSize = maxSize;\n  }\n\n  has(key: string): boolean {\n    return this.cache.has(key);\n  }\n\n  set(key: string, value: V): void {\n    if (this.cache.size >= this.maxSize) {\n      const firstKey = this.cache.keys().next().value;\n      if (firstKey !== undefined) {\n        this.cache.delete(firstKey);\n      }\n    }\n    this.cache.set(key, value);\n  }\n\n  delete(key: string): void {\n    this.cache.delete(key);\n  }\n\n  clear(): void {\n    this.cache.clear();\n  }\n\n  size(): number {\n    return this.cache.size;\n  }\n\n  get(key: string): V | undefined {\n    const value = this.cache.get(key);\n    if (value !== undefined) {\n      this.cache.delete(key);\n      this.cache.set(key, value);\n    }\n    return value;\n  }\n}\n\n/**\n * Generate event unique key\n * @param event - Event object\n * @returns Event unique key\n */\nexport function generateEventKey<T extends EventProperties>(\n  event: Payload<T>,\n): string {\n  return `${event.id}_${event.event}_${event.timestamp}`;\n}\n\n/**\n * Event deduplication manager\n */\nexport class EventDedupe {\n  private cache: LRUCache<boolean>;\n\n  constructor(maxSize: number = 10000) {\n    this.cache = new LRUCache<boolean>(maxSize);\n  }\n\n  /**\n   * Check if event already exists\n   */\n  exists<T extends EventProperties>(event: Payload<T>): boolean {\n    const key = generateEventKey(event);\n    return this.cache.has(key);\n  }\n\n  /**\n   * Add event to deduplication cache\n   */\n  add<T extends EventProperties>(event: Payload<T>): void {\n    const key = generateEventKey(event);\n    this.cache.set(key, true);\n  }\n\n  /**\n   * Remove event from deduplication cache\n   */\n  remove<T extends EventProperties>(event: Payload<T>): void {\n    const key = generateEventKey(event);\n    this.cache.delete(key);\n  }\n\n  /**\n   * Batch remove events\n   */\n  removeBatch<T extends EventProperties>(events: Payload<T>[]): void {\n    events.forEach((event) => this.remove(event));\n  }\n\n  /**\n   * Clear deduplication cache\n   */\n  clear(): void {\n    this.cache.clear();\n  }\n\n  /**\n   * Get cache size\n   */\n  size(): number {\n    return this.cache.size();\n  }\n}\n","/**\n * Utility functions module\n * Contains common utility functions for strings, numbers, objects, arrays, time, etc.\n */\n\n/**\n * Constant definitions\n */\nexport const CONSTANTS = {\n  /**\n   * Default length for random string\n   */\n  RANDOM_STRING_DEFAULT_LENGTH: 8,\n  /**\n   * Default number of decimal places for number formatting\n   */\n  NUMBER_FORMAT_DEFAULT_DECIMALS: 2\n}\n\n/**\n * String utility functions\n */\nexport const stringUtils = {\n  /**\n   * Generate random string\n   * @param length - String length\n   * @returns Random string\n   */\n  random: (length: number = CONSTANTS.RANDOM_STRING_DEFAULT_LENGTH): string => {\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'\n    let result = ''\n    for (let i = 0; i < length; i++) {\n      result += chars.charAt(Math.floor(Math.random() * chars.length))\n    }\n    return result\n  },\n\n  /**\n   * Generate unique ID\n   * @returns Unique ID\n   */\n  uuid: (): string => {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n      const r = Math.random() * 16 | 0\n      const v = c === 'x' ? r : (r & 0x3 | 0x8)\n      return v.toString(16)\n    })\n  },\n\n  /**\n   * Generate event ID\n   * @returns Event ID\n   */\n  generateEventId: (): string => {\n    const timestamp = now()\n    // Format as year-month-day-hour-minute-second-millisecond\n    const date = new Date(timestamp)\n    const year = date.getFullYear()\n    const month = String(date.getMonth() +1).padStart(2, '0')\n    const day = String(date.getDate()).padStart(2, '0')\n    const hours = String(date.getHours()).padStart(2, '0')\n    const minutes = String(date.getMinutes()).padStart(2, '0')\n    const seconds = String(date.getSeconds()).padStart(2, '0')\n    const milliseconds = String(date.getMilliseconds()).padStart(3, '0')\n    const formattedTime = `${year}${month}${day}${hours}${minutes}${seconds}${milliseconds}`\n    // Generate 8-character random string\n    const randomPart = stringUtils.random(8)\n    return `${formattedTime}${randomPart}`\n  },\n\n  /**\n   * Truncate string\n   * @param str - Original string\n   * @param maxLength - Maximum length\n   * @param suffix - Suffix\n   * @returns Truncated string\n   */\n  truncate: (str: string, maxLength: number, suffix: string = '...'): string => {\n    if (str.length <= maxLength) return str\n    return str.substring(0, maxLength - suffix.length) + suffix\n  }\n}\n\n/**\n * Number utility functions\n */\nexport const numberUtils = {\n  /**\n   * Clamp number to range\n   * @param value - Original value\n   * @param min - Minimum value\n   * @param max - Maximum value\n   * @returns Number within range\n   */\n  clamp: (value: number, min: number, max: number): number => {\n    return Math.min(Math.max(value, min), max)\n  },\n\n  /**\n   * Generate random number\n   * @param min - Minimum value\n   * @param max - Maximum value\n   * @returns Random number\n   */\n  random: (min: number, max: number): number => {\n    return Math.floor(Math.random() * (max - min +1)) + min\n  },\n\n  /**\n   * Format number\n   * @param num - Original number\n   * @param decimals - Number of decimal places\n   * @returns Formatted number string\n   */\n  format: (num: number, decimals: number = CONSTANTS.NUMBER_FORMAT_DEFAULT_DECIMALS): string => {\n    return num.toFixed(decimals)\n  }\n}\n\n/**\n * Object utility functions\n */\nexport const objectUtils = {\n  /**\n   * Deep merge objects\n   * @template T\n   * @param target - Target object\n   * @param sources - Source objects\n   * @returns Merged object\n   */\n  deepMerge: <T extends Record<string, any>>(target: T, ...sources: Record<string, any>[]): T => {\n    if (!sources.length) return target\n    \n    // Recursive merge function\n    const merge = (targetObj: Record<string, any>, sourceObj: Record<string, any>): Record<string, any> => {\n      const result = { ...targetObj }\n      \n      for (const key in sourceObj) {\n        if (Object.prototype.hasOwnProperty.call(sourceObj, key)) {\n          const sourceValue = sourceObj[key]\n          const targetValue = targetObj[key]\n          \n          if (sourceValue && typeof sourceValue === 'object' && targetValue && typeof targetValue === 'object') {\n            // Recursively merge objects\n            result[key] = merge(targetValue, sourceValue)\n          } else {\n            // Directly replace value\n            result[key] = sourceValue\n          }\n        }\n      }\n      \n      return result\n    }\n    \n    // Merge all source objects\n    let result = { ...target }\n    for (const source of sources) {\n      if (source) {\n        result = merge(result, source) as typeof result\n      }\n    }\n    \n    return result as T\n  },\n\n  /**\n   * Safely get object property\n   * @template T\n   * @param obj - Target object\n   * @param path - Property path\n   * @param defaultValue - Default value\n   * @returns Retrieved value or default value\n   */\n  get: <T>(obj: unknown, path: string | string[], defaultValue: T): T => {\n    const travel = (regexp: RegExp, obj: unknown, path: string | string[]): unknown => {\n      if (obj === null || obj === undefined) {\n        return defaultValue\n      }\n      const objRecord = obj as Record<string, unknown>\n      const value = Array.isArray(path)\n        ? path.reduce<unknown>((res, key) => (res !== null && res !== undefined ? (res as Record<string, unknown>)[key] : res), objRecord)\n        : regexp.test(path)\n        ? path.split(regexp).reduce<unknown>((res, key) => (res !== null && res !== undefined ? (res as Record<string, unknown>)[key] : res), objRecord)\n        : objRecord[path]\n      return value === undefined || value === null ? defaultValue : value\n    }\n    return travel(/[\\[\\]\\.]+/, obj, path) as T\n  },\n\n  /**\n   * Remove empty values from object\n   * @param obj - Target object\n   * @returns Object with empty values removed\n   */\n  removeEmpty: (obj: Record<string, any>): Record<string, any> => {\n    const newObj: Record<string, any> = {}\n    Object.keys(obj).forEach(key => {\n      if (obj[key] !== null && obj[key] !== undefined) {\n        newObj[key] = obj[key]\n      }\n    })\n    return newObj\n  }\n}\n\n/**\n * Array utility functions\n */\nexport const arrayUtils = {\n  /**\n   * Remove duplicates\n   * @template T\n   * @param arr - Original array\n   * @returns Array with duplicates removed\n   */\n  unique: <T>(arr: T[]): T[] => {\n    return [...new Set(arr)]\n  },\n\n  /**\n   * Shuffle array randomly\n   * @template T\n   * @param arr - Original array\n   * @returns Shuffled array\n   */\n  shuffle: <T>(arr: T[]): T[] => {\n    const result = [...arr]\n    for (let i = result.length -1; i > 0; i--) {\n      const j = Math.floor(Math.random() * (i +1))\n      ;[result[i], result[j]] = [result[j], result[i]]\n    }\n    return result\n  },\n\n  /**\n   * Process array in batches\n   * @template T\n   * @param arr - Original array\n   * @param size - Batch size\n   * @returns Batched arrays\n   */\n  chunk: <T>(arr: T[], size: number): T[][] => {\n    const result: T[][] = []\n    for (let i = 0; i < arr.length; i += size) {\n      result.push(arr.slice(i, i + size))\n    }\n    return result\n  }\n}\n\n/**\n * Time utility functions\n */\nexport const timeUtils = {\n  /**\n   * Format timestamp\n   * @param timestamp - Timestamp\n   * @param format - Format template\n   * @returns Formatted time string\n   */\n  format: (timestamp: number, format: string = 'YYYY-MM-DD HH:mm:ss'): string => {\n    const date = new Date(timestamp)\n    const year = date.getFullYear()\n    const month = String(date.getMonth() + 1).padStart(2, '0')\n    const day = String(date.getDate()).padStart(2, '0')\n    const hours = String(date.getHours()).padStart(2, '0')\n    const minutes = String(date.getMinutes()).padStart(2, '0')\n    const seconds = String(date.getSeconds()).padStart(2, '0')\n\n    return format\n      .replace('YYYY', year.toString())\n      .replace('MM', month)\n      .replace('DD', day)\n      .replace('HH', hours)\n      .replace('mm', minutes)\n      .replace('ss', seconds)\n  },\n\n  /**\n   * Calculate time difference\n   * @param start - Start timestamp\n   * @param end - End timestamp\n   * @param unit - Time unit\n   * @returns Time difference\n   */\n  diff: (start: number, end: number, unit: 'ms' | 's' | 'm' | 'h' | 'd' = 'ms'): number => {\n    const diff = end - start\n    switch (unit) {\n      case 's':\n        return diff / 1000\n      case 'm':\n        return diff / (1000 * 60)\n      case 'h':\n        return diff / (1000 * 60 * 60)\n      case 'd':\n        return diff / (1000 * 60 * 60 * 24)\n      default:\n        return diff\n    }\n  }\n}\n\n/**\n * Environment utility functions\n */\n\n/**\n * Check if running in browser environment\n * @returns Whether running in browser environment\n */\nexport const isBrowser = () => typeof window !== \"undefined\"\n\n/**\n * Get current timestamp\n * @returns Current timestamp\n */\nexport const now = () => Date.now()\n","import { isBrowser, now } from \"../utils\";\nimport { QUEUE_CONSTANTS } from \"./constants\";\n\n/**\n * Network type\n */\nexport type NetworkType = \"unknown\" | \"online\" | \"offline\" | \"slow\";\n\n/**\n * Effective network type\n */\nexport type EffectiveNetworkType = \"2g\" | \"3g\" | \"4g\" | \"5g\" | \"unknown\";\n\n/**\n * Network state interface\n */\nexport interface NetworkState {\n  type: NetworkType;\n  lastCheckTime: number;\n  effectiveType: EffectiveNetworkType;\n  rtt: number;\n  downlink: number;\n}\n\n/**\n * Network state manager\n */\nexport class NetworkManager {\n  private state: NetworkState;\n  private checkInterval: number;\n\n  constructor() {\n    this.state = {\n      type: \"unknown\",\n      lastCheckTime: 0,\n      effectiveType: \"4g\",\n      rtt: 0,\n      downlink: 0,\n    };\n    this.checkInterval = QUEUE_CONSTANTS.NETWORK_CHECK_INTERVAL;\n  }\n\n  /**\n   * Check if network state needs update\n   */\n  private shouldUpdate(): boolean {\n    const nowTime = now();\n    return nowTime - this.state.lastCheckTime >= this.checkInterval;\n  }\n\n  /**\n   * Update network state\n   */\n  update(): void {\n    if (!isBrowser() || typeof navigator === \"undefined\") {\n      return;\n    }\n\n    if (!this.shouldUpdate()) {\n      return;\n    }\n\n    this.state.lastCheckTime = now();\n    this.state.type = navigator.onLine ? \"online\" : \"offline\";\n\n    if (\"connection\" in navigator) {\n      const connection = navigator.connection as any;\n      this.state.effectiveType = connection.effectiveType || \"unknown\";\n      this.state.rtt = connection.rtt || 0;\n      this.state.downlink = connection.downlink || 0;\n\n      if (\n        this.state.effectiveType === \"2g\" ||\n        this.state.rtt > 1000 ||\n        this.state.downlink < 1\n      ) {\n        this.state.type = \"slow\";\n      }\n    }\n  }\n\n  /**\n   * Get network state\n   */\n  getState(): NetworkState {\n    this.update();\n    return { ...this.state };\n  }\n\n  /**\n   * Get network type\n   */\n  getType(): NetworkType {\n    this.update();\n    return this.state.type;\n  }\n\n  /**\n   * Check if online\n   */\n  isOnline(): boolean {\n    this.update();\n    return this.state.type === \"online\";\n  }\n\n  /**\n   * Check if offline\n   */\n  isOffline(): boolean {\n    this.update();\n    return this.state.type === \"offline\";\n  }\n\n  /**\n   * Check if slow network\n   */\n  isSlow(): boolean {\n    this.update();\n    return this.state.type === \"slow\";\n  }\n}\n\n/**\n * Network manager instance\n */\nexport const networkManager = new NetworkManager();\n","import { isBrowser } from \"../utils\";\nimport { QUEUE_CONSTANTS } from \"./constants\";\nimport { networkManager } from \"./network\";\n\n/**\n * Send strategy type\n */\nexport type SendStrategy = \"beacon\" | \"fetch\" | \"xhr\";\n\n/**\n * Send result\n */\nexport interface SendResult {\n  success: boolean;\n  strategy: SendStrategy;\n  time: number;\n}\n\n/**\n * Send options\n */\nexport interface SendOptions {\n  endpoint: string;\n  data: any;\n  timeout?: number;\n  headers?: Record<string, string>;\n  debug?: boolean;\n}\n\n/**\n * Send strategy selector\n */\nexport class SendStrategySelector {\n  private strategyHistory: Map<\n    SendStrategy,\n    { success: number; total: number }\n  > = new Map();\n  private readonly HISTORY_SIZE = 10;\n\n  /**\n   * Select send strategy\n   * @param _body - Serialized data (reserved for future extension)\n   * @param bodySize - Data size\n   * @returns Send strategy\n   */\n  select(_body: string, bodySize: number): SendStrategy {\n    const networkType = networkManager.getType();\n\n    if (networkType === \"offline\") {\n      return \"beacon\";\n    } else if (networkType === \"slow\") {\n      return this.selectBasedOnHistory(bodySize, [\"fetch\", \"beacon\"]);\n    }\n\n    if (bodySize > QUEUE_CONSTANTS.BEACON_SIZE_LIMIT) {\n      return this.selectBasedOnHistory(bodySize, [\"fetch\", \"xhr\"]);\n    } else if (bodySize < QUEUE_CONSTANTS.SMALL_DATA_THRESHOLD) {\n      return this.selectBasedOnHistory(bodySize, [\"beacon\", \"fetch\"]);\n    }\n\n    return this.selectBasedOnHistory(bodySize, [\"fetch\", \"beacon\", \"xhr\"]);\n  }\n\n  /**\n   * Select strategy based on historical success rate\n   */\n  private selectBasedOnHistory(\n    _bodySize: number,\n    candidates: SendStrategy[],\n  ): SendStrategy {\n    let bestStrategy = candidates[0];\n    let bestSuccessRate = 0;\n\n    for (const strategy of candidates) {\n      const history = this.strategyHistory.get(strategy);\n      if (history && history.total > 0) {\n        const successRate = history.success / history.total;\n        if (successRate > bestSuccessRate) {\n          bestSuccessRate = successRate;\n          bestStrategy = strategy;\n        }\n      }\n    }\n\n    return bestStrategy;\n  }\n\n  /**\n   * Record strategy result\n   */\n  recordResult(strategy: SendStrategy, success: boolean): void {\n    const history = this.strategyHistory.get(strategy) || {\n      success: 0,\n      total: 0,\n    };\n    history.total++;\n    if (success) {\n      history.success++;\n    }\n    this.strategyHistory.set(strategy, history);\n\n    if (history.total > this.HISTORY_SIZE) {\n      history.success = Math.floor(history.success * 0.8);\n      history.total = Math.floor(history.total * 0.8);\n    }\n  }\n\n  /**\n   * Get success rate for a strategy\n   */\n  getSuccessRate(strategy: SendStrategy): number {\n    const history = this.strategyHistory.get(strategy);\n    if (!history || history.total === 0) {\n      return 1.0;\n    }\n    return history.success / history.total;\n  }\n\n  /**\n   * Reset history\n   */\n  resetHistory(): void {\n    this.strategyHistory.clear();\n  }\n}\n\n/**\n * Send data using Beacon API\n */\nasync function sendWithBeacon(\n  endpoint: string,\n  body: string,\n  debug?: boolean,\n): Promise<boolean> {\n  if (!isBrowser() || typeof navigator.sendBeacon === \"undefined\") {\n    return false;\n  }\n\n  try {\n    const success = navigator.sendBeacon(endpoint, body);\n    if (debug) {\n      console.log(\"[Node-Trace] Sent with beacon:\", success);\n    }\n    return success;\n  } catch (error) {\n    if (debug) {\n      console.log(\"[Node-Trace] Beacon failed:\", error);\n    }\n    return false;\n  }\n}\n\n/**\n * Send data using Fetch API\n */\nasync function sendWithFetch(\n  endpoint: string,\n  body: string,\n  headers: Record<string, string>,\n  timeout: number,\n  debug?: boolean,\n): Promise<boolean> {\n  if (!isBrowser() || typeof fetch === \"undefined\") {\n    return false;\n  }\n\n  try {\n    const res = await fetch(endpoint, {\n      method: \"POST\",\n      body,\n      headers: {\n        \"Content-Type\": \"application/json\",\n        ...headers,\n      },\n      keepalive: true,\n      signal: timeout ? AbortSignal.timeout(timeout) : undefined,\n    });\n\n    if (debug) {\n      console.log(\"[Node-Trace] Sent with fetch:\", res.ok);\n    }\n    return res.ok;\n  } catch (error) {\n    if (debug) {\n      console.log(\"[Node-Trace] Fetch failed:\", error);\n    }\n    return false;\n  }\n}\n\n/**\n * Send data using XMLHttpRequest (as final fallback)\n */\nasync function sendWithXHR(\n  endpoint: string,\n  data: any,\n  timeout: number,\n  debug?: boolean,\n): Promise<boolean> {\n  if (!isBrowser() || typeof XMLHttpRequest === \"undefined\") {\n    return false;\n  }\n\n  return new Promise((resolve) => {\n    const xhr = new XMLHttpRequest();\n    const body = JSON.stringify(data);\n\n    xhr.open(\"POST\", endpoint, true);\n    xhr.setRequestHeader(\"Content-Type\", \"application/json\");\n\n    if (timeout > 0) {\n      xhr.timeout = timeout;\n    }\n\n    xhr.onload = function () {\n      const success = xhr.status >= 200 && xhr.status < 300;\n      if (debug) {\n        console.log(\"[Node-Trace] Sent with XHR:\", success);\n      }\n      resolve(success);\n    };\n\n    xhr.onerror = function () {\n      if (debug) {\n        console.log(\"[Node-Trace] XHR failed\");\n      }\n      resolve(false);\n    };\n\n    xhr.ontimeout = function () {\n      if (debug) {\n        console.log(\"[Node-Trace] XHR timeout\");\n      }\n      resolve(false);\n    };\n\n    xhr.send(body);\n  });\n}\n\n/**\n * Sender\n */\nexport class Sender {\n  private strategySelector: SendStrategySelector;\n\n  constructor() {\n    this.strategySelector = new SendStrategySelector();\n  }\n\n  /**\n   * Send data\n   * @param options - Send options\n   * @returns Send result\n   */\n  async send(options: SendOptions): Promise<SendResult> {\n    if (!isBrowser()) {\n      return {\n        success: false,\n        strategy: \"fetch\",\n        time: 0,\n      };\n    }\n\n    const startTime = Date.now();\n    const {\n      endpoint,\n      data,\n      timeout = QUEUE_CONSTANTS.DEFAULT_TIMEOUT,\n      headers = {},\n      debug,\n    } = options;\n\n    const body = JSON.stringify(data);\n    const bodySize = body.length;\n\n    const strategy = this.strategySelector.select(body, bodySize);\n\n    let success = false;\n    let actualStrategy = strategy;\n\n    if (strategy === \"beacon\") {\n      success = await sendWithBeacon(endpoint, body, debug);\n      if (!success) {\n        success = await sendWithFetch(endpoint, body, headers, timeout, debug);\n        actualStrategy = \"fetch\";\n      }\n    }\n\n    if (strategy === \"fetch\" || !success) {\n      success = await sendWithFetch(endpoint, body, headers, timeout, debug);\n      actualStrategy = \"fetch\";\n      if (!success) {\n        success = await sendWithXHR(endpoint, data, timeout, debug);\n        actualStrategy = \"xhr\";\n      }\n    }\n\n    const time = Date.now() - startTime;\n\n    this.strategySelector.recordResult(actualStrategy, success);\n\n    return {\n      success,\n      strategy: actualStrategy,\n      time,\n    };\n  }\n}\n\n/**\n * Sender instance\n */\nexport const sender = new Sender();\n","/**\n * Error handler implementation\n */\nimport { state } from \"../core\";\nimport {\n  ErrorType,\n  ErrorLevel,\n  TraceError,\n  ErrorHandlerConfig,\n  ErrorStats,\n} from \"./types\";\n\n/**\n * Error handler class\n * Responsible for capturing, recording, and handling errors\n */\nexport class ErrorHandler {\n  /**\n   * Configuration\n   * @private\n   */\n  private config: ErrorHandlerConfig;\n\n  /**\n   * Error queue\n   * @private\n   */\n  private errors: TraceError[] = [];\n\n  /**\n   * Error statistics\n   * @private\n   */\n  private stats: ErrorStats = {\n    total: 0,\n    byType: {} as Record<ErrorType, number>,\n    byLevel: {} as Record<ErrorLevel, number>,\n    byCode: {} as Record<string, number>,\n    lastError: 0,\n    rate: {\n      lastMinute: 0,\n      lastHour: 0,\n    },\n    consecutiveErrors: 0,\n    maxConsecutiveErrors: 0,\n  };\n\n  /**\n   * Error timestamp list\n   * @private\n   */\n  private errorTimestamps: number[] = [];\n\n  /**\n   * Constructor\n   * @param config - Configuration options\n   */\n  constructor(config?: Partial<ErrorHandlerConfig>) {\n    this.config = {\n      capture: true,\n      logLevel: \"warn\",\n      maxErrors: 100,\n      ...config,\n    };\n\n    // Initialize error statistics\n    this.initStats();\n  }\n\n  /**\n   * Initialize error statistics\n   * @private\n   */\n  private initStats(): void {\n    // Initialize statistics by type\n    const errorTypes: ErrorType[] = [\n      \"network\",\n      \"network:timeout\",\n      \"network:offline\",\n      \"network:server\",\n      \"network:client\",\n      \"storage\",\n      \"storage:quota\",\n      \"storage:access\",\n      \"browser\",\n      \"plugin\",\n      \"plugin:init\",\n      \"plugin:execute\",\n      \"queue\",\n      \"queue:full\",\n      \"queue:overflow\",\n      \"device\",\n      \"session\",\n      \"session:timeout\",\n      \"behavior\",\n      \"data\",\n      \"data:validation\",\n      \"data:serialization\",\n      \"config\",\n      \"init\",\n      \"runtime\",\n      \"unknown\",\n    ];\n\n    errorTypes.forEach((type) => {\n      this.stats.byType[type] = 0;\n    });\n\n    // Initialize statistics by level\n    const errorLevels: ErrorLevel[] = [\n      \"debug\",\n      \"info\",\n      \"warn\",\n      \"error\",\n      \"fatal\",\n    ];\n    errorLevels.forEach((level) => {\n      this.stats.byLevel[level] = 0;\n    });\n  }\n\n  /**\n   * Generate error ID\n   * @private\n   * @returns Error ID\n   */\n  private generateErrorId(): string {\n    return (\n      \"error_\" + Date.now() + \"_\" + Math.random().toString(36).substr(2, 9)\n    );\n  }\n\n  /**\n   * Parse error stack\n   * @private\n   * @param stack - Error stack\n   * @returns Parsed result\n   */\n  private parseStack(stack: string): { file?: string; line?: number } {\n    const stackLines = stack.split(\"\\n\");\n    for (const line of stackLines) {\n      const match = line.match(/at \\s*(?:\\w+\\s+)?\\(?([^:]+):(\\d+):(\\d+)\\)?/);\n      if (match) {\n        return {\n          file: match[1],\n          line: parseInt(match[2]),\n        };\n      }\n    }\n    return {};\n  }\n\n  /**\n   * Update error statistics\n   * @private\n   * @param error - Error object\n   */\n  private updateStats(error: TraceError): void {\n    // Update total error count\n    this.stats.total++;\n\n    // Update statistics by type\n    this.stats.byType[error.type] = (this.stats.byType[error.type] || 0) + 1;\n\n    // Update statistics by level\n    this.stats.byLevel[error.level] =\n      (this.stats.byLevel[error.level] || 0) + 1;\n\n    // Update statistics by code\n    if (error.code) {\n      this.stats.byCode[error.code] = (this.stats.byCode[error.code] || 0) + 1;\n    }\n\n    // Update last error time\n    this.stats.lastError = error.timestamp;\n\n    // Update error timestamp list\n    this.errorTimestamps.push(error.timestamp);\n\n    // Clean up expired timestamps (keep only the last hour)\n    const oneHourAgo = Date.now() - 60 * 60 * 1000;\n    this.errorTimestamps = this.errorTimestamps.filter((ts) => ts > oneHourAgo);\n\n    // Update error rate\n    const oneMinuteAgo = Date.now() - 60 * 1000;\n    this.stats.rate.lastMinute = this.errorTimestamps.filter(\n      (ts) => ts > oneMinuteAgo,\n    ).length;\n    this.stats.rate.lastHour = this.errorTimestamps.length;\n\n    // Update consecutive error count\n    const timeSinceLastError = error.timestamp - this.stats.lastError;\n    if (timeSinceLastError < 5000) {\n      // Errors within 5 seconds are considered consecutive\n      this.stats.consecutiveErrors++;\n      if (this.stats.consecutiveErrors > this.stats.maxConsecutiveErrors) {\n        this.stats.maxConsecutiveErrors = this.stats.consecutiveErrors;\n      }\n    } else {\n      this.stats.consecutiveErrors = 1;\n    }\n  }\n\n  /**\n   * Record error\n   * @param type - Error type\n   * @param message - Error message\n   * @param error - Original error object\n   * @param context - Error context\n   * @param level - Error level\n   * @param code - Error code\n   * @param source - Error source\n   */\n  public captureError(\n    type: ErrorType,\n    message: string,\n    error?: unknown,\n    context?: Record<string, unknown>,\n    level: ErrorLevel = \"error\",\n    code?: string,\n    source?: string,\n  ): TraceError {\n    const errorObj = error as Error | undefined;\n    const errorDetails = error as { details?: unknown } | undefined;\n\n    if (!this.config.capture) {\n      const dummyError: TraceError = {\n        type,\n        level,\n        message,\n        code,\n        stack: errorObj?.stack,\n        context,\n        timestamp: Date.now(),\n        id: this.generateErrorId(),\n      };\n      return dummyError;\n    }\n\n    // Parse error stack\n    let file: string | undefined;\n    let line: number | undefined;\n    if (errorObj?.stack) {\n      const stackInfo = this.parseStack(errorObj.stack);\n      file = stackInfo.file;\n      line = stackInfo.line;\n    }\n\n    // Create error object\n    const traceError: TraceError = {\n      type,\n      level,\n      message,\n      code,\n      stack: errorObj?.stack,\n      context,\n      details: errorDetails?.details as Record<string, unknown> | undefined,\n      source: source || \"unknown\",\n      file,\n      line,\n      timestamp: Date.now(),\n      id: this.generateErrorId(),\n      event: context?.event as string | undefined,\n      userId: context?.userId as string | undefined,\n      deviceId: context?.deviceId as string | undefined,\n    };\n\n    // Add to error queue\n    this.errors.push(traceError);\n\n    // Limit error queue size\n    if (this.errors.length > this.config.maxErrors) {\n      this.errors.shift();\n    }\n\n    // Update error statistics\n    this.updateStats(traceError);\n\n    // Log error\n    this.logError(traceError);\n\n    // Check if error rate is too high\n    this.checkErrorRate(traceError);\n\n    return traceError;\n  }\n\n  /**\n   * Check error rate\n   * @private\n   * @param error - Error object\n   */\n  private checkErrorRate(error: TraceError): void {\n    // Check if error rate is too high\n    if (this.stats.rate.lastMinute > 10) {\n      // More than 10 errors per minute, there may be a problem\n      if (typeof console !== \"undefined\") {\n        console.warn(\"[Node-Trace] High error rate detected:\", {\n          errorsPerMinute: this.stats.rate.lastMinute,\n          consecutiveErrors: this.stats.consecutiveErrors,\n          maxConsecutiveErrors: this.stats.maxConsecutiveErrors,\n        });\n      }\n    }\n\n    // Check consecutive error count\n    if (this.stats.consecutiveErrors > 5) {\n      // More than 5 consecutive errors, there may be a serious problem\n      if (typeof console !== \"undefined\") {\n        console.error(\"[Node-Trace] Critical error sequence detected:\", {\n          consecutiveErrors: this.stats.consecutiveErrors,\n          lastError: error,\n          recentErrors: this.errors.slice(-3),\n        });\n      }\n    }\n  }\n\n  /**\n   * Log error\n   * @private\n   * @param error - Error object\n   */\n  private logError(error: TraceError): void {\n    const debugEnabled = state.options?.debug || false;\n    const shouldLog = this.shouldLog(error.level);\n\n    if (debugEnabled && shouldLog) {\n      const prefix = `[Node-Trace] [${error.type.toUpperCase()}]${error.code ? ` [${error.code}]` : \"\"}`;\n      const contextStr = error.context\n        ? ` Context: ${JSON.stringify(error.context)}`\n        : \"\";\n      const detailsStr = error.details\n        ? ` Details: ${JSON.stringify(error.details)}`\n        : \"\";\n      const stackStr = error.stack ? `\\nStack: ${error.stack}` : \"\";\n      const errorIdStr = ` ErrorID: ${error.id}`;\n\n      switch (error.level) {\n        case \"debug\":\n          console.debug(\n            `${prefix} ${error.message}${errorIdStr}${contextStr}${detailsStr}${stackStr}`,\n          );\n          break;\n        case \"info\":\n          console.info(\n            `${prefix} ${error.message}${errorIdStr}${contextStr}${detailsStr}${stackStr}`,\n          );\n          break;\n        case \"warn\":\n          console.warn(\n            `${prefix} ${error.message}${errorIdStr}${contextStr}${detailsStr}${stackStr}`,\n          );\n          break;\n        case \"error\":\n          console.error(\n            `${prefix} ${error.message}${errorIdStr}${contextStr}${detailsStr}${stackStr}`,\n          );\n          break;\n        case \"fatal\":\n          console.error(\n            `${prefix} [FATAL] ${error.message}${errorIdStr}${contextStr}${detailsStr}${stackStr}`,\n          );\n          break;\n      }\n    }\n  }\n\n  /**\n   * Get error statistics\n   * @returns Error statistics information\n   */\n  public getStats(): ErrorStats {\n    return {\n      ...this.stats,\n    };\n  }\n\n  /**\n   * Get recent errors\n   * @param count - Number of errors\n   * @returns List of recent errors\n   */\n  public getRecentErrors(count: number = 10): TraceError[] {\n    return this.errors.slice(-count);\n  }\n\n  /**\n   * Check if there are errors\n   * @returns Whether there are errors\n   */\n  public hasErrors(): boolean {\n    return this.errors.length > 0;\n  }\n\n  /**\n   * Get error summary\n   * @returns Error summary\n   */\n  public getErrorSummary(): {\n    total: number;\n    lastError: TraceError | null;\n    mostFrequentType: ErrorType | null;\n    mostFrequentLevel: ErrorLevel | null;\n    rate: {\n      lastMinute: number;\n      lastHour: number;\n    };\n  } {\n    if (this.errors.length === 0) {\n      return {\n        total: 0,\n        lastError: null,\n        mostFrequentType: null,\n        mostFrequentLevel: null,\n        rate: {\n          lastMinute: 0,\n          lastHour: 0,\n        },\n      };\n    }\n\n    // Find most frequent error type\n    let mostFrequentType: ErrorType | null = null;\n    let maxTypeCount = 0;\n    Object.entries(this.stats.byType).forEach(([type, count]) => {\n      if (count > maxTypeCount) {\n        maxTypeCount = count;\n        mostFrequentType = type as ErrorType;\n      }\n    });\n\n    // Find most frequent error level\n    let mostFrequentLevel: ErrorLevel | null = null;\n    let maxLevelCount = 0;\n    Object.entries(this.stats.byLevel).forEach(([level, count]) => {\n      if (count > maxLevelCount) {\n        maxLevelCount = count;\n        mostFrequentLevel = level as ErrorLevel;\n      }\n    });\n\n    return {\n      total: this.stats.total,\n      lastError: this.errors[this.errors.length - 1],\n      mostFrequentType,\n      mostFrequentLevel,\n      rate: {\n        lastMinute: this.stats.rate.lastMinute,\n        lastHour: this.stats.rate.lastHour,\n      },\n    };\n  }\n\n  /**\n   * Check if this error level should be logged\n   * @private\n   * @param level - Error level\n   * @returns Whether to log\n   */\n  private shouldLog(level: ErrorLevel): boolean {\n    const levelOrder = [\"debug\", \"info\", \"warn\", \"error\", \"fatal\"];\n    const configLevelIndex = levelOrder.indexOf(this.config.logLevel);\n    const errorLevelIndex = levelOrder.indexOf(level);\n    return errorLevelIndex >= configLevelIndex;\n  }\n\n  /**\n   * Get error queue\n   * @returns Error queue\n   */\n  public getErrors(): TraceError[] {\n    return [...this.errors];\n  }\n\n  /**\n   * Clear error queue\n   */\n  public clearErrors(): void {\n    this.errors = [];\n  }\n\n  /**\n   * Handle network error\n   * @param error - Error object\n   * @param context - Error context\n   */\n  public handleNetworkError(\n    error: unknown,\n    context?: Record<string, unknown>,\n  ): void {\n    this.captureError(\"network\", \"Network error occurred\", error, context);\n  }\n\n  /**\n   * Handle storage error\n   * @param error - Error object\n   * @param context - Error context\n   */\n  public handleStorageError(\n    error: unknown,\n    context?: Record<string, unknown>,\n  ): void {\n    this.captureError(\n      \"storage\",\n      \"Storage error occurred\",\n      error,\n      context,\n      \"warn\",\n    );\n  }\n\n  /**\n   * Handle browser API error\n   * @param error - Error object\n   * @param context - Error context\n   */\n  public handleBrowserError(\n    error: unknown,\n    context?: Record<string, unknown>,\n  ): void {\n    this.captureError(\n      \"browser\",\n      \"Browser API error occurred\",\n      error,\n      context,\n      \"warn\",\n    );\n  }\n\n  /**\n   * Handle plugin error\n   * @param error - Error object\n   * @param context - Error context\n   */\n  public handlePluginError(\n    error: unknown,\n    context?: Record<string, unknown>,\n  ): void {\n    this.captureError(\"plugin\", \"Plugin error occurred\", error, context);\n  }\n\n  /**\n   * Handle queue error\n   * @param error - Error object\n   * @param context - Error context\n   */\n  public handleQueueError(\n    error: unknown,\n    context?: Record<string, unknown>,\n  ): void {\n    this.captureError(\"queue\", \"Queue error occurred\", error, context);\n  }\n\n  /**\n   * Handle device ID error\n   * @param error - Error object\n   * @param context - Error context\n   */\n  public handleDeviceError(\n    error: unknown,\n    context?: Record<string, unknown>,\n  ): void {\n    this.captureError(\n      \"device\",\n      \"Device ID error occurred\",\n      error,\n      context,\n      \"warn\",\n    );\n  }\n\n  /**\n   * Handle session error\n   * @param error - Error object\n   * @param context - Error context\n   */\n  public handleSessionError(\n    error: unknown,\n    context?: Record<string, unknown>,\n  ): void {\n    this.captureError(\n      \"session\",\n      \"Session error occurred\",\n      error,\n      context,\n      \"warn\",\n    );\n  }\n\n  /**\n   * Handle behavior error\n   * @param error - Error object\n   * @param context - Error context\n   */\n  public handleBehaviorError(\n    error: unknown,\n    context?: Record<string, unknown>,\n  ): void {\n    this.captureError(\n      \"behavior\",\n      \"Behavior error occurred\",\n      error,\n      context,\n      \"warn\",\n    );\n  }\n\n  /**\n   * Handle data error\n   * @param error - Error object\n   * @param context - Error context\n   */\n  public handleDataError(\n    error: unknown,\n    context?: Record<string, unknown>,\n  ): void {\n    this.captureError(\"data\", \"Data processing error occurred\", error, context);\n  }\n\n  /**\n   * Handle unknown error\n   * @param error - Error object\n   * @param context - Error context\n   */\n  public handleUnknownError(\n    error: unknown,\n    context?: Record<string, unknown>,\n  ): void {\n    this.captureError(\"unknown\", \"Unknown error occurred\", error, context);\n  }\n}\n","/**\n * Error statistics module\n */\nimport {\n  ErrorType,\n  ErrorLevel,\n  TraceError,\n  ErrorStats,\n  ErrorSummary,\n} from \"./types\";\n\n/**\n * Initialize error statistics\n * @returns Initialized error statistics object\n */\nexport function initializeStats(): ErrorStats {\n  const errorTypes: ErrorType[] = [\n    \"network\",\n    \"network:timeout\",\n    \"network:offline\",\n    \"network:server\",\n    \"network:client\",\n    \"storage\",\n    \"storage:quota\",\n    \"storage:access\",\n    \"browser\",\n    \"plugin\",\n    \"plugin:init\",\n    \"plugin:execute\",\n    \"queue\",\n    \"queue:full\",\n    \"queue:overflow\",\n    \"device\",\n    \"session\",\n    \"session:timeout\",\n    \"behavior\",\n    \"data\",\n    \"data:validation\",\n    \"data:serialization\",\n    \"config\",\n    \"init\",\n    \"runtime\",\n    \"unknown\",\n  ];\n\n  const errorLevels: ErrorLevel[] = [\"debug\", \"info\", \"warn\", \"error\", \"fatal\"];\n\n  const byType = {} as Record<ErrorType, number>;\n  errorTypes.forEach((type) => {\n    byType[type] = 0;\n  });\n\n  const byLevel = {} as Record<ErrorLevel, number>;\n  errorLevels.forEach((level) => {\n    byLevel[level] = 0;\n  });\n\n  return {\n    total: 0,\n    byType,\n    byLevel,\n    byCode: {},\n    lastError: 0,\n    rate: {\n      lastMinute: 0,\n      lastHour: 0,\n    },\n    consecutiveErrors: 0,\n    maxConsecutiveErrors: 0,\n  };\n}\n\n/**\n * Calculate error rate\n * @param timestamps - List of error timestamps\n * @returns Error rate object\n */\nexport function calculateErrorRate(timestamps: number[]): {\n  lastMinute: number;\n  lastHour: number;\n} {\n  const now = Date.now();\n  const oneMinuteAgo = now - 60 * 1000;\n  const oneHourAgo = now - 60 * 60 * 1000;\n\n  return {\n    lastMinute: timestamps.filter((ts) => ts > oneMinuteAgo).length,\n    lastHour: timestamps.filter((ts) => ts > oneHourAgo).length,\n  };\n}\n\n/**\n * Generate error summary\n * @param errors - List of errors\n * @param stats - Error statistics\n * @returns Error summary\n */\nexport function generateErrorSummary(\n  errors: TraceError[],\n  stats: ErrorStats,\n): ErrorSummary {\n  if (errors.length === 0) {\n    return {\n      total: 0,\n      lastError: null,\n      mostFrequentType: null,\n      mostFrequentLevel: null,\n      rate: {\n        lastMinute: 0,\n        lastHour: 0,\n      },\n    };\n  }\n\n  // Find the most frequent error type\n  let mostFrequentType: ErrorType | null = null;\n  let maxTypeCount = 0;\n  Object.entries(stats.byType).forEach(([type, count]) => {\n    if (count > maxTypeCount) {\n      maxTypeCount = count;\n      mostFrequentType = type as ErrorType;\n    }\n  });\n\n  // Find the most frequent error level\n  let mostFrequentLevel: ErrorLevel | null = null;\n  let maxLevelCount = 0;\n  Object.entries(stats.byLevel).forEach(([level, count]) => {\n    if (count > maxLevelCount) {\n      maxLevelCount = count;\n      mostFrequentLevel = level as ErrorLevel;\n    }\n  });\n\n  return {\n    total: stats.total,\n    lastError: errors[errors.length - 1],\n    mostFrequentType,\n    mostFrequentLevel,\n    rate: stats.rate,\n  };\n}\n\n/**\n * Clean up expired timestamps\n * @param timestamps - List of timestamps\n * @param threshold - Threshold timestamp\n * @returns Cleaned list of timestamps\n */\nexport function cleanupTimestamps(\n  timestamps: number[],\n  threshold: number,\n): number[] {\n  return timestamps.filter((ts) => ts > threshold);\n}\n","/**\n * Error handling module\n * Main entry file, exports all error handling related types and functions\n */\n\n// Export types\nexport * from \"./types\";\n\n// Export error handler\nexport { ErrorHandler } from \"./handler\";\n\n// Export statistics utilities\nexport * from \"./stats\";\n\n// Create error handler instance\nimport { ErrorHandler } from \"./handler\";\n\n/**\n * Error handler instance\n */\nexport const errorHandler = new ErrorHandler();\n\n/**\n * Capture error\n * @param type - Error type\n * @param message - Error message\n * @param error - Original error object\n * @param context - Error context\n * @param level - Error level\n */\nexport function captureError(\n  type: import(\"./types\").ErrorType,\n  message: string,\n  error?: unknown,\n  context?: Record<string, unknown>,\n  level: import(\"./types\").ErrorLevel = \"error\",\n): void {\n  errorHandler.captureError(type, message, error, context, level);\n}\n\n/**\n * Handle network error\n * @param error - Error object\n * @param context - Error context\n */\nexport function handleNetworkError(\n  error: unknown,\n  context?: Record<string, unknown>,\n): void {\n  errorHandler.handleNetworkError(error, context);\n}\n\n/**\n * Handle storage error\n * @param error - Error object\n * @param context - Error context\n */\nexport function handleStorageError(\n  error: unknown,\n  context?: Record<string, unknown>,\n): void {\n  errorHandler.handleStorageError(error, context);\n}\n\n/**\n * Handle browser API error\n * @param error - Error object\n * @param context - Error context\n */\nexport function handleBrowserError(\n  error: unknown,\n  context?: Record<string, unknown>,\n): void {\n  errorHandler.handleBrowserError(error, context);\n}\n\n/**\n * Handle plugin error\n * @param error - Error object\n * @param context - Error context\n */\nexport function handlePluginError(\n  error: unknown,\n  context?: Record<string, unknown>,\n): void {\n  errorHandler.handlePluginError(error, context);\n}\n\n/**\n * Handle queue error\n * @param error - Error object\n * @param context - Error context\n */\nexport function handleQueueError(\n  error: unknown,\n  context?: Record<string, unknown>,\n): void {\n  errorHandler.handleQueueError(error, context);\n}\n\n/**\n * Handle device ID error\n * @param error - Error object\n * @param context - Error context\n */\nexport function handleDeviceError(\n  error: unknown,\n  context?: Record<string, unknown>,\n): void {\n  errorHandler.handleDeviceError(error, context);\n}\n\n/**\n * Handle session error\n * @param error - Error object\n * @param context - Error context\n */\nexport function handleSessionError(\n  error: unknown,\n  context?: Record<string, unknown>,\n): void {\n  errorHandler.handleSessionError(error, context);\n}\n\n/**\n * Handle behavior error\n * @param error - Error object\n * @param context - Error context\n */\nexport function handleBehaviorError(\n  error: unknown,\n  context?: Record<string, unknown>,\n): void {\n  errorHandler.handleBehaviorError(error, context);\n}\n\n/**\n * Handle data error\n * @param error - Error object\n * @param context - Error context\n */\nexport function handleDataError(\n  error: unknown,\n  context?: Record<string, unknown>,\n): void {\n  errorHandler.handleDataError(error, context);\n}\n\n/**\n * Handle unknown error\n * @param error - Error object\n * @param context - Error context\n */\nexport function handleUnknownError(\n  error: unknown,\n  context?: Record<string, unknown>,\n): void {\n  errorHandler.handleUnknownError(error, context);\n}\n","/**\n * Import Dexie database library\n */\nimport Dexie, { Table } from \"dexie\";\n/**\n * Import event payload type\n */\nimport { Payload } from \"./types\";\n\n/**\n * NodeTrace database class\n * Extends Dexie for storing offline events\n */\nclass NodeTraceDB extends Dexie {\n  /**\n   * Offline events table\n   */\n  offlineEvents!: Table<Payload>;\n\n  /**\n   * Constructor\n   */\n  constructor() {\n    super(\"nodeTraceDb\");\n    this.version(1).stores({\n      offlineEvents: \"id, event, timestamp\",\n    });\n  }\n}\n\n\n/**\n * Database instance\n */\nconst db = new NodeTraceDB();\n\n/**\n * Dexie storage class\n * Used for managing offline event storage operations\n */\nexport class DexieStorage {\n  private writeBuffer: Payload[] = [];\n  private writeTimer: ReturnType<typeof setTimeout> | null = null;\n  private readonly WRITE_BUFFER_SIZE = 100;\n  private readonly WRITE_BUFFER_TIMEOUT = 5000;\n\n  /**\n   * Get all offline events\n   * @returns Offline events array\n   */\n  async all(): Promise<Payload[]> {\n    try {\n      return await db.offlineEvents.toArray();\n    } catch {\n      return [];\n    }\n  }\n\n  /**\n   * Add offline events\n   * @param events - Events array to add\n   */\n  async add(events: Payload[]): Promise<void> {\n    this.writeBuffer.push(...events);\n\n    if (this.writeBuffer.length >= this.WRITE_BUFFER_SIZE) {\n      await this.flushBuffer();\n    } else {\n      this.scheduleFlush();\n    }\n  }\n\n  /**\n   * Clear all offline events\n   */\n  async clear(): Promise<void> {\n    try {\n      await db.offlineEvents.clear();\n    } catch {\n      // Ignore storage errors\n    }\n  }\n\n  /**\n   * Delete offline events by ID\n   * @param ids - Event IDs array to delete\n   */\n  async delete(ids: string[]): Promise<void> {\n    try {\n      if (ids.length > 0) {\n        await db.offlineEvents.bulkDelete(ids);\n      }\n    } catch {\n      // Ignore storage errors\n    }\n  }\n\n  /**\n   * Flush write buffer to database\n   */\n  private async flushBuffer(): Promise<void> {\n    if (this.writeBuffer.length === 0) return;\n\n    const eventsToWrite = this.writeBuffer.splice(0);\n    try {\n      await db.offlineEvents.bulkAdd(eventsToWrite);\n    } catch {\n      // Ignore storage errors\n    }\n  }\n\n  /**\n   * Schedule buffer flush\n   */\n  private scheduleFlush(): void {\n    if (this.writeTimer) return;\n    this.writeTimer = setTimeout(() => {\n      this.flushBuffer();\n      this.writeTimer = null;\n    }, this.WRITE_BUFFER_TIMEOUT);\n  }\n\n  /**\n   * Force flush buffer immediately\n   */\n  async forceFlush(): Promise<void> {\n    if (this.writeTimer) {\n      clearTimeout(this.writeTimer);\n      this.writeTimer = null;\n    }\n    await this.flushBuffer();\n  }\n}\n\n\n/**\n * Dexie storage instance\n */\nexport const DB = new DexieStorage();","import type { Payload, EventProperties } from \"../types\";\n\nexport type EventPriority = \"high\" | \"normal\" | \"low\";\n\nexport interface PriorityEvent<\n  T extends EventProperties = EventProperties,\n> extends Payload<T> {\n  priority: EventPriority;\n}\n\nexport class PriorityQueue<T extends EventProperties = EventProperties> {\n  private high: PriorityEvent<T>[] = [];\n  private normal: PriorityEvent<T>[] = [];\n  private low: PriorityEvent<T>[] = [];\n\n  push(event: Payload<T>, priority: EventPriority = \"normal\"): void {\n    const priorityEvent: PriorityEvent<T> = { ...event, priority };\n    this[priority].push(priorityEvent);\n  }\n\n  pop(): PriorityEvent<T> | undefined {\n    if (this.high.length > 0) return this.high.shift();\n    if (this.normal.length > 0) return this.normal.shift();\n    return this.low.shift();\n  }\n\n  peek(): PriorityEvent<T> | undefined {\n    if (this.high.length > 0) return this.high[0];\n    if (this.normal.length > 0) return this.normal[0];\n    return this.low[0];\n  }\n\n  size(): number {\n    return this.high.length + this.normal.length + this.low.length;\n  }\n\n  isEmpty(): boolean {\n    return this.size() === 0;\n  }\n\n  clear(): void {\n    this.high = [];\n    this.normal = [];\n    this.low = [];\n  }\n\n  getBatch(size: number): PriorityEvent<T>[] {\n    const batch: PriorityEvent<T>[] = [];\n\n    while (batch.length < size && !this.isEmpty()) {\n      const event = this.pop();\n      if (event) {\n        batch.push(event);\n      }\n    }\n\n    return batch;\n  }\n\n  getStats(): {\n    high: number;\n    normal: number;\n    low: number;\n    total: number;\n  } {\n    return {\n      high: this.high.length,\n      normal: this.normal.length,\n      low: this.low.length,\n      total: this.size(),\n    };\n  }\n}\n\nexport function determineEventPriority(event: string): EventPriority {\n  const highPriorityEvents = [\n    \"js_error\",\n    \"promise_error\",\n    \"session_start\",\n    \"session_end\",\n  ];\n  const lowPriorityEvents = [\"scroll\", \"page_view\", \"performance\"];\n\n  if (highPriorityEvents.includes(event)) {\n    return \"high\";\n  }\n\n  if (lowPriorityEvents.includes(event)) {\n    return \"low\";\n  }\n\n  return \"normal\";\n}\n","import type { Payload, EventProperties } from \"../types\";\nimport { QUEUE_CONSTANTS } from \"./constants\";\nimport { EventDedupe } from \"./dedupe\";\nimport { sender } from \"./sender\";\nimport { plugins } from \"../core\";\nimport { handleNetworkError, handlePluginError } from \"../error\";\nimport { DB } from \"../db\";\nimport { isBrowser } from \"../utils\";\nimport { PriorityQueue, determineEventPriority } from \"./priority\";\n\n/**\n * Queue statistics\n */\nexport interface QueueStats {\n  totalEvents: number;\n  sendSuccessCount: number;\n  sendFailCount: number;\n  averageSendTime: number;\n  lastSendTime: number;\n}\n\n/**\n * Queue configuration\n */\nexport interface QueueConfig {\n  maxQueueSize: number;\n  batchSize: number;\n  batchInterval: number;\n  retryCount: number;\n  retryInterval: number;\n  offlineEnabled: boolean;\n  debug: boolean;\n  endpoint: string;\n  appId: string;\n  appKey?: string;\n  headers?: Record<string, string>;\n  timeout?: number;\n}\n\n/**\n * Queue manager\n */\nexport class QueueManager {\n  private queue: Payload<EventProperties>[];\n  private priorityQueue: PriorityQueue<EventProperties>;\n  private dedupe: EventDedupe;\n  private stats: QueueStats;\n  private config: QueueConfig | null;\n  private timer: ReturnType<typeof setTimeout> | null;\n  private retryTimers: ReturnType<typeof setTimeout>[];\n  private offlineCheckTimer: ReturnType<typeof setInterval> | null;\n  private cachedPressure: number | null;\n  private pressureCacheTime: number;\n  private readonly PRESSURE_CACHE_TTL: number;\n\n  constructor() {\n    this.queue = [];\n    this.priorityQueue = new PriorityQueue();\n    this.dedupe = new EventDedupe(QUEUE_CONSTANTS.DEDUPE_CACHE_MAX_SIZE);\n    this.stats = {\n      totalEvents: 0,\n      sendSuccessCount: 0,\n      sendFailCount: 0,\n      averageSendTime: 0,\n      lastSendTime: 0,\n    };\n    this.config = null;\n    this.timer = null;\n    this.retryTimers = [];\n    this.offlineCheckTimer = null;\n    this.cachedPressure = null;\n    this.pressureCacheTime = 0;\n    this.PRESSURE_CACHE_TTL = 1000;\n  }\n\n  /**\n   * Initialize queue\n   */\n  init(config: QueueConfig): void {\n    this.config = config;\n    this.startOfflineCheck();\n  }\n\n  /**\n   * Calculate queue pressure (0-1)\n   */\n  private calculatePressure(): number {\n    if (!this.config) return 0;\n\n    const now = Date.now();\n    if (\n      this.cachedPressure !== null &&\n      now - this.pressureCacheTime < this.PRESSURE_CACHE_TTL\n    ) {\n      return this.cachedPressure;\n    }\n\n    const pressure = this.queue.length / this.config.maxQueueSize;\n    this.cachedPressure = pressure;\n    this.pressureCacheTime = now;\n    return pressure;\n  }\n\n  /**\n   * Get dynamic batch size\n   */\n  private getDynamicBatchSize(): number {\n    if (!this.config) return QUEUE_CONSTANTS.DEFAULT_BATCH_SIZE;\n\n    const pressure = this.calculatePressure();\n    let batchSize = this.config.batchSize;\n\n    if (pressure > QUEUE_CONSTANTS.QUEUE_PRESSURE_MEDIUM) {\n      batchSize = Math.max(\n        Math.floor(batchSize * 0.8),\n        QUEUE_CONSTANTS.MIN_BATCH_SIZE,\n      );\n    } else if (pressure < QUEUE_CONSTANTS.QUEUE_PRESSURE_LOW) {\n      batchSize = Math.min(\n        Math.ceil(batchSize * 1.2),\n        QUEUE_CONSTANTS.MAX_BATCH_SIZE,\n      );\n    }\n\n    return Math.min(batchSize, this.queue.length);\n  }\n\n  /**\n   * Get dynamic send interval\n   */\n  private getDynamicInterval(): number {\n    if (!this.config) return QUEUE_CONSTANTS.DEFAULT_BATCH_INTERVAL;\n\n    const pressure = this.calculatePressure();\n    let interval = this.config.batchInterval;\n\n    if (pressure > QUEUE_CONSTANTS.QUEUE_PRESSURE_MEDIUM) {\n      interval = Math.max(interval * 0.5, QUEUE_CONSTANTS.MIN_BATCH_INTERVAL);\n    } else if (pressure < QUEUE_CONSTANTS.QUEUE_PRESSURE_LOW) {\n      interval = Math.min(interval * 1.5, QUEUE_CONSTANTS.MAX_BATCH_INTERVAL);\n    }\n\n    return interval;\n  }\n\n  /**\n   * Handle queue full scenario\n   */\n  private handleQueueFull(): void {\n    if (!this.config) return;\n\n    const pressure = this.calculatePressure();\n    let removeCount = 1;\n\n    if (pressure > QUEUE_CONSTANTS.QUEUE_PRESSURE_VERY_HIGH) {\n      removeCount = Math.min(\n        Math.ceil(this.queue.length * QUEUE_CONSTANTS.QUEUE_CLEANUP_RATIO),\n        QUEUE_CONSTANTS.MAX_CLEANUP_COUNT,\n      );\n    } else if (pressure > QUEUE_CONSTANTS.QUEUE_PRESSURE_HIGH) {\n      removeCount = Math.min(Math.ceil(this.queue.length * 0.05), 5);\n    }\n\n    const removedEvents = this.queue.splice(0, removeCount);\n    this.dedupe.removeBatch(removedEvents);\n\n    if (this.config.debug) {\n      console.log(\"[Node-Trace] Queue full, removed events:\", removeCount);\n    }\n  }\n\n  /**\n   * Push event to queue\n   */\n  push<T extends EventProperties>(event: Payload<T>): void {\n    if (this.dedupe.exists(event)) {\n      if (this.config?.debug) {\n        console.log(\n          \"[Node-Trace] Event already exists, skipping:\",\n          event.event,\n        );\n      }\n      return;\n    }\n\n    if (!this.config) {\n      this.queue.push(event);\n      this.dedupe.add(event);\n      return;\n    }\n\n    if (this.queue.length >= this.config.maxQueueSize) {\n      this.handleQueueFull();\n    }\n\n    this.queue.push(event);\n    this.dedupe.add(event);\n    this.stats.totalEvents++;\n\n    const priority = determineEventPriority(event.event);\n    this.priorityQueue.push(event, priority);\n\n    if (this.config.debug) {\n      console.log(\n        \"[Node-Trace] Event pushed:\",\n        event.event,\n        \"priority:\",\n        priority,\n      );\n      console.log(\"[Node-Trace] Queue length:\", this.queue.length);\n    }\n\n    this.cachedPressure = null;\n\n    const pressure = this.calculatePressure();\n    if (pressure > QUEUE_CONSTANTS.QUEUE_PRESSURE_HIGH) {\n      this.flush();\n    } else {\n      this.schedule();\n    }\n  }\n\n  /**\n   * Schedule send task\n   */\n  private schedule(): void {\n    if (this.timer) return;\n\n    const interval = this.getDynamicInterval();\n    this.timer = setTimeout(() => {\n      this.flush();\n    }, interval);\n  }\n\n  /**\n   * Update send statistics\n   */\n  private updateStats(sendTime: number, success: boolean): void {\n    this.stats.lastSendTime = Date.now();\n\n    if (success) {\n      this.stats.sendSuccessCount++;\n    } else {\n      this.stats.sendFailCount++;\n    }\n\n    const totalSends = this.stats.sendSuccessCount + this.stats.sendFailCount;\n    if (totalSends > 0) {\n      this.stats.averageSendTime =\n        (this.stats.averageSendTime * (totalSends - 1) + sendTime) / totalSends;\n    }\n  }\n\n  /**\n   * Handle send failure\n   */\n  private async handleSendFailure(\n    batch: Payload<EventProperties>[],\n  ): Promise<void> {\n    if (!this.config) return;\n\n    if (this.config.debug) {\n      console.log(\"[Node-Trace] Send failed, batch size:\", batch.length);\n    }\n\n    if (this.config.offlineEnabled && isBrowser()) {\n      try {\n        await DB.add(batch);\n        if (this.config.debug) {\n          console.log(\"[Node-Trace] Events cached offline:\", batch.length);\n        }\n      } catch (error) {\n        handleNetworkError(error, { eventCount: batch.length });\n      }\n    } else if (this.config.retryCount > 0) {\n      const baseInterval = this.config.retryInterval;\n      const retryInterval =\n        baseInterval *\n        Math.pow(2, this.stats.sendFailCount % QUEUE_CONSTANTS.MAX_RETRY_COUNT);\n\n      const retryTimer = setTimeout(() => {\n        this.queue.unshift(...batch);\n        batch.forEach((event) => this.dedupe.add(event));\n        if (this.config?.debug) {\n          console.log(\"[Node-Trace] Retrying events:\", batch.length);\n        }\n        this.schedule();\n      }, retryInterval);\n\n      this.retryTimers.push(retryTimer);\n    }\n  }\n\n  /**\n   * Handle send success\n   */\n  private async handleSendSuccess(\n    batch: Payload<EventProperties>[],\n  ): Promise<void> {\n    if (this.config?.debug) {\n      console.log(\"[Node-Trace] Events sent successfully:\", batch.length);\n    }\n\n    if (isBrowser()) {\n      await DB.forceFlush();\n      await DB.clear();\n    }\n  }\n\n  /**\n   * Apply plugin beforeSend hooks\n   */\n  private applyBeforeSendHooks(\n    batch: Payload<EventProperties>[],\n  ): Payload<EventProperties>[] {\n    const sortedPlugins = plugins.sort();\n    let result = batch;\n\n    for (const plugin of sortedPlugins) {\n      if (plugin.beforeSend) {\n        try {\n          result = plugin.beforeSend(result);\n        } catch (error) {\n          handlePluginError(error, {\n            plugin: plugin.name,\n            context: \"beforeSend\",\n          });\n        }\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Apply plugin afterSend hooks\n   */\n  private applyAfterSendHooks(\n    batch: Payload<EventProperties>[],\n    success: boolean,\n  ): void {\n    const sortedPlugins = plugins.getAll();\n\n    for (const plugin of sortedPlugins) {\n      if (plugin.afterSend) {\n        try {\n          plugin.afterSend(batch, success);\n        } catch (error) {\n          handlePluginError(error, {\n            plugin: plugin.name,\n            context: \"afterSend\",\n          });\n        }\n      }\n    }\n  }\n\n  /**\n   * Send events in queue\n   */\n  async flush(): Promise<void> {\n    if (!this.config || this.queue.length === 0) {\n      return;\n    }\n\n    const batchSize = this.getDynamicBatchSize();\n\n    const priorityBatch = this.priorityQueue.getBatch(batchSize);\n    const batchIds = new Set(priorityBatch.map((e) => e.id));\n\n    const batch = this.queue.filter((e) => batchIds.has(e.id));\n    this.queue = this.queue.filter((e) => !batchIds.has(e.id));\n    this.dedupe.removeBatch(batch);\n\n    const processedBatch = this.applyBeforeSendHooks(batch);\n\n    const result = await sender.send({\n      endpoint: this.config.endpoint,\n      data: {\n        appId: this.config.appId,\n        appKey: this.config.appKey,\n        events: processedBatch,\n      },\n      timeout: this.config.timeout,\n      headers: this.config.headers,\n      debug: this.config.debug,\n    });\n\n    this.updateStats(result.time, result.success);\n    this.applyAfterSendHooks(processedBatch, result.success);\n\n    if (result.success) {\n      await this.handleSendSuccess(processedBatch);\n    } else {\n      await this.handleSendFailure(processedBatch);\n    }\n\n    this.timer = null;\n  }\n\n  /**\n   * Start offline event check\n   */\n  private startOfflineCheck(): void {\n    if (!isBrowser() || this.offlineCheckTimer) {\n      return;\n    }\n\n    if (!this.config?.offlineEnabled) {\n      return;\n    }\n\n    this.offlineCheckTimer = setInterval(async () => {\n      await this.restoreOfflineEvents();\n    }, QUEUE_CONSTANTS.OFFLINE_CHECK_INTERVAL);\n  }\n\n  /**\n   * Restore offline events\n   */\n  async restoreOfflineEvents(): Promise<void> {\n    if (!isBrowser()) return;\n\n    try {\n      const offlineEvents = await DB.all();\n      if (offlineEvents.length === 0) {\n        return;\n      }\n\n      const queueEventKeys = new Set<string>();\n      this.queue.forEach((event) => {\n        const key = `${event.id}_${event.event}_${event.timestamp}`;\n        queueEventKeys.add(key);\n      });\n\n      const eventsToAdd = offlineEvents.filter((offlineEvent) => {\n        const key = `${offlineEvent.id}_${offlineEvent.event}_${offlineEvent.timestamp}`;\n        return !queueEventKeys.has(key);\n      });\n\n      if (eventsToAdd.length > 0) {\n        const idsToDelete = eventsToAdd.map((event) => event.id);\n\n        if (idsToDelete.length > 0) {\n          await DB.delete(idsToDelete);\n        }\n\n        this.queue.unshift(...eventsToAdd);\n        eventsToAdd.forEach((event) => this.dedupe.add(event));\n\n        if (this.config?.debug) {\n          console.log(\n            \"[Node-Trace] Restored offline events:\",\n            eventsToAdd.length,\n          );\n        }\n\n        this.schedule();\n      } else {\n        await DB.clear();\n\n        if (this.config?.debug) {\n          console.log(\n            \"[Node-Trace] All offline events are duplicates, cleared\",\n          );\n        }\n      }\n    } catch (error) {\n      handleNetworkError(error, { eventCount: 0 });\n    }\n  }\n\n  /**\n   * Clear all timers\n   */\n  clearTimers(): void {\n    if (this.timer) {\n      clearTimeout(this.timer);\n      this.timer = null;\n    }\n\n    this.retryTimers.forEach((t) => clearTimeout(t));\n    this.retryTimers = [];\n\n    if (this.offlineCheckTimer) {\n      clearInterval(this.offlineCheckTimer);\n      this.offlineCheckTimer = null;\n    }\n  }\n\n  /**\n   * Get queue statistics\n   */\n  getStats(): QueueStats {\n    return { ...this.stats };\n  }\n\n  /**\n   * Get queue length\n   */\n  length(): number {\n    return this.queue.length;\n  }\n\n  /**\n   * Clear queue\n   */\n  clear(): void {\n    this.queue = [];\n    this.priorityQueue.clear();\n    this.dedupe.clear();\n  }\n}\n\n/**\n * Queue manager instance\n */\nexport const queueManager = new QueueManager();\n","/**\n * Queue management module\n * Responsible for event push, scheduling, sending, and offline caching\n * Refactored to modular architecture for better maintainability and testability\n */\n\nimport type { Payload, EventProperties } from './types'\nimport { queueManager } from './queue/manager'\nimport { QUEUE_CONSTANTS } from './queue/constants'\n\n/**\n * Push event to queue\n * @template T\n * @param event - Event data\n */\nexport function push<T extends EventProperties>(event: Payload<T>) {\n  queueManager.push(event)\n}\n\n/**\n * Send events in queue\n */\nexport async function flush() {\n  await queueManager.flush()\n}\n\n/**\n * Clear all timers\n */\nexport function clearTimers() {\n  queueManager.clearTimers()\n}\n\n/**\n * Start offline event check timer\n */\nexport function startOfflineCheckTimer() {\n  // Queue manager will start offline check during init\n  // Keep as empty function for backward compatibility\n}\n\n/**\n * Export queue constants\n */\nexport { QUEUE_CONSTANTS }\n","/**\n * Core module\n * Contains core functions like initialization, event tracking, and plugin management\n */\n\nimport { push, startOfflineCheckTimer } from './queue'\nimport { queueManager } from './queue/manager'\nimport { now, stringUtils } from './utils'\nimport { handlePluginError } from './error'\nimport type { Options, Payload, IPlugin, IPluginContext, EventProperties } from './types'\n\n/**\n * Default configuration constants\n */\nexport const DEFAULT_OPTIONS = {\n  /**\n   * Default app key\n   */\n  appKey: '',\n  /**\n   * Default debug mode\n   */\n  debug: false,\n  /**\n   * Default sample rate\n   */\n  sampleRate: 1,\n  /**\n   * Default blacklist\n   */\n  blacklist: [],\n  /**\n   * Default whitelist\n   */\n  whitelist: undefined,\n  /**\n   * Default batch size\n   */\n  batchSize: 20,\n  /**\n   * Default batch interval (milliseconds)\n   */\n  batchInterval: 1000,\n  /**\n   * Default offline cache enabled state\n   */\n  offlineEnabled: false,\n  /**\n   * Default max queue size\n   */\n  maxQueueSize: 1000,\n  /**\n   * Default retry count\n   */\n  retryCount: 3,\n  /**\n   * Default retry interval (milliseconds)\n   */\n  retryInterval: 1000,\n  /**\n   * Default request headers\n   */\n  headers: {},\n  /**\n   * Default timeout (milliseconds)\n   */\n  timeout: 30000,\n  /**\n   * Default before send callback\n   */\n  beforeSend: undefined,\n}\n\n/**\n * Global state management\n */\nexport const state = {\n  /**\n   * Configuration options\n   * @type {Options | null}\n   */\n  options: null as Options | null,\n  /**\n   * Event queue\n   * @type {Payload<EventProperties>[]}\n   */\n  queue: [] as Payload<EventProperties>[],\n  /**\n   * Plugin list\n   * @type {IPlugin[]}\n   */\n  plugins: [] as IPlugin[],\n  /**\n   * Sorted plugins cache\n   * @type {IPlugin[] | null}\n   */\n  sortedPluginsCache: null as IPlugin[] | null\n}\n\n/**\n * Plugin manager\n * Responsible for plugin registration, initialization, and destruction\n */\nclass Plugins {\n  /**\n   * Plugin map\n   * @private\n   * @type {Map<string, IPlugin>}\n   */\n  private plugins: Map<string, IPlugin> = new Map()\n\n  /**\n   * Create plugin context\n   * @returns Plugin context\n   */\n  private createPluginContext(): IPluginContext {\n    return {\n      getPlugins: () => Object.fromEntries(this.plugins) as unknown as Record<string, IPlugin>,\n      getPlugin: (name: string) => this.plugins.get(name) || null,\n      getAllPlugins: () => this.getAll(),\n      callPluginMethod: (pluginName: string, methodName: string, ...args: unknown[]) => {\n        const plugin = this.plugins.get(pluginName)\n        if (plugin && typeof (plugin as unknown as Record<string, unknown>)[methodName] === 'function') {\n          const method = (plugin as unknown as Record<string, unknown>)[methodName] as (...args: unknown[]) => unknown\n          return method(...args)\n        }\n        return null\n      }\n    }\n  }\n\n  /**\n   * Register plugin\n   * @param plugin - Plugin instance\n   * @returns Whether registration was successful\n   */\n  register(plugin: IPlugin): boolean {\n    try {\n      // Check if plugin name already exists\n      if (this.plugins.has(plugin.name)) {\n        console.warn(`[Node-Trace] Plugin ${plugin.name} already registered`)\n        return false\n      }\n\n      // Check plugin dependencies\n      if (plugin.dependencies && plugin.dependencies.length > 0) {\n        for (const dep of plugin.dependencies) {\n          if (!this.plugins.has(dep)) {\n            console.warn(`[Node-Trace] Plugin ${plugin.name} depends on ${dep}, which is not registered`)\n            return false\n          }\n        }\n      }\n\n      // Check plugin conflicts\n      if (plugin.conflicts && plugin.conflicts.length > 0) {\n        for (const conflict of plugin.conflicts) {\n          if (this.plugins.has(conflict)) {\n            console.warn(`[Node-Trace] Plugin ${plugin.name} conflicts with ${conflict}`)\n            return false\n          }\n        }\n      }\n\n      // Initialize plugin state\n      plugin.lifecycle = 'idle'\n      plugin.enabled = true\n      plugin.priority = plugin.priority || 0\n\n      // Register plugin\n      this.plugins.set(plugin.name, plugin)\n      \n      // Clear plugin sort cache\n      state.sortedPluginsCache = null\n      \n      return true\n    } catch (error) {\n      handlePluginError(error, { plugin: plugin.name })\n      return false\n    }\n  }\n\n  /**\n   * Initialize plugin\n   * @param plugin - Plugin instance\n   * @returns Whether initialization was successful\n   */\n  init(plugin: IPlugin): boolean {\n    try {\n      // Update plugin lifecycle\n      plugin.lifecycle = 'loading'\n\n      const context = this.createPluginContext()\n\n      // Call plugin's beforeInit method\n      if (plugin.beforeInit) {\n        plugin.beforeInit(context)\n      }\n\n      // Call plugin's setup method\n      if (plugin.setup) {\n        plugin.setup(context)\n      }\n\n      // Call plugin's init method\n      if (plugin.init) {\n        plugin.init(context)\n      }\n\n      // Call plugin's activate method\n      if (plugin.activate) {\n        plugin.activate(context)\n      }\n\n      // Call plugin's afterInit method\n      if (plugin.afterInit) {\n        plugin.afterInit(context)\n      }\n\n      // Update plugin lifecycle\n      plugin.lifecycle = 'active'\n      return true\n    } catch (error) {\n      handlePluginError(error, { plugin: plugin.name })\n      plugin.lifecycle = 'error'\n      return false\n    }\n  }\n\n  /**\n   * Destroy plugin\n   * @param plugin - Plugin instance\n   * @returns Whether destruction was successful\n   */\n  destroy(plugin: IPlugin): boolean {\n    try {\n      const context = this.createPluginContext()\n\n      // Call plugin's beforeDestroy method\n      if (plugin.beforeDestroy) {\n        plugin.beforeDestroy(context)\n      }\n\n      // Call plugin's deactivate method\n      if (plugin.deactivate) {\n        plugin.deactivate(context)\n      }\n\n      // Call plugin's destroy method\n      if (plugin.destroy) {\n        plugin.destroy(context)\n      }\n\n      // Call plugin's afterDestroy method\n      if (plugin.afterDestroy) {\n        plugin.afterDestroy(context)\n      }\n\n      // Update plugin lifecycle\n      plugin.lifecycle = 'destroyed'\n      return true\n    } catch (error) {\n      handlePluginError(error, { plugin: plugin.name })\n      return false\n    }\n  }\n\n  /**\n   * Get plugin\n   * @param name - Plugin name\n   * @returns Plugin instance\n   */\n  get(name: string): IPlugin | undefined {\n    return this.plugins.get(name)\n  }\n\n  /**\n   * Get all plugins\n   * @returns Plugin list\n   */\n  getAll(): IPlugin[] {\n    return Array.from(this.plugins.values())\n  }\n\n  /**\n   * Get enabled plugins\n   * @returns Enabled plugin list\n   */\n  getEnabled(): IPlugin[] {\n    return Array.from(this.plugins.values()).filter(plugin => plugin.enabled)\n  }\n\n  /**\n   * Enable plugin\n   * @param name - Plugin name\n   * @returns Whether enabling was successful\n   */\n  enable(name: string): boolean {\n    const plugin = this.plugins.get(name)\n    if (!plugin) return false\n\n    plugin.enabled = true\n    \n    // Clear plugin sort cache\n    state.sortedPluginsCache = null\n    \n    return true\n  }\n\n  /**\n   * Disable plugin\n   * @param name - Plugin name\n   * @returns Whether disabling was successful\n   */\n  disable(name: string): boolean {\n    const plugin = this.plugins.get(name)\n    if (!plugin) return false\n\n    plugin.enabled = false\n    \n    // Clear plugin sort cache\n    state.sortedPluginsCache = null\n    \n    return true\n  }\n\n  /**\n   * Remove plugin\n   * @param name - Plugin name\n   * @returns Whether removal was successful\n   */\n  remove(name: string): boolean {\n    const plugin = this.plugins.get(name)\n    if (!plugin) return false\n\n    // Destroy plugin\n    this.destroy(plugin)\n\n    // Remove from plugin list\n    const result = this.plugins.delete(name)\n    \n    // Clear plugin sort cache\n    state.sortedPluginsCache = null\n    \n    return result\n  }\n\n  /**\n   * Clear all plugins\n   */\n  clear(): void {\n    for (const plugin of this.plugins.values()) {\n      this.destroy(plugin)\n    }\n    this.plugins.clear()\n    \n    // Clear plugin sort cache\n    state.sortedPluginsCache = null\n  }\n\n  /**\n   * Sort plugins by priority\n   * @returns Sorted plugin list\n   */\n  sort(): IPlugin[] {\n    return Array.from(this.plugins.values())\n      .filter(plugin => plugin.enabled)\n      .sort((a, b) => (a.priority || 0) - (b.priority || 0))\n  }\n}\n\n/**\n * Plugin manager instance\n * @type {PluginManager}\n */\nexport const plugins = new Plugins()\n\n/**\n * Initialize configuration\n * @param options - Configuration options\n */\nexport function init(options: Options) {\n  state.options = {\n    ...DEFAULT_OPTIONS,\n    ...options\n  }\n\n  // Initialize queue manager\n  queueManager.init({\n    maxQueueSize: options.maxQueueSize || 1000,\n    batchSize: options.batchSize || 20,\n    batchInterval: options.batchInterval || 1000,\n    retryCount: options.retryCount || 3,\n    retryInterval: options.retryInterval || 1000,\n    offlineEnabled: options.offlineEnabled || false,\n    debug: options.debug || false,\n    endpoint: options.endpoint,\n    appId: options.appId,\n    appKey: options.appKey,\n    headers: options.headers,\n    timeout: options.timeout,\n  })\n\n  // Start offline event check timer\n  startOfflineCheckTimer()\n}\n\n/**\n * Use plugin\n * @param plugin - Plugin instance\n */\nexport function use(plugin: IPlugin) {\n  // Register plugin\n  const registered = plugins.register(plugin)\n  if (!registered) {\n    console.warn(`[Node-Trace] Failed to register plugin ${plugin.name}`)\n    return\n  }\n\n  // Initialize plugin\n  plugins.init(plugin)\n\n  // Add to state plugin list\n  state.plugins.push(plugin)\n}\n\n/**\n * Check if event should be sent\n * @param event - Event name\n * @returns Whether event should be sent\n */\nfunction shouldSend(event: string) {\n  const opt = state.options\n  if (!opt) return true\n\n  if (opt.sampleRate && Math.random() > opt.sampleRate) return false\n  if (opt.blacklist?.includes(event)) return false\n  if (opt.whitelist && !opt.whitelist.includes(event)) return false\n\n  return true\n}\n\n/**\n * Track event\n * @template T\n * @param event - Event name\n * @param [properties] - Event properties\n */\nexport function track<T extends EventProperties>(event: string, properties?: T) {\n  if (!shouldSend(event)) return\n\n  const eventId = stringUtils.generateEventId()\n  let payload: Payload<T> = { id: eventId, event, properties, timestamp: now() }\n\n  let allPlugins = state.sortedPluginsCache\n  if (!allPlugins) {\n    allPlugins = plugins.sort()  \n    state.sortedPluginsCache = allPlugins\n  }\n\n  const pluginsToNotify: IPlugin[] = []\n\n  for (const p of allPlugins) { \n    if (p.onTrack) {\n      try {\n        const r = p.onTrack(payload)\n        if (r === null) return\n        payload = r\n      } catch (error) {\n        handlePluginError(error, { plugin: p.name, event: event })\n      }\n    }\n    if (p.onTracked) {\n      pluginsToNotify.push(p)\n    }\n  }\n\n  const final = state.options?.beforeSend?.(payload)\n  if (final === null) return\n\n  const eventToPush = final || payload\n  push(eventToPush)\n\n  for (const p of pluginsToNotify) {\n    try {\n      p.onTracked?.(eventToPush)\n    } catch (error) {\n      handlePluginError(error, { plugin: p.name, event: event })\n    }\n  }\n}\n","import { isBrowser } from \"../../utils\";\n\n/**\n * Basic browser information interface.\n */\nexport interface BrowserInfo {\n  /** Browser name */\n  name: string;\n  /** Major version number */\n  major: string;\n  /** Rendering engine name */\n  engine: string;\n  /** Rendering engine version */\n  engineVersion: string;\n}\n\n/**\n * Device type information interface.\n */\nexport interface DeviceType {\n  /** Whether the device is mobile */\n  isMobile: boolean;\n  /** Whether the device is a tablet */\n  isTablet: boolean;\n  /** Whether the device is desktop */\n  isDesktop: boolean;\n}\n\n/**\n * Detailed browser detection result interface.\n */\nexport interface BrowserDetectionResult {\n  /** Browser name */\n  name: string;\n  /** Full version string */\n  version: string;\n  /** Major version number */\n  major: string;\n  /** Rendering engine name */\n  engine: string;\n  /** Rendering engine version */\n  engineVersion: string;\n}\n\n/**\n * Device detection result interface.\n */\nexport interface DeviceDetectionResult {\n  /** Whether the device is mobile */\n  isMobile: boolean;\n  /** Whether the device is a tablet */\n  isTablet: boolean;\n  /** Whether the device is desktop */\n  isDesktop: boolean;\n  /** Device type category */\n  type: \"mobile\" | \"tablet\" | \"desktop\" | \"unknown\";\n}\n\n/**\n * Detects browser information from user agent string.\n * @param userAgent - The user agent string to parse\n * @returns Browser detection result with name, version, and engine info\n */\nexport function detectBrowser(userAgent: string): BrowserDetectionResult {\n  let name = \"unknown\";\n  let version = \"0\";\n  let major = \"0\";\n  let engine = \"Unknown\";\n  let engineVersion = \"0\";\n\n  if (/Chrome/.test(userAgent)) {\n    name = \"Chrome\";\n    version = userAgent.match(/Chrome\\/(\\d+)/)?.[1] || \"0\";\n    major = version;\n    engine = \"Blink\";\n  } else if (/Firefox/.test(userAgent)) {\n    name = \"Firefox\";\n    version = userAgent.match(/Firefox\\/(\\d+)/)?.[1] || \"0\";\n    major = version;\n    engine = \"Gecko\";\n  } else if (/Safari/.test(userAgent) && !/Chrome/.test(userAgent)) {\n    name = \"Safari\";\n    version = userAgent.match(/Version\\/(\\d+)/)?.[1] || \"0\";\n    major = version;\n    engine = \"WebKit\";\n  } else if (/Edge/.test(userAgent)) {\n    name = \"Edge\";\n    version = userAgent.match(/Edge\\/(\\d+)/)?.[1] || \"0\";\n    major = version;\n    engine = \"Blink\";\n  } else if (/MSIE|Trident/.test(userAgent)) {\n    name = \"Internet Explorer\";\n    version = userAgent.match(/MSIE\\s(\\d+)|rv:(\\d+)/)?.[1] || \"0\";\n    major = version;\n    engine = \"Trident\";\n  }\n\n  if (engine === \"WebKit\") {\n    engineVersion = userAgent.match(/WebKit\\/(\\d+)/)?.[1] || \"0\";\n  } else if (engine === \"Gecko\") {\n    engineVersion = userAgent.match(/Gecko\\/(\\d+)/)?.[1] || \"0\";\n  }\n\n  return { name, version, major, engine, engineVersion };\n}\n\n/**\n * Detects device type from user agent string.\n * @param userAgent - The user agent string to parse\n * @returns Device detection result with type information\n */\nexport function detectDevice(userAgent: string): DeviceDetectionResult {\n  const isMobile =\n    /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/.test(userAgent) &&\n    !/iPad/.test(userAgent);\n  const isTablet =\n    /iPad/.test(userAgent) ||\n    (/Android/.test(userAgent) && !/Mobile/.test(userAgent));\n  const isDesktop = !isMobile && !isTablet;\n\n  let type: \"mobile\" | \"tablet\" | \"desktop\" | \"unknown\" = \"unknown\";\n  if (isMobile) type = \"mobile\";\n  else if (isTablet) type = \"tablet\";\n  else if (isDesktop) type = \"desktop\";\n\n  return { isMobile, isTablet, isDesktop, type };\n}\n\n/**\n * Parses basic browser information from user agent string.\n * @param userAgent - The user agent string to parse\n * @returns Simplified browser information\n */\nexport function parseBrowserInfo(userAgent: string): BrowserInfo {\n  const result = detectBrowser(userAgent);\n  return {\n    name: result.name,\n    major: result.major,\n    engine: result.engine,\n    engineVersion: result.engineVersion,\n  };\n}\n\n/**\n * Parses device type from user agent string.\n * @param userAgent - The user agent string to parse\n * @returns Device type information\n */\nexport function parseDeviceType(userAgent: string): DeviceType {\n  const result = detectDevice(userAgent);\n  return {\n    isMobile: result.isMobile,\n    isTablet: result.isTablet,\n    isDesktop: result.isDesktop,\n  };\n}\n\n/**\n * Gets basic browser information from the navigator object.\n * @returns Basic browser information including app name, language, platform, etc.\n */\nexport function getBasicBrowserInfo(): {\n  app_code_name: string;\n  app_name: string;\n  language: string;\n  platform: string;\n  browser_version: string | undefined;\n  user_agent: string;\n} {\n  if (!isBrowser() || typeof navigator === \"undefined\") {\n    return {\n      app_code_name: \"\",\n      app_name: \"\",\n      language: \"\",\n      platform: \"\",\n      browser_version: \"\",\n      user_agent: \"non-browser\",\n    };\n  }\n\n  return {\n    app_code_name: navigator.appCodeName,\n    app_name: navigator.appName,\n    language: navigator.language,\n    platform: navigator.platform,\n    browser_version: navigator.appVersion,\n    user_agent: navigator.userAgent,\n  };\n}\n\n/**\n * Gets detailed browser information from user agent string.\n * @param userAgent - The user agent string to parse\n * @returns Detailed browser information with name, version, and engine details\n */\nexport function getDetailedBrowserInfo(userAgent: string): {\n  browser_name: string;\n  browser_major_version: string;\n  engine_name: string;\n  engine_version: string;\n} {\n  const browserInfo = parseBrowserInfo(userAgent);\n  return {\n    browser_name: browserInfo.name,\n    browser_major_version: browserInfo.major,\n    engine_name: browserInfo.engine,\n    engine_version: browserInfo.engineVersion,\n  };\n}\n\n/**\n * Gets device information including type and screen dimensions.\n * @param userAgent - The user agent string to parse for device type\n * @returns Device information with type, dimensions, and pixel ratio\n */\nexport function getDeviceInfo(userAgent: string): {\n  is_mobile: boolean;\n  is_tablet: boolean;\n  is_desktop: boolean;\n  device_width: number;\n  device_height: number;\n  device_pixel_ratio: number;\n} {\n  if (!isBrowser() || typeof window === \"undefined\") {\n    return {\n      is_mobile: false,\n      is_tablet: false,\n      is_desktop: true,\n      device_width: 0,\n      device_height: 0,\n      device_pixel_ratio: 1,\n    };\n  }\n\n  const deviceType = parseDeviceType(userAgent);\n  return {\n    is_mobile: deviceType.isMobile,\n    is_tablet: deviceType.isTablet,\n    is_desktop: deviceType.isDesktop,\n    device_width: window.innerWidth,\n    device_height: window.innerHeight,\n    device_pixel_ratio: window.devicePixelRatio,\n  };\n}\n","import { isBrowser } from \"../../utils\";\n\n/**\n * Network connection information interface\n */\nexport interface NetworkConnection {\n  /** Connection type (e.g., 'wifi', 'cellular', etc.) */\n  type?: string;\n  /** Downlink speed in Mbps */\n  downlink?: number;\n  /** Effective connection type (e.g., 'slow-2g', '2g', '3g', '4g') */\n  effectiveType?: string;\n  /** Round-trip time in milliseconds */\n  rtt?: number;\n  /** Whether the user has requested a reduced data usage mode */\n  saveData?: boolean;\n}\n\n/**\n * Get current network information\n * @returns Network information including online status, connection type, and speed metrics\n */\nexport function getNetworkInfo(): {\n  is_online: boolean;\n  connection_type: string;\n  downlink: number | undefined;\n  effective_type: string | undefined;\n  rtt: number | undefined;\n} {\n  if (!isBrowser() || typeof navigator === \"undefined\") {\n    return {\n      is_online: true,\n      connection_type: \"unknown\",\n      downlink: undefined,\n      effective_type: undefined,\n      rtt: undefined,\n    };\n  }\n\n  return {\n    is_online: navigator.onLine,\n    connection_type:\n      (navigator as unknown as { connection?: NetworkConnection }).connection\n        ?.type || \"unknown\",\n    downlink: (navigator as unknown as { connection?: NetworkConnection })\n      .connection?.downlink,\n    effective_type: (navigator as unknown as { connection?: NetworkConnection })\n      .connection?.effectiveType,\n    rtt: (navigator as unknown as { connection?: NetworkConnection }).connection\n      ?.rtt,\n  };\n}\n\n/**\n * Browser utility functions\n */\nexport const browserUtils = {\n  /**\n   * Get current network state\n   * @returns Network state with type, effective type, RTT, and downlink speed\n   */\n  getNetworkState: (): {\n    type: \"online\" | \"offline\";\n    effectiveType: \"2g\" | \"3g\" | \"4g\" | \"5g\" | \"unknown\";\n    rtt: number;\n    downlink: number;\n  } => {\n    if (!isBrowser() || typeof navigator === \"undefined\") {\n      return {\n        type: \"offline\",\n        effectiveType: \"unknown\",\n        rtt: 0,\n        downlink: 0,\n      };\n    }\n\n    const type = navigator.onLine ? \"online\" : \"offline\";\n    let effectiveType: \"2g\" | \"3g\" | \"4g\" | \"5g\" | \"unknown\" = \"unknown\";\n    let rtt = 0;\n    let downlink = 0;\n\n    if (\"connection\" in navigator) {\n      const connection = (\n        navigator as unknown as { connection?: NetworkConnection }\n      ).connection;\n      effectiveType =\n        (connection?.effectiveType as \"2g\" | \"3g\" | \"4g\" | \"5g\" | \"unknown\") ||\n        \"unknown\";\n      rtt = connection?.rtt || 0;\n      downlink = connection?.downlink || 0;\n    }\n\n    return {\n      type,\n      effectiveType,\n      rtt,\n      downlink,\n    };\n  },\n};\n","import { isBrowser } from \"../../utils\";\n\n/**\n * Gets information about the current page\n * @returns An object containing page information including URL, pathname, hostname, etc.\n * Returns default/empty values if not in a browser environment\n */\nexport function getPageInfo(): {\n  current_url: string;\n  pathname: string;\n  hostname: string;\n  protocol: string;\n  port: string;\n  search: string;\n  hash: string;\n  document_url: string;\n  referrer_url: string;\n  content_type: string;\n  document_title: string;\n  document_charset: string;\n  document_ready_state: string;\n} {\n  if (\n    !isBrowser() ||\n    typeof window === \"undefined\" ||\n    typeof document === \"undefined\"\n  ) {\n    return {\n      current_url: \"\",\n      pathname: \"\",\n      hostname: \"\",\n      protocol: \"\",\n      port: \"\",\n      search: \"\",\n      hash: \"\",\n      document_url: \"\",\n      referrer_url: \"\",\n      content_type: \"\",\n      document_title: \"\",\n      document_charset: \"\",\n      document_ready_state: \"loading\",\n    };\n  }\n\n  return {\n    current_url: window.location.href,\n    pathname: window.location.pathname,\n    hostname: window.location.hostname,\n    protocol: window.location.protocol,\n    port: window.location.port,\n    search: window.location.search,\n    hash: window.location.hash,\n    document_url: document.URL,\n    referrer_url: document.referrer,\n    content_type: document.contentType || \"\",\n    document_title: document.title,\n    document_charset: document.characterSet || document.charset || \"\",\n    document_ready_state: document.readyState,\n  };\n}\n\n/**\n * Gets the current scroll position of the page\n * @returns An object containing scroll_x and scroll_y coordinates\n * Returns zeros if not in a browser environment\n */\nexport function getScrollInfo(): {\n  scroll_x: number;\n  scroll_y: number;\n} {\n  if (\n    !isBrowser() ||\n    typeof window === \"undefined\" ||\n    typeof document === \"undefined\"\n  ) {\n    return {\n      scroll_x: 0,\n      scroll_y: 0,\n    };\n  }\n\n  return {\n    scroll_x: window.pageXOffset || document.documentElement.scrollLeft || 0,\n    scroll_y: window.pageYOffset || document.documentElement.scrollTop || 0,\n  };\n}\n","import { isBrowser } from \"../../utils\";\n\n/**\n * Gets screen information\n * @returns An object containing screen-related information\n */\nexport function getScreenInfo(): {\n  screen_width: number;\n  screen_height: number;\n  screen_available_width: number;\n  screen_available_height: number;\n  screen_color_depth: number;\n} {\n  if (!isBrowser() || typeof screen === \"undefined\") {\n    return {\n      screen_width: 0,\n      screen_height: 0,\n      screen_available_width: 0,\n      screen_available_height: 0,\n      screen_color_depth: 0,\n    };\n  }\n\n  return {\n    screen_width: screen.width,\n    screen_height: screen.height,\n    screen_available_width: screen.availWidth,\n    screen_available_height: screen.availHeight,\n    screen_color_depth: screen.colorDepth,\n  };\n}\n","import { isBrowser } from \"../../utils\";\n\nexport const storageUtils = {\n  /**\n   * Gets a value from localStorage\n   * @param key - The storage key name\n   * @param parser - Optional parser function to parse the stored string value\n   * @returns The stored value, or null if not found or an error occurs\n   */\n  get: (key: string, parser?: (value: string) => unknown): unknown => {\n    if (!isBrowser() || typeof localStorage === \"undefined\") {\n      return null;\n    }\n    try {\n      const value = localStorage.getItem(key);\n      if (value === null) return null;\n      return parser ? parser(value) : value;\n    } catch {\n      return null;\n    }\n  },\n\n  /**\n   * Sets a value in localStorage\n   * @param key - The storage key name\n   * @param value - The value to store, non-string values will be converted to JSON string\n   * @returns true if operation succeeds, false if it fails\n   */\n  set: (key: string, value: unknown): boolean => {\n    if (!isBrowser() || typeof localStorage === \"undefined\") {\n      return false;\n    }\n    try {\n      const stringValue =\n        typeof value === \"string\" ? value : JSON.stringify(value);\n      localStorage.setItem(key, stringValue);\n      return true;\n    } catch {\n      return false;\n    }\n  },\n\n  /**\n   * Removes a value from localStorage by key\n   * @param key - The key name to remove\n   * @returns true if operation succeeds, false if it fails\n   */\n  remove: (key: string): boolean => {\n    if (!isBrowser() || typeof localStorage === \"undefined\") {\n      return false;\n    }\n    try {\n      localStorage.removeItem(key);\n      return true;\n    } catch {\n      return false;\n    }\n  },\n\n  /**\n   * Clears all data from localStorage\n   * @returns true if operation succeeds, false if it fails\n   */\n  clear: (): boolean => {\n    if (!isBrowser() || typeof localStorage === \"undefined\") {\n      return false;\n    }\n    try {\n      localStorage.clear();\n      return true;\n    } catch {\n      return false;\n    }\n  },\n};\n","import { isBrowser } from \"../../utils\";\nimport { getDeviceId } from \"../user\";\nimport type { IPlugin, EventProperties, Payload } from \"../../types\";\nimport {\n  getBasicBrowserInfo,\n  getDetailedBrowserInfo,\n  getDeviceInfo,\n  detectBrowser,\n  detectDevice,\n} from \"./detection\";\nimport { getNetworkInfo, browserUtils as networkBrowserUtils } from \"./network\";\nimport { getPageInfo, getScrollInfo } from \"./page\";\nimport { getScreenInfo } from \"./screen\";\nimport { storageUtils } from \"./storage\";\n\n/**\n * Browser data interface\n * Contains various information collected from the browser environment\n */\nexport interface BrowserData {\n  /** Device ID */\n  device_id: string;\n  /** Event name */\n  event: string;\n  /** User agent string */\n  user_agent: string;\n  /** Device width */\n  device_width: number;\n  /** Device height */\n  device_height: number;\n  /** Whether online */\n  is_online: boolean;\n  /** Connection type */\n  connection_type?: string;\n  /** Downlink speed */\n  downlink?: number;\n  /** Effective connection type */\n  effective_type?: string;\n  /** Round-trip time */\n  rtt?: number;\n  /** Application code name */\n  app_code_name: string;\n  /** Application name */\n  app_name: string;\n  /** Language setting */\n  language: string;\n  /** Platform information */\n  platform: string;\n  /** Time zone */\n  time_zone: string;\n  /** Browser version */\n  browser_version?: string;\n  /** Browser name */\n  browser_name?: string;\n  /** Browser major version */\n  browser_major_version?: string;\n  /** Engine name */\n  engine_name?: string;\n  /** Engine version */\n  engine_version?: string;\n  /** Device pixel ratio */\n  device_pixel_ratio: number;\n  /** Whether mobile device */\n  is_mobile?: boolean;\n  /** Whether tablet device */\n  is_tablet?: boolean;\n  /** Whether desktop device */\n  is_desktop?: boolean;\n  /** Current URL */\n  current_url: string;\n  /** Path name */\n  pathname: string;\n  /** Host name */\n  hostname: string;\n  /** Protocol */\n  protocol: string;\n  /** Port */\n  port?: string;\n  /** Query string */\n  search?: string;\n  /** Hash value */\n  hash?: string;\n  /** Document URL */\n  document_url: string;\n  /** Referrer URL */\n  referrer_url: string;\n  /** Content type */\n  content_type: string;\n  /** Document title */\n  document_title: string;\n  /** Document character set */\n  document_charset: string;\n  /** Document ready state */\n  document_ready_state?: string;\n  /** Screen width */\n  screen_width: number;\n  /** Screen height */\n  screen_height: number;\n  /** Screen available width */\n  screen_available_width: number;\n  /** Screen available height */\n  screen_available_height: number;\n  /** Screen color depth */\n  screen_color_depth: number;\n  /** Horizontal scroll position */\n  scroll_x: number;\n  /** Vertical scroll position */\n  scroll_y: number;\n  /** Country */\n  country?: string;\n  /** Region */\n  region?: string;\n  /** City */\n  city?: string;\n  /** Begin time */\n  begin_time: number;\n  /** Dynamic properties */\n  [propName: string]: unknown;\n}\n\n/**\n * Browser utility object\n * Provides utility methods to get browser and device related information\n */\nexport const browserUtils = {\n  /**\n   * Gets browser information\n   * @returns Browser name, version, and platform information\n   */\n  getBrowser: (): {\n    name: string;\n    version: string;\n    platform: string;\n  } => {\n    if (!isBrowser() || typeof navigator === \"undefined\") {\n      return {\n        name: \"unknown\",\n        version: \"0\",\n        platform: \"unknown\",\n      };\n    }\n\n    const result = detectBrowser(navigator.userAgent);\n    return {\n      name: result.name,\n      version: result.version,\n      platform: navigator.platform,\n    };\n  },\n\n  /**\n   * Gets device type\n   * @returns Device type: mobile, tablet, desktop, or unknown\n   */\n  getDeviceType: (): \"mobile\" | \"tablet\" | \"desktop\" | \"unknown\" => {\n    if (!isBrowser() || typeof navigator === \"undefined\") {\n      return \"unknown\";\n    }\n\n    const result = detectDevice(navigator.userAgent);\n    return result.type;\n  },\n\n  /** Gets network state */\n  getNetworkState: networkBrowserUtils.getNetworkState,\n};\n\n/**\n * Gets browser data\n * Collects and returns various information from the current browser environment\n * @returns Browser data object\n */\nexport function getBrowserData(): BrowserData {\n  if (!isBrowser()) {\n    return {\n      device_id: getDeviceId(),\n      event: \"pageview\",\n      user_agent: \"non-browser\",\n      device_width: 0,\n      device_height: 0,\n      is_online: true,\n      connection_type: \"unknown\",\n      app_code_name: \"\",\n      app_name: \"\",\n      language: \"\",\n      platform: \"\",\n      time_zone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n      browser_version: \"\",\n      browser_name: \"non-browser\",\n      browser_major_version: \"0\",\n      engine_name: \"unknown\",\n      engine_version: \"0\",\n      device_pixel_ratio: 1,\n      is_mobile: false,\n      is_tablet: false,\n      is_desktop: true,\n      current_url: \"\",\n      pathname: \"\",\n      hostname: \"\",\n      protocol: \"\",\n      port: \"\",\n      search: \"\",\n      hash: \"\",\n      document_url: \"\",\n      referrer_url: \"\",\n      content_type: \"\",\n      document_title: \"\",\n      document_charset: \"\",\n      document_ready_state: \"loading\",\n      screen_width: 0,\n      screen_height: 0,\n      screen_available_width: 0,\n      screen_available_height: 0,\n      screen_color_depth: 0,\n      scroll_x: 0,\n      scroll_y: 0,\n      begin_time: Date.now(),\n    };\n  }\n\n  try {\n    const basicBrowserInfo = getBasicBrowserInfo();\n    const detailedBrowserInfo = getDetailedBrowserInfo(\n      basicBrowserInfo.user_agent,\n    );\n    const deviceInfo = getDeviceInfo(basicBrowserInfo.user_agent);\n    const networkInfo = getNetworkInfo();\n    const screenInfo = getScreenInfo();\n    const pageInfo = getPageInfo();\n    const scrollInfo = getScrollInfo();\n\n    return {\n      device_id: getDeviceId(),\n      event: \"pageview\",\n      ...basicBrowserInfo,\n      ...deviceInfo,\n      ...networkInfo,\n      ...detailedBrowserInfo,\n      ...screenInfo,\n      ...pageInfo,\n      ...scrollInfo,\n      time_zone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n      begin_time: Date.now(),\n    };\n  } catch (error) {\n    return {\n      device_id: getDeviceId(),\n      event: \"pageview\",\n      user_agent: navigator?.userAgent || \"unknown\",\n      device_width: window?.innerWidth || 0,\n      device_height: window?.innerHeight || 0,\n      is_online: navigator?.onLine || false,\n      connection_type:\n        (navigator as unknown as { connection?: { type?: string } })?.connection\n          ?.type || \"unknown\",\n      downlink: (navigator as unknown as { connection?: { downlink?: number } })\n        ?.connection?.downlink,\n      effective_type: (\n        navigator as unknown as { connection?: { effectiveType?: string } }\n      )?.connection?.effectiveType,\n      rtt: (navigator as unknown as { connection?: { rtt?: number } })\n        ?.connection?.rtt,\n      app_code_name: navigator?.appCodeName || \"\",\n      app_name: navigator?.appName || \"\",\n      language: navigator?.language || \"\",\n      platform: navigator?.platform || \"\",\n      time_zone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n      browser_version: navigator?.appVersion,\n      device_pixel_ratio: window?.devicePixelRatio || 1,\n      is_mobile: false,\n      is_tablet: false,\n      is_desktop: true,\n      current_url: window?.location?.href || \"\",\n      pathname: window?.location?.pathname || \"\",\n      hostname: window?.location?.hostname || \"\",\n      protocol: window?.location?.protocol || \"\",\n      port: window?.location?.port || \"\",\n      search: window?.location?.search || \"\",\n      hash: window?.location?.hash || \"\",\n      document_url: document?.URL || \"\",\n      referrer_url: document?.referrer || \"\",\n      content_type: document?.contentType || \"\",\n      document_title: document?.title || \"\",\n      document_charset: document?.characterSet || document?.charset || \"\",\n      document_ready_state: document?.readyState,\n      screen_width: screen?.width || 0,\n      screen_height: screen?.height || 0,\n      screen_available_width: screen?.availWidth || 0,\n      screen_available_height: screen?.availHeight || 0,\n      screen_color_depth: screen?.colorDepth || 0,\n      scroll_x: window?.pageXOffset || document?.documentElement?.scrollLeft || 0,\n      scroll_y: window?.pageYOffset || document?.documentElement?.scrollTop || 0,\n      begin_time: Date.now(),\n    };\n  }\n}\n\n/**\n * Browser data collection plugin\n * Automatically collects browser environment data during event tracking\n */\nexport const browserPlugin: IPlugin = {\n  name: \"browser\",\n  version: \"1.0.0\",\n  description: \"Browser data collection plugin\",\n  priority: 20,\n\n  /**\n   * Event tracking hook\n   * @param payload - Original event payload\n   * @returns Event payload with browser data added\n   */\n  onTrack<T extends EventProperties>(payload: Payload<T>): Payload<T> {\n    const browserData = getBrowserData();\n    return {\n      ...payload,\n      ...browserData,\n    };\n  },\n\n  /**\n   * Gets plugin information\n   * @returns Plugin name, version, and description\n   */\n  getInfo(): Record<string, unknown> {\n    return {\n      name: this.name,\n      version: this.version,\n      description: this.description,\n    };\n  },\n};\n\nexport { storageUtils };\nexport type { BrowserDetectionResult, DeviceDetectionResult, BrowserInfo, DeviceType } from \"./detection\";\nexport type { NetworkConnection } from \"./network\";\n","/**\n * User management plugin\n * Responsible for device ID and user ID generation, storage, and management\n */\n\nimport { isBrowser } from \"../utils\";\nimport { handleBrowserError, handleStorageError } from \"../error\";\nimport { storageUtils } from \"./browser\";\nimport type { IPlugin, EventProperties, Payload } from \"../types\";\n\n/**\n * Device ID storage key\n */\nconst DEVICE_ID_KEY = \"__analytics_device_id__\";\n\n/**\n * User ID storage key\n */\nconst USER_ID_KEY = \"__analytics_user_id__\";\n\n/**\n * Stores device ID for non-browser environments\n */\nlet nonBrowserDeviceId: string | null = null;\n\n/**\n * Caches browser device ID\n */\nlet cachedBrowserDeviceId: string | null = null;\n\n/**\n * Default device ID length\n */\nconst DEFAULT_DEVICE_ID_LENGTH = 32;\n\n/**\n * Extended Navigator interface\n */\ninterface ExtendedNavigator extends Navigator {\n  deviceMemory?: number;\n}\n\n/**\n * Generates SHA-256 hash\n * @param input - Input string\n * @returns SHA-256 hash value\n */\nasync function generateSHA256Hash(input: string): Promise<string> {\n  if (isBrowser() && typeof crypto !== \"undefined\" && crypto.subtle) {\n    const encoder = new TextEncoder();\n    const data = encoder.encode(input);\n    const hashBuffer = await crypto.subtle.digest(\"SHA-256\", data);\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\n    return hashArray.map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n  } else if (!isBrowser() && typeof require !== \"undefined\") {\n    try {\n      const crypto = require(\"crypto\");\n      return crypto.createHash(\"sha256\").update(input).digest(\"hex\");\n    } catch {\n      return improvedHash(input);\n    }\n  } else {\n    return improvedHash(input);\n  }\n}\n\n/**\n * Improved hash function (using FNV-1a algorithm)\n * @param input - Input string\n * @returns Hash value\n */\nfunction improvedHash(input: string): string {\n  const FNV_PRIME = 0x01000193;\n  const FNV_OFFSET_BASIS = 0x811c9dc5;\n\n  let hash = FNV_OFFSET_BASIS;\n  for (let i = 0; i < input.length; i++) {\n    hash ^= input.charCodeAt(i);\n    hash = Math.imul(hash, FNV_PRIME);\n  }\n\n  const hashStr = (hash >>> 0).toString(36);\n\n  if (hashStr.length >= DEFAULT_DEVICE_ID_LENGTH) {\n    return hashStr.substring(0, DEFAULT_DEVICE_ID_LENGTH);\n  }\n\n  const randomPart = Math.random().toString(36).slice(2, 10);\n  const combined = `${hashStr}${randomPart}`;\n  return combined.substring(0, DEFAULT_DEVICE_ID_LENGTH);\n}\n\n/**\n * Collects browser fingerprint information\n * @returns Browser fingerprint information string\n */\nfunction collectBrowserFingerprint(): string {\n  if (!isBrowser()) {\n    return \"non-browser\";\n  }\n\n  try {\n    const extendedNavigator = navigator as ExtendedNavigator;\n    const fingerprint = {\n      userAgent: navigator.userAgent,\n      platform: navigator.platform,\n      language: navigator.language,\n      hardwareConcurrency: navigator.hardwareConcurrency || 0,\n      deviceMemory: extendedNavigator.deviceMemory || 0,\n      screen: {\n        width: screen.width,\n        height: screen.height,\n        colorDepth: screen.colorDepth,\n      },\n      vendor: navigator.vendor,\n      appVersion: navigator.appVersion,\n      product: navigator.product,\n      productSub: navigator.productSub,\n    };\n\n    return JSON.stringify(fingerprint);\n  } catch (error) {\n    handleBrowserError(error, { context: \"fingerprint_collection\" });\n    return \"fallback-fingerprint\";\n  }\n}\n\n/**\n * Synchronous version of device ID generation\n * @returns Device ID\n */\nfunction generateStableDeviceIdSync(): string {\n  if (!isBrowser()) {\n    if (!nonBrowserDeviceId) {\n      const timestamp = Date.now().toString(36);\n      const random = Math.random().toString(36).slice(2, 10);\n      nonBrowserDeviceId = `${timestamp}_${random}`;\n    }\n    return nonBrowserDeviceId;\n  }\n\n  if (cachedBrowserDeviceId) {\n    return cachedBrowserDeviceId;\n  }\n\n  try {\n    const fingerprint = collectBrowserFingerprint();\n    const deviceId = improvedHash(fingerprint);\n    cachedBrowserDeviceId = deviceId;\n    return deviceId;\n  } catch (error) {\n    handleBrowserError(error, { context: \"device_id_generation\" });\n    const timestamp = Date.now().toString(36);\n    const random = Math.random().toString(36).slice(2, 10);\n    const fallbackId = `${timestamp}_${random}`;\n    cachedBrowserDeviceId = fallbackId;\n    return fallbackId;\n  }\n}\n\n/**\n * Asynchronous version of device ID generation\n * @returns Device ID\n */\nasync function generateDeviceIdAsync(): Promise<string> {\n  if (!isBrowser()) {\n    return generateStableDeviceIdSync();\n  }\n\n  if (cachedBrowserDeviceId) {\n    return cachedBrowserDeviceId;\n  }\n\n  try {\n    const fingerprint = collectBrowserFingerprint();\n    const hash = await generateSHA256Hash(fingerprint);\n    const deviceId = hash.substring(0, DEFAULT_DEVICE_ID_LENGTH);\n    cachedBrowserDeviceId = deviceId;\n    return deviceId;\n  } catch (error) {\n    handleBrowserError(error, { context: \"device_id_generation_async\" });\n    return generateStableDeviceIdSync();\n  }\n}\n\n/**\n * Device ID generation function (synchronous)\n * @returns Device ID\n */\nfunction generateStableDeviceId(): string {\n  return generateStableDeviceIdSync();\n}\n\n/**\n * Asynchronous version of device ID generation\n * @returns Device ID\n */\nexport async function generateStableDeviceIdAsync(): Promise<string> {\n  return generateDeviceIdAsync();\n}\n\n/**\n * Gets device ID\n * @returns Device ID\n */\nexport function getDeviceId(): string {\n  if (!isBrowser()) {\n    return generateStableDeviceId();\n  }\n\n  const existingId = storageUtils.get(DEVICE_ID_KEY) as string | null;\n  if (existingId) {\n    return existingId;\n  }\n\n  const newId = generateStableDeviceId();\n  const success = storageUtils.set(DEVICE_ID_KEY, newId);\n  if (!success) {\n    handleStorageError(new Error(\"Failed to set device ID in localStorage\"), {\n      key: DEVICE_ID_KEY,\n      operation: \"set\",\n    });\n  }\n  return newId;\n}\n\n/**\n * Sets user ID\n * @param id - User ID\n */\nexport function setID(id: string): void {\n  if (!isBrowser()) {\n    return;\n  }\n\n  const success = storageUtils.set(USER_ID_KEY, id);\n  if (!success) {\n    handleStorageError(new Error(\"Failed to set user ID in localStorage\"), {\n      key: USER_ID_KEY,\n      operation: \"set\",\n    });\n  }\n}\n\n/**\n * Gets user ID\n * @returns User ID\n */\nexport function getID(): string {\n  if (!isBrowser()) {\n    return getDeviceId();\n  }\n\n  const userId = storageUtils.get(USER_ID_KEY) as string | null;\n  if (userId) {\n    return userId;\n  }\n  return getDeviceId();\n}\n\n/**\n * Clears user ID\n */\nexport function clearID(): void {\n  if (!isBrowser()) {\n    return;\n  }\n\n  const success = storageUtils.remove(USER_ID_KEY);\n  if (!success) {\n    handleStorageError(\n      new Error(\"Failed to remove user ID from localStorage\"),\n      { key: USER_ID_KEY, operation: \"remove\" },\n    );\n  }\n}\n\n/**\n * User plugin\n */\nexport const userPlugin: IPlugin = {\n  name: \"user\",\n  version: \"1.0.0\",\n  description:\n    \"User management plugin for device ID and user ID generation and management\",\n  priority: 10,\n\n  /**\n   * Event tracking callback\n   */\n  onTrack<T extends EventProperties>(payload: Payload<T>): Payload<T> {\n    return {\n      ...payload,\n      device_id: getDeviceId(),\n      user_id: getID(),\n    };\n  },\n\n  /**\n   * Gets plugin information\n   */\n  getInfo(): Record<string, unknown> {\n    return {\n      name: this.name,\n      version: this.version,\n      description: this.description,\n      deviceId: getDeviceId(),\n      userId: getID(),\n      isBrowser: isBrowser(),\n    };\n  },\n};\n","/**\n * Session management plugin\n * Responsible for session creation, maintenance, timeout handling, and session data collection\n */\n\nimport { isBrowser } from \"../utils\";\nimport { storageUtils } from \"./browser\";\nimport { handleSessionError } from \"../error\";\nimport type {\n  EventProperties,\n  IPlugin,\n  IPluginContext,\n  Payload,\n} from \"../types\";\n\n/**\n * Session ID storage key\n */\nconst SESSION_ID_KEY = \"__analytics_session_id__\";\n\n/**\n * Session start time storage key\n */\nconst SESSION_START_KEY = \"__analytics_session_start__\";\n\n/**\n * Session last active time storage key\n */\nconst SESSION_LAST_ACTIVE_KEY = \"__analytics_session_last_active__\";\n\n/**\n * Session constants definition\n */\nexport const SESSION_CONSTANTS = {\n  /**\n   * Session timeout (30 minutes)\n   */\n  TIMEOUT: 30 * 60 * 1000,\n  /**\n   * Storage sync interval (milliseconds)\n   */\n  SYNC_INTERVAL: 5000,\n};\n\n/**\n * Session state interface\n */\ninterface SessionState {\n  /**\n   * Session ID\n   */\n  id: string;\n  /**\n   * Session start time\n   */\n  startTime: number;\n  /**\n   * Session last active time\n   */\n  lastActive: number;\n  /**\n   * Page views count\n   */\n  pageViews: number;\n  /**\n   * Events count\n   */\n  events: number;\n  /**\n   * Whether it's a new session\n   */\n  isNew: boolean;\n}\n\n/**\n * Session manager class\n */\nclass Sessions {\n  /**\n   * Session state\n   */\n  private session: SessionState | null = null;\n  /**\n   * Timeout ID\n   */\n  private timeoutId: ReturnType<typeof setTimeout> | null = null;\n  /**\n   * Memory cache\n   */\n  private storageCache: Record<string, string | null> = {};\n  /**\n   * Last storage sync time\n   */\n  private lastStorageSync: number = 0;\n  /**\n   * Storage sync interval (milliseconds)\n   */\n  private syncInterval: number = SESSION_CONSTANTS.SYNC_INTERVAL;\n\n  /**\n   * Initialize session\n   */\n  start(): void {\n    if (!isBrowser()) return;\n\n    try {\n      this.session = this.getOrCreateSession();\n      this.startSessionTimeout();\n      this.updateLastActive();\n    } catch (error) {\n      handleSessionError(error, { context: \"start\" });\n    }\n  }\n  /**\n   * Update session last active time\n   */\n  updateLastActive(): void {\n    if (!isBrowser() || !this.session) return;\n\n    try {\n      const now = Date.now();\n      this.session.lastActive = now;\n\n      // Update memory cache\n      this.storageCache[SESSION_LAST_ACTIVE_KEY] = now.toString();\n\n      // Async sync to storage\n      this.syncStorage();\n\n      this.resetSessionTimeout();\n    } catch (error) {\n      handleSessionError(error, { context: \"updateLastActive\" });\n    }\n  }\n\n  /**\n   * Get session ID\n   * @returns Session ID\n   */\n  getID(): string | null {\n    if (!this.session) {\n      this.start();\n    }\n    return this.session?.id || null;\n  }\n\n  /**\n   * Get session start time\n   * @returns Session start time\n   */\n  getStartTime(): number | null {\n    if (!this.session) {\n      this.start();\n    }\n    return this.session?.startTime || null;\n  }\n\n  /**\n   * Get session duration\n   * @returns Session duration\n   */\n  getDuration(): number {\n    if (!this.session) {\n      this.start();\n    }\n    return this.session ? Date.now() - this.session.startTime : 0;\n  }\n\n  /**\n   * Check if it's a new session\n   * @returns Whether it's a new session\n   */\n  isNew(): boolean {\n    if (!this.session) {\n      this.start();\n    }\n    return this.session?.isNew || false;\n  }\n\n  /**\n   * Clear timeout\n   */\n  clearTimeout(): void {\n    if (this.timeoutId) {\n      clearTimeout(this.timeoutId);\n      this.timeoutId = null;\n    }\n  }\n\n  /**\n   * Increment page views count\n   */\n  incrementPageViews(): void {\n    if (this.session) {\n      this.session.pageViews++;\n    }\n  }\n\n  /**\n   * Increment events count\n   */\n  incrementEvents(): void {\n    if (this.session) {\n      this.session.events++;\n    }\n  }\n\n  /**\n   * Get session statistics\n   * @returns Session statistics\n   */\n  getStats(): {\n    pageViews: number;\n    events: number;\n    duration: number;\n  } {\n    if (!this.session) {\n      this.start();\n    }\n    return {\n      pageViews: this.session?.pageViews || 0,\n      events: this.session?.events || 0,\n      duration: this.session ? Date.now() - this.session.startTime : 0,\n    };\n  }\n\n  /**\n   * Get session context\n   * @returns Session context\n   */\n  getContext(): EventProperties {\n    if (!this.session) {\n      this.start();\n    }\n    return {\n      session_id: this.session?.id || \"\",\n      session_start: this.session?.startTime || 0,\n      session_duration: this.session ? Date.now() - this.session.startTime : 0,\n      session_page_views: this.session?.pageViews || 0,\n      session_events: this.session?.events || 0,\n      session_is_new: this.session?.isNew || false,\n    };\n  }\n  /**\n   * Stop session\n   */\n  stop(): void {\n    if (!isBrowser()) return;\n\n    try {\n      // Clear storage\n      storageUtils.remove(SESSION_ID_KEY);\n      storageUtils.remove(SESSION_START_KEY);\n      storageUtils.remove(SESSION_LAST_ACTIVE_KEY);\n\n      // Clear memory cache\n      delete this.storageCache[SESSION_ID_KEY];\n      delete this.storageCache[SESSION_START_KEY];\n      delete this.storageCache[SESSION_LAST_ACTIVE_KEY];\n\n      this.session = null;\n\n      if (this.timeoutId) {\n        clearTimeout(this.timeoutId);\n        this.timeoutId = null;\n      }\n    } catch (error) {\n      handleSessionError(error, { context: \"stop\" });\n    }\n  }\n\n  /**\n   * Start session timeout\n   */\n  private startSessionTimeout(): void {\n    this.resetSessionTimeout();\n  }\n\n  /**\n   * Reset session timeout\n   */\n  private resetSessionTimeout(): void {\n    if (this.timeoutId) {\n      clearTimeout(this.timeoutId);\n    }\n\n    this.timeoutId = setTimeout(() => {\n      this.stop();\n    }, SESSION_CONSTANTS.TIMEOUT);\n  }\n\n  /**\n   * Sync storage cache\n   */\n  private syncStorage(): void {\n    const now = Date.now();\n    if (now - this.lastStorageSync < this.syncInterval) {\n      return;\n    }\n\n    // Write memory cache data to storage\n    Object.entries(this.storageCache).forEach(([key, value]) => {\n      storageUtils.set(key, value);\n    });\n\n    this.lastStorageSync = now;\n  }\n\n  /**\n   * Get or create session\n   * @returns Session state\n   */\n  private getOrCreateSession(): SessionState {\n    // First check memory cache\n    let sessionId = this.storageCache[SESSION_ID_KEY];\n    let startTimeStr = this.storageCache[SESSION_START_KEY];\n    let lastActiveStr = this.storageCache[SESSION_LAST_ACTIVE_KEY];\n\n    // If not in memory cache, read from storage\n    if (!sessionId || !startTimeStr || !lastActiveStr) {\n      sessionId = storageUtils.get(SESSION_ID_KEY) as string | null;\n      startTimeStr = storageUtils.get(SESSION_START_KEY) as string | null;\n      lastActiveStr = storageUtils.get(SESSION_LAST_ACTIVE_KEY) as\n        | string\n        | null;\n\n      // Update memory cache\n      if (sessionId) this.storageCache[SESSION_ID_KEY] = sessionId;\n      if (startTimeStr) this.storageCache[SESSION_START_KEY] = startTimeStr;\n      if (lastActiveStr)\n        this.storageCache[SESSION_LAST_ACTIVE_KEY] = lastActiveStr;\n    }\n\n    const startTime = startTimeStr ? Number(startTimeStr) : null;\n    const lastActive = lastActiveStr ? Number(lastActiveStr) : null;\n\n    // Check if session exists and not timed out\n    if (sessionId && startTime && lastActive) {\n      const now = Date.now();\n      if (now - lastActive < SESSION_CONSTANTS.TIMEOUT) {\n        // Session valid, return existing session\n        return {\n          id: sessionId,\n          startTime,\n          lastActive,\n          pageViews: 0,\n          events: 0,\n          isNew: false,\n        };\n      }\n    }\n\n    // Create new session\n    const newSessionId = this.generateSessionId();\n    const newStartTime = Date.now();\n\n    // Update memory cache\n    this.storageCache[SESSION_ID_KEY] = newSessionId;\n    this.storageCache[SESSION_START_KEY] = newStartTime.toString();\n    this.storageCache[SESSION_LAST_ACTIVE_KEY] = newStartTime.toString();\n\n    // Sync to storage immediately\n    this.syncStorage();\n\n    return {\n      id: newSessionId,\n      startTime: newStartTime,\n      lastActive: newStartTime,\n      pageViews: 0,\n      events: 0,\n      isNew: true,\n    };\n  }\n\n  /**\n   * Generate session ID\n   * @returns Session ID\n   */\n  private generateSessionId(): string {\n    return (\n      \"session_\" + Date.now() + \"_\" + Math.random().toString(36).substr(2, 9)\n    );\n  }\n}\n\n/**\n * Session manager instance\n */\nconst sessions = new Sessions();\n\n/**\n * Session plugin\n */\nexport const sessionPlugin: IPlugin = {\n  name: \"session\",\n  version: \"1.0.0\",\n  description: \"Session management plugin for tracking user sessions\",\n  priority: 10,\n\n  /**\n   * Initialize plugin\n   */\n  init(_context: IPluginContext): void {\n    sessions.start();\n  },\n\n  /**\n   * Before event tracking callback\n   */\n  onTrack<T extends EventProperties>(payload: Payload<T>): Payload<T> {\n    // Update session activity time and event count\n    sessions.updateLastActive();\n    sessions.incrementEvents();\n\n    // If it's a page view event, increment page views count\n    if (payload.event === \"page_view\") {\n      sessions.incrementPageViews();\n    }\n\n    // Add session context\n    const sessionContext = sessions.getContext();\n    return {\n      ...payload,\n      properties: {\n        ...payload.properties,\n        ...sessionContext,\n      } as T,\n    };\n  },\n\n  /**\n   * Plugin state\n   */\n  state: {\n    sessions,\n  },\n\n  /**\n   * Get plugin information\n   */\n  getInfo(): Record<string, any> {\n    return {\n      name: this.name,\n      version: this.version,\n      description: this.description,\n      sessionId: sessions.getID(),\n      sessionStartTime: sessions.getStartTime(),\n      sessionDuration: sessions.getDuration(),\n      sessionIsNew: sessions.isNew(),\n      sessionPageViews: sessions.getStats().pageViews,\n      sessionEvents: sessions.getStats().events,\n    };\n  },\n};\n\n/**\n * Export session manager instance for use elsewhere\n */\nexport { sessions };\n","/**\n * Behavior management plugin\n * Responsible for tracking user behavior, page views, and behavior analysis\n */\n\nimport { isBrowser } from \"../utils\";\nimport { storageUtils } from \"./browser\";\nimport { handleBehaviorError } from \"../error\";\nimport type {\n  EventProperties,\n  IPlugin,\n  IPluginContext,\n  Payload,\n} from \"../types\";\n\n/**\n * Behavior path storage key\n */\nconst BEHAVIOR_PATH_KEY = \"__analytics_behavior_path__\";\n\n/**\n * Behavior constants definition\n */\nexport const BEHAVIOR_CONSTANTS = {\n  /**\n   * Maximum behavior path length\n   */\n  MAX_STEPS: 50,\n  /**\n   * Save interval (milliseconds)\n   */\n  SAVE_INTERVAL: 2000,\n  /**\n   * Default recent behaviors limit\n   */\n  DEFAULT_RECENT_BEHAVIORS_LIMIT: 10,\n  /**\n   * Behavior context recent behaviors limit\n   */\n  CONTEXT_RECENT_BEHAVIORS_LIMIT: 5,\n  /**\n   * Analysis result limit\n   */\n  ANALYSIS_RESULT_LIMIT: 5,\n  /**\n   * Session timeout (milliseconds)\n   */\n  SESSION_TIMEOUT: 30 * 60 * 1000,\n};\n\n/**\n * Behavior step interface\n */\ninterface BehaviorStep {\n  /**\n   * Event name\n   */\n  event: string;\n  /**\n   * Timestamp\n   */\n  timestamp: number;\n  /**\n   * Event properties\n   */\n  properties: EventProperties;\n  /**\n   * Path\n   */\n  path: string;\n  /**\n   * Referrer\n   */\n  referrer: string;\n}\n\n/**\n * Behavior manager\n * Responsible for tracking and managing user behavior\n */\nclass Behaviors {\n  /**\n   * Behavior path\n   * @private\n   */\n  private behaviorPath: BehaviorStep[] = [];\n\n  /**\n   * Save timeout ID\n   * @private\n   */\n  private saveTimeoutId: ReturnType<typeof setTimeout> | null = null;\n\n  /**\n   * Last save time\n   * @private\n   */\n  private lastSaveTime: number = 0;\n\n  /**\n   * Save interval (milliseconds)\n   * @private\n   */\n  private saveInterval: number = BEHAVIOR_CONSTANTS.SAVE_INTERVAL;\n\n  /**\n   * Initialize behavior manager\n   */\n  init(): void {\n    if (!isBrowser()) return;\n\n    try {\n      this.behaviorPath = this.loadBehaviorPath();\n    } catch (error) {\n      handleBehaviorError(error, { context: \"init\" });\n      this.behaviorPath = [];\n    }\n  }\n\n  /**\n   * Load behavior path\n   * @private\n   * @returns Behavior path\n   */\n  private loadBehaviorPath(): BehaviorStep[] {\n    const pathStr = storageUtils.get(BEHAVIOR_PATH_KEY) as string | null;\n    if (!pathStr) return [];\n    try {\n      const path = JSON.parse(pathStr) as unknown;\n      return Array.isArray(path) ? path : [];\n    } catch {\n      return [];\n    }\n  }\n\n  /**\n   * Save behavior path\n   * @private\n   */\n  private saveBehaviorPath(): void {\n    if (!isBrowser()) return;\n\n    // Clear previous timeout\n    if (this.saveTimeoutId) {\n      clearTimeout(this.saveTimeoutId);\n      this.saveTimeoutId = null;\n    }\n\n    // Use throttling mechanism to avoid frequent writes\n    const now = Date.now();\n    if (now - this.lastSaveTime < this.saveInterval) {\n      // Set timeout for delayed save\n      this.saveTimeoutId = setTimeout(() => {\n        this.saveBehaviorPathToStorage();\n      }, this.saveInterval);\n      return;\n    }\n\n    // Save immediately\n    this.saveBehaviorPathToStorage();\n  }\n\n  /**\n   * Actually save behavior path to storage\n   * @private\n   */\n  private saveBehaviorPathToStorage(): void {\n    try {\n      // Limit behavior path length\n      if (this.behaviorPath.length > BEHAVIOR_CONSTANTS.MAX_STEPS) {\n        this.behaviorPath = this.behaviorPath.slice(\n          -BEHAVIOR_CONSTANTS.MAX_STEPS,\n        );\n      }\n      storageUtils.set(BEHAVIOR_PATH_KEY, JSON.stringify(this.behaviorPath));\n      this.lastSaveTime = Date.now();\n    } catch (error) {\n      handleBehaviorError(error, { context: \"saveBehaviorPathToStorage\" });\n    }\n  }\n\n  /**\n   * Track behavior\n   * @param event - Event name\n   * @param properties - Event properties\n   */\n  track(event: string, properties: EventProperties = {}): void {\n    if (!isBrowser()) return;\n\n    try {\n      const step: BehaviorStep = {\n        event,\n        timestamp: Date.now(),\n        properties,\n        path: window.location.pathname,\n        referrer: document.referrer,\n      };\n\n      this.behaviorPath.push(step);\n      this.saveBehaviorPath();\n    } catch (error) {\n      handleBehaviorError(error, { context: \"track\", event });\n    }\n  }\n\n  /**\n   * Track page view\n   * @param properties - Page properties\n   */\n  trackView(properties: EventProperties = {}): void {\n    if (!isBrowser()) return;\n\n    try {\n      const step: BehaviorStep = {\n        event: \"pageview\",\n        timestamp: Date.now(),\n        properties,\n        path: window.location.pathname,\n        referrer: document.referrer,\n      };\n\n      this.behaviorPath.push(step);\n      this.saveBehaviorPath();\n    } catch (error) {\n      handleBehaviorError(error, { context: \"trackView\" });\n    }\n  }\n\n  /**\n   * Get behavior path\n   * @returns Behavior path\n   */\n  getPath(): BehaviorStep[] {\n    return [...this.behaviorPath];\n  }\n\n  /**\n   * Get recent behaviors\n   * @param limit - Limit count\n   * @returns Recent behaviors\n   */\n  getRecent(\n    limit: number = BEHAVIOR_CONSTANTS.DEFAULT_RECENT_BEHAVIORS_LIMIT,\n  ): BehaviorStep[] {\n    return this.behaviorPath.slice(-limit);\n  }\n\n  /**\n   * Get behavior path statistics\n   * @returns Behavior statistics\n   * @returns totalSteps - Total steps\n   * @returns uniqueEvents - Unique events count\n   * @returns averageTimeBetweenSteps - Average time between steps\n   */\n  getStats(): {\n    totalSteps: number;\n    uniqueEvents: number;\n    averageTimeBetweenSteps: number;\n  } {\n    const totalSteps = this.behaviorPath.length;\n    const uniqueEvents = new Set(this.behaviorPath.map((step) => step.event))\n      .size;\n\n    let averageTimeBetweenSteps = 0;\n    if (totalSteps > 1) {\n      let totalTime = 0;\n      for (let i = 1; i < totalSteps; i++) {\n        totalTime +=\n          this.behaviorPath[i].timestamp - this.behaviorPath[i - 1].timestamp;\n      }\n      averageTimeBetweenSteps = totalTime / (totalSteps - 1);\n    }\n\n    return {\n      totalSteps,\n      uniqueEvents,\n      averageTimeBetweenSteps,\n    };\n  }\n\n  /**\n   * Get behavior path context\n   * @returns Behavior context\n   */\n  getContext(): EventProperties {\n    const recentBehaviors = this.getRecent(\n      BEHAVIOR_CONSTANTS.CONTEXT_RECENT_BEHAVIORS_LIMIT,\n    );\n    const behaviorStats = this.getStats();\n\n    return {\n      behavior_steps: recentBehaviors.length,\n      behavior_unique_events: behaviorStats.uniqueEvents,\n      behavior_avg_time_between_steps: Math.round(\n        behaviorStats.averageTimeBetweenSteps,\n      ),\n      last_event: recentBehaviors[recentBehaviors.length - 1]?.event || \"\",\n      last_event_time:\n        recentBehaviors[recentBehaviors.length - 1]?.timestamp || 0,\n    };\n  }\n\n  /**\n   * Clear behavior path\n   */\n  clear(): void {\n    if (!isBrowser()) return;\n\n    try {\n      this.clearTimeouts();\n\n      this.behaviorPath = [];\n      storageUtils.remove(BEHAVIOR_PATH_KEY);\n      this.lastSaveTime = 0;\n    } catch (error) {\n      handleBehaviorError(error, { context: \"clear\" });\n    }\n  }\n\n  /**\n   * Clear timeouts\n   */\n  clearTimeouts(): void {\n    if (this.saveTimeoutId) {\n      clearTimeout(this.saveTimeoutId);\n      this.saveTimeoutId = null;\n    }\n  }\n\n  /**\n   * Analyze behavior path\n   * @returns Behavior analysis result\n   * @returns mostFrequentEvents - Most frequent events\n   * @returns commonPaths - Common paths\n   * @returns averageSessionDuration - Average session duration\n   */\n  analyze(): {\n    mostFrequentEvents: Array<{ event: string; count: number }>;\n    commonPaths: Array<{ path: string; count: number }>;\n    averageSessionDuration: number;\n  } {\n    const eventCounts: Record<string, number> = {};\n    for (const step of this.behaviorPath) {\n      eventCounts[step.event] = (eventCounts[step.event] || 0) + 1;\n    }\n\n    const mostFrequentEvents = Object.entries(eventCounts)\n      .map(([event, count]) => ({ event, count }))\n      .sort((a, b) => b.count - a.count)\n      .slice(0, BEHAVIOR_CONSTANTS.ANALYSIS_RESULT_LIMIT);\n\n    const pathCounts: Record<string, number> = {};\n    for (const step of this.behaviorPath) {\n      pathCounts[step.path] = (pathCounts[step.path] || 0) + 1;\n    }\n\n    const commonPaths = Object.entries(pathCounts)\n      .map(([path, count]) => ({ path, count }))\n      .sort((a, b) => b.count - a.count)\n      .slice(0, BEHAVIOR_CONSTANTS.ANALYSIS_RESULT_LIMIT);\n\n    const sessions = this.extractSessions();\n    const averageSessionDuration =\n      sessions.length > 0\n        ? sessions.reduce((total, session) => total + session.duration, 0) /\n          sessions.length\n        : 0;\n\n    return {\n      mostFrequentEvents,\n      commonPaths,\n      averageSessionDuration,\n    };\n  }\n\n  /**\n   * Extract sessions\n   * @private\n   * @returns Session list\n   */\n  private extractSessions(): Array<{\n    startTime: number;\n    endTime: number;\n    duration: number;\n    steps: BehaviorStep[];\n  }> {\n    const sessions: Array<{\n      startTime: number;\n      endTime: number;\n      duration: number;\n      steps: BehaviorStep[];\n    }> = [];\n    if (this.behaviorPath.length === 0) return sessions;\n\n    let currentSession: BehaviorStep[] = [this.behaviorPath[0]];\n    let startTime = this.behaviorPath[0].timestamp;\n\n    for (let i = 1; i < this.behaviorPath.length; i++) {\n      const step = this.behaviorPath[i];\n      const timeDiff =\n        step.timestamp - currentSession[currentSession.length - 1].timestamp;\n\n      // Session timeout check\n      if (timeDiff > BEHAVIOR_CONSTANTS.SESSION_TIMEOUT) {\n        // End current session\n        const endTime = currentSession[currentSession.length - 1].timestamp;\n        sessions.push({\n          startTime,\n          endTime,\n          duration: endTime - startTime,\n          steps: [...currentSession],\n        });\n\n        // Start new session\n        currentSession = [step];\n        startTime = step.timestamp;\n      } else {\n        currentSession.push(step);\n      }\n    }\n\n    // Add last session\n    if (currentSession.length > 0) {\n      const endTime = currentSession[currentSession.length - 1].timestamp;\n      sessions.push({\n        startTime,\n        endTime,\n        duration: endTime - startTime,\n        steps: [...currentSession],\n      });\n    }\n\n    return sessions;\n  }\n}\n\n/**\n * Behavior manager instance\n */\nconst behaviors = new Behaviors();\n\n/**\n * Behavior plugin\n */\nexport const behaviorPlugin: IPlugin = {\n  name: \"behavior\",\n  version: \"1.0.0\",\n  description:\n    \"Behavior tracking plugin for tracking user behavior and page views\",\n  priority: 20,\n  dependencies: [\"session\"],\n\n  setup(context: IPluginContext): void {\n    const sessionPlugin = context.getPlugin(\"session\");\n    if (!sessionPlugin) {\n      console.warn(\n        \"[Node-Trace] behavior plugin requires session plugin to be registered\",\n      );\n      return;\n    }\n  },\n\n  init(_context: IPluginContext): void {\n    behaviors.init();\n  },\n\n  /**\n   * Before event tracking callback\n   */\n  onTrack<T extends EventProperties>(payload: Payload<T>): Payload<T> {\n    behaviors.track(payload.event, payload.properties || {});\n\n    if (payload.event === \"page_view\") {\n      behaviors.trackView(payload.properties || {});\n    }\n\n    const behaviorContext = behaviors.getContext();\n    return {\n      ...payload,\n      properties: {\n        ...payload.properties,\n        ...behaviorContext,\n      } as T,\n    };\n  },\n\n  state: {\n    behaviors,\n  },\n\n  getInfo(): Record<string, any> {\n    return {\n      name: this.name,\n      version: this.version,\n      description: this.description,\n      behaviorStats: behaviors.getStats(),\n      recentBehaviors: behaviors.getRecent(5),\n    };\n  },\n};\n\n/**\n * Export behavior manager instance for use elsewhere\n */\nexport { behaviors };\n","/**\n * Error plugin\n * Responsible for listening to and capturing JavaScript errors and unhandled Promise rejections\n */\n\nimport { track } from \"../core\";\nimport type { IPlugin, IPluginContext } from \"../types\";\nimport { isBrowser } from \"../utils\";\n\n/**\n * Error plugin\n */\nexport const errorPlugin: IPlugin = {\n  /**\n   * Plugin name\n   */\n  name: \"error\",\n\n  /**\n   * Plugin setup method\n   */\n  setup(_context: IPluginContext) {\n    if (!isBrowser()) return;\n\n    // Listen for JavaScript errors\n    window.addEventListener(\"error\", (e) => {\n      try {\n        track(\"js_error\", {\n          message: e.message,\n          filename: e.filename,\n          lineno: e.lineno,\n          colno: e.colno,\n        });\n      } catch {\n        // Ignore errors to avoid infinite loops\n      }\n    });\n\n    // Listen for unhandled Promise rejections\n    window.addEventListener(\"unhandledrejection\", (e) => {\n      try {\n        track(\"promise_error\", {\n          reason: String(e.reason),\n          message: e.reason?.message || String(e.reason),\n        });\n      } catch {\n        // Ignore errors to avoid infinite loops\n      }\n    });\n  },\n};\n","/**\n * Performance plugin\n * Responsible for collecting and sending page performance data, including load time, time to first byte, DOM parsing time, etc.\n */\n\nimport { track } from \"../core\";\nimport type { IPlugin, IPluginContext } from \"../types\";\nimport { isBrowser } from \"../utils\";\n\n/**\n * Performance paint entry interface\n */\ninterface PerformancePaintEntry {\n  name: string;\n  startTime: number;\n  duration: number;\n  entryType: string;\n}\n\n/**\n * Send performance data\n */\nfunction sendPerformanceData() {\n  if (!isBrowser()) return;\n\n  try {\n    const performance = window.performance;\n    if (!performance || !performance.getEntriesByType) return;\n\n    // Get navigation performance data\n    const navigationEntries = performance.getEntriesByType(\"navigation\");\n    if (navigationEntries.length > 0) {\n      const navEntry = navigationEntries[0] as PerformanceNavigationTiming;\n\n      track(\"page_performance\", {\n        // Page load time\n        loadTime: navEntry.loadEventEnd - navEntry.fetchStart,\n        // Time to first byte\n        ttfb: navEntry.responseStart - navEntry.fetchStart,\n        // DOM parsing time\n        domContentLoaded:\n          navEntry.domContentLoadedEventEnd - navEntry.fetchStart,\n        // Redirect time\n        redirectTime: navEntry.redirectEnd - navEntry.redirectStart,\n        // DNS query time\n        dnsTime: navEntry.domainLookupEnd - navEntry.domainLookupStart,\n        // TCP connection time\n        tcpTime: navEntry.connectEnd - navEntry.connectStart,\n        // SSL handshake time\n        sslTime: navEntry.secureConnectionStart\n          ? navEntry.connectEnd - navEntry.secureConnectionStart\n          : 0,\n        // First paint time (estimated)\n        firstPaint:\n          performance\n            .getEntriesByType(\"paint\")\n            .find((e) => (e as PerformancePaintEntry).name === \"first-paint\")\n            ?.startTime || 0,\n        firstContentfulPaint:\n          performance\n            .getEntriesByType(\"paint\")\n            .find(\n              (e) =>\n                (e as PerformancePaintEntry).name === \"first-contentful-paint\",\n            )?.startTime || 0,\n      });\n    }\n\n    // Get resource loading performance data\n    const resourceEntries = performance.getEntriesByType(\"resource\");\n    if (resourceEntries.length > 0) {\n      const resourceStats = {\n        total: resourceEntries.length,\n        scripts: 0,\n        stylesheets: 0,\n        images: 0,\n        fonts: 0,\n        other: 0,\n        totalLoadTime: 0,\n      };\n\n      resourceEntries.forEach((entry) => {\n        const resourceEntry = entry as PerformanceResourceTiming;\n        resourceStats.totalLoadTime += resourceEntry.duration;\n\n        if (resourceEntry.name.includes(\".js\")) {\n          resourceStats.scripts++;\n        } else if (resourceEntry.name.includes(\".css\")) {\n          resourceStats.stylesheets++;\n        } else if (/(jpg|jpeg|png|gif|webp|svg)$/i.test(resourceEntry.name)) {\n          resourceStats.images++;\n        } else if (/(woff|woff2|ttf|otf)$/i.test(resourceEntry.name)) {\n          resourceStats.fonts++;\n        } else {\n          resourceStats.other++;\n        }\n      });\n\n      track(\"resource_performance\", resourceStats);\n    }\n  } catch {\n    // Ignore errors to avoid infinite loops\n  }\n}\n\n/**\n * Performance plugin\n */\nexport const performancePlugin: IPlugin = {\n  /**\n   * Plugin name\n   */\n  name: \"performance\",\n\n  /**\n   * Plugin setup method\n   */\n  setup(_context: IPluginContext) {\n    if (!isBrowser()) return;\n\n    // Wait for page load to complete\n    if (document.readyState === \"complete\") {\n      sendPerformanceData();\n    } else {\n      window.addEventListener(\"load\", sendPerformanceData);\n    }\n  },\n};\n","/**\n * Page view plugin\n * Responsible for monitoring and tracking page view events, including initial load and route changes\n */\n\nimport { track } from \"../core\";\nimport { getBrowserData } from \"./browser\";\nimport type { IPlugin, IPluginContext } from \"../types\";\nimport { isBrowser } from \"../utils\";\n\n/**\n * Send page view event\n */\nfunction sendPageView() {\n  if (!isBrowser()) return;\n\n  try {\n    // Page view event will automatically trigger session and behavior updates through plugin system\n    const browserData = getBrowserData();\n    track(\"page_view\", {\n      ...browserData,\n      url: window.location.href,\n      pathname: window.location.pathname,\n      referrer: document.referrer,\n      title: document.title,\n    });\n  } catch {\n    // Ignore errors to avoid infinite loops\n  }\n}\n\n/**\n * Listen for route changes\n */\nfunction listenForRouteChanges() {\n  if (!isBrowser()) return;\n\n  // Listen for hash changes\n  window.addEventListener(\"hashchange\", sendPageView);\n\n  // Listen for history changes\n  const originalPushState = history.pushState;\n  const originalReplaceState = history.replaceState;\n\n  history.pushState = function (...args) {\n    originalPushState.apply(this, args);\n    sendPageView();\n  };\n\n  history.replaceState = function (...args) {\n    originalReplaceState.apply(this, args);\n    sendPageView();\n  };\n\n  // Listen for forward/back buttons\n  window.addEventListener(\"popstate\", sendPageView);\n}\n\n/**\n * Page view plugin\n */\nexport const pageviewPlugin: IPlugin = {\n  /**\n   * Plugin name\n   */\n  name: \"pageview\",\n\n  /**\n   * Plugin dependencies\n   */\n  dependencies: [\"session\", \"behavior\"],\n\n  /**\n   * Plugin setup method\n   */\n  setup(context: IPluginContext) {\n    if (!isBrowser()) return;\n\n    const sessionPlugin = context.getPlugin(\"session\");\n    const behaviorPlugin = context.getPlugin(\"behavior\");\n\n    if (!sessionPlugin) {\n      console.warn(\n        \"[Node-Trace] pageview plugin requires session plugin to be registered\",\n      );\n      return;\n    }\n\n    if (!behaviorPlugin) {\n      console.warn(\n        \"[Node-Trace] pageview plugin requires behavior plugin to be registered\",\n      );\n      return;\n    }\n\n    sendPageView();\n    listenForRouteChanges();\n  },\n};\n","/**\n * Network plugin\n * Responsible for monitoring and tracking network requests, including XMLHttpRequest and fetch requests\n */\n\nimport { track, state } from \"../core\";\nimport type { IPlugin, IPluginContext } from \"../types\";\nimport { isBrowser } from \"../utils\";\n\n/**\n * Extended XMLHttpRequest interface with custom properties\n */\ninterface XMLHttpRequestWithCustomProps extends XMLHttpRequest {\n  /**\n   * Request start time\n   */\n  _requestStartTime?: number;\n  /**\n   * Request method\n   */\n  _requestMethod?: string;\n  /**\n   * Request URL\n   */\n  _requestUrl?: string | URL;\n}\n\n/**\n * Check if URL is SDK's own reporting endpoint\n * @param url URL to check\n * @returns Whether it's SDK's own reporting endpoint\n */\nfunction isSdkEndpoint(url: string): boolean {\n  try {\n    const options = state.options;\n    if (!options?.endpoint) return false;\n\n    const sdkUrl = new URL(options.endpoint);\n    const requestUrl = new URL(url, window.location.origin);\n\n    // Compare protocol, host, and path\n    return (\n      sdkUrl.protocol === requestUrl.protocol &&\n      sdkUrl.host === requestUrl.host &&\n      sdkUrl.pathname === requestUrl.pathname\n    );\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Patch XMLHttpRequest to monitor network requests\n */\nfunction patchXMLHttpRequest() {\n  if (!isBrowser() || !window.XMLHttpRequest) return;\n\n  const originalOpen = XMLHttpRequest.prototype.open;\n  const originalSend = XMLHttpRequest.prototype.send;\n\n  XMLHttpRequest.prototype.open = function (\n    method: string,\n    url: string | URL,\n    async?: boolean,\n    username?: string | null,\n    password?: string | null,\n  ) {\n    const xhr = this as XMLHttpRequestWithCustomProps;\n    xhr._requestStartTime = Date.now();\n    xhr._requestMethod = method;\n    xhr._requestUrl = url;\n    return originalOpen.call(\n      this,\n      method,\n      url,\n      async !== false,\n      username,\n      password,\n    );\n  };\n\n  XMLHttpRequest.prototype.send = function (\n    body?: Document | XMLHttpRequestBodyInit | null,\n  ) {\n    const xhr = this as XMLHttpRequestWithCustomProps;\n\n    this.addEventListener(\"load\", function () {\n      try {\n        const url = xhr._requestUrl?.toString() || \"\";\n        // Exclude SDK's own reporting endpoint\n        if (isSdkEndpoint(url)) return;\n\n        const duration = Date.now() - (xhr._requestStartTime || Date.now());\n        track(\"network_request\", {\n          method: xhr._requestMethod || \"GET\",\n          url,\n          status: xhr.status,\n          statusText: xhr.statusText,\n          duration,\n          type: \"xhr\",\n          success: xhr.status >= 200 && xhr.status < 300,\n        });\n      } catch {\n        // Ignore errors to avoid infinite loops\n      }\n    });\n\n    this.addEventListener(\"error\", function () {\n      try {\n        const url = xhr._requestUrl?.toString() || \"\";\n        // Exclude SDK's own reporting endpoint\n        if (isSdkEndpoint(url)) return;\n\n        const duration = Date.now() - (xhr._requestStartTime || Date.now());\n        track(\"network_request\", {\n          method: xhr._requestMethod || \"GET\",\n          url,\n          status: 0,\n          statusText: \"Error\",\n          duration,\n          type: \"xhr\",\n          success: false,\n        });\n      } catch {\n        // Ignore errors to avoid infinite loops\n      }\n    });\n\n    this.addEventListener(\"abort\", function () {\n      try {\n        const url = xhr._requestUrl?.toString() || \"\";\n        // Exclude SDK's own reporting endpoint\n        if (isSdkEndpoint(url)) return;\n\n        const duration = Date.now() - (xhr._requestStartTime || Date.now());\n        track(\"network_request\", {\n          method: xhr._requestMethod || \"GET\",\n          url,\n          status: 0,\n          statusText: \"Aborted\",\n          duration,\n          type: \"xhr\",\n          success: false,\n        });\n      } catch {\n        // Ignore errors to avoid infinite loops\n      }\n    });\n\n    return originalSend.call(this, body);\n  };\n}\n\n/**\n * Patch fetch to monitor network requests\n */\nfunction patchFetch() {\n  if (!isBrowser() || !window.fetch) return;\n\n  const originalFetch = window.fetch;\n\n  window.fetch = async function (...args) {\n    const startTime = Date.now();\n    const url = args[0] as string;\n    const options = args[1] || {};\n    const method = options.method || \"GET\";\n\n    // Exclude SDK's own reporting endpoint\n    if (isSdkEndpoint(url)) {\n      return originalFetch.apply(this, args);\n    }\n\n    try {\n      const response = await originalFetch.apply(this, args);\n      const duration = Date.now() - startTime;\n\n      track(\"network_request\", {\n        method,\n        url,\n        status: response.status,\n        statusText: response.statusText,\n        duration,\n        type: \"fetch\",\n        success: response.ok,\n      });\n\n      return response;\n    } catch (error) {\n      const duration = Date.now() - startTime;\n\n      track(\"network_request\", {\n        method,\n        url,\n        status: 0,\n        statusText: error instanceof Error ? error.message : \"Error\",\n        duration,\n        type: \"fetch\",\n        success: false,\n      });\n\n      throw error;\n    }\n  };\n}\n\n/**\n * Network plugin\n */\nexport const networkPlugin: IPlugin = {\n  /**\n   * Plugin name\n   */\n  name: \"network\",\n\n  /**\n   * Plugin setup method\n   */\n  setup(_context: IPluginContext) {\n    if (!isBrowser()) return;\n\n    // Patch XMLHttpRequest\n    patchXMLHttpRequest();\n\n    // Patch fetch\n    patchFetch();\n  },\n};\n"],"mappings":"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","names":["QUEUE_CONSTANTS","LRUCache","maxSize","key","value","firstKey","generateEventKey","event","EventDedupe","events","CONSTANTS","stringUtils","length","chars","result","i","c","r","timestamp","now","date","year","month","day","hours","minutes","seconds","milliseconds","formattedTime","randomPart","str","maxLength","suffix","isBrowser","now","NetworkManager","QUEUE_CONSTANTS","now","isBrowser","connection","networkManager","SendStrategySelector","_body","bodySize","networkType","networkManager","QUEUE_CONSTANTS","_bodySize","candidates","bestStrategy","bestSuccessRate","strategy","history","successRate","success","sendWithBeacon","endpoint","body","debug","isBrowser","error","sendWithFetch","headers","timeout","res","sendWithXHR","data","resolve","xhr","Sender","options","startTime","actualStrategy","time","sender","ErrorHandler","config","type","level","stack","stackLines","line","match","error","oneHourAgo","ts","oneMinuteAgo","message","context","code","source","errorObj","errorDetails","file","stackInfo","traceError","_a","debugEnabled","state","shouldLog","prefix","contextStr","detailsStr","stackStr","errorIdStr","count","mostFrequentType","maxTypeCount","mostFrequentLevel","maxLevelCount","levelOrder","configLevelIndex","initializeStats","errorTypes","errorLevels","byType","type","byLevel","level","calculateErrorRate","timestamps","now","oneMinuteAgo","oneHourAgo","ts","generateErrorSummary","errors","stats","mostFrequentType","maxTypeCount","count","mostFrequentLevel","maxLevelCount","cleanupTimestamps","threshold","errorHandler","ErrorHandler","captureError","type","message","error","context","level","handleNetworkError","handleStorageError","handleBrowserError","handlePluginError","handleQueueError","handleDeviceError","handleSessionError","handleBehaviorError","handleDataError","handleUnknownError","Dexie","NodeTraceDB","db","DexieStorage","events","ids","e","eventsToWrite","DB","PriorityQueue","event","priority","priorityEvent","size","batch","determineEventPriority","highPriorityEvents","lowPriorityEvents","QueueManager","PriorityQueue","EventDedupe","QUEUE_CONSTANTS","config","now","pressure","batchSize","interval","removeCount","removedEvents","event","_a","priority","determineEventPriority","sendTime","success","totalSends","batch","isBrowser","DB","error","handleNetworkError","retryInterval","retryTimer","sortedPlugins","plugins","result","plugin","handlePluginError","priorityBatch","batchIds","e","processedBatch","sender","_b","offlineEvents","queueEventKeys","key","eventsToAdd","offlineEvent","idsToDelete","t","queueManager","push","event","queueManager","flush","clearTimers","DEFAULT_OPTIONS","state","Plugins","name","pluginName","methodName","args","plugin","method","dep","conflict","error","handlePluginError","context","result","a","b","plugins","init","options","queueManager","use","shouldSend","event","_a","opt","track","properties","_b","_c","payload","stringUtils","now","allPlugins","pluginsToNotify","p","r","final","eventToPush","push","detectBrowser","userAgent","_a","_b","_c","_d","_e","_f","_g","name","version","major","engine","engineVersion","detectDevice","isMobile","isTablet","isDesktop","type","parseBrowserInfo","result","parseDeviceType","getBasicBrowserInfo","isBrowser","getDetailedBrowserInfo","browserInfo","getDeviceInfo","deviceType","getNetworkInfo","_a","_b","_c","_d","isBrowser","browserUtils","type","effectiveType","rtt","downlink","connection","getPageInfo","isBrowser","getScrollInfo","getScreenInfo","isBrowser","storageUtils","key","parser","isBrowser","value","e","stringValue","browserUtils","isBrowser","result","detectBrowser","detectDevice","getBrowserData","_a","_b","_c","_d","_e","_f","_g","_h","_i","_j","_k","_l","_m","getDeviceId","basicBrowserInfo","getBasicBrowserInfo","detailedBrowserInfo","getDetailedBrowserInfo","deviceInfo","getDeviceInfo","networkInfo","getNetworkInfo","screenInfo","getScreenInfo","pageInfo","getPageInfo","scrollInfo","getScrollInfo","error","browserPlugin","payload","browserData","DEVICE_ID_KEY","USER_ID_KEY","nonBrowserDeviceId","cachedBrowserDeviceId","DEFAULT_DEVICE_ID_LENGTH","generateSHA256Hash","input","isBrowser","data","hashBuffer","b","__require","improvedHash","hash","i","hashStr","randomPart","collectBrowserFingerprint","extendedNavigator","fingerprint","error","handleBrowserError","generateStableDeviceIdSync","timestamp","random","deviceId","fallbackId","generateDeviceIdAsync","generateStableDeviceId","generateStableDeviceIdAsync","getDeviceId","existingId","storageUtils","newId","handleStorageError","setID","id","getID","userId","clearID","userPlugin","payload","SESSION_ID_KEY","SESSION_START_KEY","SESSION_LAST_ACTIVE_KEY","SESSION_CONSTANTS","Sessions","isBrowser","error","handleSessionError","now","_a","_b","_c","_d","_e","storageUtils","key","value","sessionId","startTimeStr","lastActiveStr","startTime","lastActive","newSessionId","newStartTime","sessions","sessionPlugin","_context","payload","sessionContext","BEHAVIOR_PATH_KEY","BEHAVIOR_CONSTANTS","Behaviors","isBrowser","error","handleBehaviorError","pathStr","storageUtils","path","e","event","properties","step","limit","totalSteps","uniqueEvents","averageTimeBetweenSteps","totalTime","_a","_b","recentBehaviors","behaviorStats","eventCounts","mostFrequentEvents","count","a","b","pathCounts","commonPaths","sessions","averageSessionDuration","total","session","currentSession","startTime","i","endTime","behaviors","behaviorPlugin","context","_context","payload","behaviorContext","errorPlugin","_context","isBrowser","track","e","_a","sendPerformanceData","_a","_b","isBrowser","performance","navigationEntries","navEntry","track","e","resourceEntries","resourceStats","entry","resourceEntry","performancePlugin","_context","sendPageView","isBrowser","browserData","getBrowserData","track","e","listenForRouteChanges","originalPushState","originalReplaceState","args","pageviewPlugin","context","sessionPlugin","behaviorPlugin","isSdkEndpoint","url","options","state","sdkUrl","requestUrl","patchXMLHttpRequest","isBrowser","originalOpen","originalSend","method","async","username","password","xhr","body","_a","duration","track","e","patchFetch","originalFetch","args","startTime","response","error","networkPlugin","_context"]}